<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>RMUTTO - VASD | ‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family:"Segoe UI", sans-serif; background:#f4f6f8; margin:0; }
header {
  background:#fff;
  border-bottom:1px solid #ddd;
  padding:14px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.container { max-width:1600px; margin:auto; padding:20px; }

table {
  width:100%;
  border-collapse:collapse;
  background:#fff;
  box-shadow:0 2px 5px rgba(0,0,0,0.1);
}
th, td {
  border:1px solid #ddd;
  padding:10px;
  text-align:center;
}
th { background:#f1f3f5; }

input, select { width:100%; box-sizing:border-box; padding:4px; }

/* STATUS COLORS */
.status-wait       { background:#eeeeee; }
.status-anesthesia { background:#e3f2fd; }
.status-surgery    { background:#fdecea; }
.status-recovery   { background:#f3e5f5; }
.status-ready      { background:#fff9c4; }
.status-done       { background:#e8f5e9; }
.status-cancel     { background:#eeeeee; opacity:0.6; }

button {
  padding:6px 10px;
  border:none;
  border-radius:4px;
  cursor:pointer;
  font-size:13px;
  margin:2px;
}
.btn-edit   { background:#2c7be5; color:#fff; }
.btn-save   { background:#198754; color:#fff; }
.btn-cancel { background:#fd7e14; color:#fff; }
.btn-del    { background:#dc3545; color:#fff; }
.btn-home   { background:#6c757d; color:#fff; }
.btn-print  { background:#000; color:#fff; }

.btn-save:disabled { opacity:.4; cursor:not-allowed; }

.footer-actions { margin-top:20px; text-align:right; }
</style>
</head>

<body>

<header>
  <h3>üêæ ‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</h3>
  <button class="btn-home" onclick="location.href='index.html'">üè† Home</button>
</header>

<div class="container">

<table>
<thead>
<tr>
  <th>‡∏Ñ‡∏¥‡∏ß</th>
  <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå</th>
  <th>‡∏ä‡∏ô‡∏¥‡∏î</th>
  <th>‡πÄ‡∏û‡∏®</th>
  <th>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</th>
  <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
  <th>‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</th>
  <th>‡πÇ‡∏ó‡∏£</th>
  <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
</tr>
</thead>
<tbody id="animalTable"></tbody>
</table>

<div class="footer-actions">
  <button class="btn-del" onclick="deleteAll()">‚ùå ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</button>
</div>

</div>

<script type="module">
import { supabase } from "./js/supabase.js";

const ADMIN_PASSWORD = "2500";

const statusMap = {
  waiting:{ text:"‡∏£‡∏≠‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î", cls:"status-wait" },
  anesthesia:{ text:"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏≤‡∏á‡∏¢‡∏≤‡∏™‡∏•‡∏ö", cls:"status-anesthesia" },
  surgery:{ text:"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î", cls:"status-surgery" },
  recovery:{ text:"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏Å‡∏ü‡∏∑‡πâ‡∏ô", cls:"status-recovery" },
  ready_to_go_home:{ text:"‡∏ü‡∏∑‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß / ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö", cls:"status-ready" },
  done:{ text:"‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß", cls:"status-done" },
  cancel:{ text:"‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å", cls:"status-cancel" }
};

/* ================= LOAD ================= */
async function loadAnimals(){

  const { data:eventId } = await supabase.rpc("get_today_event");

  const { data, error } = await supabase
    .from("vasd_animal")
    .select(`
      id, queue_number, animal_name, species, sex, est_weight,
      vasd_owner ( owner_name, phone ),
      vasd_queue ( status )
    `)
    .eq("event_id", eventId)
    .order("queue_number");

  if(error){ console.error(error); return; }

  const tbody = document.getElementById("animalTable");
  tbody.innerHTML = "";

  data.forEach(a => {

    const statusKey = a.vasd_queue?.status || "waiting";
    const s = statusMap[statusKey] || statusMap.waiting;

    const tr = document.createElement("tr");
    tr.dataset.id = a.id;
    tr.className = s.cls;

    tr.innerHTML = `
      <td>${a.queue_number}</td>
      <td><input class="f" value="${a.animal_name}" readonly></td>

      <td>
        <select class="f" disabled>
          <option value="‡∏°" ${a.species==="‡∏°"?"selected":""}>‡πÅ‡∏°‡∏ß</option>
          <option value="‡∏™" ${a.species==="‡∏™"?"selected":""}>‡∏™‡∏∏‡∏ô‡∏±‡∏Ç</option>
        </select>
      </td>

      <td>
        <select class="f" disabled>
          <option value="‡πÄ‡∏°‡∏µ‡∏¢" ${a.sex==="‡πÄ‡∏°‡∏µ‡∏¢"?"selected":""}>‡πÄ‡∏°‡∏µ‡∏¢</option>
          <option value="‡∏ú‡∏π‡πâ" ${a.sex==="‡∏ú‡∏π‡πâ"?"selected":""}>‡∏ú‡∏π‡πâ</option>
        </select>
      </td>

      <td><input class="f" type="number" value="${a.est_weight ?? ""}" readonly></td>

      <td>
        <select class="status" disabled>
          ${Object.entries(statusMap).map(([k,v]) =>
            `<option value="${k}" ${k===statusKey?"selected":""}>${v.text}</option>`
          ).join("")}
        </select>
      </td>

      <td>${a.vasd_owner?.owner_name ?? ""}</td>
      <td>${a.vasd_owner?.phone ?? ""}</td>

      <td>
        <button class="btn-print" onclick="printQueue('${a.id}')">üñ® ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏¥‡∏ß</button>
        <button class="btn-edit" onclick="enableEdit(this)">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        <button class="btn-save" onclick="saveRow(this)" disabled>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button class="btn-cancel" onclick="cancelRow('${a.id}')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="btn-del" onclick="deleteRow('${a.id}')">‡∏•‡∏ö</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

loadAnimals();

/* ================= PRINT (FIXED 1 PAGE ONLY) ================= */
window.printQueue = async function(animalId){

  const { data } = await supabase
    .from("vasd_animal")
    .select(`
      queue_number,
      animal_name,
      species,
      sex,
      vasd_owner ( owner_name ),
      vasd_service ( service_type )
    `)
    .eq("id", animalId)
    .single();

  if(!data) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");

  const speciesText = data.species === "‡∏™" ? "‡∏™‡∏∏‡∏ô‡∏±‡∏Ç" : "‡πÅ‡∏°‡∏ß";
  const sexText = data.sex === "‡πÄ‡∏°‡∏µ‡∏¢" ? "‡πÄ‡∏û‡∏®‡πÄ‡∏°‡∏µ‡∏¢" : "‡πÄ‡∏û‡∏®‡∏ú‡∏π‡πâ";
  const services = data.vasd_service?.map(s=>s.service_type).join(", ") || "-";

  const win = window.open("", "", "width=400,height=500");

  win.document.write(`
  <html>
  <head>
  <style>
    @page { size:80mm 50mm; margin:0; }

    html,body{
      width:80mm;
      height:50mm;
      margin:0;
      padding:0;
      overflow:hidden;
      font-family:monospace;
      line-height:1.2;
    }

    .wrap{
      padding:5mm;
      box-sizing:border-box;
      height:50mm;
    }

    .big{ font-size:18px; font-weight:bold; }
    .small{ font-size:12px; }

    *{
      page-break-after:avoid !important;
      page-break-before:avoid !important;
      page-break-inside:avoid !important;
    }
  </style>
  </head>

  <body>
    <div class="wrap">
      <div class="big">‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà ${data.queue_number}</div>
      <div>${speciesText}${sexText}</div>

      <div style="margin-top:4px;">
        ${data.animal_name}
      </div>

      <div style="margin-top:4px;">
        ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: ${data.vasd_owner?.owner_name || "-"}
      </div>

      <div class="small" style="margin-top:4px;">
        ‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£: ${services}
      </div>
    </div>

    <script>
      window.onload=function(){
        window.print();
        setTimeout(()=>window.close(),300);
      }
    <\/script>

  </body>
  </html>
  `);

  win.document.close();
};

/* ================= EDIT / DELETE ================= */
window.enableEdit=function(btn){
  const pass = prompt("‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ admin");
  if(pass!==ADMIN_PASSWORD) return;

  const tr = btn.closest("tr");
  tr.querySelectorAll(".f,.status").forEach(el=>{
    el.readOnly=false;
    el.disabled=false;
  });
  tr.querySelector(".btn-save").disabled=false;
};

window.saveRow=async function(btn){
  const tr=btn.closest("tr");
  const id=tr.dataset.id;

  const f=tr.querySelectorAll(".f");
  const status=tr.querySelector(".status").value;

  await supabase.from("vasd_animal").update({
    animal_name:f[0].value,
    species:f[1].value,
    sex:f[2].value,
    est_weight:f[3].value
  }).eq("id",id);

  await supabase.from("vasd_queue")
    .update({ status, updated_at:new Date() })
    .eq("animal_id",id);

  loadAnimals();
};

window.cancelRow=async function(id){
  await supabase.from("vasd_queue")
    .update({ status:"cancel", updated_at:new Date() })
    .eq("animal_id",id);
  loadAnimals();
};

window.deleteRow=async function(id){
  const pwd=prompt("‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ admin ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö");
  if(!pwd) return;

  const { error } = await supabase.rpc("admin_delete_animal",{
    p_animal_id:id,
    p_admin_password:pwd
  });

  if(error) alert("‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  else loadAnimals();
};

window.deleteAll=async function(){
  if(!confirm("‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
  const pwd=prompt("‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ admin");
  if(!pwd) return;

  const { error } = await supabase.rpc("admin_delete_all_today",{
    p_admin_password:pwd
  });

  if(error) alert("‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  else{
    alert("‚úÖ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß");
    loadAnimals();
  }
};

/* ================= REALTIME ================= */
supabase.channel("vasd-live")
  .on("postgres_changes",{event:"*",schema:"public",table:"vasd_queue"},loadAnimals)
  .on("postgres_changes",{event:"*",schema:"public",table:"vasd_animal"},loadAnimals)
  .subscribe();

</script>

</body>
</html>
