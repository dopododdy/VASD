<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>RMUTTO - VASD | ‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&family=Prompt:wght@300;400;500;700&family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>
:root {
  --navy:#0d1b2a; --teal:#1a6b72; --teal-light:#22919a; --accent:#00d4aa;
  --bg:#f0f4f8; --surface:#fff; --text:#1a202c; --text-muted:#718096;
  --border:#e2e8f0; --danger:#e53e3e; --success:#38a169; --warning:#d69e2e;
  --shadow-sm:0 1px 3px rgba(0,0,0,0.06); --shadow-md:0 4px 16px rgba(13,27,42,0.08);
  --radius:14px; --radius-sm:8px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{font-family:"Sarabun",sans-serif;background:var(--bg);color:var(--text);}

/* HEADER */
header{
  background:var(--navy);padding:0 32px;display:flex;
  justify-content:space-between;align-items:center;height:68px;
  position:sticky;top:0;z-index:100;box-shadow:0 2px 20px rgba(0,0,0,0.25);
}
.header-brand{display:flex;align-items:center;gap:14px;}
.brand-icon{
  width:40px;height:40px;background:linear-gradient(135deg,var(--teal-light),var(--accent));
  border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;
}
.brand-text h1{font-size:17px;font-weight:700;color:#fff;line-height:1.2;}
.brand-text span{font-size:11px;color:rgba(255,255,255,0.5);}

.btn-home{
  padding:8px 18px;font-size:13px;font-weight:600;font-family:"Sarabun",sans-serif;
  background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.9);
  border:1px solid rgba(255,255,255,0.2);border-radius:var(--radius-sm);
  cursor:pointer;transition:background 0.2s;
}
.btn-home:hover{background:rgba(255,255,255,0.18);}

/* MAIN */
.container{max-width:1400px;margin:0 auto;padding:28px 24px;}

.page-header{
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:24px;animation:fadeUp 0.4s ease both;
}
.page-header h2{font-size:22px;font-weight:700;color:var(--navy);}

/* TABLE WRAPPER */
.table-wrap{
  background:var(--surface);border-radius:var(--radius);
  border:1px solid var(--border);box-shadow:var(--shadow-sm);
  overflow:hidden;animation:fadeUp 0.4s 0.05s ease both;
}
.table-responsive{overflow-x:auto;-webkit-overflow-scrolling:touch;}

table{width:100%;border-collapse:collapse;min-width:860px;}

thead tr{background:linear-gradient(135deg,var(--navy),#1a2f47);}
thead th{
  padding:13px 12px;text-align:center;font-size:12px;font-weight:700;
  letter-spacing:0.5px;text-transform:uppercase;color:rgba(255,255,255,0.8);
  border:none;white-space:nowrap;
}

tbody tr{border-bottom:1px solid var(--border);transition:background 0.15s;}
tbody td{padding:10px 12px;text-align:center;font-size:13px;border:none;vertical-align:middle;}
tbody tr:last-child{border-bottom:none;}

/* STATUS ROW COLORS */
.status-wait       {background:#ffffff;}
.status-anesthesia {background:#ebf8ff;}
.status-surgery    {background:#fff5f5;}
.status-recovery   {background:#faf5ff;}
.status-ready      {background:#fffff0;}
.status-done       {background:#f0fff4;}
.status-cancel     {background:#f7fafc;opacity:0.65;}

/* INLINE INPUTS */
tbody input, tbody select{
  padding:6px 8px;font-size:13px;font-family:"Sarabun",sans-serif;
  border:1px solid var(--border);border-radius:6px;
  width:100%;background:#fff;outline:none;
  transition:border-color 0.2s;
}
tbody input:focus, tbody select:focus{border-color:var(--teal-light);}
tbody input[readonly], tbody select:disabled{
  border-color:transparent;background:transparent;cursor:default;
}

/* BUTTONS */
.btn{
  padding:5px 10px;font-size:12px;font-weight:600;font-family:"Sarabun",sans-serif;
  border:none;border-radius:6px;cursor:pointer;
  transition:opacity 0.2s,transform 0.15s;display:inline-flex;align-items:center;gap:4px;
  margin:2px;white-space:nowrap;
}
.btn:hover{opacity:0.85;transform:translateY(-1px);}
.btn:disabled{opacity:0.4;cursor:not-allowed;transform:none;}
.btn-print {background:var(--navy);color:#fff;}
.btn-edit  {background:var(--teal-light);color:#fff;}
.btn-save  {background:var(--success);color:#fff;}
.btn-cancel{background:var(--warning);color:#fff;}
.btn-del   {background:var(--danger);color:#fff;}

/* STATUS BADGE */
.status-badge{
  display:inline-block;padding:3px 10px;border-radius:20px;
  font-size:11px;font-weight:600;
}
.badge-wait      {background:#edf2f7;color:#4a5568;}
.badge-anesthesia{background:#bee3f8;color:#2b6cb0;}
.badge-surgery   {background:#fed7d7;color:#c53030;}
.badge-recovery  {background:#e9d8fd;color:#6b46c1;}
.badge-ready     {background:#fefcbf;color:#744210;}
.badge-done      {background:#c6f6d5;color:#276749;}
.badge-cancel    {background:#edf2f7;color:#718096;}

/* FOOTER ACTIONS */
.footer-actions{
  padding:16px 20px;border-top:1px solid var(--border);
  display:flex;justify-content:flex-end;background:#fafbfc;
}

@keyframes fadeUp{from{opacity:0;transform:translateY(14px);}to{opacity:1;transform:translateY(0);}}
</style>
</head>
<body>

<header>
  <div class="header-brand">
    <div class="brand-icon">üêæ</div>
    <div class="brand-text">
      <h1>‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h1>
      <span>RMUTTO ‚Äì Veterinary Academic Service Division</span>
    </div>
  </div>
  <button class="btn-home" onclick="location.href='index.html'">üè† ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
</header>

<div class="container">

  <div class="page-header">
    <h2>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h2>
  </div>

  <div class="table-wrap">
    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th>‡∏Ñ‡∏¥‡∏ß</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå</th>
            <th>‡∏ä‡∏ô‡∏¥‡∏î</th>
            <th>‡πÄ‡∏û‡∏®</th>
            <th>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)</th>
            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th>‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</th>
            <th>‡πÇ‡∏ó‡∏£</th>
            <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
          </tr>
        </thead>
        <tbody id="animalTable"></tbody>
      </table>
    </div>
    <div class="footer-actions">
      <button class="btn btn-del" onclick="deleteAll()">üóë ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
    </div>
  </div>

</div>

<script type="module">
import { supabase } from "./js/supabase.js";

const ADMIN_PASSWORD = "2500";

const statusMap = {
  waiting:          { text:"‡∏£‡∏≠‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î",         cls:"status-wait",       badge:"badge-wait" },
  anesthesia:       { text:"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏≤‡∏á‡∏¢‡∏≤‡∏™‡∏•‡∏ö",    cls:"status-anesthesia", badge:"badge-anesthesia" },
  surgery:          { text:"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î",      cls:"status-surgery",    badge:"badge-surgery" },
  recovery:         { text:"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏Å‡∏ü‡∏∑‡πâ‡∏ô",     cls:"status-recovery",   badge:"badge-recovery" },
  ready_to_go_home: { text:"‡∏ü‡∏∑‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß/‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö",cls:"status-ready",    badge:"badge-ready" },
  done:             { text:"‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß",       cls:"status-done",       badge:"badge-done" },
  cancel:           { text:"‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å",            cls:"status-cancel",     badge:"badge-cancel" }
};

async function loadAnimals() {
  const { data:eventId } = await supabase.rpc("get_today_event");
  const { data, error } = await supabase
    .from("vasd_animal")
    .select(`id,queue_number,animal_name,species,sex,est_weight,vasd_owner(owner_name,phone),vasd_queue(status)`)
    .eq("event_id", eventId)
    .order("queue_number");

  if (error) { console.error(error); return; }

  const tbody = document.getElementById("animalTable");
  tbody.innerHTML = "";

  data.forEach(a => {
    const statusKey = a.vasd_queue?.status || "waiting";
    const s = statusMap[statusKey] || statusMap.waiting;

    const tr = document.createElement("tr");
    tr.dataset.id = a.id;
    tr.className = s.cls;

    tr.innerHTML = `
      <td><strong>#${a.queue_number}</strong></td>
      <td><input class="f" value="${a.animal_name}" readonly></td>
      <td>
        <select class="f" disabled>
          <option value="‡∏°" ${a.species==="‡∏°"?"selected":""}>‡πÅ‡∏°‡∏ß</option>
          <option value="‡∏™" ${a.species==="‡∏™"?"selected":""}>‡∏™‡∏∏‡∏ô‡∏±‡∏Ç</option>
        </select>
      </td>
      <td>
        <select class="f" disabled>
          <option value="‡πÄ‡∏°‡∏µ‡∏¢" ${a.sex==="‡πÄ‡∏°‡∏µ‡∏¢"?"selected":""}>‡πÄ‡∏°‡∏µ‡∏¢</option>
          <option value="‡∏ú‡∏π‡πâ"  ${a.sex==="‡∏ú‡∏π‡πâ" ?"selected":""}>‡∏ú‡∏π‡πâ</option>
        </select>
      </td>
      <td><input class="f" type="number" value="${a.est_weight??""}" readonly style="max-width:80px;margin:auto;"></td>
      <td>
        <select class="status" disabled>
          ${Object.entries(statusMap).map(([k,v])=>
            `<option value="${k}" ${k===statusKey?"selected":""}>${v.text}</option>`
          ).join("")}
        </select>
      </td>
      <td>${a.vasd_owner?.owner_name??""}</td>
      <td>${a.vasd_owner?.phone??""}</td>
      <td>
        <button class="btn btn-print" onclick="printQueue('${a.id}')">üñ®</button>
        <button class="btn btn-edit"  onclick="enableEdit(this)">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        <button class="btn btn-save"  onclick="saveRow(this)" disabled>üíæ</button>
        <button class="btn btn-cancel" onclick="cancelRow('${a.id}')">üö´</button>
        <button class="btn btn-del"   onclick="deleteRow('${a.id}')">üóë</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

loadAnimals();

window.printQueue = async function(animalId) {
  const { data:a } = await supabase
    .from("vasd_animal")
    .select(`queue_number,animal_name,species,sex,vasd_owner(owner_name,phone),vasd_service(service_type)`)
    .eq("id", animalId).single();
  if (!a) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");

  const spcText  = a.species==="‡∏™"?"‡∏™‡∏∏‡∏ô‡∏±‡∏Ç":"‡πÅ‡∏°‡∏ß";
  const services = a.vasd_service?.map(s=>s.service_type).join(", ") || "-";
  const phone    = a.vasd_owner?.phone || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
  const ownerName= a.vasd_owner?.owner_name || "";

  const { data:tmplData } = await supabase.from("vasd_print_template").select("config").eq("template_type","queue").single();
  if (!tmplData?.config) return alert("‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Template ‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏Ñ‡∏¥‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Å‡πà‡∏≠‡∏ô");

  let printContents = "";
  tmplData.config.forEach(l => {
    let text = l.text
      .replace("{{queue_number}}",a.queue_number)
      .replace("{{animal_name}}",a.animal_name)
      .replace("{{species}}",spcText)
      .replace("{{sex}}",a.sex)
      .replace("{{owner_name}}",ownerName)
      .replace("{{phone}}",phone)
      .replace("{{services}}",services);
    printContents += `<div class="line" style="left:${l.x||0}px;right:0;top:${l.y||0}px;font-size:${l.size}px;font-weight:${l.weight};font-family:${l.font};text-align:${l.align||"left"};">${text}</div>`;
  });

  const pw = window.open("","_blank","width=800,height=600");
  pw.document.write(`<html><head><title>Print</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&family=Prompt:wght@400;700&family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>body{margin:0}.sticker{position:relative;width:80mm;height:50mm;background:#fff;overflow:hidden}.line{position:absolute;white-space:pre-wrap;word-break:break-word;padding-right:5px;box-sizing:border-box;color:#000!important}@page{size:80mm 50mm;margin:0}</style>
    </head><body><div class="sticker">${printContents}</div>
    <script>window.onload=function(){document.fonts.ready.then(()=>{setTimeout(()=>{window.print();window.close();},200);});}<\/script></body></html>`);
  pw.document.close();
};

window.enableEdit = function(btn) {
  const pass = prompt("‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ admin");
  if (pass !== ADMIN_PASSWORD) return;
  const tr = btn.closest("tr");
  tr.querySelectorAll(".f,.status").forEach(el=>{ el.readOnly=false; el.disabled=false; });
  tr.querySelector(".btn-save").disabled = false;
};

window.saveRow = async function(btn) {
  const tr = btn.closest("tr"), id = tr.dataset.id;
  const f  = tr.querySelectorAll(".f");
  const status = tr.querySelector(".status").value;
await supabase.from("vasd_animal").update({ 
  animal_name: f[0].value, 
  species: f[1].value, 
  sex: f[2].value, 
  est_weight: f[3].value, 
  actual_weight: f[3].value // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏à‡∏£‡∏¥‡∏á
}).eq("id",id);
  await supabase.from("vasd_queue").update({ status, updated_at:new Date() }).eq("animal_id",id);
  loadAnimals();
};

window.cancelRow = async function(id) {
  await supabase.from("vasd_queue").update({ status:"cancel", updated_at:new Date() }).eq("animal_id",id);
  loadAnimals();
};

window.deleteRow = async function(id) {
  const pwd = prompt("‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ admin ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö");
  if (!pwd) return;
  const { error } = await supabase.rpc("admin_delete_animal",{ p_animal_id:id, p_admin_password:pwd });
  if (error) alert("‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); else loadAnimals();
};

window.deleteAll = async function() {
  if (!confirm("‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
  const pwd = prompt("‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ admin");
  if (!pwd) return;
  const { error } = await supabase.rpc("admin_delete_all_today",{ p_admin_password:pwd });
  if (error) alert("‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  else { alert("‚úÖ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß"); loadAnimals(); }
};

supabase.channel("vasd-live")
  .on("postgres_changes",{event:"*",schema:"public",table:"vasd_queue"},loadAnimals)
  .on("postgres_changes",{event:"*",schema:"public",table:"vasd_animal"},loadAnimals)
  .subscribe();
</script>
</body>
</html>
