<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>à¸ªà¸±à¸•à¸§à¹Œà¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” â€“ VASD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOKENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --navy:         #0b1929;
  --navy-mid:     #112240;
  --teal:         #0ea5a0;
  --teal-light:   #14c4bc;
  --teal-glow:    rgba(14,165,160,0.25);
  --rose:         #ef4444;
  --rose-soft:    rgba(239,68,68,0.12);

  --surface:      rgba(255,255,255,0.04);
  --surface-2:    rgba(255,255,255,0.07);
  --surface-3:    rgba(255,255,255,0.11);
  --border:       rgba(255,255,255,0.08);
  --border-2:     rgba(255,255,255,0.14);
  --text:         #e2e8f0;
  --text-dim:     #94a3b8;
  --text-faint:   #4a5568;

  --radius-sm:    10px;
  --radius:       16px;
  --radius-lg:    22px;

  /* status palette */
  --s-wait:       #64748b;
  --s-anes:       #3b82f6;
  --s-surg:       #ef4444;
  --s-rec:        #8b5cf6;
  --s-ready:      #f59e0b;
  --s-done:       #10b981;
  --s-cancel:     #475569;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }

body {
  font-family: "Sarabun", sans-serif;
  background: var(--navy);
  color: var(--text);
  min-height: 100vh; min-height: 100dvh;
  display: flex; flex-direction: column;
  overflow-x: hidden;
}
body::before {
  content: ""; position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background:
    radial-gradient(ellipse 60% 50% at 15% 10%, rgba(14,165,160,0.10) 0%, transparent 70%),
    radial-gradient(ellipse 40% 50% at 85% 80%, rgba(99,102,241,0.07) 0%, transparent 60%);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
header {
  position: sticky; top: 0; z-index: 200;
  background: rgba(11,25,41,0.88);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-bottom: 1px solid var(--border);
  padding: 0 20px; height: 64px;
  display: flex; align-items: center; justify-content: space-between; gap: 12px;
}
.brand { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
.brand-logo {
  width: 38px; height: 38px;
  background: linear-gradient(135deg, var(--teal), var(--teal-light));
  border-radius: 10px; display: flex; align-items: center; justify-content: center;
  font-size: 18px; box-shadow: 0 0 20px var(--teal-glow);
}
.brand-name {
  font-family: "Outfit", sans-serif;
  font-size: 15px; font-weight: 700; color: #fff; line-height: 1; letter-spacing: -0.3px;
}
.brand-sub { font-size: 10px; color: var(--text-dim); margin-top: 2px; }
.btn-home {
  padding: 8px 14px; font-size: 12px; font-weight: 600; font-family: "Sarabun", sans-serif;
  background: var(--surface-2); color: var(--text-dim);
  border: 1px solid var(--border-2); border-radius: var(--radius-sm); cursor: pointer;
  display: flex; align-items: center; gap: 5px;
  transition: background 0.2s, color 0.2s;
  -webkit-tap-highlight-color: transparent;
}
.btn-home:hover { background: var(--surface-3); color: var(--text); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WRAP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.wrap {
  position: relative; z-index: 1;
  max-width: 1000px; margin: 0 auto;
  padding: 24px 16px 100px;
  width: 100%;
}

/* â”€â”€ Section Title & Controls â”€â”€ */
.section-header {
  display: flex; align-items: center; gap: 10px;
  margin-bottom: 12px; flex-wrap: wrap;
}
.section-title {
  font-size: 10px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase;
  color: var(--text-faint); 
  display: flex; align-items: center; gap: 8px; flex: 1;
  animation: slideUp 0.4s ease both;
}
.section-title::after { content: ""; flex: 1; height: 1px; background: var(--border); }
.section-count {
  font-size: 10px; font-weight: 600; color: var(--text-dim);
  background: var(--surface-2); border: 1px solid var(--border-2);
  border-radius: 20px; padding: 2px 10px;
}

/* â”€â”€ Search & Sort Controls â”€â”€ */
.controls-row {
  display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap;
  animation: slideUp 0.4s ease both;
}
.search-input {
  flex: 1; min-width: 200px;
  padding: 8px 14px;
  border-radius: var(--radius-sm);
  background: var(--surface-2); border: 1px solid var(--border-2);
  color: var(--text); font-family: "Sarabun", sans-serif; font-size: 13px;
  outline: none; transition: border-color 0.2s, box-shadow 0.2s;
}
.search-input:focus {
  border-color: var(--teal);
  box-shadow: 0 0 0 3px var(--teal-glow);
}
.sort-select {
  background: var(--surface-2); border: 1px solid var(--border-2);
  color: var(--text); padding: 8px 12px;
  border-radius: var(--radius-sm); font-size: 13px; font-family: "Sarabun", sans-serif;
  outline: none; cursor: pointer; transition: border-color 0.2s;
}
.sort-select option { background: var(--navy-mid); }
.sort-select:focus { border-color: var(--teal); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ANIMAL CARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#animalList { display: flex; flex-direction: column; gap: 10px; }

.animal-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  animation: slideUp 0.35s ease both;
  transition: border-color 0.2s;
}

/* status left bar */
.animal-card::before { content: ""; display: block; height: 3px; width: 100%; }
.ac-wait::before   { background: var(--s-wait); }
.ac-anes::before   { background: var(--s-anes); }
.ac-surg::before   { background: var(--s-surg); }
.ac-rec::before    { background: var(--s-rec); }
.ac-ready::before  { background: var(--s-ready); }
.ac-done::before   { background: var(--s-done); }
.ac-cancel::before { background: var(--s-cancel); }
.ac-cancel { opacity: 0.6; }

/* â”€â”€ Card Top Row â”€â”€ */
.card-top {
  display: flex; align-items: center; gap: 10px;
  padding: 12px 14px 10px;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}
.queue-badge {
  font-family: "Outfit", sans-serif;
  font-size: 13px; font-weight: 800;
  min-width: 36px; height: 36px; border-radius: 50%;
  background: var(--surface-2); border: 1px solid var(--border-2);
  display: flex; align-items: center; justify-content: center;
  color: #fff; flex-shrink: 0;
}
.card-info { flex: 1; min-width: 0; }
.animal-name {
  font-size: 14px; font-weight: 700; color: #fff;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  display: flex; align-items: center;
}
.animal-meta { font-size: 11px; color: var(--text-dim); margin-top: 2px; }

.status-pill {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 4px 10px; border-radius: 20px;
  font-size: 11px; font-weight: 600; flex-shrink: 0;
}
.sp-wait   { background: rgba(100,116,139,0.2); color: #94a3b8; border: 1px solid rgba(100,116,139,0.3); }
.sp-anes   { background: rgba(59,130,246,0.2);  color: #93c5fd; border: 1px solid rgba(59,130,246,0.3); }
.sp-surg   { background: rgba(239,68,68,0.2);   color: #fca5a5; border: 1px solid rgba(239,68,68,0.3); }
.sp-rec    { background: rgba(139,92,246,0.2);  color: #c4b5fd; border: 1px solid rgba(139,92,246,0.3); }
.sp-ready  { background: rgba(245,158,11,0.2);  color: #fcd34d; border: 1px solid rgba(245,158,11,0.3); }
.sp-done   { background: rgba(16,185,129,0.2);  color: #6ee7b7; border: 1px solid rgba(16,185,129,0.3); }
.sp-cancel { background: rgba(71,85,105,0.2);   color: #64748b; border: 1px solid rgba(71,85,105,0.3); }

.expand-icon {
  font-size: 16px; color: var(--text-dim);
  transition: transform 0.25s; flex-shrink: 0;
}
.animal-card.open .expand-icon { transform: rotate(180deg); }

/* â”€â”€ Expandable Detail â”€â”€ */
.card-detail {
  max-height: 0; overflow: hidden;
  transition: max-height 0.35s cubic-bezier(0.4,0,0.2,1);
  border-top: 0px solid var(--border);
}
.animal-card.open .card-detail {
  max-height: 800px;
  border-top: 1px solid var(--border);
}

.detail-body { padding: 14px; }

/* Added parts: Services & Health Notes */
.svc-chip {
  background: var(--surface-3); border: 1px solid var(--border-2);
  border-radius: 50px; padding: 4px 12px; font-size: 11px; font-weight: 500; color: var(--text);
}
.health-note {
  display: flex; align-items: flex-start; gap: 10px;
  background: var(--rose-soft); border: 1px solid rgba(239,68,68,0.2);
  border-radius: var(--radius-sm); padding: 12px 14px;
  margin-bottom: 14px; color: var(--rose);
}

/* edit fields grid */
.edit-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr 80px;
  gap: 10px; margin-bottom: 12px;
}
@media (max-width: 480px) {
  .edit-grid { grid-template-columns: 1fr 1fr; }
}

.field-group { display: flex; flex-direction: column; gap: 4px; }
.field-label { font-size: 10px; font-weight: 700; letter-spacing: 0.8px; text-transform: uppercase; color: var(--text-faint); }

.edit-input, .edit-select {
  width: 100%; padding: 8px 10px;
  font-size: 13px; font-family: "Sarabun", sans-serif;
  background: var(--surface-2); border: 1px solid var(--border-2);
  border-radius: var(--radius-sm); color: var(--text); outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
  -webkit-appearance: none;
}
.edit-input[readonly], .edit-select[disabled] {
  border-color: transparent; background: transparent; cursor: default;
  color: var(--text);
}
.edit-input:focus, .edit-select:focus {
  border-color: var(--teal); box-shadow: 0 0 0 3px var(--teal-glow);
}
.edit-select option { background: var(--navy-mid); }

/* owner row */
.owner-row {
  display: flex; gap: 10px; margin-bottom: 14px; flex-wrap: wrap;
}
.owner-chip {
  display: flex; align-items: center; gap: 6px;
  background: var(--surface-2); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 7px 12px;
  font-size: 12px; color: var(--text-dim);
}
.owner-chip span { color: var(--text); font-weight: 600; }

/* status change row */
.status-row { margin-bottom: 14px; }
.status-row .field-label { margin-bottom: 6px; display: block; }
.status-select-full {
  width: 100%; padding: 9px 12px;
  font-size: 13px; font-family: "Sarabun", sans-serif;
  background: var(--surface-2); border: 1px solid var(--border-2);
  border-radius: var(--radius-sm); color: var(--text); outline: none; cursor: pointer;
  -webkit-appearance: none;
  transition: border-color 0.2s;
}
.status-select-full[disabled] { border-color: transparent; background: transparent; cursor: default; }
.status-select-full:focus { border-color: var(--teal); }
.status-select-full option { background: var(--navy-mid); }

/* action buttons */
.action-row {
  display: flex; gap: 7px; flex-wrap: wrap;
  padding-top: 10px; border-top: 1px solid var(--border);
}
.btn {
  padding: 8px 14px; font-size: 12px; font-weight: 600; font-family: "Sarabun", sans-serif;
  border: none; border-radius: var(--radius-sm); cursor: pointer;
  display: inline-flex; align-items: center; gap: 5px;
  transition: opacity 0.2s, transform 0.15s;
  -webkit-tap-highlight-color: transparent;
  white-space: nowrap;
}
.btn:active { transform: scale(0.95); }
.btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; }

.btn-print  { background: var(--surface-3); color: var(--text); border: 1px solid var(--border-2); }
.btn-print:hover { border-color: var(--teal); color: var(--teal-light); }
.btn-edit   { background: rgba(14,165,160,0.15); color: var(--teal-light); border: 1px solid rgba(14,165,160,0.3); }
.btn-edit:hover { background: rgba(14,165,160,0.25); }
.btn-save   { background: rgba(16,185,129,0.15); color: #6ee7b7; border: 1px solid rgba(16,185,129,0.3); }
.btn-save:hover { background: rgba(16,185,129,0.25); }
.btn-cancel-status { background: rgba(245,158,11,0.15); color: #fcd34d; border: 1px solid rgba(245,158,11,0.3); }
.btn-cancel-status:hover { background: rgba(245,158,11,0.25); }
.btn-del    { background: rgba(239,68,68,0.15); color: #fca5a5; border: 1px solid rgba(239,68,68,0.3); }
.btn-del:hover { background: rgba(239,68,68,0.25); }

/* â”€â”€ Empty & Loading â”€â”€ */
.empty-state {
  text-align: center; padding: 60px 16px; color: var(--text-faint);
  animation: slideUp 0.4s ease both;
}
.empty-state-icon { font-size: 48px; margin-bottom: 14px; }
.empty-state-text { font-size: 14px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOBILE BOTTOM NAV (â‰¤ 640px)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bottom-nav {
  display: none;
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 300;
  background: rgba(11,25,41,0.95);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-top: 1px solid var(--border-2);
  padding: 8px 0 max(8px, env(safe-area-inset-bottom));
  grid-template-columns: repeat(5, 1fr);
}
.nav-item {
  display: flex; flex-direction: column; align-items: center; gap: 3px;
  padding: 6px 4px;
  font-size: 9px; color: var(--text-dim);
  text-decoration: none; cursor: pointer;
  transition: color 0.2s;
  -webkit-tap-highlight-color: transparent;
}
.nav-item:active { color: var(--teal); }
.nav-icon { font-size: 21px; line-height: 1; }
.nav-item.active { color: var(--teal); }
.nav-item.active .nav-icon { filter: drop-shadow(0 0 6px var(--teal)); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ANIMATIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@keyframes slideUp {
  from { opacity: 0; transform: translateY(16px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 640px) {
  header { height: 56px; padding: 0 14px; }
  .brand-sub { display: none; }
  .wrap { padding: 18px 12px 90px; }
  
  .bottom-nav { display: grid; }
}
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="brand-logo">ğŸ¾</div>
    <div>
      <div class="brand-name">à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¸ªà¸±à¸•à¸§à¹Œà¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸—à¸µà¹ˆà¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™</div>
      <div class="brand-sub">RMUTTO â€“ Veterinary Academic Service Division</div>
    </div>
  </div>
  <button class="btn-home" onclick="location.href='index.html'">ğŸ  à¸«à¸™à¹‰à¸²à¸«à¸¥à¸±à¸</button>
</header>

<div class="wrap">

  <div class="section-header">
    <div class="section-title">
      à¹à¸•à¸°à¸—à¸µà¹ˆà¸£à¸²à¸¢à¸à¸²à¸£à¹€à¸à¸·à¹ˆà¸­à¸”à¸¹à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¹à¸¥à¸°à¹à¸à¹‰à¹„à¸‚
      <span class="section-count" id="countBadge">0 à¸£à¸²à¸¢à¸à¸²à¸£</span>
    </div>
  </div>

  <div class="controls-row">
    <input type="text" id="searchInput" class="search-input" placeholder="ğŸ” à¸„à¹‰à¸™à¸«à¸²à¸”à¹‰à¸§à¸¢à¸Šà¸·à¹ˆà¸­à¸ªà¸±à¸•à¸§à¹Œ, à¹€à¸¥à¸‚à¸„à¸´à¸§, à¸«à¸£à¸·à¸­à¸Šà¸·à¹ˆà¸­à¹€à¸ˆà¹‰à¸²à¸‚à¸­à¸‡...">
    
    <select id="sortSelect" class="sort-select">
      <option value="queue">à¹€à¸£à¸µà¸¢à¸‡à¸•à¸²à¸¡: à¸¥à¸³à¸”à¸±à¸šà¸„à¸´à¸§</option>
      <option value="name">à¹€à¸£à¸µà¸¢à¸‡à¸•à¸²à¸¡: à¸Šà¸·à¹ˆà¸­à¸ªà¸±à¸•à¸§à¹Œ (à¸-à¸®)</option>
      <option value="status">à¹€à¸£à¸µà¸¢à¸‡à¸•à¸²à¸¡: à¸ªà¸–à¸²à¸™à¸°à¸à¸²à¸£à¸£à¸±à¸à¸©à¸²</option>
    </select>
  </div>

  <div id="animalList">
    <div class="empty-state" id="emptyState">
      <div class="empty-state-icon">ğŸ¾</div>
      <div class="empty-state-text">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥...</div>
    </div>
  </div>

</div>

<nav class="bottom-nav">
  <a class="nav-item" href="index.html">
    <span class="nav-icon">ğŸ </span>à¸«à¸™à¹‰à¸²à¸«à¸¥à¸±à¸
  </a>
  <a class="nav-item active" href="animals.html">
    <span class="nav-icon">ğŸ¾</span>à¸ªà¸±à¸•à¸§à¹Œ
  </a>
  <a class="nav-item" href="anesthesia.html">
    <span class="nav-icon">ğŸ’‰</span>à¸§à¸²à¸‡à¸¢à¸²
  </a>
  <a class="nav-item" href="surgery.html">
    <span class="nav-icon">ğŸ›ï¸</span>à¸œà¹ˆà¸²à¸•à¸±à¸”
  </a>
  <a class="nav-item" href="recovery.html">
    <span class="nav-icon">â¤ï¸â€ğŸ©¹</span>à¸à¸±à¸à¸Ÿà¸·à¹‰à¸™
  </a>
</nav>

<script type="module">
import { supabase } from "./js/supabase.js";

const ADMIN_PASSWORD = "2500";

const statusMap = {
  waiting:          { text: "à¸£à¸­à¸œà¹ˆà¸²à¸•à¸±à¸”",          cls: "ac-wait",   pill: "sp-wait",   dot: "âšª" },
  anesthesia:       { text: "à¸à¸³à¸¥à¸±à¸‡à¸§à¸²à¸‡à¸¢à¸²à¸ªà¸¥à¸š",     cls: "ac-anes",   pill: "sp-anes",   dot: "ğŸ”µ" },
  surgery:          { text: "à¸à¸³à¸¥à¸±à¸‡à¸œà¹ˆà¸²à¸•à¸±à¸”",       cls: "ac-surg",   pill: "sp-surg",   dot: "ğŸ”´" },
  recovery:         { text: "à¸à¸³à¸¥à¸±à¸‡à¸à¸±à¸à¸Ÿà¸·à¹‰à¸™",      cls: "ac-rec",    pill: "sp-rec",    dot: "ğŸŸ£" },
  ready_to_go_home: { text: "à¸Ÿà¸·à¹‰à¸™à¹à¸¥à¹‰à¸§/à¸£à¸­à¸£à¸±à¸šà¸à¸¥à¸±à¸š", cls: "ac-ready",  pill: "sp-ready",  dot: "ğŸŸ¡" },
  done:             { text: "à¸£à¸±à¸šà¸à¸¥à¸±à¸šà¹à¸¥à¹‰à¸§",       cls: "ac-done",   pill: "sp-done",   dot: "ğŸŸ¢" },
  cancel:           { text: "à¸¢à¸à¹€à¸¥à¸´à¸",            cls: "ac-cancel", pill: "sp-cancel", dot: "â¬›" }
};

// à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¸ªà¸³à¸«à¸£à¸±à¸šà¹€à¸£à¸µà¸¢à¸‡à¸•à¸²à¸¡à¸ªà¸–à¸²à¸™à¸°à¸•à¸²à¸¡ Workflow
const statusWeight = {
  waiting: 1,
  anesthesia: 2,
  surgery: 3,
  recovery: 4,
  ready_to_go_home: 5,
  done: 6,
  cancel: 7
};

let allData = [];

// à¸”à¸¶à¸‡ Elements
const searchInput = document.getElementById("searchInput");
const sortSelect = document.getElementById("sortSelect");

// à¸à¸³à¸«à¸™à¸”à¸„à¹ˆà¸²à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™
let currentSort = sortSelect.value || "queue"; 
let searchQuery = searchInput.value.toLowerCase().trim() || "";

// ğŸ› ï¸ à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸à¸¥à¸²à¸‡à¸ªà¸³à¸«à¸£à¸±à¸šà¸­à¸±à¸›à¹€à¸”à¸•à¹à¸¥à¸°à¹à¸ªà¸”à¸‡à¸œà¸¥
function updateFiltersAndRender() {
  searchQuery = searchInput.value.toLowerCase().trim();
  currentSort = sortSelect.value;
  applySortAndRender();
}

// ğŸ› ï¸ à¸œà¸¹à¸ Event à¸”à¸±à¸à¸ˆà¸±à¸šà¸à¸²à¸£à¸„à¹‰à¸™à¸«à¸² (à¸—à¸³à¸‡à¸²à¸™à¸—à¸±à¸™à¸—à¸µà¸—à¸µà¹ˆà¸à¸´à¸¡à¸à¹Œ/à¸¥à¸š/à¸§à¸²à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡)
searchInput.addEventListener("input", updateFiltersAndRender);
searchInput.addEventListener("keyup", updateFiltersAndRender); // à¸ªà¸³à¸£à¸­à¸‡à¹€à¸œà¸·à¹ˆà¸­à¸šà¸²à¸‡à¹€à¸šà¸£à¸²à¸§à¹Œà¹€à¸‹à¸­à¸£à¹Œ

// ğŸ› ï¸ à¸œà¸¹à¸ Event à¸”à¸±à¸à¸ˆà¸±à¸šà¸à¸²à¸£à¹€à¸£à¸µà¸¢à¸‡à¸¥à¸³à¸”à¸±à¸š
sortSelect.addEventListener("change", updateFiltersAndRender);

async function loadAnimals() {
  const { data, error } = await supabase
    .from("vasd_animal")
    .select(`id,queue_number,animal_name,species,sex,est_weight,health_note,vasd_owner(owner_name,phone),vasd_queue(status),vasd_service(service_type)`)
    .order("id", { ascending: false }) 
    .limit(200);

  if (error) { console.error(error); return; }

  // ---------------------------------------------------------
  // à¸à¸£à¸­à¸‡à¹„à¸¡à¹ˆà¹ƒà¸«à¹‰à¹€à¸¥à¸‚à¸„à¸´à¸§ (queue_number) à¸‹à¹‰à¸³à¸à¸±à¸™
  // ---------------------------------------------------------
  const uniqueQueues = new Map();
  (data || []).forEach(item => {
    if (!uniqueQueues.has(item.queue_number) || uniqueQueues.get(item.queue_number).id < item.id) {
      uniqueQueues.set(item.queue_number, item);
    }
  });

  // à¹€à¸à¹‡à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸¥à¸‡à¸•à¸±à¸§à¹à¸›à¸£à¸«à¸¥à¸±à¸
  allData = Array.from(uniqueQueues.values());
  
  // à¹€à¸£à¸µà¸¢à¸à¹ƒà¸Šà¹‰à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™ à¸à¸£à¸­à¸‡ -> à¹€à¸£à¸µà¸¢à¸‡ -> à¹à¸ªà¸”à¸‡à¸œà¸¥
  applySortAndRender();
}

// ğŸ› ï¸ à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸£à¸­à¸‡à¸„à¹‰à¸™à¸«à¸² à¹à¸¥à¸°à¹€à¸£à¸µà¸¢à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¹ˆà¸­à¸™à¹à¸ªà¸”à¸‡à¸œà¸¥
function applySortAndRender() {
  // 1. à¸„à¹‰à¸™à¸«à¸² (Filter) à¸à¹ˆà¸­à¸™
  let filteredData = allData.filter(a => {
    if (!searchQuery) return true; // à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸à¸´à¸¡à¸à¹Œà¸­à¸°à¹„à¸£ à¹ƒà¸«à¹‰à¸„à¸·à¸™à¸„à¹ˆà¸²à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
    
    const nameMatch = (a.animal_name || "").toLowerCase().includes(searchQuery);
    const queueMatch = String(a.queue_number).toLowerCase().includes(searchQuery);
    const ownerMatch = (a.vasd_owner?.owner_name || "").toLowerCase().includes(searchQuery);
    
    return nameMatch || queueMatch || ownerMatch;
  });

  // 2. à¸ˆà¸±à¸”à¹€à¸£à¸µà¸¢à¸‡ (Sort) à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸–à¸¹à¸à¸à¸£à¸­à¸‡à¹à¸¥à¹‰à¸§
  if (currentSort === "queue") {
    // à¹€à¸£à¸µà¸¢à¸‡à¸•à¸²à¸¡à¹€à¸¥à¸‚à¸„à¸´à¸§à¸ˆà¸²à¸à¸™à¹‰à¸­à¸¢à¹„à¸›à¸¡à¸²à¸
    filteredData.sort((a, b) => String(a.queue_number).localeCompare(String(b.queue_number), 'th', { numeric: true }));
  } 
  else if (currentSort === "name") {
    // à¹€à¸£à¸µà¸¢à¸‡à¸•à¸²à¸¡à¸Šà¸·à¹ˆà¸­ à¸-à¸®
    filteredData.sort((a, b) => String(a.animal_name).localeCompare(String(b.animal_name), 'th'));
  } 
  else if (currentSort === "status") {
    // à¹€à¸£à¸µà¸¢à¸‡à¸•à¸²à¸¡à¸ªà¸–à¸²à¸™à¸° (à¸£à¸­à¸œà¹ˆà¸²à¸•à¸±à¸” -> à¸§à¸²à¸‡à¸¢à¸² -> ...)
    filteredData.sort((a, b) => {
      const wA = statusWeight[a.vasd_queue?.status || "waiting"] || 99;
      const wB = statusWeight[b.vasd_queue?.status || "waiting"] || 99;
      if (wA === wB) {
        // à¸–à¹‰à¸²à¸ªà¸–à¸²à¸™à¸°à¹€à¸”à¸µà¸¢à¸§à¸à¸±à¸™ à¹ƒà¸«à¹‰à¹€à¸£à¸µà¸¢à¸‡à¸„à¸´à¸§à¸•à¹ˆà¸­
        return String(a.queue_number).localeCompare(String(b.queue_number), 'th', { numeric: true });
      }
      return wA - wB;
    });
  }

  // 3. à¸™à¸³à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸›à¸§à¸²à¸”à¸¥à¸‡à¸«à¸™à¹‰à¸²à¸ˆà¸­
  renderCards(filteredData);
}

function renderCards(data) {
  const list = document.getElementById("animalList");
  const empty = document.getElementById("emptyState");
  document.getElementById("countBadge").textContent = `${data.length} à¸£à¸²à¸¢à¸à¸²à¸£`;

  if (data.length === 0) {
    list.innerHTML = "";
    empty.style.display = "block";
    empty.querySelector(".empty-state-text").textContent = searchQuery ? "à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸„à¹‰à¸™à¸«à¸²" : "à¹„à¸¡à¹ˆà¸à¸šà¸£à¸²à¸¢à¸à¸²à¸£à¸ªà¸±à¸•à¸§à¹Œ";
    list.appendChild(empty);
    return;
  }
  if (empty.parentNode === list) list.removeChild(empty);

  /* keep open states */
  const openIds = new Set([...list.querySelectorAll(".animal-card.open")].map(el => el.dataset.id));

  list.innerHTML = "";
  data.forEach((a, idx) => {
    const statusKey = a.vasd_queue?.status || "waiting";
    const s = statusMap[statusKey] || statusMap.waiting;
    const speciesText = a.species === "à¸¡" ? "ğŸ± à¹à¸¡à¸§" : "ğŸ¶ à¸ªà¸¸à¸™à¸±à¸‚";

    // à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥ à¸‚à¹‰à¸­à¸„à¸§à¸£à¸£à¸°à¸§à¸±à¸‡ à¹à¸¥à¸° à¸šà¸£à¸´à¸à¸²à¸£
    const note = a.health_note ? a.health_note.trim() : "";
    const hasNote = note.length > 0;
    
    const services = a.vasd_service && a.vasd_service.length > 0
      ? a.vasd_service.map(srv => `<span class="svc-chip">${srv.service_type}</span>`).join("")
      : `<span style="font-size:11px; color:var(--text-faint);">à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸£à¸°à¸šà¸¸</span>`;

    const card = document.createElement("div");
    card.className = `animal-card ${s.cls}`;
    card.dataset.id = a.id;
    card.dataset.status = statusKey;
    card.dataset.name = (a.animal_name || "").toLowerCase();
    card.dataset.owner = (a.vasd_owner?.owner_name || "").toLowerCase();
    card.style.animationDelay = `${idx * 0.03}s`;

    card.innerHTML = `
      <div class="card-top" onclick="toggleCard(this.closest('.animal-card'))">
        <div class="queue-badge">#${a.queue_number}</div>
        <div class="card-info">
          <div class="animal-name">${a.animal_name} ${hasNote ? '<span title="à¸¡à¸µà¸‚à¹‰à¸­à¸„à¸§à¸£à¸£à¸°à¸§à¸±à¸‡" style="font-size:14px; margin-left:6px;">âš ï¸</span>' : ''}</div>
          <div class="animal-meta">${speciesText} Â· ${a.sex} Â· ${a.est_weight ?? "â€“"} à¸à¸.</div>
        </div>
        <span class="status-pill ${s.pill}">${s.dot} ${s.text}</span>
        <span class="expand-icon">âŒ„</span>
      </div>

      <div class="card-detail">
        <div class="detail-body">

          <div class="owner-row">
            <div class="owner-chip">ğŸ‘¤ à¹€à¸ˆà¹‰à¸²à¸‚à¸­à¸‡: <span>${a.vasd_owner?.owner_name ?? "â€“"}</span></div>
            ${a.vasd_owner?.phone ? `<div class="owner-chip">ğŸ“ <a href="tel:${a.vasd_owner.phone}" style="color:var(--teal-light);text-decoration:none;">${a.vasd_owner.phone}</a></div>` : ""}
          </div>

          <div style="margin-bottom: 14px;">
            <div style="font-size:10px; font-weight:700; color:var(--text-faint); text-transform:uppercase; margin-bottom:6px;">à¸šà¸£à¸´à¸à¸²à¸£à¸—à¸µà¹ˆà¹€à¸‚à¹‰à¸²à¸£à¸±à¸š</div>
            <div style="display:flex; flex-wrap:wrap; gap:6px;">
              ${services}
            </div>
          </div>

          ${hasNote ? `
          <div class="health-note">
            <span style="font-size:18px;">âš ï¸</span>
            <div>
              <div style="font-size:10px; font-weight:800; text-transform:uppercase; opacity:0.8; margin-bottom:2px;">à¸£à¸°à¸§à¸±à¸‡à¸à¸´à¹€à¸¨à¸© / à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸¸à¸‚à¸ à¸²à¸</div>
              <div style="font-weight:600; font-size:13px; line-height:1.4;">${note}</div>
            </div>
          </div>
          ` : ""}

          <div class="edit-grid">
            <div class="field-group">
              <span class="field-label">à¸Šà¸·à¹ˆà¸­à¸ªà¸±à¸•à¸§à¹Œ</span>
              <input class="edit-input f-name" value="${a.animal_name}" readonly>
            </div>
            <div class="field-group">
              <span class="field-label">à¸Šà¸™à¸´à¸”</span>
              <select class="edit-select f-species" disabled>
                <option value="à¸¡" ${a.species==="à¸¡"?"selected":""}>ğŸ± à¹à¸¡à¸§</option>
                <option value="à¸ª" ${a.species==="à¸ª"?"selected":""}>ğŸ¶ à¸ªà¸¸à¸™à¸±à¸‚</option>
              </select>
            </div>
            <div class="field-group">
              <span class="field-label">à¹€à¸à¸¨</span>
              <select class="edit-select f-sex" disabled>
                <option value="à¹€à¸¡à¸µà¸¢" ${a.sex==="à¹€à¸¡à¸µà¸¢"?"selected":""}>â™€ à¹€à¸¡à¸µà¸¢</option>
                <option value="à¸œà¸¹à¹‰"  ${a.sex==="à¸œà¸¹à¹‰" ?"selected":""}>â™‚ à¸œà¸¹à¹‰</option>
              </select>
            </div>
            <div class="field-group">
              <span class="field-label">à¸™à¸™. (à¸à¸.)</span>
              <input class="edit-input f-weight" type="number" value="${a.est_weight??""}" readonly min="0" step="0.1">
            </div>
          </div>

          <div class="status-row">
            <span class="field-label">à¸ªà¸–à¸²à¸™à¸°</span>
            <select class="status-select-full f-status" disabled>
              ${Object.entries(statusMap).map(([k,v]) =>
                `<option value="${k}" ${k===statusKey?"selected":""}>${v.dot} ${v.text}</option>`
              ).join("")}
            </select>
          </div>

          <div class="action-row">
            <button class="btn btn-print" onclick="printQueue('${a.id}')">ğŸ–¨ à¸à¸´à¸¡à¸à¹Œà¸„à¸´à¸§</button>
            <button class="btn btn-edit"  onclick="enableEdit(this, '${a.id}')">âœï¸ à¹à¸à¹‰à¹„à¸‚</button>
            <button class="btn btn-save"  onclick="saveRow(this, '${a.id}')" disabled>ğŸ’¾ à¸šà¸±à¸™à¸—à¸¶à¸</button>
            <button class="btn btn-cancel-status" onclick="cancelRow('${a.id}')">ğŸš« à¸¢à¸à¹€à¸¥à¸´à¸</button>
            <button class="btn btn-del"   onclick="deleteRow('${a.id}')">ğŸ—‘ à¸¥à¸š</button>
          </div>

        </div>
      </div>
    `;

    if (openIds.has(a.id)) card.classList.add("open");
    list.appendChild(card);
  });
}

/* â”€â”€ Toggle expand â”€â”€ */
window.toggleCard = function(card) {
  card.classList.toggle("open");
};

/* â”€â”€ Print â”€â”€ */
window.printQueue = async function(animalId) {
  const { data: a } = await supabase.from("vasd_animal")
    .select(`queue_number,animal_name,species,sex,vasd_owner(owner_name,phone),vasd_service(service_type)`)
    .eq("id", animalId).single();
  if (!a) return alert("à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥");

  const spcText  = a.species === "à¸ª" ? "à¸ªà¸¸à¸™à¸±à¸‚" : "à¹à¸¡à¸§";
  const services = a.vasd_service?.map(s => s.service_type).join(", ") || "-";
  const phone    = a.vasd_owner?.phone || "à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸";
  const ownerName= a.vasd_owner?.owner_name || "";

  const { data: tmplData } = await supabase.from("vasd_print_template").select("config").eq("template_type","queue").single();
  if (!tmplData?.config) return alert("âš ï¸ à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸šà¸±à¸™à¸—à¸¶à¸ Template à¸ªà¸•à¸´à¹Šà¸à¹€à¸à¸­à¸£à¹Œà¸„à¸´à¸§ à¸à¸£à¸¸à¸“à¸²à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸à¸´à¸¡à¸à¹Œà¸à¹ˆà¸­à¸™");

  let printContents = "";
  tmplData.config.forEach(l => {
    let text = l.text
      .replace("{{queue_number}}", a.queue_number)
      .replace("{{animal_name}}", a.animal_name)
      .replace("{{species}}", spcText).replace("{{sex}}", a.sex)
      .replace("{{owner_name}}", ownerName).replace("{{phone}}", phone)
      .replace("{{services}}", services);
    printContents += `<div class="line" style="left:${l.x||0}px;right:0;top:${l.y||0}px;font-size:${l.size}px;font-weight:${l.weight};font-family:${l.font};text-align:${l.align||"left"};">${text}</div>`;
  });

  const pw = window.open("","_blank","width=800,height=600");
  pw.document.write(`<html><head><title>Print</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&family=Prompt:wght@400;700&family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>body{margin:0}.sticker{position:relative;width:80mm;height:50mm;background:#fff;overflow:hidden}.line{position:absolute;white-space:pre-wrap;word-break:break-word;padding-right:5px;box-sizing:border-box;color:#000!important}@page{size:80mm 50mm;margin:0}</style>
    </head><body><div class="sticker">${printContents}</div>
    <script>window.onload=function(){document.fonts.ready.then(()=>{setTimeout(()=>{window.print();window.close();},200)})}<\/script></body></html>`);
  pw.document.close();
};

/* â”€â”€ Enable Edit â”€â”€ */
window.enableEdit = function(btn, id) {
  const pass = prompt("à¸à¸£à¸­à¸à¸£à¸«à¸±à¸ª admin");
  if (pass !== ADMIN_PASSWORD) return;
  const card = btn.closest(".animal-card");
  card.querySelectorAll(".f-name, .f-weight").forEach(el => el.readOnly = false);
  card.querySelectorAll(".f-species, .f-sex, .f-status").forEach(el => el.disabled = false);
  card.querySelector(".btn-save").disabled = false;
  btn.disabled = true;
};

/* â”€â”€ Save Row â”€â”€ */
window.saveRow = async function(btn, id) {
  const card = btn.closest(".animal-card");
  const name    = card.querySelector(".f-name").value;
  const species = card.querySelector(".f-species").value;
  const sex     = card.querySelector(".f-sex").value;
  const weight  = card.querySelector(".f-weight").value;
  const status  = card.querySelector(".f-status").value;

  await supabase.from("vasd_animal").update({
    animal_name: name, species, sex,
    est_weight: weight, actual_weight: weight
  }).eq("id", id);
  await supabase.from("vasd_queue").update({ status, updated_at: new Date() }).eq("animal_id", id);
  loadAnimals();
};

/* â”€â”€ Cancel Status â”€â”€ */
window.cancelRow = async function(id) {
  if (!confirm("à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸¢à¸à¹€à¸¥à¸´à¸à¸ªà¸–à¸²à¸™à¸°à¸ªà¸±à¸•à¸§à¹Œà¸•à¸±à¸§à¸™à¸µà¹‰?")) return;
  await supabase.from("vasd_queue").update({ status: "cancel", updated_at: new Date() }).eq("animal_id", id);
  loadAnimals();
};

/* â”€â”€ Delete Row â”€â”€ */
window.deleteRow = async function(id) {
  const pwd = prompt("à¸à¸£à¸­à¸à¸£à¸«à¸±à¸ª admin à¹€à¸à¸·à¹ˆà¸­à¸¢à¸·à¸™à¸¢à¸±à¸™à¸à¸²à¸£à¸¥à¸š");
  if (!pwd) return;
  const { error } = await supabase.rpc("admin_delete_animal", { p_animal_id: id, p_admin_password: pwd });
  if (error) alert("âŒ à¸¥à¸šà¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: " + error.message);
  else loadAnimals();
};

/* â”€â”€ Real-time â”€â”€ */
supabase.channel("vasd-animals-live")
  .on("postgres_changes", { event: "*", schema: "public", table: "vasd_queue" }, loadAnimals)
  .on("postgres_changes", { event: "*", schema: "public", table: "vasd_animal" }, loadAnimals)
  .subscribe();

loadAnimals();
</script>
   <script type="module" src="./js/global-alarm.js"></script>
</body>
</html>
