<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>RMUTTO - VASD | ‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family:"Segoe UI", sans-serif;
  background:#f4f6f8;
  margin:0;
}
header {
  background:#fff;
  border-bottom:1px solid #ddd;
  padding:14px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.container {
  max-width:1500px;
  margin:auto;
  padding:20px;
}
table {
  width:100%;
  border-collapse:collapse;
  background:#fff;
}
th, td {
  border:1px solid #ddd;
  padding:8px;
  text-align:center;
}
th { background:#f1f3f5; }

input, select {
  width:100%;
  box-sizing:border-box;
}
.readonly {
  background:#f1f3f5;
}

/* ===== STATUS COLORS ===== */
.status-wait       { background:#eeeeee; }
.status-anesthesia { background:#e3f2fd; }
.status-surgery    { background:#fdecea; }
.status-recovery   { background:#f3e5f5; }
.status-ready      { background:#fff9c4; }
.status-done       { background:#e8f5e9; }
.status-cancel     { background:#f0f0f0; color:#999; text-decoration:line-through; }

button {
  padding:4px 8px;
  border:none;
  border-radius:4px;
  cursor:pointer;
  font-size:12px;
}
.btn-edit { background:#2c7be5; color:#fff; }
.btn-save { background:#198754; color:#fff; }
.btn-cancel { background:#ffc107; }
.btn-delete { background:#dc3545; color:#fff; }
.btn-home { background:#6c757d; color:#fff; }
.btn-save:disabled {
  opacity:.4;
  cursor:not-allowed;
}
</style>
</head>

<body>

<header>
  <h3>üêæ ‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</h3>
  <button class="btn-home" onclick="location.href='index.html'">üè† Home</button>
</header>

<div class="container">

<table>
  <thead>
    <tr>
      <th>‡∏Ñ‡∏¥‡∏ß</th>
      <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå</th>
      <th>‡∏ä‡∏ô‡∏¥‡∏î</th>
      <th>‡πÄ‡∏û‡∏®</th>
      <th>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</th>
      <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
      <th>‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</th>
      <th>‡πÇ‡∏ó‡∏£</th>
      <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
    </tr>
  </thead>
  <tbody id="animalTable"></tbody>
</table>

</div>

<script type="module">
import { supabase } from "./js/supabase.js";

const EDIT_PASSWORD = "2500";

/* ===== STATUS MAP ===== */
const statusMap = {
  "registered": { text:"‡∏£‡∏≠‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î", cls:"status-wait" },
  "anesthesia": { text:"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏≤‡∏á‡∏¢‡∏≤‡∏™‡∏•‡∏ö", cls:"status-anesthesia" },
  "surgery":    { text:"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î", cls:"status-surgery" },
  "recovery":   { text:"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏Å‡∏ü‡∏∑‡πâ‡∏ô", cls:"status-recovery" },
  "ready":      { text:"‡∏ü‡∏∑‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß / ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö", cls:"status-ready" },
  "done":       { text:"‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß", cls:"status-done" },
  "cancel":     { text:"‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å", cls:"status-cancel" }
};

/* ===== LOAD ===== */
async function loadAnimals() {
  const { data: eventId } = await supabase.rpc("get_today_event");

  const { data } = await supabase
    .from("vasd_animal")
    .select(`
      id,
      queue_number,
      animal_name,
      species,
      sex,
      est_weight,
      vasd_owner ( owner_name, phone ),
      vasd_queue ( status )
    `)
    .eq("event_id", eventId)
    .order("queue_number");

  const tbody = document.getElementById("animalTable");
  tbody.innerHTML = "";

  data.forEach(a => {
    const statusKey = a.vasd_queue?.status || "registered";
    const s = statusMap[statusKey];

    const tr = document.createElement("tr");
    tr.dataset.id = a.id;
    tr.className = s.cls;

    tr.innerHTML = `
      <td>${a.queue_number}</td>
      <td><input class="f" value="${a.animal_name ?? ""}" readonly></td>
      <td>
        <select class="f" disabled>
          <option value="‡∏°" ${a.species==="‡∏°"?"selected":""}>‡πÅ‡∏°‡∏ß</option>
          <option value="‡∏™" ${a.species==="‡∏™"?"selected":""}>‡∏™‡∏∏‡∏ô‡∏±‡∏Ç</option>
        </select>
      </td>
      <td>
        <select class="f" disabled>
          <option ${a.sex==="‡πÄ‡∏°‡∏µ‡∏¢"?"selected":""}>‡πÄ‡∏°‡∏µ‡∏¢</option>
          <option ${a.sex==="‡∏ú‡∏π‡πâ"?"selected":""}>‡∏ú‡∏π‡πâ</option>
        </select>
      </td>
      <td><input class="f" type="number" value="${a.est_weight ?? ""}" readonly></td>
      <td>
        <select class="status" disabled>
          ${Object.entries(statusMap).map(([k,v]) =>
            `<option value="${k}" ${k===statusKey?"selected":""}>${v.text}</option>`
          ).join("")}
        </select>
      </td>
      <td>${a.vasd_owner?.owner_name ?? ""}</td>
      <td>${a.vasd_owner?.phone ?? ""}</td>
      <td>
        <button class="btn-edit" onclick="enableEdit(this)">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        <button class="btn-save" onclick="saveRow(this)" disabled>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button><br><br>
        <button class="btn-cancel" onclick="cancelRow(this)">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="btn-delete" onclick="deleteRow(this)">‡∏•‡∏ö</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

loadAnimals();

/* ===== ENABLE EDIT ===== */
window.enableEdit = function(btn){
  const pass = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô");
  if (pass !== EDIT_PASSWORD) return;

  const tr = btn.closest("tr");
  tr.querySelectorAll(".f, .status").forEach(el=>{
    el.readOnly = false;
    el.disabled = false;
  });
  tr.querySelector(".btn-save").disabled = false;
};

/* ===== SAVE ===== */
window.saveRow = async function(btn){
  const tr = btn.closest("tr");
  const id = tr.dataset.id;
  const f = tr.querySelectorAll(".f");
  const status = tr.querySelector(".status").value;

  await supabase.from("vasd_animal").update({
    animal_name: f[0].value,
    species: f[1].value,
    sex: f[2].value,
    est_weight: f[3].value
  }).eq("id", id);

  await supabase.from("vasd_queue")
    .update({ status })
    .eq("animal_id", id);

  loadAnimals();
};

/* ===== CANCEL ===== */
window.cancelRow = async function(btn){
  if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ?")) return;
  const id = btn.closest("tr").dataset.id;

  await supabase.from("vasd_queue")
    .update({ status:"cancel" })
    .eq("animal_id", id);

  loadAnimals();
};

/* ===== DELETE ===== */
window.deleteRow = async function(btn){
  if (!confirm("‚ö†Ô∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ñ‡∏≤‡∏ß‡∏£?")) return;
  const id = btn.closest("tr").dataset.id;

  await supabase.from("vasd_animal").delete().eq("id", id);
  loadAnimals();
};

/* ===== REALTIME ===== */
supabase
  .channel("vasd-animal-status")
  .on("postgres_changes",
      { event:"*", schema:"public", table:"vasd_queue" },
      () => loadAnimals())
  .subscribe();
</script>

</body>
</html>
