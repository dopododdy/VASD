<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>RMUTTO - VASD | ‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family:"Segoe UI", sans-serif; background:#f4f6f8; margin:0; }
header {
  background:#fff;
  border-bottom:1px solid #ddd;
  padding:14px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.container { max-width:1600px; margin:auto; padding:20px; }

table {
  width:100%;
  border-collapse:collapse;
  background:#fff;
  box-shadow:0 2px 5px rgba(0,0,0,0.1);
}
th, td {
  border:1px solid #ddd;
  padding:10px;
  text-align:center;
}
th { background:#f1f3f5; }

input, select { width:100%; box-sizing:border-box; padding:4px; }

/* STATUS COLORS */
.status-wait       { background:#eeeeee; }
.status-anesthesia { background:#e3f2fd; }
.status-surgery    { background:#fdecea; }
.status-recovery   { background:#f3e5f5; }
.status-ready      { background:#fff9c4; }
.status-done       { background:#e8f5e9; }
.status-cancel     { background:#eeeeee; opacity:0.6; }

button {
  padding:6px 10px;
  border:none;
  border-radius:4px;
  cursor:pointer;
  font-size:13px;
  margin:2px;
}
.btn-edit   { background:#2c7be5; color:#fff; }
.btn-save   { background:#198754; color:#fff; }
.btn-cancel { background:#fd7e14; color:#fff; }
.btn-del    { background:#dc3545; color:#fff; }
.btn-home   { background:#6c757d; color:#fff; }
.btn-print  { background:#000; color:#fff; }

.btn-save:disabled { opacity:.4; cursor:not-allowed; }

.footer-actions { margin-top:20px; text-align:right; }
</style>
</head>

<body>

<header>
  <h3>üêæ ‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</h3>
  <button class="btn-home" onclick="location.href='index.html'">üè† Home</button>
</header>

<div class="container">

<table>
<thead>
<tr>
  <th>‡∏Ñ‡∏¥‡∏ß</th>
  <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå</th>
  <th>‡∏ä‡∏ô‡∏¥‡∏î</th>
  <th>‡πÄ‡∏û‡∏®</th>
  <th>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</th>
  <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
  <th>‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</th>
  <th>‡πÇ‡∏ó‡∏£</th>
  <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
</tr>
</thead>
<tbody id="animalTable"></tbody>
</table>

<div class="footer-actions">
  <button class="btn-del" onclick="deleteAll()">‚ùå ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</button>
</div>

</div>

<script type="module">
import { supabase } from "./js/supabase.js";

const ADMIN_PASSWORD = "2500";

const statusMap = {
  waiting:{ text:"‡∏£‡∏≠‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î", cls:"status-wait" },
  anesthesia:{ text:"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏≤‡∏á‡∏¢‡∏≤‡∏™‡∏•‡∏ö", cls:"status-anesthesia" },
  surgery:{ text:"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î", cls:"status-surgery" },
  recovery:{ text:"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏Å‡∏ü‡∏∑‡πâ‡∏ô", cls:"status-recovery" },
  ready_to_go_home:{ text:"‡∏ü‡∏∑‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß / ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö", cls:"status-ready" },
  done:{ text:"‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß", cls:"status-done" },
  cancel:{ text:"‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å", cls:"status-cancel" }
};

/* ================= LOAD ================= */
async function loadAnimals(){

  const { data:eventId } = await supabase.rpc("get_today_event");

  const { data, error } = await supabase
    .from("vasd_animal")
    .select(`
      id, queue_number, animal_name, species, sex, est_weight,
      vasd_owner ( owner_name, phone ),
      vasd_queue ( status )
    `)
    .eq("event_id", eventId)
    .order("queue_number");

  if(error){ console.error(error); return; }

  const tbody = document.getElementById("animalTable");
  tbody.innerHTML = "";

  data.forEach(a => {

    const statusKey = a.vasd_queue?.status || "waiting";
    const s = statusMap[statusKey] || statusMap.waiting;

    const tr = document.createElement("tr");
    tr.dataset.id = a.id;
    tr.className = s.cls;

    tr.innerHTML = `
      <td>${a.queue_number}</td>
      <td><input class="f" value="${a.animal_name}" readonly></td>

      <td>
        <select class="f" disabled>
          <option value="‡∏°" ${a.species==="‡∏°"?"selected":""}>‡πÅ‡∏°‡∏ß</option>
          <option value="‡∏™" ${a.species==="‡∏™"?"selected":""}>‡∏™‡∏∏‡∏ô‡∏±‡∏Ç</option>
        </select>
      </td>

      <td>
        <select class="f" disabled>
          <option value="‡πÄ‡∏°‡∏µ‡∏¢" ${a.sex==="‡πÄ‡∏°‡∏µ‡∏¢"?"selected":""}>‡πÄ‡∏°‡∏µ‡∏¢</option>
          <option value="‡∏ú‡∏π‡πâ" ${a.sex==="‡∏ú‡∏π‡πâ"?"selected":""}>‡∏ú‡∏π‡πâ</option>
        </select>
      </td>

      <td><input class="f" type="number" value="${a.est_weight ?? ""}" readonly></td>

      <td>
        <select class="status" disabled>
          ${Object.entries(statusMap).map(([k,v]) =>
            `<option value="${k}" ${k===statusKey?"selected":""}>${v.text}</option>`
          ).join("")}
        </select>
      </td>

      <td>${a.vasd_owner?.owner_name ?? ""}</td>
      <td>${a.vasd_owner?.phone ?? ""}</td>

      <td>
        <button class="btn-print" onclick="printQueue('${a.id}')">üñ® ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏¥‡∏ß</button>
        <button class="btn-edit" onclick="enableEdit(this)">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        <button class="btn-save" onclick="saveRow(this)" disabled>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button class="btn-cancel" onclick="cancelRow('${a.id}')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="btn-del" onclick="deleteRow('${a.id}')">‡∏•‡∏ö</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

loadAnimals();

/* ================= PRINT (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Template) ================= */
window.printQueue = async function(animalId){
  // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
  const { data: a } = await supabase
    .from("vasd_animal")
    .select(`
      queue_number, animal_name, species, sex,
      vasd_owner ( owner_name, phone ),
      vasd_service ( service_type )
    `)
    .eq("id", animalId)
    .single();

  if(!a) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");

  const spcText = a.species === "‡∏™" ? "‡∏™‡∏∏‡∏ô‡∏±‡∏Ç" : "‡πÅ‡∏°‡∏ß";
  const services = a.vasd_service?.map(s=>s.service_type).join(", ") || "-";
  const ownerName = a.vasd_owner?.owner_name || "";
  const phone = a.vasd_owner?.phone || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";

  // 2. ‡∏î‡∏∂‡∏á Template ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå (‡∏Ñ‡∏¥‡∏ß)
  const { data: tmplData } = await supabase
    .from("vasd_print_template")
    .select("config")
    .eq("template_type", "queue")
    .single();

  if(!tmplData || !tmplData.config) {
    return alert("‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Template ‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏Ñ‡∏¥‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
  }

  // 3. ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏•‡∏á‡πÉ‡∏ô Template
  let printContents = '';
  tmplData.config.forEach(l => {
    let text = l.text
      .replace("{{queue_number}}", a.queue_number)
      .replace("{{animal_name}}", a.animal_name)
      .replace("{{species}}", spcText)
      .replace("{{sex}}", a.sex)
      .replace("{{owner_name}}", ownerName)
      .replace("{{phone}}", phone)
      .replace("{{services}}", services);
      
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ l.align ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì width ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
    let textAlign = l.align || "left";
    let width = `calc(100% - ${l.x}px)`;
      
    printContents += `<div class="line" style="left:${l.x}px; top:${l.y}px; font-size:${l.size}px; font-weight:${l.weight}; font-family:${l.font}; text-align:${textAlign}; width:${width};">${text}</div>`;
  });

  // 4. ‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå (‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ó‡∏™‡∏ï‡πå‡∏û‡∏¥‡∏°‡∏û‡πå)
  const printWindow = window.open('', '_blank', 'width=800,height=600');
  
  printWindow.document.write(`
    <html>
      <head>
        <title>Print Queue</title>
        <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&family=Prompt:wght@300;400;500;700&family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
        <style>
          body { margin: 0; padding: 0; color: #000 !important; }
          .sticker {
            position: relative;
            width: 80mm;
            height: 50mm;
            background: #fff;
            overflow: hidden;
          }
          .line {
            position: absolute;
            white-space: pre-wrap;
            word-break: break-word;
            padding-right: 5px; /* ‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏∞‡∏•‡∏∏‡∏Ç‡∏≠‡∏ö */
            box-sizing: border-box; /* ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Width */
            color: #000 !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
          }
          @page {
            size: 80mm 50mm;
            margin: 0;
          }
        </style>
      </head>
      <body>
        <div class="sticker">${printContents}</div>
        <script>
          window.onload = function() {
            setTimeout(() => {
              window.print();
              window.close();
            }, 300);
          };
        <\/script>
      </body>
    </html>
  `);
  printWindow.document.close();
};

/* ================= EDIT / DELETE ================= */
window.enableEdit=function(btn){
  const pass = prompt("‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ admin");
  if(pass!==ADMIN_PASSWORD) return;

  const tr = btn.closest("tr");
  tr.querySelectorAll(".f,.status").forEach(el=>{
    el.readOnly=false;
    el.disabled=false;
  });
  tr.querySelector(".btn-save").disabled=false;
};

window.saveRow=async function(btn){
  const tr=btn.closest("tr");
  const id=tr.dataset.id;

  const f=tr.querySelectorAll(".f");
  const status=tr.querySelector(".status").value;

  await supabase.from("vasd_animal").update({
    animal_name:f[0].value,
    species:f[1].value,
    sex:f[2].value,
    est_weight:f[3].value
  }).eq("id",id);

  await supabase.from("vasd_queue")
    .update({ status, updated_at:new Date() })
    .eq("animal_id",id);

  loadAnimals();
};

window.cancelRow=async function(id){
  await supabase.from("vasd_queue")
    .update({ status:"cancel", updated_at:new Date() })
    .eq("animal_id",id);
  loadAnimals();
};

window.deleteRow=async function(id){
  const pwd=prompt("‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ admin ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö");
  if(!pwd) return;

  const { error } = await supabase.rpc("admin_delete_animal",{
    p_animal_id:id,
    p_admin_password:pwd
  });

  if(error) alert("‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  else loadAnimals();
};

window.deleteAll=async function(){
  if(!confirm("‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
  const pwd=prompt("‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ admin");
  if(!pwd) return;

  const { error } = await supabase.rpc("admin_delete_all_today",{
    p_admin_password:pwd
  });

  if(error) alert("‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  else{
    alert("‚úÖ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß");
    loadAnimals();
  }
};

/* ================= REALTIME ================= */
supabase.channel("vasd-live")
  .on("postgres_changes",{event:"*",schema:"public",table:"vasd_queue"},loadAnimals)
  .on("postgres_changes",{event:"*",schema:"public",table:"vasd_animal"},loadAnimals)
  .subscribe();

</script>

</body>
</html>
