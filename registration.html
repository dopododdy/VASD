<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>VASD ‚Äì ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏±‡∏ï‡∏ß‡πå</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family:Segoe UI, sans-serif; background:#f4f6f8; margin:0; }
header {
  background:#fff; border-bottom:1px solid #ddd;
  padding:14px 20px; display:flex; justify-content:space-between;
}
.container { max-width:1600px; margin:auto; padding:20px; }
.card {
  background:#fff; border-radius:10px; padding:20px;
  margin-bottom:20px; box-shadow:0 2px 6px rgba(0,0,0,.05);
}
.owner-grid {
  display:grid; grid-template-columns:2fr 1fr auto; gap:12px;
}
input, select, textarea {
  width:100%; box-sizing:border-box; padding:6px;
}
table { width:100%; border-collapse:collapse; }
th, td { border:1px solid #ddd; padding:6px; text-align:center; }
.service-line { display:flex; gap:16px; flex-wrap:wrap; }
button {
  padding:8px 12px; border:none; border-radius:6px;
  cursor:pointer; font-weight:bold;
}
.btn-add{background:#6c757d;color:#fff;}
.btn-save{background:#2c7be5;color:#fff;}
.btn-del{background:#dc3545;color:#fff;}
</style>
</head>

<body>

<header>
  <h3>üìù ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏±‡∏ï‡∏ß‡πå ‚Äì VASD</h3>
  <button onclick="location.href='index.html'">üè† Home</button>
</header>

<div class="container">

<div class="card">
  <h4>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</h4>
  <div class="owner-grid">
    <input id="ownerName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á">
    <input id="phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£">
    <button id="btnReadID" onclick="alert('‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£ (mock)')">üìá ‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ï‡∏£</button>
  </div>
</div>

<div class="card">
  <h4>‡∏™‡∏±‡∏ï‡∏ß‡πå</h4>
  <table>
    <thead>
      <tr>
        <th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏ä‡∏ô‡∏¥‡∏î</th><th>‡πÄ‡∏û‡∏®</th>
        <th>‡∏ô‡∏ô.</th><th>‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£</th><th>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</th><th>‡∏•‡∏ö</th>
      </tr>
    </thead>
    <tbody id="animalBody"></tbody>
  </table>
  <br>
  <button class="btn-add" onclick="addAnimal()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ï‡∏ß‡πå</button>
</div>

<div class="card" style="text-align:center">
  <button class="btn-save" onclick="saveAll()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
</div>

</div>

<script type="module">
import { supabase } from "./js/supabase.js";

/* ---------- UI ---------- */
function serviceHTML(species) {
  return `
    <div class="service-line">
      <label><input type="checkbox" class="svc" value="‡∏ó‡∏≥‡∏´‡∏°‡∏±‡∏ô" checked> ‡∏ó‡∏≥‡∏´‡∏°‡∏±‡∏ô</label>
      <label><input type="checkbox" class="svc" value="‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡∏û‡∏¥‡∏©‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏ö‡πâ‡∏≤"> ‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡∏û‡∏¥‡∏©‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏ö‡πâ‡∏≤</label>
      ${species==="‡∏™"?
        `<label><input type="checkbox" class="svc" value="‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡πá‡∏ö‡∏´‡∏°‡∏±‡∏î"> ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡πá‡∏ö‡∏´‡∏°‡∏±‡∏î</label>`:""}
    </div>`;
}

window.addAnimal = function () {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input class="animalName"></td>
    <td>
      <select class="species">
        <option value="‡∏°">‡πÅ‡∏°‡∏ß</option>
        <option value="‡∏™">‡∏™‡∏∏‡∏ô‡∏±‡∏Ç</option>
      </select>
    </td>
    <td>
      <select class="sex">
        <option>‡πÄ‡∏°‡∏µ‡∏¢</option>
        <option>‡∏ú‡∏π‡πâ</option>
      </select>
    </td>
    <td><input type="number" value="3"></td>
    <td class="svcCell"></td>
    <td><textarea></textarea></td>
    <td><button class="btn-del" onclick="this.closest('tr').remove()">üóë</button></td>
  `;
  const species = tr.querySelector(".species");
  const svcCell = tr.querySelector(".svcCell");
  svcCell.innerHTML = serviceHTML("‡∏°");
  species.onchange = () => svcCell.innerHTML = serviceHTML(species.value);
  document.getElementById("animalBody").appendChild(tr);
};

/* ---------- SAVE REAL ---------- */
window.saveAll = async function () {
  const ownerName = document.getElementById("ownerName").value.trim();
  const phone = document.getElementById("phone").value.trim();
  if (!ownerName || !phone) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£");
    return;
  }

  const rows = document.querySelectorAll("#animalBody tr");
  if (rows.length === 0) {
    alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏±‡∏ï‡∏ß‡πå");
    return;
  }

  // 1) event ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
  const { data: eventId, error: e1 } = await supabase.rpc("get_today_event");
  if (e1) { alert("event error"); console.error(e1); return; }

  // 2) owner
  const { data: owner, error: e2 } = await supabase
    .from("vasd_owner")
    .insert({ event_id: eventId, owner_name: ownerName, phone })
    .select().single();

  if (e2) { alert("owner error"); console.error(e2); return; }

  // 3) queue start
  const { count } = await supabase
    .from("vasd_animal")
    .select("*", { count: "exact", head: true })
    .eq("event_id", eventId);

  let q = (count || 0) + 1;

  // 4) animals
  for (const r of rows) {
    const { data: animal, error: e3 } = await supabase
      .from("vasd_animal")
      .insert({
        event_id: eventId,
        owner_id: owner.id,
        queue_number: q++,
        species: r.querySelector(".species").value,
        animal_name: r.querySelector(".animalName").value,
        sex: r.querySelector(".sex").value,
        est_weight: r.querySelector("input[type=number]").value,
        health_note: r.querySelector("textarea").value
      })
      .select().single();

    if (e3) { alert("animal error"); console.error(e3); return; }

    // services
    const svcs = [];
    r.querySelectorAll(".svc:checked").forEach(s =>
      svcs.push({ animal_id: animal.id, service_type: s.value })
    );
    if (svcs.length) await supabase.from("vasd_service").insert(svcs);

    // queue
    await supabase.from("vasd_queue").insert({
      animal_id: animal.id,
      status: "registered"
    });
  }

  alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
  location.href = "index.html";
};
</script>

</body>
</html>
