<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>RMUTTO - VASD | ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏±‡∏ï‡∏ß‡πå</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&family=Prompt:wght@300;400;500;700&family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>
/* ================= CSS ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô ================= */
body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background: #f4f6f8; margin: 0; color: #333; }
header {
  background: #fff; border-bottom: 1px solid #ddd;
  padding: 14px 20px; display: flex; justify-content: space-between; align-items: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.02);
}
header h3 { margin: 0; color: #2c7be5; }
.container { max-width: 1200px; margin: auto; padding: 20px; }
.card {
  background: #fff; border-radius: 8px; padding: 20px;
  margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  border: 1px solid #e9ecef;
}
.card h4 { margin-top: 0; margin-bottom: 15px; color: #495057; border-bottom: 2px solid #f4f6f8; padding-bottom: 10px; }

.owner-grid { display: grid; grid-template-columns: 2fr 1fr auto; gap: 12px; }
input, select, textarea {
  width: 100%; box-sizing: border-box; padding: 10px;
  border: 1px solid #ced4da; border-radius: 4px;
  font-family: inherit; font-size: 14px; transition: border-color 0.15s ease-in-out;
}
input:focus, select:focus, textarea:focus { border-color: #80bdff; outline: 0; box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25); }
textarea { resize: vertical; min-height: 42px; }

.table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
table { width: 100%; border-collapse: collapse; min-width: 900px; }
th, td { border: 1px solid #e9ecef; padding: 10px; text-align: center; vertical-align: middle; }
th { background: #f8f9fa; color: #495057; font-weight: 600; }
tbody tr:nth-child(even) { background: #fcfcfc; }
tbody tr:hover { background: #f1f3f5; }

.service-line { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 8px; text-align: left; }
.service-line label { 
  display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 13px; 
  background: #f8f9fa; padding: 8px 10px; border: 1px solid #dee2e6; border-radius: 6px; user-select: none; margin: 0;
}
.service-line label:hover { background: #e9ecef; border-color: #ced4da; }
.service-line label:has(input:checked) { background: #e8f4fd; border-color: #b8daff; color: #004085; font-weight: 500; }
.service-line input[type="checkbox"] { width: auto; margin: 0; }

.important-warning { background: #fff3cd !important; border: 2px solid #ffc107 !important; }
.important-warning::before { content: "‚ö†Ô∏è "; font-weight: bold; }

button {
  padding: 10px 16px; border: none; border-radius: 4px;
  cursor: pointer; font-weight: bold; font-size: 14px;
  transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 6px;
}
button:hover { opacity: 0.85; }
button:disabled { opacity: 0.6; cursor: not-allowed; }

.btn-add { background: #6c757d; color: #fff; }
.btn-save { background: #2c7be5; color: #fff; font-size: 16px; padding: 12px 24px; }
.btn-del { background: #dc3545; color: #fff; padding: 6px 10px; }
.btn-paste { background: #198754; color: #fff; }
.btn-home { background: #e9ecef; color: #495057; }

@media (max-width: 768px) {
  .owner-grid { grid-template-columns: 1fr; }
  .btn-paste { width: 100%; }
}

/* ================= CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏±‡∏ï‡∏£‡∏Ñ‡∏¥‡∏ß ================= */
#printArea { display: none; }
@media print {
  body > :not(#printArea) { display: none !important; } /* ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå */
  #printArea { display: block !important; }
  
  .sticker-page {
    position: relative;
    width: 80mm;
    height: 50mm;
    page-break-after: always; /* ‡∏ï‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏ú‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏™‡∏°‡∏≠ */
    overflow: hidden;
    background: #fff;
    font-family: "Segoe UI", sans-serif;
  }
  .line {
    position: absolute;
    white-space: pre-wrap;
    word-break: break-word;
    max-width: 95%;
    /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏™‡∏µ‡∏î‡∏≥‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏ö‡∏ö‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô */
    color: #000 !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }
  @page {
    size: 80mm 50mm;
    margin: 0;
  }
}
</style>
</head>

<body>

<header>
  <h3>üìù RMUTTO - VASD | ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏±‡∏ï‡∏ß‡πå</h3>
  <button class="btn-home" onclick="location.href='index.html'">üè† ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
</header>

<div class="container">
  <div class="card">
    <h4>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå</h4>
    <div class="owner-grid">
      <input id="ownerName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)" required>
      <input id="phone" type="tel" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)">
      <button class="btn-paste" onclick="pasteOwnerName()">üìã ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ï‡∏£</button>
    </div>
  </div>

  <div class="card">
    <h4>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ï‡∏ß‡πå</h4>
    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th width="15%">‡∏ä‡∏∑‡πà‡∏≠</th>
            <th width="8%">‡∏ä‡∏ô‡∏¥‡∏î</th>
            <th width="8%">‡πÄ‡∏û‡∏®</th>
            <th width="8%">‡∏ô‡∏ô. (‡∏Å‡∏Å.)</th>
            <th width="35%">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</th>
            <th width="16%">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û / ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</th>
            <th width="10%">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
          </tr>
        </thead>
        <tbody id="animalBody"></tbody>
      </table>
    </div>
    <br>
    <button class="btn-add" onclick="addAnimal()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏ï‡∏ß‡πå</button>
  </div>

  <div class="card" style="text-align:center; background: transparent; border: none; box-shadow: none;">
    <button id="btnSaveAll" class="btn-save" onclick="saveAll()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö ‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏¥‡∏ß</button>
  </div>
</div>

<div id="printArea"></div>

<script type="module">
import { supabase } from "./js/supabase.js";

/* ========================= ‡∏ß‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á ========================= */
window.pasteOwnerName = async function () {
  try {
    const text = await navigator.clipboard.readText();
    if (!text) return alert("‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Clipboard");
    document.getElementById("ownerName").value = text.trim();
    document.getElementById("phone").focus();
  } catch (err) {
    alert("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô Clipboard ‡πÑ‡∏î‡πâ");
  }
};

/* ========================= ‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ ========================= */
const phoneInput = document.getElementById("phone");
phoneInput.addEventListener("input", function() {
  let v = this.value.replace(/\D/g,"").slice(0,10);
  if (v.length > 6) v = v.replace(/(\d{3})(\d{3})(\d+)/,"$1-$2-$3");
  else if (v.length > 3) v = v.replace(/(\d{3})(\d+)/,"$1-$2");
  this.value = v;
});

/* ========================= ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ========================= */
function neuterText(sex) { return sex === "‡∏ú‡∏π‡πâ" ? "‡∏ó‡∏≥‡∏´‡∏°‡∏±‡∏ô‡πÄ‡∏û‡∏®‡∏ú‡∏π‡πâ" : "‡∏ó‡∏≥‡∏´‡∏°‡∏±‡∏ô‡πÄ‡∏û‡∏®‡πÄ‡∏°‡∏µ‡∏¢"; }
function serviceHTML(sex, species) {
  return `
    <div class="service-line">
      <label><input type="checkbox" class="svc" checked value="${neuterText(sex)}"> ${neuterText(sex)}</label>
      <label><input type="checkbox" class="svc" value="‡∏â‡∏µ‡∏î‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡∏û‡∏¥‡∏©‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏ö‡πâ‡∏≤"> ‡∏â‡∏µ‡∏î‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡∏û‡∏¥‡∏©‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏ö‡πâ‡∏≤</label>
      ${species === "‡∏™" ? `<label><input type="checkbox" class="svc" value="‡∏â‡∏µ‡∏î‡∏¢‡∏≤‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡πá‡∏ö"> ‡∏â‡∏µ‡∏î‡∏¢‡∏≤‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡πá‡∏ö</label>` : ""}
      <label><input type="checkbox" class="svc" value="‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏•‡∏∑‡∏≠‡∏î"> ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏•‡∏∑‡∏≠‡∏î</label>
      <label><input type="checkbox" class="svc" value="‡∏ù‡∏±‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡∏ä‡∏¥‡∏ü"> ‡∏ù‡∏±‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡∏ä‡∏¥‡∏ü</label>
    </div>`;
}

/* ========================= ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ï‡∏ß‡πå ========================= */
window.addAnimal = function () {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input class="animalName" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠..." required></td>
    <td><select class="species"><option value="‡∏°">‡πÅ‡∏°‡∏ß</option><option value="‡∏™">‡∏™‡∏∏‡∏ô‡∏±‡∏Ç</option></select></td>
    <td><select class="sex"><option value="‡πÄ‡∏°‡∏µ‡∏¢">‡πÄ‡∏°‡∏µ‡∏¢</option><option value="‡∏ú‡∏π‡πâ">‡∏ú‡∏π‡πâ</option></select></td>
    <td><input type="number" class="estWeight" value="3" min="0" step="0.1"></td>
    <td class="svcCell"></td>
    <td class="noteCell"><textarea class="healthNote" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß..."></textarea></td>
    <td><button class="btn-del" onclick="this.closest('tr').remove()" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ">üóë ‡∏•‡∏ö</button></td>
  `;

  const species = tr.querySelector(".species"), sex = tr.querySelector(".sex"), svcCell = tr.querySelector(".svcCell"), note = tr.querySelector(".healthNote"), noteCell = tr.querySelector(".noteCell"), nameInput = tr.querySelector(".animalName");
  nameInput.oninput = () => { nameInput.style.backgroundColor = ""; };
  function refreshService() { svcCell.innerHTML = serviceHTML(sex.value, species.value); }
  refreshService();
  species.onchange = refreshService; sex.onchange = refreshService;
  note.oninput = () => { noteCell.classList.toggle("important-warning", note.value.trim() !== ""); };
  document.getElementById("animalBody").appendChild(tr);
};
window.addEventListener('DOMContentLoaded', () => { addAnimal(); });

/* ========================= SAVE & PRINT ========================= */
window.saveAll = async function () {
  const btnSave = document.getElementById("btnSaveAll");
  const ownerNameInput = document.getElementById("ownerName");
  const ownerName = ownerNameInput.value.trim();
  const phone = document.getElementById("phone").value.trim();

  if (!ownerName) return alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå"), ownerNameInput.focus();
  const rows = document.querySelectorAll("#animalBody tr");
  if (rows.length === 0) return alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");

  let hasError = false;
  rows.forEach((row, index) => {
    const nameInput = row.querySelector(".animalName");
    if (!nameInput.value.trim()) {
      alert(`‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${index + 1}`);
      nameInput.focus(); nameInput.style.backgroundColor = "#ffecec"; hasError = true;
    }
  });
  if (hasError) return;

  btnSave.disabled = true;
  btnSave.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏¥‡∏ß...";

  try {
    const { data: eventId, error: evtErr } = await supabase.rpc("get_today_event");
    if (evtErr) throw evtErr;

    const { data: owner, error: ownerErr } = await supabase.from("vasd_owner")
      .insert({ event_id: eventId, owner_name: ownerName, phone: phone }).select().single();
    if (ownerErr) throw ownerErr;

    const { count, error: countErr } = await supabase.from("vasd_animal")
      .select("*", { count: "exact", head: true }).eq("event_id", eventId);
    if (countErr) throw countErr;

    let currentQueue = (count || 0) + 1;
    let svcsToInsert = [], queuesToInsert = [], animalsForPrint = [];

    for (const r of rows) {
      const speciesVal = r.querySelector(".species").value;
      const { data: animal, error: animalErr } = await supabase.from("vasd_animal")
        .insert({
          event_id: eventId, owner_id: owner.id, queue_number: currentQueue++,
          species: speciesVal, animal_name: r.querySelector(".animalName").value.trim(),
          sex: r.querySelector(".sex").value, est_weight: r.querySelector(".estWeight").value || 0,
          health_note: r.querySelector(".healthNote").value.trim()
        }).select().single();
      if (animalErr) throw animalErr;

      let sNames = [];
      r.querySelectorAll(".svc:checked").forEach(s => {
        svcsToInsert.push({ animal_id: animal.id, service_type: s.value });
        sNames.push(s.value);
      });
      queuesToInsert.push({ animal_id: animal.id, status: "waiting" });

      animalsForPrint.push({
        q: animal.queue_number,
        name: animal.animal_name,
        spc: speciesVal === '‡∏°' ? '‡πÅ‡∏°‡∏ß' : '‡∏™‡∏∏‡∏ô‡∏±‡∏Ç',
        sex: animal.sex,
        svc: sNames.join(', ')
      });
    }

    if (svcsToInsert.length > 0) await supabase.from("vasd_service").insert(svcsToInsert);
    if (queuesToInsert.length > 0) await supabase.from("vasd_queue").insert(queuesToInsert);

    // ==========================================
    // ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå
    // ==========================================
    const { data: tmplData } = await supabase.from("vasd_print_template").select("config").eq("template_type", "queue").single();
    
    if (tmplData && tmplData.config) {
      let printHtml = '';
      animalsForPrint.forEach(a => {
        let pageHtml = '<div class="sticker-page">';
        tmplData.config.forEach(l => {
          let text = l.text
            .replace("{{queue_number}}", a.q)
            .replace("{{animal_name}}", a.name)
            .replace("{{species}}", a.spc)
            .replace("{{sex}}", a.sex)
            .replace("{{owner_name}}", ownerName)
            .replace("{{phone}}", phone || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏")
            .replace("{{services}}", a.svc);
          pageHtml += `<div class="line" style="left:${l.x}px; top:${l.y}px; font-size:${l.size}px; font-weight:${l.weight}; font-family:${l.font};">${text}</div>`;
        });
        pageHtml += '</div>';
        printHtml += pageHtml;
      });
      document.getElementById("printArea").innerHTML = printHtml;
      
      window.print();
    }

    setTimeout(() => {
      location.href = "index.html";
    }, 1000);

  } catch (error) {
    console.error("Save Error:", error);
    alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " + (error.message || "‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"));
    btnSave.disabled = false;
    btnSave.innerHTML = "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö ‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏¥‡∏ß";
  }
};
</script>

</body>
</html>
