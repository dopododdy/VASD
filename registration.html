<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>RMUTTO - VASD | ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏±‡∏ï‡∏ß‡πå</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* ================= CSS ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà ================= */
body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background: #f4f6f8; margin: 0; color: #333; }
header {
  background: #fff; border-bottom: 1px solid #ddd;
  padding: 14px 20px; display: flex; justify-content: space-between; align-items: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.02);
}
header h3 { margin: 0; color: #2c7be5; }
.container { max-width: 1200px; margin: auto; padding: 20px; }
.card {
  background: #fff; border-radius: 8px; padding: 20px;
  margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  border: 1px solid #e9ecef;
}
.card h4 { margin-top: 0; margin-bottom: 15px; color: #495057; border-bottom: 2px solid #f4f6f8; padding-bottom: 10px; }

.owner-grid {
  display: grid;
  grid-template-columns: 2fr 1fr auto;
  gap: 12px;
}

input, select, textarea {
  width: 100%; box-sizing: border-box; padding: 10px;
  border: 1px solid #ced4da; border-radius: 4px;
  font-family: inherit; font-size: 14px; transition: border-color 0.15s ease-in-out;
}
input:focus, select:focus, textarea:focus {
  border-color: #80bdff; outline: 0;
  box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
}
textarea { resize: vertical; min-height: 42px; }

/* Responsive Table Wrapper */
.table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
table { width: 100%; border-collapse: collapse; min-width: 800px; }
th, td { border: 1px solid #e9ecef; padding: 10px; text-align: center; vertical-align: middle; }
th { background: #f8f9fa; color: #495057; font-weight: 600; }
tbody tr:nth-child(even) { background: #fcfcfc; }
tbody tr:hover { background: #f1f3f5; }

.service-line { display: flex; gap: 12px; flex-wrap: wrap; justify-content: flex-start; text-align: left; }
.service-line label { display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 13px; }

.important-warning { background: #fff3cd !important; border: 2px solid #ffc107 !important; transition: all 0.3s; }
.important-warning::before { content: "‚ö†Ô∏è "; font-weight: bold; }

button {
  padding: 10px 16px; border: none; border-radius: 4px;
  cursor: pointer; font-weight: bold; font-size: 14px;
  transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 6px;
}
button:hover { opacity: 0.85; transform: translateY(-1px); }
button:active { transform: translateY(0); }
button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

.btn-add { background: #6c757d; color: #fff; }
.btn-save { background: #2c7be5; color: #fff; font-size: 16px; padding: 12px 24px; }
.btn-del { background: #dc3545; color: #fff; padding: 6px 10px; }
.btn-paste { background: #198754; color: #fff; }
.btn-home { background: #e9ecef; color: #495057; }

/* Mobile Adjustments */
@media (max-width: 768px) {
  .owner-grid { grid-template-columns: 1fr; }
  .btn-paste { width: 100%; }
}
</style>
</head>

<body>

<header>
  <h3>üìù RMUTTO - VASD | ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏±‡∏ï‡∏ß‡πå</h3>
  <button class="btn-home" onclick="location.href='index.html'">üè† ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
</header>

<div class="container">

<div class="card">
  <h4>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå</h4>
  <div class="owner-grid">
    <input id="ownerName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)" required>
    <input id="phone" type="tel" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)">
    <button class="btn-paste" onclick="pasteOwnerName()">üìã ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ï‡∏£</button>
  </div>
</div>

<div class="card">
  <h4>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ï‡∏ß‡πå</h4>
  <div class="table-responsive">
    <table>
      <thead>
        <tr>
          <th width="15%">‡∏ä‡∏∑‡πà‡∏≠</th>
          <th width="10%">‡∏ä‡∏ô‡∏¥‡∏î</th>
          <th width="10%">‡πÄ‡∏û‡∏®</th>
          <th width="10%">‡∏ô‡∏ô. (‡∏Å‡∏Å.)</th>
          <th width="25%">‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</th>
          <th width="20%">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û / ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</th>
          <th width="10%">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody id="animalBody"></tbody>
    </table>
  </div>
  <br>
  <button class="btn-add" onclick="addAnimal()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏ï‡∏ß‡πå</button>
</div>

<div class="card" style="text-align:center; background: transparent; border: none; box-shadow: none;">
  <button id="btnSaveAll" class="btn-save" onclick="saveAll()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</button>
</div>

</div>

<script type="module">
import { supabase } from "./js/supabase.js";

/* =========================
   PASTE OWNER NAME
========================= */
window.pasteOwnerName = async function () {
  try {
    const text = await navigator.clipboard.readText();
    if (!text) {
      alert("‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Clipboard");
      return;
    }
    document.getElementById("ownerName").value = text.trim();
    document.getElementById("phone").focus();
  } catch (err) {
    alert("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô Clipboard ‡πÑ‡∏î‡πâ (‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Clipboard)");
  }
};

/* =========================
   FORMAT PHONE
========================= */
const phoneInput = document.getElementById("phone");
phoneInput.addEventListener("input", function() {
  let v = this.value.replace(/\D/g,"").slice(0,10);
  if (v.length > 6) v = v.replace(/(\d{3})(\d{3})(\d+)/,"$1-$2-$3");
  else if (v.length > 3) v = v.replace(/(\d{3})(\d+)/,"$1-$2");
  this.value = v;
});

/* =========================
   SERVICE LOGIC
========================= */
function neuterText(sex) {
  return sex === "‡∏ú‡∏π‡πâ" ? "‡∏ó‡∏≥‡∏´‡∏°‡∏±‡∏ô‡πÄ‡∏û‡∏®‡∏ú‡∏π‡πâ" : "‡∏ó‡∏≥‡∏´‡∏°‡∏±‡∏ô‡πÄ‡∏û‡∏®‡πÄ‡∏°‡∏µ‡∏¢";
}

function serviceHTML(sex, species) {
  return `
    <div class="service-line">
      <label>
        <input type="checkbox" class="svc" checked value="${neuterText(sex)}">
        ${neuterText(sex)}
      </label>
      <label>
        <input type="checkbox" class="svc" value="‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡∏û‡∏¥‡∏©‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏ö‡πâ‡∏≤">
        ‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡∏û‡∏¥‡∏©‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏ö‡πâ‡∏≤
      </label>
      ${species === "‡∏™" ? `
        <label>
          <input type="checkbox" class="svc" value="‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡πá‡∏ö‡∏´‡∏°‡∏±‡∏î">
          ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡πá‡∏ö‡∏´‡∏°‡∏±‡∏î
        </label>` : ""}
    </div>`;
}

/* =========================
   ADD ANIMAL
========================= */
window.addAnimal = function () {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input class="animalName" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠..." required></td>
    <td>
      <select class="species">
        <option value="‡∏°">‡πÅ‡∏°‡∏ß</option>
        <option value="‡∏™">‡∏™‡∏∏‡∏ô‡∏±‡∏Ç</option>
      </select>
    </td>
    <td>
      <select class="sex">
        <option value="‡πÄ‡∏°‡∏µ‡∏¢">‡πÄ‡∏°‡∏µ‡∏¢</option>
        <option value="‡∏ú‡∏π‡πâ">‡∏ú‡∏π‡πâ</option>
      </select>
    </td>
    <td><input type="number" class="estWeight" value="3" min="0" step="0.1"></td>
    <td class="svcCell"></td>
    <td class="noteCell">
      <textarea class="healthNote" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß / ‡∏î‡∏∏ / ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏î‡∏≠‡∏≤‡∏´‡∏≤‡∏£..."></textarea>
    </td>
    <td>
      <button class="btn-del" onclick="this.closest('tr').remove()" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ">üóë ‡∏•‡∏ö</button>
    </td>
  `;

  const species = tr.querySelector(".species");
  const sex = tr.querySelector(".sex");
  const svcCell = tr.querySelector(".svcCell");
  const note = tr.querySelector(".healthNote");
  const noteCell = tr.querySelector(".noteCell");
  const nameInput = tr.querySelector(".animalName");

  // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå
  nameInput.oninput = () => { nameInput.style.backgroundColor = ""; };

  function refreshService() {
    svcCell.innerHTML = serviceHTML(sex.value, species.value);
  }
  
  refreshService();
  species.onchange = refreshService;
  sex.onchange = refreshService;

  // ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ï‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
  note.oninput = () => {
    noteCell.classList.toggle("important-warning", note.value.trim() !== "");
  };

  document.getElementById("animalBody").appendChild(tr);
};

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏™‡∏±‡∏ï‡∏ß‡πå 1 ‡∏ï‡∏±‡∏ß‡πÄ‡∏™‡∏°‡∏≠
window.addEventListener('DOMContentLoaded', () => {
  addAnimal();
});

/* =========================
   SAVE (REAL + VALIDATE)
========================= */
window.saveAll = async function () {
  const btnSave = document.getElementById("btnSaveAll");
  const ownerNameInput = document.getElementById("ownerName");
  const ownerName = ownerNameInput.value.trim();
  const phone = document.getElementById("phone").value.trim();

  // Validate Owner
  if (!ownerName) {
    alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå");
    ownerNameInput.focus();
    return;
  }

  const rows = document.querySelectorAll("#animalBody tr");
  if (rows.length === 0) {
    alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
    return;
  }

  // Validate Animals
  let hasError = false;
  rows.forEach((row, index) => {
    const nameInput = row.querySelector(".animalName");
    if (!nameInput.value.trim()) {
      alert(`‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${index + 1}`);
      nameInput.focus();
      nameInput.style.backgroundColor = "#ffecec";
      hasError = true;
    }
  });
  if (hasError) return;

  // Lock UI & Start Loading
  btnSave.disabled = true;
  btnSave.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";

  try {
    // 1. Get Event ID
    const { data: eventId, error: evtErr } = await supabase.rpc("get_today_event");
    if (evtErr) throw evtErr;

    // 2. Insert Owner
    const { data: owner, error: ownerErr } = await supabase
      .from("vasd_owner")
      .insert({ event_id: eventId, owner_name: ownerName, phone: phone })
      .select()
      .single();
    if (ownerErr) throw ownerErr;

    // 3. Get latest queue number
    const { count, error: countErr } = await supabase
      .from("vasd_animal")
      .select("*", { count: "exact", head: true })
      .eq("event_id", eventId);
    if (countErr) throw countErr;

    let currentQueue = (count || 0) + 1;

    // 4. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤ ID ‡∏°‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Service ‡πÅ‡∏•‡∏∞ Queue
    let svcsToInsert = [];
    let queuesToInsert = [];

    for (const r of rows) {
      const { data: animal, error: animalErr } = await supabase
        .from("vasd_animal")
        .insert({
          event_id: eventId,
          owner_id: owner.id,
          queue_number: currentQueue++,
          species: r.querySelector(".species").value,
          animal_name: r.querySelector(".animalName").value.trim(),
          sex: r.querySelector(".sex").value,
          est_weight: r.querySelector(".estWeight").value || 0,
          health_note: r.querySelector(".healthNote").value.trim()
        })
        .select()
        .single();
      
      if (animalErr) throw animalErr;

      // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Services
      r.querySelectorAll(".svc:checked").forEach(s => {
        svcsToInsert.push({ animal_id: animal.id, service_type: s.value });
      });

      // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Queue
      queuesToInsert.push({ animal_id: animal.id, status: "registered" });
    }

    // 5. Batch Insert ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Service ‡πÅ‡∏•‡∏∞ Queue (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô)
    if (svcsToInsert.length > 0) {
      const { error: svcErr } = await supabase.from("vasd_service").insert(svcsToInsert);
      if (svcErr) throw svcErr;
    }
    
    if (queuesToInsert.length > 0) {
      const { error: qErr } = await supabase.from("vasd_queue").insert(queuesToInsert);
      if (qErr) throw qErr;
    }

    alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
    location.href = "index.html";

  } catch (error) {
    console.error("Save Error:", error);
    alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " + (error.message || "‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"));
  } finally {
    // Unlock UI
    btnSave.disabled = false;
    btnSave.innerHTML = "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö";
  }
};
</script>

</body>
</html>
