<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>RMUTTO - VASD | ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏±‡∏ï‡∏ß‡πå</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family:Segoe UI, sans-serif; background:#f4f6f8; margin:0; }
header {
  background:#fff; border-bottom:1px solid #ddd;
  padding:14px 20px; display:flex; justify-content:space-between;
}
.container { max-width:1600px; margin:auto; padding:20px; }
.card {
  background:#fff; border-radius:10px; padding:20px;
  margin-bottom:20px; box-shadow:0 2px 6px rgba(0,0,0,.05);
}
.owner-grid {
  display:grid;
  grid-template-columns: 2fr 1fr auto;
  gap:12px;
}
input, select, textarea {
  width:100%; box-sizing:border-box; padding:6px;
}
table { width:100%; border-collapse:collapse; }
th, td { border:1px solid #ddd; padding:6px; text-align:center; }
tbody tr:nth-child(even) { background:#f9fbff; }

.service-line { display:flex; gap:16px; flex-wrap:wrap; }

.important-warning {
  background:#fff3cd;
  border:2px solid #ff9800;
}
.important-warning::before {
  content:"‚ö†Ô∏è ";
  font-weight:bold;
}

button {
  padding:8px 12px; border:none; border-radius:6px;
  cursor:pointer; font-weight:bold;
}
.btn-add{background:#6c757d;color:#fff;}
.btn-save{background:#2c7be5;color:#fff;}
.btn-del{background:#dc3545;color:#fff;}
.btn-paste{background:#198754;color:#fff;}
</style>
</head>

<body>

<header>
  <h3>üìù RMUTTO - VASD | ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏±‡∏ï‡∏ß‡πå</h3>
  <button onclick="location.href='index.html'">üè† Home</button>
</header>

<div class="container">

<!-- ================= OWNER ================= -->
<div class="card">
  <h4>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå</h4>
  <div class="owner-grid">
    <input id="ownerName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå">
    <input id="phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)">
    <button class="btn-paste" onclick="pasteOwnerName()">üìã ‡∏ß‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠</button>
  </div>
</div>

<!-- ================= ANIMAL ================= -->
<div class="card">
  <h4>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ï‡∏ß‡πå</h4>
  <table>
    <thead>
      <tr>
        <th>‡∏ä‡∏∑‡πà‡∏≠</th>
        <th>‡∏ä‡∏ô‡∏¥‡∏î</th>
        <th>‡πÄ‡∏û‡∏®</th>
        <th>‡∏ô‡∏ô. (‡∏Å‡∏Å.)</th>
        <th>‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£</th>
        <th>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</th>
        <th>‡∏•‡∏ö</th>
      </tr>
    </thead>
    <tbody id="animalBody"></tbody>
  </table>
  <br>
  <button class="btn-add" onclick="addAnimal()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ï‡∏ß‡πå</button>
</div>

<!-- ================= SAVE ================= -->
<div class="card" style="text-align:center">
  <button class="btn-save" onclick="saveAll()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
</div>

</div>

<script type="module">
import { supabase } from "./js/supabase.js";

/* =========================
   PASTE OWNER NAME
========================= */
window.pasteOwnerName = async function () {
  try {
    const text = await navigator.clipboard.readText();
    if (!text) {
      alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô");
      return;
    }
    document.getElementById("ownerName").value = text;
    document.getElementById("phone").focus();
  } catch {
    alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô Clipboard ‡πÑ‡∏î‡πâ (‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ Chrome ‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°)");
  }
};

/* =========================
   FORMAT PHONE
========================= */
const phoneInput = document.getElementById("phone");
phoneInput.addEventListener("input", () => {
  let v = phoneInput.value.replace(/\D/g,"").slice(0,10);
  if (v.length > 6) v = v.replace(/(\d{3})(\d{3})(\d+)/,"$1-$2-$3");
  else if (v.length > 3) v = v.replace(/(\d{3})(\d+)/,"$1-$2");
  phoneInput.value = v;
});

/* =========================
   SERVICE
========================= */
function neuterText(sex) {
  return sex === "‡∏ú‡∏π‡πâ" ? "‡∏ó‡∏≥‡∏´‡∏°‡∏±‡∏ô‡πÄ‡∏û‡∏®‡∏ú‡∏π‡πâ" : "‡∏ó‡∏≥‡∏´‡∏°‡∏±‡∏ô‡πÄ‡∏û‡∏®‡πÄ‡∏°‡∏µ‡∏¢";
}

function serviceHTML(sex, species) {
  return `
    <div class="service-line">
      <label>
        <input type="checkbox" class="svc" checked value="${neuterText(sex)}">
        ${neuterText(sex)}
      </label>
      <label>
        <input type="checkbox" class="svc" value="‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡∏û‡∏¥‡∏©‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏ö‡πâ‡∏≤">
        ‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡∏û‡∏¥‡∏©‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏ö‡πâ‡∏≤
      </label>
      ${species==="‡∏™" ? `
        <label>
          <input type="checkbox" class="svc" value="‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡πá‡∏ö‡∏´‡∏°‡∏±‡∏î">
          ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡πá‡∏ö‡∏´‡∏°‡∏±‡∏î
        </label>` : ""}
    </div>`;
}

/* =========================
   ADD ANIMAL
========================= */
window.addAnimal = function () {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input class="animalName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå (‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á)"></td>
    <td>
      <select class="species">
        <option value="‡∏°">‡πÅ‡∏°‡∏ß</option>
        <option value="‡∏™">‡∏™‡∏∏‡∏ô‡∏±‡∏Ç</option>
      </select>
    </td>
    <td>
      <select class="sex">
        <option value="‡πÄ‡∏°‡∏µ‡∏¢">‡πÄ‡∏°‡∏µ‡∏¢</option>
        <option value="‡∏ú‡∏π‡πâ">‡∏ú‡∏π‡πâ</option>
      </select>
    </td>
    <td><input type="number" value="3" min="0"></td>
    <td class="svcCell"></td>
    <td class="noteCell">
      <textarea placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏£‡∏Ñ‡∏´‡∏±‡∏ß‡πÉ‡∏à / ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏î‡∏≠‡∏≤‡∏´‡∏≤‡∏£"></textarea>
    </td>
    <td>
      <button class="btn-del" onclick="this.closest('tr').remove()">üóë</button>
    </td>
  `;

  const species = tr.querySelector(".species");
  const sex = tr.querySelector(".sex");
  const svcCell = tr.querySelector(".svcCell");
  const note = tr.querySelector("textarea");
  const noteCell = tr.querySelector(".noteCell");

  function refreshService() {
    svcCell.innerHTML = serviceHTML(sex.value, species.value);
  }
  refreshService();
  species.onchange = refreshService;
  sex.onchange = refreshService;

  note.oninput = () => {
    noteCell.classList.toggle("important-warning", note.value.trim() !== "");
  };

  document.getElementById("animalBody").appendChild(tr);
};

/* =========================
   SAVE (REAL + VALIDATE)
========================= */
window.saveAll = async function () {
  const ownerName = document.getElementById("ownerName").value.trim();
  const phone = document.getElementById("phone").value.trim();

  if (!ownerName) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå");
    document.getElementById("ownerName").focus();
    return;
  }

  const rows = document.querySelectorAll("#animalBody tr");
  if (rows.length === 0) {
    alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ï‡∏ß‡πå");
    return;
  }

  /* ===== VALIDATE ANIMAL NAME ===== */
  for (let i = 0; i < rows.length; i++) {
    const nameInput = rows[i].querySelector(".animalName");
    const name = nameInput.value.trim();

    if (!name) {
      alert(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå (‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${i + 1})`);
      nameInput.focus();
      nameInput.style.backgroundColor = "#ffecec";
      return;
    } else {
      nameInput.style.backgroundColor = "";
    }
  }

  /* ===== SAVE TO SUPABASE ===== */
  const { data: eventId } = await supabase.rpc("get_today_event");

  const { data: owner } = await supabase
    .from("vasd_owner")
    .insert({ event_id: eventId, owner_name: ownerName, phone })
    .select().single();

  const { count } = await supabase
    .from("vasd_animal")
    .select("*", { count:"exact", head:true })
    .eq("event_id", eventId);

  let q = (count || 0) + 1;

  for (const r of rows) {
    const { data: animal } = await supabase
      .from("vasd_animal")
      .insert({
        event_id: eventId,
        owner_id: owner.id,
        queue_number: q++,
        species: r.querySelector(".species").value,
        animal_name: r.querySelector(".animalName").value.trim(),
        sex: r.querySelector(".sex").value,
        est_weight: r.querySelector("input[type=number]").value,
        health_note: r.querySelector("textarea").value
      })
      .select().single();

    const svcs = [];
    r.querySelectorAll(".svc:checked").forEach(s =>
      svcs.push({ animal_id: animal.id, service_type: s.value })
    );
    if (svcs.length) {
      await supabase.from("vasd_service").insert(svcs);
    }

    await supabase.from("vasd_queue").insert({
      animal_id: animal.id,
      status: "registered"
    });
  }

  alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
  location.href = "index.html";
};
</script>

</body>
</html>
