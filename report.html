<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>à¸£à¸²à¸¢à¸‡à¸²à¸™à¸ªà¸£à¸¸à¸›à¸œà¸¥ â€“ RMUTTO VASD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DESIGN TOKENS (Shared with index.html)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --navy:       #0b1929;
  --navy-mid:   #112240;
  --navy-card:  #162d4a;
  --teal:       #0ea5a0;
  --teal-light: #14c4bc;
  --teal-glow:  rgba(14,165,160,0.25);
  --surface:    rgba(255,255,255,0.04);
  --border:     rgba(255,255,255,0.08);
  --text:       #e2e8f0;
  --text-dim:   #94a3b8;
  --radius-lg:  22px;
  --radius-sm:  10px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: "Sarabun", "Outfit", sans-serif;
  background: var(--navy);
  color: var(--text);
  min-height: 100vh;
  display: flex; flex-direction: column;
}

/* Mesh background */
body::before {
  content: ""; position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background: radial-gradient(ellipse 60% 50% at 20% 10%, rgba(14,165,160,0.12) 0%, transparent 70%);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER & LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
header {
  position: sticky; top: 0; z-index: 200;
  background: rgba(11,25,41,0.85);
  backdrop-filter: blur(20px); border-bottom: 1px solid var(--border);
  padding: 10px 20px; display: flex; align-items: center; justify-content: space-between;
}
.brand { display: flex; align-items: center; gap: 10px; }
.brand-logo {
  width: 42px; height: 34px; background: linear-gradient(135deg, var(--teal), var(--teal-light));
  border-radius: 8px; display: flex; align-items: center; justify-content: center;
}
.brand-name { font-family: "Outfit", sans-serif; font-size: 15px; font-weight: 700; color: #fff; }

.wrap {
  position: relative; z-index: 1;
  max-width: 900px; margin: 0 auto;
  padding: 24px 18px 100px; width: 100%;
}

.section-header {
  display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
}
.title-group h2 { font-family: "Outfit", sans-serif; font-size: 22px; color: #fff; }
.title-group p { font-size: 13px; color: var(--text-dim); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REPORT CARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.report-list { display: flex; flex-direction: column; gap: 16px; }

.report-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius-lg); padding: 20px;
  animation: slideUp 0.4s ease both;
}

.card-top {
  display: flex; justify-content: space-between; align-items: flex-start;
  border-bottom: 1px solid var(--border); padding-bottom: 12px; margin-bottom: 12px;
}
.animal-info h3 { color: var(--teal-light); font-size: 18px; margin-bottom: 2px; }
.q-badge {
  background: var(--teal); color: #fff; padding: 4px 12px;
  border-radius: 30px; font-weight: 700; font-family: "Outfit"; font-size: 14px;
}

.data-grid {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px; margin-bottom: 16px;
}
.data-item label { display: block; font-size: 11px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 4px; }
.data-item span { font-size: 14px; color: var(--text); }

/* Vitals Table Style */
.vitals-scroll { overflow-x: auto; background: rgba(0,0,0,0.2); border-radius: 12px; padding: 10px; margin-top: 10px; }
.vitals-table { width: 100%; border-collapse: collapse; font-size: 12px; text-align: center; }
.vitals-table th { color: var(--teal-light); padding: 8px; border-bottom: 1px solid var(--border); }
.vitals-table td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); }

.tag-container { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 4px; }
.tag { background: var(--navy-mid); border: 1px solid var(--border); padding: 2px 8px; border-radius: 6px; font-size: 12px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOTTOM NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bottom-nav {
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 300;
  background: rgba(11,25,41,0.95); backdrop-filter: blur(20px);
  border-top: 1px solid rgba(255,255,255,0.1);
  padding: 8px 0 max(8px, env(safe-area-inset-bottom));
  display: grid; grid-template-columns: repeat(5, 1fr);
}
.nav-item {
  display: flex; flex-direction: column; align-items: center; gap: 3px;
  font-size: 9px; color: var(--text-dim); text-decoration: none;
}
.nav-item.active { color: var(--teal); }
.nav-icon { font-size: 21px; }

@keyframes slideUp {
  from { opacity: 0; transform: translateY(15px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="brand-logo">ğŸ“Š</div>
    <div class="brand-name">VASD REPORT</div>
  </div>
  <button class="btn-logout" onclick="location.href='index.html'" style="background:none; border:1px solid var(--border); color:var(--text-dim); padding:5px 12px; border-radius:8px; cursor:pointer;">Back</button>
</header>

<div class="wrap">
  <div class="section-header">
    <div class="title-group">
      <h2>à¸ªà¸£à¸¸à¸›à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸„à¸ª</h2>
      <p>à¸£à¸²à¸¢à¸à¸²à¸£à¸ªà¸±à¸•à¸§à¹Œà¸—à¸µà¹ˆà¸£à¸±à¸à¸©à¸²à¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸´à¹‰à¸™à¹à¸¥à¸°à¸£à¸±à¸šà¸à¸¥à¸±à¸šà¸šà¹‰à¸²à¸™à¹à¸¥à¹‰à¸§</p>
    </div>
  </div>

  <div id="reportContainer" class="report-list">
    <div style="text-align:center; padding:40px; color:var(--text-dim);">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸£à¸²à¸¢à¸‡à¸²à¸™...</div>
  </div>
</div>

<nav class="bottom-nav">
  <a class="nav-item" href="index.html"><span class="nav-icon">ğŸ </span>à¸«à¸™à¹‰à¸²à¸«à¸¥à¸±à¸</a>
  <a class="nav-item" href="animals.html"><span class="nav-icon">ğŸ¾</span>à¸ªà¸±à¸•à¸§à¹Œ</a>
  <a class="nav-item" href="anesthesia.html"><span class="nav-icon">ğŸ’‰</span>à¸§à¸²à¸‡à¸¢à¸²</a>
  <a class="nav-item" href="surgery.html"><span class="nav-icon">ğŸ›ï¸</span>à¸œà¹ˆà¸²à¸•à¸±à¸”</a>
  <a class="nav-item active" href="report.html"><span class="nav-icon">ğŸ“Š</span>à¸£à¸²à¸¢à¸‡à¸²à¸™</a>
</nav>

<script type="module">
import { supabase } from "./js/supabase.js";

async function loadReport() {
  const container = document.getElementById("reportContainer");
  
  // 1. à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸±à¸•à¸§à¹Œà¸—à¸µà¹ˆà¸¡à¸µà¸„à¸´à¸§à¸ªà¸–à¸²à¸™à¸° 'done'
  const { data: animals, error } = await supabase
    .from('vasd_animal')
    .select(`
      *,
      vasd_owner(owner_name, phone),
      vasd_queue!inner(status, surgeon_name, anesthesiologist_name),
      vasd_service(*),
      vasd_vital_signs(*),
      vasd_prescription(*)
    `)
    .eq('vasd_queue.status', 'done')
    .order('queue_number', { ascending: true });

  if (error) {
    container.innerHTML = `<div style="color:var(--rose)">Error: ${error.message}</div>`;
    return;
  }

  if (!animals || animals.length === 0) {
    container.innerHTML = `<div style="text-align:center; padding:40px; color:var(--text-dim);">à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸±à¸•à¸§à¹Œà¸—à¸µà¹ˆà¸—à¸³à¸£à¸²à¸¢à¸à¸²à¸£à¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸´à¹‰à¸™</div>`;
    return;
  }

  container.innerHTML = "";

  animals.forEach(ani => {
    const card = document.createElement("div");
    card.className = "report-card";

    // à¸ˆà¸±à¸”à¸à¸²à¸£à¸«à¸±à¸•à¸–à¸à¸²à¸£
    const services = ani.vasd_service.map(s => `<span class="tag">${s.service_type} ${s.is_done ? 'âœ…' : ''}</span>`).join("");
    
    // à¸ˆà¸±à¸”à¸à¸²à¸£à¸¢à¸²à¸à¸¥à¸±à¸šà¸šà¹‰à¸²à¸™
    const meds = ani.vasd_prescription.map(m => `<div class="tag" style="display:block; margin-bottom:4px;">ğŸ’Š ${m.drug_id}: ${m.dose} (${m.freq}) x ${m.days} à¸§à¸±à¸™</div>`).join("");

    // à¸ˆà¸±à¸”à¸à¸²à¸£à¸•à¸²à¸£à¸²à¸‡ Vitals
    let vitalsHtml = "";
    if (ani.vasd_vital_signs.length > 0) {
      vitalsHtml = `
        <div class="vitals-scroll">
          <table class="vitals-table">
            <thead>
              <tr>
                <th>à¹€à¸§à¸¥à¸²</th><th>HR</th><th>RR</th><th>SpO2</th><th>Temp</th><th>CRT/MM</th>
              </tr>
            </thead>
            <tbody>
              ${ani.vasd_vital_signs.map(v => `
                <tr>
                  <td>${v.time_recorded || '-'}</td>
                  <td>${v.hr || '-'}</td>
                  <td>${v.rr || '-'}</td>
                  <td>${v.spo2 || '-'}</td>
                  <td>${v.temp || '-'}</td>
                  <td>${v.crt || '-'}/${v.mm || '-'}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
      `;
    }

    card.innerHTML = `
      <div class="card-top">
        <div class="animal-info">
          <h3>${ani.animal_name} (${ani.species === 'à¸ª' ? 'à¸ªà¸¸à¸™à¸±à¸‚' : 'à¹à¸¡à¸§'})</h3>
          <p style="font-size:13px; color:var(--text-dim)">à¹€à¸à¸¨ ${ani.sex} | à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¸ˆà¸£à¸´à¸‡: ${ani.actual_weight || ani.est_weight || '-'} kg</p>
        </div>
        <div class="q-badge">Q-${ani.queue_number}</div>
      </div>

      <div class="data-grid">
        <div class="data-item">
          <label>à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸ˆà¹‰à¸²à¸‚à¸­à¸‡</label>
          <span>${ani.vasd_owner?.owner_name || '-'} (${ani.vasd_owner?.phone || '-'})</span>
        </div>
        <div class="data-item">
          <label>à¸—à¸µà¸¡à¸œà¹ˆà¸²à¸•à¸±à¸”/à¸§à¸²à¸‡à¸¢à¸²</label>
          <span>à¸«à¸¡à¸­: ${ani.vasd_queue[0]?.surgeon_name || '-'}<br>à¸”à¸¡à¸¢à¸²: ${ani.vasd_queue[0]?.anesthesiologist_name || '-'}</span>
        </div>
        <div class="data-item">
          <label>à¸«à¸±à¸•à¸–à¸à¸²à¸£à¸—à¸µà¹ˆà¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£</label>
          <div class="tag-container">${services || 'à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥'}</div>
        </div>
        <div class="data-item">
          <label>à¸¢à¸²à¸à¸¥à¸±à¸šà¸šà¹‰à¸²à¸™ (RX)</label>
          <div style="margin-top:5px;">${meds || '<span style="color:var(--text-faint)">à¹„à¸¡à¹ˆà¸¡à¸µà¸à¸²à¸£à¸ˆà¹ˆà¸²à¸¢à¸¢à¸²</span>'}</div>
        </div>
      </div>

      <label style="font-size:11px; color:var(--teal-light); font-weight:700; text-transform:uppercase;">à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸±à¸à¸à¸²à¸“à¸Šà¸µà¸ (Vitals History)</label>
      ${vitalsHtml || '<div style="font-size:12px; color:var(--text-faint); margin-top:5px;">à¹„à¸¡à¹ˆà¸¡à¸µà¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸±à¸à¸à¸²à¸“à¸Šà¸µà¸</div>'}
      
      ${ani.health_note ? `
        <div style="margin-top:15px; padding:10px; background:rgba(245,158,11,0.1); border-radius:8px; font-size:13px;">
          <strong style="color:var(--amber)">Note:</strong> ${ani.health_note}
        </div>
      ` : ''}
    `;

    container.appendChild(card);
  });
}

// à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸›à¸´à¸”à¸«à¸™à¹‰à¸²
loadReport();
</script>
<script type="module" src="./js/global-alarm.js"></script>
</body>
</html>
