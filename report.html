<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>à¸£à¸²à¸¢à¸‡à¸²à¸™à¸ªà¸£à¸¸à¸›à¸œà¸¥ â€“ RMUTTO VASD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOKENS & THEME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --navy:         #0b1929;
  --navy-mid:     #112240;
  --teal:         #0ea5a0;
  --teal-light:   #14c4bc;
  --teal-glow:    rgba(14,165,160,0.25);
  --rose:         #ef4444;
  --rose-soft:    rgba(239,68,68,0.12);
  --surface:      rgba(255,255,255,0.04);
  --surface-2:    rgba(255,255,255,0.07);
  --border:       rgba(255,255,255,0.08);
  --border-2:     rgba(255,255,255,0.14);
  --text:         #e2e8f0;
  --text-dim:     #94a3b8;
  --text-faint:   #4a5568;
  --radius-sm:    10px;
  --radius:       16px;
  --radius-lg:    22px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: "Sarabun", sans-serif;
  background: var(--navy); color: var(--text);
  min-height: 100vh; display: flex; flex-direction: column;
}

body::before {
  content: ""; position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background: radial-gradient(ellipse 60% 50% at 20% 10%, rgba(14,165,160,0.12) 0%, transparent 70%);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
header {
  position: sticky; top: 0; z-index: 200;
  background: rgba(11,25,41,0.85);
  backdrop-filter: blur(20px) saturate(180%);
  border-bottom: 1px solid var(--border);
  padding: 12px 20px; display: flex; align-items: center; justify-content: space-between;
}
.brand { display: flex; align-items: center; gap: 10px; }
.brand-logo {
  width: 38px; height: 38px; background: linear-gradient(135deg, var(--teal), var(--teal-light));
  border-radius: 10px; display: flex; align-items: center; justify-content: center;
  font-size: 18px; box-shadow: 0 0 20px var(--teal-glow);
}
.brand-name { font-family: "Outfit", sans-serif; font-size: 16px; font-weight: 700; color: #fff; }
.brand-sub { font-size: 10px; color: var(--text-dim); margin-top: 2px; }

.btn-home {
  padding: 8px 14px; font-size: 12px; font-weight: 600; font-family: "Sarabun", sans-serif;
  background: var(--surface-2); color: var(--text-dim);
  border: 1px solid var(--border-2); border-radius: var(--radius-sm); cursor: pointer;
  transition: all 0.2s; text-decoration: none; display: inline-flex; align-items: center; gap: 5px;
}
.btn-home:hover { background: var(--surface); color: var(--text); border-color: var(--teal); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN WRAPPER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.wrap {
  position: relative; z-index: 1;
  max-width: 1000px; margin: 0 auto;
  padding: 24px 16px 100px; width: 100%;
}

.action-bar {
  display: flex; justify-content: space-between; align-items: flex-end;
  margin-bottom: 24px; flex-wrap: wrap; gap: 14px;
}
.section-title h2 { font-family: "Outfit", sans-serif; font-size: 24px; color: #fff; line-height: 1.2; }
.section-title p { font-size: 13px; color: var(--text-dim); margin-top: 4px; }

.export-btns { display: flex; gap: 10px; }
.btn-export {
  padding: 10px 16px; font-size: 13px; font-weight: 600; font-family: "Sarabun", sans-serif;
  border-radius: var(--radius-sm); cursor: pointer; display: inline-flex; align-items: center; gap: 8px;
  transition: all 0.2s; border: 1px solid transparent;
}
.btn-csv { background: rgba(16,185,129,0.15); color: #6ee7b7; border-color: rgba(16,185,129,0.3); }
.btn-csv:hover { background: rgba(16,185,129,0.25); }
.btn-pdf { background: rgba(239,68,68,0.15); color: #fca5a5; border-color: rgba(239,68,68,0.3); }
.btn-pdf:hover { background: rgba(239,68,68,0.25); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REPORT CARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.report-list { display: flex; flex-direction: column; gap: 16px; }

.report-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 20px;
  animation: slideUp 0.4s ease both; box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

.card-top {
  display: flex; justify-content: space-between; align-items: flex-start;
  border-bottom: 1px solid var(--border); padding-bottom: 14px; margin-bottom: 14px;
}
.animal-info h3 { color: #fff; font-size: 18px; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
.animal-info p { font-size: 12px; color: var(--text-dim); }
.q-badge {
  background: var(--surface-2); border: 1px solid var(--border-2);
  color: #fff; padding: 6px 14px; border-radius: 30px; 
  font-weight: 800; font-family: "Outfit", sans-serif; font-size: 16px;
}

.data-grid {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 16px; margin-bottom: 16px;
}
.data-item { background: var(--surface-2); padding: 12px; border-radius: var(--radius-sm); border: 1px solid var(--border-2); }
.data-item label { display: block; font-size: 10px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 6px; font-weight: 700; letter-spacing: 0.5px; }
.data-item span { font-size: 13px; color: var(--text); line-height: 1.4; display: block; }

/* Tags & Badges */
.tag-container { display: flex; flex-wrap: wrap; gap: 6px; }
.tag-svc { background: rgba(14,165,160,0.15); color: var(--teal-light); border: 1px solid rgba(14,165,160,0.3); padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }
.tag-med { background: rgba(139,92,246,0.15); color: #c4b5fd; border: 1px solid rgba(139,92,246,0.3); padding: 4px 10px; border-radius: 6px; font-size: 11px; margin-bottom: 4px; display: inline-block; }

/* Health Note (Red) */
.health-note {
  display: flex; align-items: flex-start; gap: 10px;
  background: var(--rose-soft); border: 1px solid rgba(239,68,68,0.2);
  border-radius: var(--radius-sm); padding: 12px 14px; margin-bottom: 16px; color: var(--rose);
}

/* Vitals Table */
.vitals-section-title { font-size: 11px; color: var(--teal-light); font-weight: 700; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px; }
.vitals-scroll { overflow-x: auto; background: var(--navy-mid); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 0; }
.vitals-table { width: 100%; border-collapse: collapse; font-size: 12px; text-align: center; }
.vitals-table th { color: var(--text-dim); padding: 10px 8px; border-bottom: 1px solid var(--border); font-weight: 600; background: rgba(0,0,0,0.2); }
.vitals-table td { padding: 10px 8px; border-bottom: 1px solid var(--border); }
.vitals-table tr:last-child td { border-bottom: none; }

/* Bottom Nav */
.bottom-nav {
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 300;
  background: rgba(11,25,41,0.95); backdrop-filter: blur(20px); border-top: 1px solid var(--border-2);
  padding: 8px 0 max(8px, env(safe-area-inset-bottom)); display: grid; grid-template-columns: repeat(5, 1fr);
}
.nav-item { display: flex; flex-direction: column; align-items: center; gap: 3px; font-size: 9px; color: var(--text-dim); text-decoration: none; transition: color 0.2s; }
.nav-item.active { color: var(--teal); }
.nav-icon { font-size: 21px; }

@keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

@media (max-width: 640px) {
  .export-btns { width: 100%; }
  .btn-export { flex: 1; justify-content: center; }
}
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="brand-logo">ğŸ“Š</div>
    <div>
      <div class="brand-name">à¸ªà¸£à¸¸à¸›à¸£à¸²à¸¢à¸‡à¸²à¸™à¸œà¸¥</div>
      <div class="brand-sub">RMUTTO VASD</div>
    </div>
  </div>
  <a href="index.html" class="btn-home">ğŸ  à¸«à¸™à¹‰à¸²à¸«à¸¥à¸±à¸</a>
</header>

<div class="wrap">
  <div class="action-bar">
    <div class="section-title">
      <h2>à¸£à¸²à¸¢à¸‡à¸²à¸™à¹€à¸„à¸ªà¸—à¸µà¹ˆà¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸´à¹‰à¸™à¹à¸¥à¹‰à¸§</h2>
      <p>à¸£à¸²à¸¢à¸à¸²à¸£à¸ªà¸±à¸•à¸§à¹Œà¸—à¸µà¹ˆà¸£à¸±à¸à¸©à¸²à¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸´à¹‰à¸™à¹à¸¥à¸°à¸£à¸±à¸šà¸à¸¥à¸±à¸šà¸šà¹‰à¸²à¸™à¹à¸¥à¹‰à¸§</p>
    </div>
    <div class="export-btns">
      <button class="btn-export btn-csv" onclick="exportCSV()">ğŸ“„ CSV (à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”)</button>
      <button class="btn-export btn-pdf" onclick="exportPDF()">ğŸ–¨ï¸ à¸à¸´à¸¡à¸à¹Œ (à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”)</button>
    </div>
  </div>

  <div id="reportContainer" class="report-list">
    <div style="text-align:center; padding:60px 20px; color:var(--text-dim);">
      <div style="font-size:40px; margin-bottom:10px;">â³</div>
      à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸£à¸²à¸¢à¸‡à¸²à¸™...
    </div>
  </div>
</div>

<nav class="bottom-nav">
  <a class="nav-item" href="index.html"><span class="nav-icon">ğŸ </span>à¸«à¸™à¹‰à¸²à¸«à¸¥à¸±à¸</a>
  <a class="nav-item" href="animals.html"><span class="nav-icon">ğŸ¾</span>à¸ªà¸±à¸•à¸§à¹Œ</a>
  <a class="nav-item" href="anesthesia.html"><span class="nav-icon">ğŸ’‰</span>à¸§à¸²à¸‡à¸¢à¸²</a>
  <a class="nav-item" href="surgery.html"><span class="nav-icon">ğŸ›ï¸</span>à¸œà¹ˆà¸²à¸•à¸±à¸”</a>
  <a class="nav-item active" href="report.html"><span class="nav-icon">ğŸ“Š</span>à¸£à¸²à¸¢à¸‡à¸²à¸™</a>
</nav>

<script type="module">
import { supabase } from "./js/supabase.js";

let globalReportData = []; // à¹€à¸à¹‡à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸Šà¹‰à¸•à¸­à¸™ Export

function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

async function loadReport() {
  const container = document.getElementById("reportContainer");
  
  // ğŸŸ¢ à¹à¸à¹‰à¸›à¸±à¸à¸«à¸²à¹€à¸”à¹‡à¸”à¸‚à¸²à¸”: à¹€à¸­à¸²à¸à¸²à¸£à¸à¸£à¸­à¸‡ Event à¸­à¸­à¸à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” 
  // à¹ƒà¸«à¹‰à¸”à¸¶à¸‡ "à¸—à¸¸à¸à¹€à¸„à¸ª" à¸—à¸µà¹ˆà¸œà¹ˆà¸²à¸•à¸±à¸”à¹€à¸ªà¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§ (done) à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¸à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸‚à¸¶à¹‰à¸™à¸¡à¸²à¹à¸ªà¸”à¸‡à¹€à¸ªà¸¡à¸­
  const { data: animals, error } = await supabase
    .from('vasd_animal')
    .select(`
      *,
      vasd_owner(owner_name, phone),
      vasd_queue!inner(status, operating_table, surgeon_name, anesthetist),
      vasd_service(*),
      vasd_vital_signs(*),
      vasd_prescription(*)
    `)
    .eq('vasd_queue.status', 'done')
    .order('queue_number', { ascending: true }); // à¹€à¸£à¸µà¸¢à¸‡à¸•à¸²à¸¡à¸¥à¸³à¸”à¸±à¸šà¸„à¸´à¸§

  if (error) {
    container.innerHTML = `<div style="text-align:center; padding:40px; color:var(--rose)">à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”: ${error.message}</div>`;
    return;
  }

  if (!animals || animals.length === 0) {
    container.innerHTML = `<div style="text-align:center; padding:60px 20px; color:var(--text-dim); background:var(--surface); border-radius:var(--radius); border:1px dashed var(--border);">à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸„à¸ªà¸—à¸µà¹ˆà¸£à¸±à¸à¸©à¸²à¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸´à¹‰à¸™</div>`;
    globalReportData = [];
    return;
  }

  globalReportData = animals; // à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸³à¸«à¸£à¸±à¸š Export
  container.innerHTML = "";

  animals.forEach((ani, idx) => {
    const card = document.createElement("div");
    card.className = "report-card";
    card.style.animationDelay = `${idx * 0.05}s`;

    // Services
    const services = ani.vasd_service?.length > 0 
      ? ani.vasd_service.map(s => `<span class="tag-svc">${s.service_type} ${s.is_done ? 'âœ…' : ''}</span>`).join("")
      : '<span style="color:var(--text-faint); font-size:12px;">à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸£à¸°à¸šà¸¸</span>';
    
    // Medications
    const meds = ani.vasd_prescription?.length > 0
      ? ani.vasd_prescription.map(m => `<div class="tag-med">ğŸ’Š ${m.drug_id}: ${m.dose} (${m.freq}) x ${m.days} à¸§à¸±à¸™</div>`).join(" ")
      : '<span style="color:var(--text-faint); font-size:12px;">à¹„à¸¡à¹ˆà¸¡à¸µà¸à¸²à¸£à¸ˆà¹ˆà¸²à¸¢à¸¢à¸²</span>';

    // Vitals
    const sortedVitals = (ani.vasd_vital_signs || []).sort((x, y) => new Date(x.created_at) - new Date(y.created_at));
    let vitalsHtml = "";
    if (sortedVitals.length > 0) {
      vitalsHtml = `
        <div class="vitals-section-title">ğŸ“Š à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸±à¸à¸à¸²à¸“à¸Šà¸µà¸ (Vitals History)</div>
        <div class="vitals-scroll">
          <table class="vitals-table">
            <thead>
              <tr><th>à¹€à¸§à¸¥à¸²</th><th>HR</th><th>RR</th><th>SpO2</th><th>Temp</th><th>Zol. (Top)</th><th>à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸</th></tr>
            </thead>
            <tbody>
              ${sortedVitals.map(v => `
                <tr>
                  <td style="color:var(--teal-light); font-weight:600;">${v.time_recorded || '-'}</td>
                  <td>${v.hr || '-'}</td>
                  <td>${v.rr || '-'}</td>
                  <td>${v.spo2 ? v.spo2+'%' : '-'}</td>
                  <td>${v.temp ? v.temp+'Â°C' : '-'}</td>
                  <td>${v.zoletil_top || '-'}</td>
                  <td style="text-align:left; font-size:11px; color:var(--text-dim); max-width:150px;">${v.note || '-'}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
      `;
    }

    const qData = Array.isArray(ani.vasd_queue) ? ani.vasd_queue[0] : ani.vasd_queue;
    const table = escapeHtml(qData?.operating_table || 'à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¹‚à¸•à¹Šà¸°');
    const surgeon = escapeHtml(qData?.surgeon_name || '-');
    const anes = escapeHtml(qData?.anesthetist || '-');
    const speciesText = ani.species === 'à¸ª' ? 'ğŸ¶ à¸ªà¸¸à¸™à¸±à¸‚' : 'ğŸ± à¹à¸¡à¸§';
    const hasNote = ani.health_note && ani.health_note.trim().length > 0;

    card.innerHTML = `
      <div class="card-top">
        <div class="animal-info">
          <h3>${ani.animal_name} <span style="font-size:14px; font-weight:400; color:var(--text-dim);">- ${speciesText}</span></h3>
          <p>à¹€à¸à¸¨: ${ani.sex} | à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¸ˆà¸£à¸´à¸‡: <strong>${ani.actual_weight || ani.est_weight || '-'} à¸à¸.</strong></p>
        </div>
        <div class="q-badge">Q-${ani.queue_number}</div>
      </div>

      ${hasNote ? `
        <div class="health-note">
          <span style="font-size:18px;">âš ï¸</span>
          <div>
            <div style="font-size:10px; font-weight:800; text-transform:uppercase; opacity:0.8; margin-bottom:2px;">à¸£à¸°à¸§à¸±à¸‡à¸à¸´à¹€à¸¨à¸© / à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸¸à¸‚à¸ à¸²à¸à¸à¹ˆà¸­à¸™à¸œà¹ˆà¸²</div>
            <div style="font-weight:600; font-size:13px; line-height:1.4;">${ani.health_note}</div>
          </div>
        </div>
      ` : ''}

      <div class="data-grid">
        <div class="data-item">
          <label>ğŸ‘¤ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸ˆà¹‰à¸²à¸‚à¸­à¸‡</label>
          <span><strong>${ani.vasd_owner?.owner_name || '-'}</strong><br>ğŸ“ ${ani.vasd_owner?.phone || '-'}</span>
        </div>
        <div class="data-item">
          <label>âš•ï¸ à¸—à¸µà¸¡à¸œà¹ˆà¸²à¸•à¸±à¸”/à¸§à¸²à¸‡à¸¢à¸²</label>
          <span><strong>à¹‚à¸•à¹Šà¸°:</strong> ${table}<br><strong>à¸¨à¸±à¸¥à¸¢à¹à¸à¸—à¸¢à¹Œ:</strong> ${surgeon}<br><strong>à¸§à¸´à¸ªà¸±à¸à¸à¸µ:</strong> ${anes}</span>
        </div>
        <div class="data-item">
          <label>âœ‚ï¸ à¸«à¸±à¸•à¸–à¸à¸²à¸£à¸—à¸µà¹ˆà¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£</label>
          <div class="tag-container" style="margin-top:4px;">${services}</div>
        </div>
        <div class="data-item">
          <label>ğŸ’Š à¸¢à¸²à¸à¸¥à¸±à¸šà¸šà¹‰à¸²à¸™ (RX)</label>
          <div style="margin-top:4px;">${meds}</div>
        </div>
      </div>

      ${vitalsHtml}

      <div style="margin-top: 16px; padding-top: 16px; border-top: 1px dashed var(--border); display: flex; gap: 8px; justify-content: flex-end;">
        <button class="btn-export btn-csv" style="padding: 6px 12px; font-size: 11px;" onclick="exportCSV('${ani.id}')">ğŸ“„ CSV (à¸•à¸±à¸§à¸™à¸µà¹‰)</button>
        <button class="btn-export btn-pdf" style="padding: 6px 12px; font-size: 11px;" onclick="exportPDF('${ani.id}')">ğŸ–¨ï¸ à¸à¸´à¸¡à¸à¹Œ (à¸•à¸±à¸§à¸™à¸µà¹‰)</button>
      </div>
    `;

    container.appendChild(card);
  });
}

// â”€â”€ à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™ Export CSV â”€â”€
// à¸£à¸­à¸‡à¸£à¸±à¸šà¸à¸²à¸£à¸£à¸±à¸š Parameter animalId à¸–à¹‰à¸²à¸¡à¸µà¸„à¹ˆà¸² à¸ˆà¸°à¸à¸´à¸¡à¸à¹Œà¹à¸„à¹ˆà¸•à¸±à¸§à¹€à¸”à¸µà¸¢à¸§ à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µ à¸ˆà¸°à¸à¸´à¸¡à¸à¹Œà¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
window.exportCSV = function(animalId = null) {
  const dataToExport = animalId 
    ? globalReportData.filter(a => a.id === animalId) 
    : globalReportData;

  if (dataToExport.length === 0) return alert("à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸³à¸«à¸£à¸±à¸š Export");
  
  let csvContent = "\uFEFF"; // BOM à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸«à¹‰ Excel à¸­à¹ˆà¸²à¸™à¸ à¸²à¸©à¸²à¹„à¸—à¸¢à¹„à¸”à¹‰
  csvContent += "à¸„à¸´à¸§,à¸Šà¸·à¹ˆà¸­à¸ªà¸±à¸•à¸§à¹Œ,à¸Šà¸™à¸´à¸”,à¹€à¸à¸¨,à¸™à¹‰à¸³à¸«à¸™à¸±à¸(à¸à¸.),à¸Šà¸·à¹ˆà¸­à¹€à¸ˆà¹‰à¸²à¸‚à¸­à¸‡,à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£,à¹‚à¸•à¹Šà¸°à¸œà¹ˆà¸²à¸•à¸±à¸”,à¸¨à¸±à¸¥à¸¢à¹à¸à¸—à¸¢à¹Œ,à¸§à¸´à¸ªà¸±à¸à¸à¸µà¹à¸à¸—à¸¢à¹Œ,à¸«à¸±à¸•à¸–à¸à¸²à¸£,à¸‚à¹‰à¸­à¸„à¸§à¸£à¸£à¸°à¸§à¸±à¸‡,à¸¢à¸²à¸à¸¥à¸±à¸šà¸šà¹‰à¸²à¸™\n";

  dataToExport.forEach(ani => {
    const qData = Array.isArray(ani.vasd_queue) ? ani.vasd_queue[0] : ani.vasd_queue;
    const services = ani.vasd_service?.map(s => s.service_type).join("; ") || "";
    const meds = ani.vasd_prescription?.map(m => `${m.drug_id} ${m.dose}(${m.freq})x${m.days}d`).join("; ") || "";
    
    const row = [
      ani.queue_number,
      ani.animal_name,
      ani.species === 'à¸ª' ? 'à¸ªà¸¸à¸™à¸±à¸‚' : 'à¹à¸¡à¸§',
      ani.sex,
      ani.actual_weight || ani.est_weight || '',
      ani.vasd_owner?.owner_name || '',
      ani.vasd_owner?.phone || '',
      qData?.operating_table || '',
      qData?.surgeon_name || '',
      qData?.anesthetist || '',
      services,
      ani.health_note || '',
      meds
    ].map(field => `"${String(field).replace(/"/g, '""')}"`).join(",");
    
    csvContent += row + "\n";
  });

  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.setAttribute("href", url);
  
  const fileName = animalId 
    ? `VASD_Report_Q${dataToExport[0].queue_number}_${new Date().toISOString().split('T')[0]}.csv`
    : `VASD_Report_All_${new Date().toISOString().split('T')[0]}.csv`;
    
  link.setAttribute("download", fileName);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
};

// â”€â”€ à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™ Export PDF (A4 Print) â”€â”€
// à¸£à¸­à¸‡à¸£à¸±à¸šà¸à¸²à¸£à¸£à¸±à¸š Parameter animalId à¹€à¸à¸·à¹ˆà¸­à¸à¸´à¸¡à¸à¹Œà¹€à¸‰à¸à¸²à¸°à¹€à¸„à¸ª
window.exportPDF = function(animalId = null) {
  const dataToExport = animalId 
    ? globalReportData.filter(a => a.id === animalId) 
    : globalReportData;

  if (dataToExport.length === 0) return alert("à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸³à¸«à¸£à¸±à¸š Print");

  const printWindow = window.open('', '_blank');
  
  let html = `
    <!DOCTYPE html>
    <html lang="th">
    <head>
      <meta charset="UTF-8">
      <title>à¸£à¸²à¸¢à¸‡à¸²à¸™à¸à¸²à¸£à¸œà¹ˆà¸²à¸•à¸±à¸” VASD</title>
      <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
      <style>
        @page { size: A4; margin: 15mm; }
        body { font-family: 'Sarabun', sans-serif; color: #000; font-size: 14px; line-height: 1.5; background: #fff; }
        .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #0ea5a0; padding-bottom: 10px; }
        .header h1 { font-size: 20px; margin: 0 0 5px 0; color: #0ea5a0; }
        .header p { font-size: 14px; margin: 0; color: #555; }
        .case-card { border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 20px; page-break-inside: avoid; }
        .case-header { display: flex; justify-content: space-between; border-bottom: 1px dashed #ccc; padding-bottom: 10px; margin-bottom: 10px; }
        .case-header h2 { font-size: 18px; margin: 0; }
        .q-num { background: #0ea5a0; color: #fff; padding: 3px 10px; border-radius: 4px; font-weight: bold; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .info-box { background: #f9f9f9; padding: 8px; border-radius: 4px; font-size: 13px; }
        .info-box strong { display: block; font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 2px; }
        .note { color: #d32f2f; background: #ffebee; padding: 8px; border-radius: 4px; font-size: 13px; margin-bottom: 10px; border: 1px solid #ffcdd2; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
        th { background: #f0f0f0; }
        .footer { text-align: center; font-size: 10px; color: #888; margin-top: 30px; }
      </style>
    </head>
    <body>
      <div class="header">
        <h1>${animalId ? 'à¸£à¸²à¸¢à¸‡à¸²à¸™à¸ªà¸£à¸¸à¸›à¸œà¸¥à¸à¸²à¸£à¸œà¹ˆà¸²à¸•à¸±à¸” (à¸£à¸²à¸¢à¸šà¸¸à¸„à¸„à¸¥)' : 'à¸£à¸²à¸¢à¸‡à¸²à¸™à¸ªà¸£à¸¸à¸›à¸œà¸¥à¸à¸²à¸£à¸œà¹ˆà¸²à¸•à¸±à¸”à¹à¸¥à¸°à¸—à¸³à¸«à¸¡à¸±à¸™à¸ªà¸±à¸•à¸§à¹Œ'}</h1>
        <p>à¸«à¸™à¹ˆà¸§à¸¢à¸šà¸£à¸´à¸à¸²à¸£à¸§à¸´à¸Šà¸²à¸à¸²à¸£à¸ªà¸±à¸•à¸§à¹à¸à¸—à¸¢à¹Œ (VASD) à¸¡à¸«à¸²à¸§à¸´à¸—à¸¢à¸²à¸¥à¸±à¸¢à¹€à¸—à¸„à¹‚à¸™à¹‚à¸¥à¸¢à¸µà¸£à¸²à¸Šà¸¡à¸‡à¸„à¸¥à¸•à¸°à¸§à¸±à¸™à¸­à¸­à¸</p>
        <p>à¸§à¸±à¸™à¸—à¸µà¹ˆà¸à¸´à¸¡à¸à¹Œ: ${new Date().toLocaleDateString('th-TH')} à¹€à¸§à¸¥à¸² ${new Date().toLocaleTimeString('th-TH')}</p>
      </div>
  `;

  dataToExport.forEach(ani => {
    const qData = Array.isArray(ani.vasd_queue) ? ani.vasd_queue[0] : ani.vasd_queue;
    const services = ani.vasd_service?.map(s => s.service_type).join(", ") || "-";
    const meds = ani.vasd_prescription?.map(m => `${m.drug_id}: ${m.dose} (${m.freq}) x ${m.days}d`).join(", ") || "-";
    const speciesText = ani.species === 'à¸ª' ? 'à¸ªà¸¸à¸™à¸±à¸‚' : 'à¹à¸¡à¸§';
    const hasNote = ani.health_note && ani.health_note.trim().length > 0;

    // Vitals Table
    const vitals = (ani.vasd_vital_signs || []).sort((x, y) => new Date(x.created_at) - new Date(y.created_at));
    let vitalsHtml = "";
    if (vitals.length > 0) {
      vitalsHtml = `
        <table>
          <thead><tr><th>à¹€à¸§à¸¥à¸²</th><th>HR</th><th>RR</th><th>SpO2</th><th>Temp</th><th>Zoletil</th><th>Note</th></tr></thead>
          <tbody>
            ${vitals.map(v => `
              <tr>
                <td>${v.time_recorded || '-'}</td><td>${v.hr || '-'}</td><td>${v.rr || '-'}</td>
                <td>${v.spo2 ? v.spo2+'%' : '-'}</td><td>${v.temp ? v.temp+'Â°C' : '-'}</td>
                <td>${v.zoletil_top || '-'}</td><td style="text-align:left;">${v.note || '-'}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    } else {
      vitalsHtml = `<p style="font-size:12px; color:#777; margin:5px 0 0 0;">à¹„à¸¡à¹ˆà¸¡à¸µà¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸±à¸à¸à¸²à¸“à¸Šà¸µà¸</p>`;
    }

    html += `
      <div class="case-card">
        <div class="case-header">
          <h2>${ani.animal_name} (${speciesText} ${ani.sex}) - ${ani.actual_weight || ani.est_weight || '-'} à¸à¸.</h2>
          <div class="q-num">Q-${ani.queue_number}</div>
        </div>
        
        ${hasNote ? `<div class="note"><strong>âš ï¸ à¸‚à¹‰à¸­à¸„à¸§à¸£à¸£à¸°à¸§à¸±à¸‡à¸à¹ˆà¸­à¸™à¸œà¹ˆà¸²à¸•à¸±à¸”:</strong> ${ani.health_note}</div>` : ''}
        
        <div class="grid">
          <div class="info-box"><strong>à¹€à¸ˆà¹‰à¸²à¸‚à¸­à¸‡ / à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£</strong>${ani.vasd_owner?.owner_name || '-'} (${ani.vasd_owner?.phone || '-'})</div>
          <div class="info-box"><strong>à¸—à¸µà¸¡à¸œà¹ˆà¸²à¸•à¸±à¸” (à¹‚à¸•à¹Šà¸°: ${qData?.operating_table || '-'})</strong>à¸«à¸¡à¸­: ${qData?.surgeon_name || '-'} | à¸”à¸¡à¸¢à¸²: ${qData?.anesthetist || '-'}</div>
          <div class="info-box"><strong>à¸«à¸±à¸•à¸–à¸à¸²à¸£</strong>${services}</div>
          <div class="info-box"><strong>à¸¢à¸²à¸à¸¥à¸±à¸šà¸šà¹‰à¸²à¸™</strong>${meds}</div>
        </div>
        
        <div style="font-size:13px; font-weight:bold; margin-top:10px;">à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸±à¸à¸à¸²à¸“à¸Šà¸µà¸ (Vitals History)</div>
        ${vitalsHtml}
      </div>
    `;
  });

  html += `<div class="footer">à¸ªà¸£à¹‰à¸²à¸‡à¹‚à¸”à¸¢à¸£à¸°à¸šà¸š VASD Management System</div></body></html>`;

  printWindow.document.open();
  printWindow.document.write(html);
  printWindow.document.close();

  // à¸£à¸­à¹ƒà¸«à¹‰à¸Ÿà¸­à¸™à¸•à¹Œà¹à¸¥à¸° DOM à¹‚à¸«à¸¥à¸”à¹€à¸ªà¸£à¹‡à¸ˆà¸à¹ˆà¸­à¸™à¸ªà¸±à¹ˆà¸‡ Print
  setTimeout(() => {
    printWindow.print();
  }, 500);
};

// à¹€à¸£à¸´à¹ˆà¸¡à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥
loadReport();
</script>
<script type="module" src="./js/global-alarm.js"></script>
</body>
</html>
