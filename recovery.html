<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>à¸«à¹‰à¸­à¸‡à¸à¸±à¸à¸Ÿà¸·à¹‰à¸™ â€“ VASD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOKENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --navy:         #0b1929;
  --navy-mid:     #112240;
  --teal:         #0ea5a0;
  --teal-light:   #14c4bc;
  --teal-glow:    rgba(14,165,160,0.25);
  --violet:       #8b5cf6;
  --violet-soft:  rgba(139,92,246,0.14);
  --violet-glow:  rgba(139,92,246,0.25);
  --rose:         #ef4444;
  --rose-soft:    rgba(239,68,68,0.12);
  --emerald:      #10b981;
  --emerald-soft: rgba(16,185,129,0.14);

  --surface:    rgba(255,255,255,0.04);
  --surface-2:  rgba(255,255,255,0.07);
  --surface-3:  rgba(255,255,255,0.11);
  --border:     rgba(255,255,255,0.08);
  --border-2:   rgba(255,255,255,0.14);
  --text:       #e2e8f0;
  --text-dim:   #94a3b8;
  --text-faint: #4a5568;

  --radius-xs: 6px;
  --radius-sm: 10px;
  --radius:    16px;
  --radius-lg: 22px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }

body {
  font-family: "Sarabun", sans-serif;
  background: var(--navy);
  color: var(--text);
  min-height: 100vh; min-height: 100dvh;
  display: flex; flex-direction: column;
  overflow-x: hidden;
}
body::before {
  content: ""; position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background:
    radial-gradient(ellipse 60% 50% at 20% 10%, rgba(139,92,246,0.09) 0%, transparent 70%),
    radial-gradient(ellipse 50% 40% at 80% 80%, rgba(14,165,160,0.07) 0%, transparent 60%);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
header {
  position: sticky; top: 0; z-index: 200;
  background: rgba(11,25,41,0.88);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-bottom: 1px solid var(--border);
  padding: 0 20px; height: 64px;
  display: flex; align-items: center; justify-content: space-between; gap: 12px;
}
.brand { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
.brand-logo {
  width: 38px; height: 38px;
  background: linear-gradient(135deg, var(--violet), #a78bfa);
  border-radius: 10px; display: flex; align-items: center; justify-content: center;
  font-size: 18px; box-shadow: 0 0 20px var(--violet-glow);
}
.brand-name {
  font-family: "Outfit", sans-serif;
  font-size: 15px; font-weight: 700; color: #fff; line-height: 1; letter-spacing: -0.3px;
}
.brand-sub { font-size: 10px; color: var(--text-dim); margin-top: 2px; }
.btn-home {
  padding: 8px 14px; font-size: 12px; font-weight: 600; font-family: "Sarabun", sans-serif;
  background: var(--surface-2); color: var(--text-dim);
  border: 1px solid var(--border-2); border-radius: var(--radius-sm); cursor: pointer;
  display: flex; align-items: center; gap: 5px;
  transition: background 0.2s, color 0.2s;
  -webkit-tap-highlight-color: transparent;
}
.btn-home:hover { background: var(--surface-3); color: var(--text); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WRAP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.wrap {
  position: relative; z-index: 1;
  max-width: 960px; margin: 0 auto;
  padding: 24px 16px 60px; width: 100%;
}

.page-header {
  display: flex; align-items: flex-start; justify-content: space-between;
  margin-bottom: 22px; flex-wrap: wrap; gap: 10px;
  animation: slideUp 0.4s ease both;
}
.page-title {
  font-family: "Outfit", sans-serif;
  font-size: 20px; font-weight: 800; color: #fff; letter-spacing: -0.5px;
}
.page-sub { font-size: 12px; color: var(--text-dim); margin-top: 3px; }

.section-title {
  font-size: 10px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase;
  color: var(--text-faint); margin-bottom: 12px;
  display: flex; align-items: center; gap: 8px;
}
.section-title::after { content: ""; flex: 1; height: 1px; background: var(--border); }
.section-count {
  font-size: 10px; color: var(--text-dim); background: var(--surface-2);
  border: 1px solid var(--border-2); border-radius: 20px; padding: 2px 10px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RECOVERY GRID
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#recoveryGrid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
  gap: 14px;
}
@media (max-width: 640px) {
  #recoveryGrid { grid-template-columns: 1fr; }
}

/* â”€â”€â”€ Recovery Card â”€â”€â”€ */
.rec-card {
  background: var(--surface);
  border: 1px solid var(--border-2);
  border-radius: var(--radius-lg);
  overflow: hidden;
  display: flex; flex-direction: column;
  animation: slideUp 0.4s ease both;
}
/* violet top bar */
.rec-card::before {
  content: ""; display: block; height: 3px;
  background: linear-gradient(90deg, var(--violet), #a78bfa);
}

/* â”€â”€ Card Header â”€â”€ */
.rc-header {
  display: flex; align-items: center; gap: 12px;
  padding: 12px 14px 10px;
  border-bottom: 1px solid var(--border);
  background: var(--surface-2);
}
.queue-circle {
  font-family: "Outfit", sans-serif;
  width: 40px; height: 40px; border-radius: 50%;
  background: var(--violet-soft);
  border: 2px solid rgba(139,92,246,0.3);
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; font-weight: 800; color: #c4b5fd; flex-shrink: 0;
}
.rc-title-block { flex: 1; min-width: 0; }
.rc-animal-name {
  font-family: "Outfit", sans-serif;
  font-size: 15px; font-weight: 800; color: #fff; line-height: 1.1;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.rc-meta { font-size: 11px; color: var(--text-dim); margin-top: 3px; }
.rec-status-pill {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 4px 10px; border-radius: 20px; flex-shrink: 0;
  font-size: 10px; font-weight: 700;
  background: var(--violet-soft); color: #c4b5fd;
  border: 1px solid rgba(139,92,246,0.3);
}

/* â”€â”€ Card Tabs â”€â”€ */
.rc-tabs {
  display: flex; border-bottom: 1px solid var(--border);
  background: var(--surface-2);
}
.rc-tab {
  flex: 1; padding: 9px 6px; text-align: center;
  font-size: 11px; font-weight: 600; color: var(--text-dim);
  cursor: pointer; border: none; background: none;
  border-bottom: 2px solid transparent;
  transition: color 0.2s, border-color 0.2s;
  font-family: "Sarabun", sans-serif;
  -webkit-tap-highlight-color: transparent;
}
.rc-tab.active { color: #c4b5fd; border-bottom-color: var(--violet); }
.rc-tab:hover  { color: var(--text); }

/* â”€â”€ Panel â”€â”€ */
.rc-panel { display: none; padding: 14px; }
.rc-panel.active { display: block; }

/* â”€â”€ Info panel â”€â”€ */
.info-chips { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 0; }
.info-chip {
  display: flex; align-items: center; gap: 6px;
  background: var(--surface-2); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 8px 12px; font-size: 12px;
}
.ic-label { color: var(--text-dim); }
.ic-val   { color: var(--text); font-weight: 600; }

/* â”€â”€ Vitals panel â”€â”€ */
.vital-input-grid {
  display: grid;
  grid-template-columns: 72px repeat(4, 1fr) auto;
  gap: 7px; align-items: end;
  margin-bottom: 12px;
}
@media (max-width: 480px) {
  .vital-input-grid {
    grid-template-columns: repeat(3, 1fr);
  }
  .vital-input-grid .v-time-cell { grid-column: 1 / -1; }
  .vital-input-grid .v-btn-cell  { grid-column: 1 / -1; }
}

.field-group { display: flex; flex-direction: column; gap: 3px; }
.field-label {
  font-size: 9px; font-weight: 700; letter-spacing: 0.8px; text-transform: uppercase;
  color: var(--text-faint);
}
.f-input {
  width: 100%; padding: 8px 9px;
  font-size: 13px; font-family: "Sarabun", sans-serif;
  background: var(--surface-2); border: 1px solid var(--border-2);
  border-radius: var(--radius-sm); color: var(--text); outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
  -webkit-appearance: none;
}
.f-input::placeholder { color: var(--text-faint); }
.f-input:focus {
  border-color: var(--violet);
  box-shadow: 0 0 0 3px var(--violet-soft);
}

/* vital table */
.vital-table-wrap {
  border: 1px solid var(--border); border-radius: var(--radius-sm);
  overflow: hidden; overflow-x: auto; -webkit-overflow-scrolling: touch;
}
.vital-table {
  width: 100%; border-collapse: collapse; min-width: 340px; font-size: 12px;
}
.vital-table thead tr { background: var(--surface-3); }
.vital-table th {
  padding: 7px 8px; text-align: center; font-weight: 700;
  color: var(--text-dim); font-size: 9px; letter-spacing: 0.8px; text-transform: uppercase;
  border-bottom: 1px solid var(--border); white-space: nowrap;
}
.vital-table tbody tr { border-bottom: 1px solid var(--border); transition: background 0.15s; }
.vital-table tbody tr:last-child { border-bottom: none; }
.vital-table tbody tr:hover { background: var(--surface-2); }
.vital-table td {
  padding: 7px 8px; text-align: center; color: var(--text); vertical-align: middle;
}
.vital-table td:first-child { font-weight: 700; color: #c4b5fd; }
.vital-empty {
  text-align: center; padding: 20px; color: var(--text-faint); font-size: 12px;
}

/* â”€â”€ Card Footer â”€â”€ */
.rc-footer {
  display: flex; gap: 8px; flex-wrap: wrap;
  padding: 11px 14px;
  border-top: 1px solid var(--border);
  background: var(--surface-2);
  margin-top: auto;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUTTONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn {
  padding: 9px 14px; font-size: 12px; font-weight: 600; font-family: "Sarabun", sans-serif;
  border: none; border-radius: var(--radius-sm); cursor: pointer;
  display: inline-flex; align-items: center; gap: 5px;
  transition: opacity 0.2s, transform 0.15s;
  -webkit-tap-highlight-color: transparent;
  white-space: nowrap;
}
.btn:active { transform: scale(0.96); }

.btn-add-vital {
  padding: 8px 12px;
  background: var(--violet-soft); color: #c4b5fd;
  border: 1px solid rgba(139,92,246,0.3);
}
.btn-add-vital:hover { background: rgba(139,92,246,0.22); }

.btn-rx {
  background: rgba(14,165,160,0.15); color: var(--teal-light);
  border: 1px solid rgba(14,165,160,0.3); flex: 1; justify-content: center;
}
.btn-rx:hover { background: rgba(14,165,160,0.25); }

.btn-close-job {
  background: var(--emerald-soft); color: var(--emerald);
  border: 1px solid rgba(16,185,129,0.3); flex: 1; justify-content: center;
  font-size: 12px;
}
.btn-close-job:hover { background: rgba(16,185,129,0.25); }

/* â”€â”€ Empty â”€â”€ */
.empty-state {
  grid-column: 1 / -1;
  text-align: center; padding: 60px 16px;
  color: var(--text-faint); animation: slideUp 0.4s ease both;
}
.empty-state-icon { font-size: 52px; margin-bottom: 14px; }
.empty-state-text { font-size: 14px; color: var(--text-dim); }
.empty-state-sub  { font-size: 12px; margin-top: 6px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ANIMATIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@keyframes slideUp {
  from { opacity: 0; transform: translateY(18px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 640px) {
  header { height: 56px; padding: 0 14px; }
  .brand-sub { display: none; }
  .wrap { padding: 18px 12px 50px; }
  .page-title { font-size: 18px; }
}
</style>
</head>
<body>

<!-- â”€â”€ HEADER â”€â”€ -->
<header>
  <div class="brand">
    <div class="brand-logo">ğŸŸ£</div>
    <div>
      <div class="brand-name">à¸«à¹‰à¸­à¸‡à¸à¸±à¸à¸Ÿà¸·à¹‰à¸™</div>
      <div class="brand-sub">RMUTTO â€“ Veterinary Academic Service Division</div>
    </div>
  </div>
  <button class="btn-home" onclick="location.href='index.html'">ğŸ  à¸«à¸™à¹‰à¸²à¸«à¸¥à¸±à¸</button>
</header>

<!-- â”€â”€ CONTENT â”€â”€ -->
<div class="wrap">

  <div class="page-header">
    <div>
      <div class="page-title">à¸ªà¸±à¸•à¸§à¹Œà¸—à¸µà¹ˆà¸à¸³à¸¥à¸±à¸‡à¸à¸±à¸à¸Ÿà¸·à¹‰à¸™</div>
      <div class="page-sub">à¸šà¸±à¸™à¸—à¸¶à¸ Vitals à¹à¸¥à¸°à¸›à¸´à¸” Job à¹€à¸¡à¸·à¹ˆà¸­à¸ªà¸±à¸•à¸§à¹Œà¸Ÿà¸·à¹‰à¸™à¸•à¸±à¸§à¸”à¸µà¹à¸¥à¹‰à¸§</div>
    </div>
  </div>

  <div class="section-title">
    à¸à¸³à¸¥à¸±à¸‡à¸à¸±à¸à¸Ÿà¸·à¹‰à¸™
    <span class="section-count" id="recCount">0 à¸£à¸²à¸¢à¸à¸²à¸£</span>
    <span></span>
  </div>

  <div id="recoveryGrid">
    <div class="empty-state">
      <div class="empty-state-icon">ğŸŸ£</div>
      <div class="empty-state-text">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥...</div>
    </div>
  </div>

</div>

<script type="module">
import { supabase } from "./js/supabase.js";

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOAD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadRecoveryAnimals() {
  const grid = document.getElementById("recoveryGrid");

  const { data: eventId } = await supabase.rpc("get_today_event");
  const { data, error } = await supabase
    .from("vasd_animal")
    .select(`
      id, queue_number, animal_name, species, sex, actual_weight,
      vasd_owner(owner_name),
      vasd_queue!inner(status),
      vasd_vital_signs(*)
    `)
    .eq("event_id", eventId)
    .eq("vasd_queue.status", "recovery")
    .order("queue_number");

  if (error) {
    console.error(error);
    grid.innerHTML = `<div class="empty-state"><div class="empty-state-text" style="color:#fca5a5;">âŒ à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: ${error.message}</div></div>`;
    return;
  }

  document.getElementById("recCount").textContent = `${data.length} à¸£à¸²à¸¢à¸à¸²à¸£`;

  if (data.length === 0) {
    grid.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">âœ…</div>
        <div class="empty-state-text">à¸‚à¸“à¸°à¸™à¸µà¹‰à¹„à¸¡à¹ˆà¸¡à¸µà¸ªà¸±à¸•à¸§à¹Œà¹ƒà¸™à¸«à¹‰à¸­à¸‡à¸à¸±à¸à¸Ÿà¸·à¹‰à¸™</div>
        <div class="empty-state-sub">à¹€à¸¡à¸·à¹ˆà¸­à¸¡à¸µà¹€à¸„à¸ªà¸ˆà¸²à¸à¸«à¹‰à¸­à¸‡à¸œà¹ˆà¸²à¸•à¸±à¸” à¸«à¸™à¹‰à¸²à¸ˆà¸­à¸ˆà¸°à¸­à¸±à¸›à¹€à¸”à¸•à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´</div>
      </div>`;
    return;
  }

  /* keep open tab state */
  const tabStates = {};
  grid.querySelectorAll(".rec-card").forEach(c => {
    const id  = c.dataset.id;
    const act = c.querySelector(".rc-tab.active");
    if (act) tabStates[id] = act.dataset.tab;
  });

  grid.innerHTML = "";
  const now = new Date().toTimeString().substring(0, 5);

  data.forEach((a, idx) => {
    const spText    = a.species === "à¸ª" ? "ğŸ¶ à¸ªà¸¸à¸™à¸±à¸‚" : "ğŸ± à¹à¸¡à¸§";
    const ownerName = a.vasd_owner?.owner_name || "â€“";

    /* sort vitals */
    const vitals = (a.vasd_vital_signs || []).sort((x, y) => {
      const t1 = x.time_recorded || x.created_at || "";
      const t2 = y.time_recorded || y.created_at || "";
      return t1.localeCompare(t2);
    });

    const vitalRows = vitals.length === 0
      ? `<tr><td colspan="5" class="vital-empty">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸ Vitals</td></tr>`
      : vitals.map(v => {
          let timeStr = "â€“";
          if (v.time_recorded) timeStr = v.time_recorded.substring(0, 5);
          else if (v.created_at) timeStr = new Date(v.created_at).toLocaleTimeString("th-TH", {hour12:false}).substring(0,5);
          const spo2 = v.spo2 ? v.spo2 + "%" : "â€“";
          return `<tr>
            <td>${timeStr}</td>
            <td>${v.hr   || "â€“"}</td>
            <td>${v.rr   || "â€“"}</td>
            <td>${v.temp || v.bt || "â€“"}</td>
            <td>${spo2}</td>
          </tr>`;
        }).join("");

    const activeTab = tabStates[a.id] || "info";

    const card = document.createElement("div");
    card.className = "rec-card";
    card.dataset.id = a.id;
    card.style.animationDelay = `${idx * 0.06}s`;

    card.innerHTML = `
      <!-- Top bar via ::before -->

      <!-- Header -->
      <div class="rc-header">
        <div class="queue-circle">#${a.queue_number}</div>
        <div class="rc-title-block">
          <div class="rc-animal-name">${a.animal_name}</div>
          <div class="rc-meta">${spText} Â· ${a.sex} Â· ${a.actual_weight ?? "??"} à¸à¸.</div>
        </div>
        <span class="rec-status-pill">ğŸŸ£ à¸à¸±à¸à¸Ÿà¸·à¹‰à¸™</span>
      </div>

      <!-- Tabs -->
      <div class="rc-tabs">
        <button class="rc-tab${activeTab === "info"   ? " active" : ""}" data-tab="info"   onclick="switchRecTab(this,'${a.id}')">ğŸ“‹ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥</button>
        <button class="rc-tab${activeTab === "vitals" ? " active" : ""}" data-tab="vitals" onclick="switchRecTab(this,'${a.id}')">ğŸ©º Vitals</button>
      </div>

      <!-- Panel: Info -->
      <div class="rc-panel${activeTab === "info" ? " active" : ""}" data-panel="info-${a.id}">
        <div class="info-chips">
          <div class="info-chip"><span class="ic-label">ğŸ‘¤</span><span class="ic-val">${ownerName}</span></div>
          <div class="info-chip"><span class="ic-label">âš–ï¸</span><span class="ic-val">${a.actual_weight ?? "â€“"} à¸à¸.</span></div>
          <div class="info-chip"><span class="ic-label">Vitals</span><span class="ic-val">${vitals.length} à¸£à¸²à¸¢à¸à¸²à¸£</span></div>
        </div>
      </div>

      <!-- Panel: Vitals -->
      <div class="rc-panel${activeTab === "vitals" ? " active" : ""}" data-panel="vitals-${a.id}">
        <!-- Input row -->
        <div class="vital-input-grid" id="form-${a.id}">
          <div class="field-group v-time-cell">
            <span class="field-label">à¹€à¸§à¸¥à¸²</span>
            <input class="f-input v-time" type="time" value="${now}">
          </div>
          <div class="field-group">
            <span class="field-label">HR</span>
            <input class="f-input v-hr" type="number" placeholder="HR">
          </div>
          <div class="field-group">
            <span class="field-label">RR</span>
            <input class="f-input v-rr" type="number" placeholder="RR">
          </div>
          <div class="field-group">
            <span class="field-label">Temp</span>
            <input class="f-input v-temp" type="number" placeholder="Â°C">
          </div>
          <div class="field-group">
            <span class="field-label">SpO2%</span>
            <input class="f-input v-spo2" type="number" placeholder="%">
          </div>
          <div class="field-group v-btn-cell" style="justify-content:flex-end;">
            <span class="field-label" style="opacity:0">a</span>
            <button class="btn btn-add-vital" onclick="saveVital('${a.id}')">â• à¸šà¸±à¸™à¸—à¸¶à¸</button>
          </div>
        </div>

        <!-- Table -->
        <div class="vital-table-wrap">
          <table class="vital-table">
            <thead>
              <tr>
                <th>à¹€à¸§à¸¥à¸²</th><th>HR</th><th>RR</th><th>Temp Â°C</th><th>SpO2</th>
              </tr>
            </thead>
            <tbody>${vitalRows}</tbody>
          </table>
        </div>
      </div>

      <!-- Footer -->
      <div class="rc-footer">
        <button class="btn btn-rx" onclick="location.href='rx.html?animal_id=${a.id}'">ğŸ’Š à¸ªà¸±à¹ˆà¸‡à¸¢à¸²à¹€à¸à¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡</button>
        <button class="btn btn-close-job" onclick="closeRecoveryJob('${a.id}')">âœ… à¸Ÿà¸·à¹‰à¸™à¹à¸¥à¹‰à¸§ / à¸›à¸´à¸” Job</button>
      </div>
    `;

    grid.appendChild(card);
  });
}

/* â”€â”€ Switch tab â”€â”€ */
window.switchRecTab = function(btn, animalId) {
  const card = btn.closest(".rec-card");
  const tab  = btn.dataset.tab;
  card.querySelectorAll(".rc-tab").forEach(t => t.classList.toggle("active", t.dataset.tab === tab));
  card.querySelectorAll(".rc-panel").forEach(p => {
    p.classList.toggle("active", p.dataset.panel === `${tab}-${animalId}`);
  });
};

/* â”€â”€ Save vital â”€â”€ */
window.saveVital = async function(animalId) {
  const form    = document.getElementById(`form-${animalId}`);
  const timeVal = form.querySelector(".v-time").value;
  if (!timeVal) return alert("à¸à¸£à¸¸à¸“à¸²à¸£à¸°à¸šà¸¸à¹€à¸§à¸¥à¸²");

  const { error } = await supabase.from("vasd_vital_signs").insert({
    animal_id:     animalId,
    time_recorded: timeVal,
    hr:    form.querySelector(".v-hr").value   || null,
    rr:    form.querySelector(".v-rr").value   || null,
    temp:  form.querySelector(".v-temp").value || null,
    spo2:  form.querySelector(".v-spo2").value || null,
  });

  if (error) alert("à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: " + error.message);
  else {
    ["v-hr","v-rr","v-temp","v-spo2"].forEach(cls => form.querySelector(`.${cls}`).value = "");
    loadRecoveryAnimals();
  }
};

/* â”€â”€ Close job â”€â”€ */
window.closeRecoveryJob = async function(animalId) {
  if (!confirm("à¸¢à¸·à¸™à¸¢à¸±à¸™à¸§à¹ˆà¸²à¸ªà¸±à¸•à¸§à¹Œà¸Ÿà¸·à¹‰à¸™à¸•à¸±à¸§à¸”à¸µà¹à¸¥à¹‰à¸§?\nà¸£à¸°à¸šà¸šà¸ˆà¸°à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸›à¸¢à¸±à¸‡à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸ˆà¸±à¸”à¸¢à¸²/à¸£à¸±à¸šà¸à¸¥à¸±à¸š")) return;

  const { error } = await supabase
    .from("vasd_queue")
    .update({ status: "ready_to_go_home", updated_at: new Date() })
    .eq("animal_id", animalId);

  if (error) alert("à¸­à¸±à¸›à¹€à¸”à¸•à¸ªà¸–à¸²à¸™à¸°à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: " + error.message);
  else { alert("âœ… à¸›à¸´à¸” Job à¸à¸±à¸à¸Ÿà¸·à¹‰à¸™à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢"); loadRecoveryAnimals(); }
};

/* â”€â”€ Real-time â”€â”€ */
supabase.channel("recovery-live")
  .on("postgres_changes", { event:"*", schema:"public", table:"vasd_queue" },       loadRecoveryAnimals)
  .on("postgres_changes", { event:"*", schema:"public", table:"vasd_vital_signs" }, loadRecoveryAnimals)
  .subscribe();

loadRecoveryAnimals();
</script>
</body>
</html>
