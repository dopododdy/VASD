<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>à¸«à¹‰à¸­à¸‡à¸à¸±à¸à¸Ÿà¸·à¹‰à¸™ â€“ VASD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOKENS (à¸„à¸‡à¹€à¸”à¸´à¸¡à¸•à¸²à¸¡ Design System à¸‚à¸­à¸‡à¸„à¸¸à¸“)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --navy:         #0b1929;
  --navy-mid:      #112240;
  --teal:          #0ea5a0;
  --teal-light:    #14c4bc;
  --teal-glow:     rgba(14,165,160,0.25);
  --violet:        #8b5cf6;
  --violet-soft:   rgba(139,92,246,0.14);
  --violet-glow:   rgba(139,92,246,0.25);
  --rose:          #ef4444;
  --rose-soft:     rgba(239,68,68,0.12);
  --emerald:       #10b981;
  --emerald-soft:  rgba(16,185,129,0.14);

  --surface:    rgba(255,255,255,0.04);
  --surface-2:  rgba(255,255,255,0.07);
  --surface-3:  rgba(255,255,255,0.11);
  --border:     rgba(255,255,255,0.08);
  --border-2:   rgba(255,255,255,0.14);
  --text:       #e2e8f0;
  --text-dim:   #94a3b8;
  --text-faint: #4a5568;

  --radius-xs: 6px;
  --radius-sm: 10px;
  --radius:    16px;
  --radius-lg: 22px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }

body {
  font-family: "Sarabun", sans-serif;
  background: var(--navy);
  color: var(--text);
  min-height: 100vh;
  display: flex; flex-direction: column;
  overflow-x: hidden;
}
body::before {
  content: ""; position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background:
    radial-gradient(ellipse 60% 50% at 20% 10%, rgba(139,92,246,0.09) 0%, transparent 70%),
    radial-gradient(ellipse 50% 40% at 80% 80%, rgba(14,165,160,0.07) 0%, transparent 60%);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
header {
  position: sticky; top: 0; z-index: 200;
  background: rgba(11,25,41,0.88);
  backdrop-filter: blur(20px) saturate(180%);
  border-bottom: 1px solid var(--border);
  padding: 0 20px; height: 64px;
  display: flex; align-items: center; justify-content: space-between;
}
.brand { display: flex; align-items: center; gap: 10px; }
.brand-logo {
  width: 38px; height: 38px;
  background: linear-gradient(135deg, var(--violet), #a78bfa);
  border-radius: 10px; display: flex; align-items: center; justify-content: center;
  box-shadow: 0 0 20px var(--violet-glow);
}
.brand-name { font-family: "Outfit", sans-serif; font-size: 15px; font-weight: 700; color: #fff; }
.btn-home {
  padding: 8px 14px; font-size: 12px; font-weight: 600;
  background: var(--surface-2); color: var(--text-dim);
  border: 1px solid var(--border-2); border-radius: var(--radius-sm); cursor: pointer;
}

.wrap {
  position: relative; z-index: 1;
  max-width: 960px; margin: 0 auto;
  padding: 24px 16px 60px; width: 100%;
}

.section-title {
  font-size: 10px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase;
  color: var(--text-faint); margin-bottom: 18px;
  display: flex; align-items: center; gap: 8px;
}
.section-title::after { content: ""; flex: 1; height: 1px; background: var(--border); }
.section-count {
  font-size: 10px; color: var(--text-dim); background: var(--surface-2);
  border: 1px solid var(--border-2); border-radius: 20px; padding: 2px 10px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RECOVERY GRID & CARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#recoveryGrid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
  gap: 16px;
}
@media (max-width: 640px) { #recoveryGrid { grid-template-columns: 1fr; } }

.rec-card {
  background: var(--surface);
  border: 1px solid var(--border-2);
  border-radius: var(--radius-lg);
  display: flex; flex-direction: column;
  animation: slideUp 0.4s ease both;
}
.rec-card::before {
  content: ""; display: block; height: 3px;
  background: linear-gradient(90deg, var(--violet), #a78bfa);
}

.rc-header {
  display: flex; align-items: center; gap: 12px;
  padding: 12px 14px; background: var(--surface-2);
}
.queue-circle {
  font-family: "Outfit", sans-serif; width: 40px; height: 40px; border-radius: 50%;
  background: var(--violet-soft); border: 2px solid rgba(139,92,246,0.3);
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; font-weight: 800; color: #c4b5fd;
}
.rc-animal-name { font-family: "Outfit", sans-serif; font-size: 16px; font-weight: 800; color: #fff; }
.rc-meta { font-size: 11px; color: var(--text-dim); }

.rc-tabs { display: flex; border-bottom: 1px solid var(--border); background: var(--surface-2); }
.rc-tab {
  flex: 1; padding: 10px; text-align: center; font-size: 12px; font-weight: 600;
  color: var(--text-dim); cursor: pointer; border: none; background: none;
  border-bottom: 2px solid transparent; transition: 0.2s;
}
.rc-tab.active { color: #c4b5fd; border-bottom-color: var(--violet); }
.rc-tab.tab-emergency.active { color: #fca5a5; border-bottom-color: var(--rose); }

.rc-panel { display: none; padding: 14px; }
.rc-panel.active { display: block; }

/* Vital Table Style */
.vital-input-grid {
  display: grid; grid-template-columns: 72px repeat(4, 1fr) auto;
  gap: 7px; margin-bottom: 12px;
}
@media (max-width: 480px) {
  .vital-input-grid { grid-template-columns: repeat(3, 1fr); }
  .v-time-cell, .v-btn-cell { grid-column: 1 / -1; }
}

.field-group { display: flex; flex-direction: column; gap: 3px; }
.field-label { font-size: 9px; font-weight: 700; color: var(--text-faint); text-transform: uppercase; }
.f-input {
  width: 100%; padding: 8px; font-size: 13px; background: var(--surface-2);
  border: 1px solid var(--border-2); border-radius: var(--radius-sm); color: #fff;
}

.vital-table-wrap { border: 1px solid var(--border); border-radius: var(--radius-sm); overflow-x: auto; }
.vital-table { width: 100%; border-collapse: collapse; font-size: 12px; text-align: center; }
.vital-table th { padding: 8px; background: var(--surface-3); font-size: 9px; color: var(--text-dim); }
.vital-table td { padding: 8px; border-bottom: 1px solid var(--border); }

/* Emergency Table */
.em-table { width: 100%; border-collapse: collapse; }
.em-row { border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; padding: 10px 0; }
.em-drug { font-weight: 600; color: #fca5a5; font-size: 13px; }
.em-dose { font-family: "Outfit", sans-serif; font-weight: 700; color: #fff; font-size: 15px; }
.em-hint { font-size: 10px; color: var(--text-dim); }

.rc-footer { padding: 12px; display: flex; gap: 8px; background: var(--surface-2); margin-top: auto; }
.btn { 
    flex: 1; padding: 10px; border-radius: var(--radius-sm); border: none; 
    font-weight: 600; cursor: pointer; font-family: "Sarabun"; font-size: 12px;
}
.btn-rx { background: rgba(14,165,160,0.15); color: var(--teal-light); border: 1px solid rgba(14,165,160,0.3); }
.btn-close-job { background: var(--emerald-soft); color: var(--emerald); border: 1px solid rgba(16,185,129,0.3); }

@keyframes slideUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="brand-logo">ğŸŸ£</div>
    <div class="brand-name">VASD RECOVERY</div>
  </div>
  <button class="btn-home" onclick="location.href='index.html'">ğŸ  à¸«à¸™à¹‰à¸²à¸«à¸¥à¸±à¸</button>
</header>

<div class="wrap">
  <div class="section-title">
    à¸à¸³à¸¥à¸±à¸‡à¸à¸±à¸à¸Ÿà¸·à¹‰à¸™ <span class="section-count" id="recCount">0</span>
  </div>

  <div id="recoveryGrid">
    <div class="empty-state">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥...</div>
  </div>
</div>

<script type="module">
import { supabase } from "./js/supabase.js";

async function loadRecoveryAnimals() {
  const grid = document.getElementById("recoveryGrid");
  const { data: eventId } = await supabase.rpc("get_today_event");
  
  const { data, error } = await supabase
    .from("vasd_animal")
    .select(`
      id, queue_number, animal_name, species, sex, actual_weight,
      vasd_queue!inner(status),
      vasd_vital_signs(*)
    `)
    .eq("event_id", eventId)
    .eq("vasd_queue.status", "recovery")
    .order("queue_number");

  if (error) return;
  document.getElementById("recCount").textContent = data.length;

  if (data.length === 0) {
    grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:60px; color:var(--text-faint);">à¹„à¸¡à¹ˆà¸¡à¸µà¸ªà¸±à¸•à¸§à¹Œà¹ƒà¸™à¸«à¹‰à¸­à¸‡à¸à¸±à¸à¸Ÿà¸·à¹‰à¸™</div>`;
    return;
  }

  // à¹€à¸à¹‡à¸šà¸ªà¸–à¸²à¸™à¸° Tab à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™à¹„à¸§à¹‰à¸à¸±à¸™à¸«à¸™à¹‰à¸²à¸ˆà¸­ Refresh à¹à¸¥à¹‰à¸§à¸à¸£à¸°à¹‚à¸”à¸”
  const currentTabs = {};
  grid.querySelectorAll(".rec-card").forEach(c => {
    const active = c.querySelector(".rc-tab.active");
    if(active) currentTabs[c.dataset.id] = active.dataset.tab;
  });

  grid.innerHTML = "";
  const now = new Date().toTimeString().substring(0, 5);

  data.forEach(a => {
    const weight = a.actual_weight || 0;
    const activeTab = currentTabs[a.id] || "monitoring";

    // à¸„à¸³à¸™à¸§à¸“ Emergency Dose
    // Adrenaline 1mg/ml (0.01 mg/kg) -> ml = (weight * 0.01) / 1
    const adr = (weight * 0.01).toFixed(2);
    // Atropine 1mg/ml (0.02 mg/kg) -> ml = (weight * 0.02) / 1
    const atr = (weight * 0.02).toFixed(2);
    // Antipamezole 5mg/ml (0.05 mg/kg) -> ml = (weight * 0.05) / 5
    const ant = ((weight * 0.05) / 5).toFixed(2);

    const vitals = (a.vasd_vital_signs || []).sort((x, y) => (x.time_recorded || "").localeCompare(y.time_recorded || ""));
    const vitalRows = vitals.length === 0 
      ? `<tr><td colspan="5" style="padding:20px; color:var(--text-faint)">à¹„à¸¡à¹ˆà¸¡à¸µà¸šà¸±à¸™à¸—à¸¶à¸</td></tr>`
      : vitals.map(v => `
          <tr>
            <td style="color:#c4b5fd; font-weight:700">${v.time_recorded?.substring(0,5)}</td>
            <td>${v.hr || '-'}</td>
            <td>${v.rr || '-'}</td>
            <td>${v.temp || '-'}</td>
            <td>${v.spo2 ? v.spo2+'%' : '-'}</td>
          </tr>
        `).join("");

    const card = document.createElement("div");
    card.className = "rec-card";
    card.dataset.id = a.id;
    card.innerHTML = `
      <div class="rc-header">
        <div class="queue-circle">#${a.queue_number}</div>
        <div style="flex:1">
          <div class="rc-animal-name">${a.animal_name}</div>
          <div class="rc-meta">${a.species === 'à¸ª' ? 'à¸ªà¸¸à¸™à¸±à¸‚' : 'à¹à¸¡à¸§'} Â· ${a.sex} Â· ${weight} kg</div>
        </div>
      </div>

      <div class="rc-tabs">
        <button class="rc-tab ${activeTab==='monitoring'?'active':''}" data-tab="monitoring" onclick="switchTab(this)">Monitoring</button>
        <button class="rc-tab tab-emergency ${activeTab==='emergency'?'active':''}" data-tab="emergency" onclick="switchTab(this)">Emergency</button>
      </div>

      <div class="rc-panel ${activeTab==='monitoring'?'active':''}" data-panel="monitoring">
        <div class="vital-input-grid" id="form-${a.id}">
          <div class="field-group v-time-cell"><span class="field-label">Time</span><input class="f-input v-time" type="time" value="${now}"></div>
          <div class="field-group"><span class="field-label">HR</span><input class="f-input v-hr" type="number" placeholder="bpm"></div>
          <div class="field-group"><span class="field-label">RR</span><input class="f-input v-rr" type="number" placeholder="/m"></div>
          <div class="field-group"><span class="field-label">Temp</span><input class="f-input v-temp" type="number" placeholder="Â°C"></div>
          <div class="field-group"><span class="field-label">SpO2</span><input class="f-input v-spo2" type="number" placeholder="%"></div>
          <div class="field-group v-btn-cell" style="justify-content:flex-end">
            <button class="btn" style="background:var(--violet); color:#fff; padding:8px" onclick="saveVital('${a.id}')">à¸šà¸±à¸™à¸—à¸¶à¸</button>
          </div>
        </div>
        <div class="vital-table-wrap">
          <table class="vital-table">
            <thead><tr><th>Time</th><th>HR</th><th>RR</th><th>T(Â°C)</th><th>SpO2</th></tr></thead>
            <tbody>${vitalRows}</tbody>
          </table>
        </div>
      </div>

      <div class="rc-panel ${activeTab==='emergency'?'active':''}" data-panel="emergency">
        <div class="em-row">
          <div><div class="em-drug">Adrenaline (1 mg/ml)</div><div class="em-hint">0.01 mg/kg</div></div>
          <div class="em-dose">${adr} <span style="font-size:10px">ml</span></div>
        </div>
        <div class="em-row">
          <div><div class="em-drug">Atropine (1 mg/ml)</div><div class="em-hint">0.02 mg/kg</div></div>
          <div class="em-dose">${atr} <span style="font-size:10px">ml</span></div>
        </div>
        <div class="em-row" style="border:none">
          <div><div class="em-drug">Antipamezole (5 mg/ml)</div><div class="em-hint">0.05 mg/kg</div></div>
          <div class="em-dose">${ant} <span style="font-size:10px">ml</span></div>
        </div>
      </div>

      <div class="rc-footer">
        <button class="btn btn-rx" onclick="location.href='rx.html?animal_id=${a.id}'">ğŸ’Š à¸ªà¸±à¹ˆà¸‡à¸¢à¸²à¹€à¸à¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡</button>
        <button class="btn btn-close-job" onclick="closeJob('${a.id}')">âœ… à¸Ÿà¸·à¹‰à¸™à¸ªà¸¥à¸šà¹à¸¥à¹‰à¸§</button>
      </div>
    `;
    grid.appendChild(card);
  });
}

window.switchTab = (btn) => {
  const card = btn.closest(".rec-card");
  const tab = btn.dataset.tab;
  card.querySelectorAll(".rc-tab").forEach(t => t.classList.toggle("active", t.dataset.tab === tab));
  card.querySelectorAll(".rc-panel").forEach(p => p.classList.toggle("active", p.dataset.panel === tab));
};

window.saveVital = async (animalId) => {
  const form = document.getElementById(`form-${animalId}`);
  const { error } = await supabase.from("vasd_vital_signs").insert({
    animal_id: animalId,
    time_recorded: form.querySelector(".v-time").value,
    hr: form.querySelector(".v-hr").value || null,
    rr: form.querySelector(".v-rr").value || null,
    temp: form.querySelector(".v-temp").value || null,
    spo2: form.querySelector(".v-spo2").value || null
  });
  if (error) alert(error.message); else loadRecoveryAnimals();
};

window.closeJob = async (animalId) => {
  if (!confirm("à¸¢à¸·à¸™à¸¢à¸±à¸™à¸à¸²à¸£à¸Ÿà¸·à¹‰à¸™à¸ªà¸¥à¸šà¹à¸¥à¸°à¸›à¸´à¸”à¹€à¸„à¸ªà¸à¸±à¸à¸Ÿà¸·à¹‰à¸™?")) return;
  const { error } = await supabase.from("vasd_queue").update({ status: "ready_to_go_home" }).eq("animal_id", animalId);
  if (error) alert(error.message); else loadRecoveryAnimals();
};

// Real-time
supabase.channel("recovery-update").on("postgres_changes", { event: "*", schema: "public", table: "vasd_queue" }, loadRecoveryAnimals).subscribe();
loadRecoveryAnimals();
</script>
</body>
</html>
