<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>à¸«à¸™à¹ˆà¸§à¸¢à¸à¸±à¸à¸Ÿà¸·à¹‰à¸™ (Recovery) â€“ VASD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOKENS & BASE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --navy:         #0b1929;
  --navy-mid:      #112240;
  --teal:          #0ea5a0;
  --teal-light:    #14c4bc;
  --teal-glow:     rgba(14,165,160,0.25);
  --violet:        #8b5cf6;
  --violet-soft:   rgba(139,92,246,0.14);
  --rose:          #ef4444;
  --surface:       rgba(255,255,255,0.04);
  --border:        rgba(255,255,255,0.08);
  --text:          #e2e8f0;
  --text-dim:      #94a3b8;
}

* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: "Sarabun", sans-serif;
  background: var(--navy);
  color: var(--text);
  padding-bottom: 100px;
}

header {
  padding: 15px 20px;
  background: rgba(11,25,41,0.8);
  backdrop-filter: blur(10px);
  position: sticky; top: 0; z-index: 100;
  border-bottom: 1px solid var(--border);
  display: flex; justify-content: space-between; align-items: center;
}

.container { padding: 20px; max-width: 800px; margin: 0 auto; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RECOVERY CARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.rec-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 24px;
  padding: 20px;
  margin-bottom: 20px;
  position: relative;
  overflow: hidden;
}

.card-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
.q-circle {
  width: 45px; height: 45px; border-radius: 50%;
  background: var(--violet); color: white;
  display: flex; align-items: center; justify-content: center;
  font-family: 'Outfit'; font-weight: 800; font-size: 18px;
}

.tabs { display: flex; gap: 8px; margin-bottom: 15px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 12px; }
.tab-btn {
  flex: 1; padding: 8px; border: none; border-radius: 8px;
  background: transparent; color: var(--text-dim); font-size: 13px; cursor: pointer;
}
.tab-btn.active { background: var(--violet); color: white; }

.panel { display: none; }
.panel.active { display: block; }

/* Vitals Table (The Trend View) */
.vitals-history { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
.vitals-history th { color: var(--teal-light); border-bottom: 1px solid var(--border); padding: 8px 4px; text-align: center; }
.vitals-history td { text-align: center; padding: 8px 4px; border-bottom: 1px solid rgba(255,255,255,0.05); }

/* Form Elements */
.input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
input {
  background: rgba(0,0,0,0.3); border: 1px solid var(--border);
  padding: 12px; border-radius: 12px; color: white; width: 100%;
}

.btn-save {
  width: 100%; padding: 14px; background: var(--teal); border: none;
  border-radius: 14px; color: white; font-weight: 700; cursor: pointer;
}

.btn-finish {
  width: 100%; padding: 14px; background: transparent; border: 1px solid var(--violet);
  color: var(--violet); border-radius: 14px; font-weight: 700; margin-top: 10px; cursor: pointer;
}

/* Bottom Nav */
.bottom-nav {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: rgba(11, 25, 41, 0.9); backdrop-filter: blur(20px);
  border-top: 1px solid var(--border); display: flex; justify-content: space-around;
  padding: 10px 0 calc(10px + env(safe-area-inset-bottom));
}
.nav-item { text-decoration: none; color: var(--text-dim); font-size: 10px; text-align: center; }
.nav-item.active { color: var(--teal-light); }
</style>
</head>
<body>

<header>
  <h2 style="font-family:'Outfit';">Recovery Ward</h2>
  <div id="count-badge" style="background:var(--violet); padding:4px 12px; border-radius:20px; font-size:12px;">0 à¸ªà¸±à¸•à¸§à¹Œà¸à¸±à¸à¸Ÿà¸·à¹‰à¸™</div>
</header>

<div class="container" id="recovery-list">
  </div>

<nav class="bottom-nav">
  <a href="index.html" class="nav-item">ğŸ <br>à¸«à¸™à¹‰à¸²à¸«à¸¥à¸±à¸</a>
  <a href="surgery.html" class="nav-item">âœ‚ï¸<br>à¸œà¹ˆà¸²à¸•à¸±à¸”</a>
  <a href="recovery.html" class="nav-item active">ğŸš‘<br>à¸à¸±à¸à¸Ÿà¸·à¹‰à¸™</a>
  <a href="report.html" class="nav-item">ğŸ“Š<br>à¸£à¸²à¸¢à¸‡à¸²à¸™</a>
</nav>

<script type="module">
import { supabase } from "./js/supabase.js";

async function loadRecovery() {
  const container = document.getElementById("recovery-list");
  
  // à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸±à¸•à¸§à¹Œ à¸à¸£à¹‰à¸­à¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸„à¸´à¸§ (Status: recovery) à¹à¸¥à¸° Vital Signs à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” (à¹€à¸£à¸µà¸¢à¸‡à¸•à¸²à¸¡à¹€à¸§à¸¥à¸²)
  const { data: animals, error } = await supabase
    .from('vasd_animal')
    .select(`
      *,
      vasd_owner(owner_name),
      vasd_queue!inner(*),
      vasd_vital_signs(*)
    `)
    .eq('vasd_queue.status', 'recovery')
    .order('created_at', { foreignTable: 'vasd_vital_signs', ascending: true });

  if (error) return console.error(error);
  
  document.getElementById("count-badge").innerText = `${animals.length} à¸ªà¸±à¸•à¸§à¹Œà¸à¸±à¸à¸Ÿà¸·à¹‰à¸™`;
  container.innerHTML = "";

  animals.forEach(ani => {
    // à¹€à¸•à¸£à¸µà¸¢à¸¡à¹à¸–à¸§à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸•à¸²à¸£à¸²à¸‡ (Vital Signs Trends)
    const vitalsRows = (ani.vasd_vital_signs || []).map(v => `
      <tr>
        <td style="color:var(--teal-light)">${v.time_recorded || '-'}</td>
        <td>${v.hr || '-'}</td>
        <td>${v.rr || '-'}</td>
        <td>${v.spo2 || '-'}</td>
        <td>${v.temp || '-'}</td>
      </tr>
    `).join('');

    const card = document.createElement("div");
    card.className = "rec-card";
    card.innerHTML = `
      <div class="card-header">
        <div>
          <h3 style="font-size:18px;">${ani.animal_name}</h3>
          <p style="font-size:12px; color:var(--text-dim)">à¹€à¸ˆà¹‰à¸²à¸‚à¸­à¸‡: ${ani.vasd_owner?.owner_name || '-'}</p>
        </div>
        <div class="q-circle">${ani.queue_number}</div>
      </div>

      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab(this, 'monitor')">Monitoring</button>
        <button class="tab-btn" onclick="switchTab(this, 'record')">à¸šà¸±à¸™à¸—à¸¶à¸à¹€à¸à¸´à¹ˆà¸¡</button>
      </div>

      <div class="panel active" id="panel-monitor-${ani.id}">
        <div style="overflow-x:auto; background:rgba(0,0,0,0.2); border-radius:12px; padding:10px;">
          <table class="vitals-history">
            <thead>
              <tr>
                <th>Time</th><th>HR</th><th>RR</th><th>SpO2</th><th>Temp</th>
              </tr>
            </thead>
            <tbody>
              ${vitalsRows || '<tr><td colspan="5" style="padding:20px; color:var(--text-dim)">à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸±à¸à¸à¸²à¸“à¸Šà¸µà¸</td></tr>'}
            </tbody>
          </table>
        </div>
        <button class="btn-finish" onclick="moveToReady('${ani.id}')">à¸Ÿà¸·à¹‰à¸™à¸ªà¸¥à¸šà¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢ (Ready)</button>
      </div>

      <div class="panel" id="panel-record-${ani.id}">
        <div class="input-row">
          <input type="number" placeholder="HR (à¸„à¸£à¸±à¹‰à¸‡/à¸™à¸²à¸—à¸µ)" class="in-hr">
          <input type="number" placeholder="RR (à¸„à¸£à¸±à¹‰à¸‡/à¸™à¸²à¸—à¸µ)" class="in-rr">
        </div>
        <div class="input-row">
          <input type="number" step="0.1" placeholder="Temp (Â°C)" class="in-temp">
          <input type="number" placeholder="SpO2 (%)" class="in-spo2">
        </div>
        <button class="btn-save" onclick="saveVital('${ani.id}', this)">à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸±à¸à¸à¸²à¸“à¸Šà¸µà¸</button>
      </div>
    `;
    container.appendChild(card);
  });
}

// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸ªà¸¥à¸±à¸š Tab à¸ à¸²à¸¢à¹ƒà¸™ Card
window.switchTab = (btn, tabName) => {
  const card = btn.closest(".rec-card");
  card.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
  
  card.querySelectorAll(".panel").forEach(p => p.classList.remove("active"));
  card.querySelector(`#panel-${tabName}-${card.querySelector('.btn-save').getAttribute('onclick').split("'")[1]}`).classList.add("active");
};

// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸±à¸à¸à¸²à¸“à¸Šà¸µà¸à¹ƒà¸«à¸¡à¹ˆ
window.saveVital = async (animalId, btn) => {
  const panel = btn.closest(".panel");
  const data = {
    animal_id: animalId,
    time_recorded: new Date().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', hour12: false }),
    hr: panel.querySelector(".in-hr").value,
    rr: panel.querySelector(".in-rr").value,
    temp: panel.querySelector(".in-temp").value,
    spo2: panel.querySelector(".in-spo2").value
  };

  const { error } = await supabase.from('vasd_vital_signs').insert(data);
  if (error) alert("à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”: " + error.message);
  else loadRecovery();
};

// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸¢à¹‰à¸²à¸¢à¸ªà¸–à¸²à¸™à¸°à¹„à¸›à¸¢à¸±à¸‡ "à¸à¸£à¹‰à¸­à¸¡à¸à¸¥à¸±à¸šà¸šà¹‰à¸²à¸™"
window.moveToReady = async (animalId) => {
  if (!confirm("à¸ªà¸±à¸•à¸§à¹Œà¸•à¸±à¸§à¸™à¸µà¹‰à¸Ÿà¸·à¹‰à¸™à¸ªà¸¥à¸šà¸ªà¸¡à¸šà¸¹à¸£à¸“à¹Œà¹à¸¥à¸°à¸à¸£à¹‰à¸­à¸¡à¸à¸¥à¸±à¸šà¸šà¹‰à¸²à¸™à¹à¸¥à¹‰à¸§à¹ƒà¸Šà¹ˆà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ?")) return;
  const { error } = await supabase.from('vasd_queue').update({ status: 'ready_to_go_home' }).eq('animal_id', animalId);
  if (error) alert(error.message);
  else loadRecovery();
};

// Realtime Update: à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¸¡à¹ˆà¸«à¸²à¸à¸¡à¸µà¸à¸²à¸£à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡
supabase.channel('recovery-realtime')
  .on('postgres_changes', { event: '*', schema: 'public', table: 'vasd_vital_signs' }, loadRecovery)
  .on('postgres_changes', { event: '*', schema: 'public', table: 'vasd_queue' }, loadRecovery)
  .subscribe();

loadRecovery();
</script>
   <script type="module" src="./js/global-alarm.js"></script>
</body>
</html>
