<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>à¸«à¸™à¹ˆà¸§à¸¢à¸à¸±à¸à¸Ÿà¸·à¹‰à¸™ â€“ VASD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOKENS & BASE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --navy:         #0b1929;
  --navy-mid:      #112240;
  --teal:          #0ea5a0;
  --teal-light:    #14c4bc;
  --teal-glow:     rgba(14,165,160,0.25);
  --violet:        #8b5cf6;
  --violet-soft:   rgba(139,92,246,0.14);
  --rose:          #ef4444;
  --amber:         #f59e0b;
  --emerald:       #10b981;
  --surface:       rgba(255,255,255,0.04);
  --border:        rgba(255,255,255,0.08);
  --border-2:      rgba(255,255,255,0.14);
  --text:          #e2e8f0;
  --text-dim:      #94a3b8;
}

* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: "Sarabun", sans-serif;
  background: var(--navy);
  color: var(--text);
  padding-bottom: 100px;
}

header {
  padding: 15px 20px;
  background: rgba(11,25,41,0.8);
  backdrop-filter: blur(10px);
  position: sticky; top: 0; z-index: 100;
  border-bottom: 1px solid var(--border);
  display: flex; justify-content: space-between; align-items: center;
}

.container { padding: 20px; max-width: 800px; margin: 0 auto; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RECOVERY CARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.rec-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 24px;
  padding: 20px;
  margin-bottom: 20px;
  position: relative;
  overflow: hidden;
  animation: slideUp 0.4s ease both;
}
@keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

.card-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
.q-circle {
  width: 45px; height: 45px; border-radius: 50%;
  background: var(--violet); color: white;
  display: flex; align-items: center; justify-content: center;
  font-family: 'Outfit'; font-weight: 800; font-size: 18px;
  flex-shrink: 0;
}

.tabs { display: flex; gap: 8px; margin-bottom: 15px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 12px; }
.tab-btn {
  flex: 1; padding: 10px; border: none; border-radius: 8px;
  background: transparent; color: var(--text-dim); font-size: 13px; font-weight: 600; cursor: pointer;
  transition: all 0.2s; font-family: "Sarabun", sans-serif;
}
.tab-btn.active { background: var(--violet); color: white; }

.panel { display: none; }
.panel.active { display: block; animation: fadeIn 0.3s ease; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* Vitals Table */
.vitals-history { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
.vitals-history th { color: var(--teal-light); border-bottom: 1px solid var(--border); padding: 8px 4px; text-align: center; }
.vitals-history td { text-align: center; padding: 8px 4px; border-bottom: 1px solid rgba(255,255,255,0.05); }

/* Form Elements */
.monitor-inputs { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 10px; }
.monitor-inputs .wide { grid-column: span 4; }
input {
  background: rgba(0,0,0,0.3); border: 1px solid var(--border);
  padding: 10px 8px; border-radius: 10px; color: white; width: 100%;
  font-size: 13px; font-family: "Sarabun", sans-serif; text-align: center;
  outline: none; transition: 0.2s;
}
input:focus { border-color: var(--violet); }

.btn-save {
  width: 100%; padding: 10px; background: var(--violet); border: none;
  border-radius: 10px; color: white; font-weight: 600; cursor: pointer;
  margin-bottom: 15px; font-family: "Sarabun", sans-serif; font-size: 13px;
}

.btn-finish {
  width: 100%; padding: 14px; background: transparent; border: 1px solid var(--violet);
  color: var(--violet); border-radius: 14px; font-weight: 700; margin-top: 15px; cursor: pointer;
  font-family: "Sarabun", sans-serif; font-size: 15px; transition: 0.2s;
}
.btn-finish:hover { background: var(--violet-soft); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOTTOM NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bottom-nav {
  display: grid;
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 300;
  background: rgba(11,25,41,0.95);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-top: 1px solid var(--border-2);
  padding: 8px 0 max(8px, env(safe-area-inset-bottom));
  grid-template-columns: repeat(5, 1fr);
}
.nav-item {
  display: flex; flex-direction: column; align-items: center; gap: 3px;
  padding: 6px 4px;
  font-size: 9px; color: var(--text-dim);
  text-decoration: none; cursor: pointer;
  transition: color 0.2s;
  -webkit-tap-highlight-color: transparent;
  font-weight: normal;
}
.nav-item:active { color: var(--teal); }
.nav-icon { font-size: 21px; line-height: 1; }
.nav-item.active { color: var(--teal); }
.nav-item.active .nav-icon { filter: drop-shadow(0 0 6px var(--teal)); }
</style>
</head>
<body>

<header>
  <h2 style="font-family:'Outfit';">à¸«à¸™à¹ˆà¸§à¸¢à¸à¸±à¸à¸Ÿà¸·à¹‰à¸™</h2>
  <div id="count-badge" style="background:var(--violet); padding:4px 12px; border-radius:20px; font-size:12px;">0 à¸ªà¸±à¸•à¸§à¹Œà¸à¸±à¸à¸Ÿà¸·à¹‰à¸™</div>
</header>

<div class="container" id="recovery-list">
  <div style="text-align: center; color: var(--text-dim); padding: 40px;">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥...</div>
</div>

<nav class="bottom-nav">
  <a class="nav-item" href="index.html">
    <span class="nav-icon">ğŸ </span>à¸«à¸™à¹‰à¸²à¸«à¸¥à¸±à¸
  </a>
  <a class="nav-item" href="animals.html">
    <span class="nav-icon">ğŸ¾</span>à¸ªà¸±à¸•à¸§à¹Œ
  </a>
  <a class="nav-item" href="anesthesia.html">
    <span class="nav-icon">ğŸ’‰</span>à¸§à¸²à¸‡à¸¢à¸²
  </a>
  <a class="nav-item" href="surgery.html">
    <span class="nav-icon">ğŸ›ï¸</span>à¸œà¹ˆà¸²à¸•à¸±à¸”
  </a>
  <a class="nav-item active" href="recovery.html">
    <span class="nav-icon">â¤ï¸â€ğŸ©¹</span>à¸à¸±à¸à¸Ÿà¸·à¹‰à¸™
  </a>
</nav>

<script type="module">
import { supabase } from "./js/supabase.js";

// à¸›à¹‰à¸­à¸‡à¸à¸±à¸™ HTML injection à¸ªà¸³à¸«à¸£à¸±à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸”à¸¶à¸‡à¸¡à¸²à¹à¸ªà¸”à¸‡à¸œà¸¥
function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

async function loadRecovery() {
  const container = document.getElementById("recovery-list");
  
  // à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸±à¸•à¸§à¹Œ à¸à¸£à¹‰à¸­à¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸„à¸´à¸§ (Status: recovery) à¹à¸¥à¸° Vital Signs à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
  const { data: animals, error } = await supabase
    .from('vasd_animal')
    .select(`
      *,
      vasd_owner(owner_name),
      vasd_queue!inner(*),
      vasd_vital_signs(*)
    `)
    .eq('vasd_queue.status', 'recovery')
    .order('created_at', { foreignTable: 'vasd_vital_signs', ascending: true });

  if (error) {
    container.innerHTML = `<div style="text-align:center; padding: 40px; color: #fca5a5;">âŒ à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ</div>`;
    return console.error(error);
  }
  
  document.getElementById("count-badge").innerText = `${animals.length} à¸ªà¸±à¸•à¸§à¹Œà¸à¸±à¸à¸Ÿà¸·à¹‰à¸™`;
  container.innerHTML = "";

  if (animals.length === 0) {
    container.innerHTML = `<div style="text-align:center; padding: 60px 20px; color: var(--text-dim);">âœ… à¹„à¸¡à¹ˆà¸¡à¸µà¹€à¸„à¸ªà¸à¸³à¸¥à¸±à¸‡à¸à¸±à¸à¸Ÿà¸·à¹‰à¸™à¹ƒà¸™à¸‚à¸“à¸°à¸™à¸µà¹‰</div>`;
    return;
  }

  animals.forEach(ani => {
    // à¸ˆà¸±à¸”à¹€à¸£à¸µà¸¢à¸‡à¹€à¸§à¸¥à¸²à¹à¸ªà¸”à¸‡à¸œà¸¥ à¹à¸¥à¸°à¹€à¸à¸´à¹ˆà¸¡à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œ Zol / Note
    const sortedVitals = (ani.vasd_vital_signs || []).sort((x, y) => new Date(x.created_at) - new Date(y.created_at));
    const vitalsRows = sortedVitals.map(v => `
      <tr>
        <td style="color:var(--teal-light)">${v.time_recorded || '-'}</td>
        <td>${v.hr || '-'}</td>
        <td>${v.rr || '-'}</td>
        <td>${v.spo2 || '-'}</td>
        <td>${v.temp || '-'}</td>
        <td>${v.zoletil_top || '-'}</td>
        <td style="text-align:left; font-size:11px;">${v.note || '-'}</td>
      </tr>
    `).join('');

    // à¸„à¸³à¸™à¸§à¸“à¸›à¸£à¸´à¸¡à¸²à¸•à¸£à¸¢à¸² Emergency 
    const weight = parseFloat(ani.actual_weight) || 0;
    let adrVol = "N/A", atrVol = "N/A", atipVol = "N/A";
    if (weight > 0) {
      adrVol = ((weight * 0.01) / 1).toFixed(2) + " ml";
      atrVol = ((weight * 0.02) / 1).toFixed(2) + " ml";
      atipVol = ((weight * 0.1) / 5).toFixed(2) + " ml";
    }

    // à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ à¹‚à¸•à¹Šà¸°, Surgeon, Anes à¸—à¸µà¹ˆà¸šà¸±à¸™à¸—à¸¶à¸à¸¡à¸²à¸ˆà¸²à¸à¸«à¹‰à¸­à¸‡à¸œà¹ˆà¸²à¸•à¸±à¸”
    const qData = Array.isArray(ani.vasd_queue) ? ani.vasd_queue[0] : ani.vasd_queue;
    const table = escapeHtml(qData?.operating_table || '-');
    const surgeon = escapeHtml(qData?.surgeon_name || '-');
    const anes = escapeHtml(qData?.anesthetist || '-');

    const card = document.createElement("div");
    card.className = "rec-card";
    card.innerHTML = `
      <div class="card-header">
        <div style="flex: 1;">
          <h3 style="font-size:18px;">${ani.animal_name}</h3>
          <p style="font-size:12px; color:var(--text-dim)">à¹€à¸ˆà¹‰à¸²à¸‚à¸­à¸‡: ${ani.vasd_owner?.owner_name || '-'}</p>
          <p style="font-size:11px; color:var(--text-dim); margin-top:2px;">à¸™à¸™.: ${ani.actual_weight || '-'} kg</p>
          
          <div style="font-size:11px; color:var(--teal-light); margin-top:8px; display:flex; gap:10px; flex-wrap:wrap; background: rgba(0,0,0,0.2); padding: 8px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05);">
            <span>ğŸ›ï¸ à¹‚à¸•à¹Šà¸°: <b style="color:#fff">${table}</b></span>
            <span>ğŸ”ª à¸«à¸¡à¸­: <b style="color:#fff">${surgeon}</b></span>
            <span>ğŸ’‰ à¸§à¸´à¸ªà¸±à¸à¸à¸µ: <b style="color:#fff">${anes}</b></span>
          </div>
        </div>
        <div class="q-circle">${ani.queue_number}</div>
      </div>

      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab(this, 'panel-monitor-${ani.id}')">Monitoring</button>
        <button class="tab-btn" style="color:var(--rose);" onclick="switchTab(this, 'panel-emergency-${ani.id}')">ğŸš¨ Emergency</button>
      </div>

      <div class="panel active" id="panel-monitor-${ani.id}">
        <div class="monitor-inputs">
          <input type="number" placeholder="HR" class="in-hr">
          <input type="number" placeholder="RR" class="in-rr">
          <input type="number" placeholder="SpO2%" class="in-spo2">
          <input type="number" step="0.1" placeholder="Temp" class="in-temp">
          <input type="text" placeholder="à¸šà¸±à¸™à¸—à¸¶à¸à¹€à¸à¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡ (Note)..." class="in-note wide">
        </div>
        <button class="btn-save" onclick="saveVital('${ani.id}', this)">+ à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸±à¸à¸à¸²à¸“à¸Šà¸µà¸à¸¥à¸‡à¸£à¸°à¸šà¸š</button>

        <div style="overflow-x:auto; background:rgba(0,0,0,0.2); border-radius:12px; padding:10px;">
          <table class="vitals-history">
            <thead>
              <tr>
                <th>Time</th><th>HR</th><th>RR</th><th>SpO2</th><th>Temp</th><th>Zol</th><th>Note</th>
              </tr>
            </thead>
            <tbody>
              ${vitalsRows || '<tr><td colspan="7" style="padding:20px; color:var(--text-dim)">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸±à¸à¸à¸²à¸“à¸Šà¸µà¸</td></tr>'}
            </tbody>
          </table>
        </div>
        <button class="btn-finish" onclick="moveToReady('${ani.id}')">âœ… à¸Ÿà¸·à¹‰à¸™à¸ªà¸¥à¸šà¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢</button>
      </div>

      <div class="panel" id="panel-emergency-${ani.id}">
        <div style="display: flex; flex-direction: column; gap: 8px;">
          <div style="background: rgba(239,68,68,0.1); padding: 12px; border-radius: 10px; display: flex; justify-content: space-between;">
            <span style="color:var(--rose); font-weight:700;">Adrenaline</span> <b style="font-size:18px;">${adrVol}</b>
          </div>
          <div style="background: rgba(245,158,11,0.1); padding: 12px; border-radius: 10px; display: flex; justify-content: space-between;">
            <span style="color:var(--amber); font-weight:700;">Atropine</span> <b style="font-size:18px;">${atrVol}</b>
          </div>
          <div style="background: rgba(16,185,129,0.1); padding: 12px; border-radius: 10px; display: flex; justify-content: space-between;">
            <span style="color:var(--emerald); font-weight:700;">Atipamezole</span> <b style="font-size:18px;">${atipVol}</b>
          </div>
        </div>
      </div>
    `;
    container.appendChild(card);
  });
}

// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸ªà¸¥à¸±à¸š Tab
window.switchTab = (btn, targetId) => {
  const card = btn.closest(".rec-card");
  card.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
  
  card.querySelectorAll(".panel").forEach(p => p.classList.remove("active"));
  document.getElementById(targetId).classList.add("active");
};

// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸±à¸à¸à¸²à¸“à¸Šà¸µà¸à¹ƒà¸«à¸¡à¹ˆ
window.saveVital = async (animalId, btn) => {
  const panel = btn.closest(".panel");
  const inHr = panel.querySelector(".in-hr").value;
  const inRr = panel.querySelector(".in-rr").value;
  const inTemp = panel.querySelector(".in-temp").value;
  const inSpo2 = panel.querySelector(".in-spo2").value;
  const inNote = panel.querySelector(".in-note").value;

  if (!inHr && !inRr && !inTemp && !inSpo2 && !inNote) return; 

  const data = {
    animal_id: animalId,
    time_recorded: new Date().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', hour12: false }),
    hr: inHr,
    rr: inRr,
    temp: inTemp,
    spo2: inSpo2,
    note: inNote
  };

  const { error } = await supabase.from('vasd_vital_signs').insert(data);
  if (error) alert("à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”: " + error.message);
};

// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸¢à¹‰à¸²à¸¢à¸ªà¸–à¸²à¸™à¸°à¹„à¸›à¸¢à¸±à¸‡ "à¸à¸£à¹‰à¸­à¸¡à¸à¸¥à¸±à¸šà¸šà¹‰à¸²à¸™"
window.moveToReady = async (animalId) => {
  if (!confirm("à¸ªà¸±à¸•à¸§à¹Œà¸•à¸±à¸§à¸™à¸µà¹‰à¸Ÿà¸·à¹‰à¸™à¸ªà¸¥à¸šà¸ªà¸¡à¸šà¸¹à¸£à¸“à¹Œà¹à¸¥à¸°à¸à¸£à¹‰à¸­à¸¡à¸à¸¥à¸±à¸šà¸šà¹‰à¸²à¸™à¹à¸¥à¹‰à¸§à¹ƒà¸Šà¹ˆà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ?")) return;
  const { error } = await supabase.from('vasd_queue').update({ status: 'ready_to_go_home' }).eq('animal_id', animalId);
  if (error) alert(error.message);
};

// Realtime Update
supabase.channel('recovery-realtime')
  .on('postgres_changes', { event: '*', schema: 'public', table: 'vasd_vital_signs' }, loadRecovery)
  .on('postgres_changes', { event: '*', schema: 'public', table: 'vasd_queue' }, loadRecovery)
  .subscribe();

loadRecovery();
</script>
   <script type="module" src="./js/global-alarm.js"></script>
</body>
</html>
