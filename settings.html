<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>RMUTTO - VASD | ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&family=Prompt:wght@300;400;500;700&family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>
:root {
  --navy:#0d1b2a; --teal:#1a6b72; --teal-light:#22919a; --accent:#00d4aa;
  --bg:#f0f4f8; --surface:#fff; --text:#1a202c; --text-muted:#718096;
  --border:#e2e8f0; --danger:#e53e3e; --success:#38a169; --warning:#d69e2e;
  --shadow-sm:0 1px 3px rgba(0,0,0,0.06); --shadow-md:0 4px 16px rgba(13,27,42,0.08);
  --radius:14px; --radius-sm:8px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{font-family:"Sarabun",sans-serif;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;}

/* HEADER */
header{
  background:var(--navy);padding:0 24px;display:flex;
  justify-content:space-between;align-items:center;height:68px;
  flex-shrink:0;box-shadow:0 2px 20px rgba(0,0,0,0.25);z-index:10;
}
.header-brand{display:flex;align-items:center;gap:12px;}
.brand-icon{
  width:38px;height:38px;background:linear-gradient(135deg,var(--teal-light),var(--accent));
  border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:18px;
}
.brand-text h1{font-size:16px;font-weight:700;color:#fff;line-height:1.2;}
.brand-text span{font-size:11px;color:rgba(255,255,255,0.5);}
.header-actions{display:flex;gap:8px;}
.btn-header{
  padding:7px 14px;font-size:13px;font-weight:600;font-family:"Sarabun",sans-serif;
  border:none;border-radius:var(--radius-sm);cursor:pointer;
  transition:opacity 0.2s,transform 0.15s;display:inline-flex;align-items:center;gap:5px;
}
.btn-header:hover{opacity:0.88;transform:translateY(-1px);}
.btn-print-test{background:linear-gradient(135deg,var(--success),#48bb78);color:#fff;}
.btn-home-h{background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.85);border:1px solid rgba(255,255,255,0.2);}
.btn-home-h:hover{background:rgba(255,255,255,0.18);}

/* MAIN LAYOUT */
.layout{display:grid;grid-template-columns:380px 1fr;flex:1;overflow:hidden;}

/* SIDEBAR */
.sidebar{
  background:var(--surface);border-right:1px solid var(--border);
  overflow-y:auto;display:flex;flex-direction:column;
}
.sidebar-top{padding:20px;border-bottom:1px solid var(--border);}
.sidebar-section{padding:16px 20px;border-bottom:1px solid var(--border);}
.sidebar-section:last-child{border-bottom:none;}
.section-title{
  font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;
  color:var(--text-muted);margin-bottom:12px;
}

/* FIELDS */
label.field-label{font-size:12px;font-weight:600;color:var(--text-muted);display:block;margin-bottom:4px;}
input,select{
  width:100%;padding:9px 12px;font-size:13px;font-family:"Sarabun",sans-serif;
  border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);
  background:#fff;outline:none;transition:border-color 0.2s,box-shadow 0.2s;margin-bottom:10px;
}
input:focus,select:focus{border-color:var(--teal-light);box-shadow:0 0 0 3px rgba(34,145,154,0.12);}
input:last-child,select:last-child{margin-bottom:0;}

/* LINE BLOCK */
.line-block{
  background:#fafbfc;border:1px solid var(--border);border-radius:var(--radius-sm);
  padding:14px;margin-bottom:10px;position:relative;
}
.line-block:last-child{margin-bottom:0;}
.line-block-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
.line-block-header strong{font-size:13px;color:var(--navy);}

.prop-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;}
.prop-mini{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:8px;}
.prop-grid select,.prop-mini input,.prop-mini select{margin-bottom:0;}

/* VARS HINT */
.vars-hint{
  background:#f0fdf9;border:1px solid #a7f3d0;border-radius:var(--radius-sm);
  padding:12px;font-size:12px;line-height:1.8;color:#065f46;
}
.vars-hint strong{color:var(--navy);display:block;margin-bottom:4px;margin-top:8px;}
.vars-hint strong:first-child{margin-top:0;}
.vars-hint code{
  background:rgba(0,0,0,0.06);padding:2px 5px;border-radius:4px;font-size:11px;display:inline-block;margin-bottom:4px;
}

/* BUTTONS */
.btn{
  width:100%;padding:10px;font-size:13px;font-weight:700;font-family:"Sarabun",sans-serif;
  border:none;border-radius:var(--radius-sm);cursor:pointer;
  transition:opacity 0.2s,transform 0.15s;display:inline-flex;align-items:center;justify-content:center;gap:6px;
  margin-bottom:8px;
}
.btn:last-child{margin-bottom:0;}
.btn:hover{opacity:0.88;transform:translateY(-1px);}
.btn-load{background:#edf2f7;color:var(--text);}
.btn-add {background:var(--border);color:var(--text);}
.btn-save{background:linear-gradient(135deg,var(--teal),var(--accent));color:#fff;}
.btn-del-line{
  background:none;border:1px solid var(--border);color:var(--danger);
  padding:3px 8px;font-size:11px;border-radius:5px;cursor:pointer;font-weight:600;
}
.btn-del-line:hover{background:var(--danger);color:#fff;border-color:var(--danger);}

/* PREVIEW PANE */
.preview-pane{
  background:#dee3ea;display:flex;flex-direction:column;
  justify-content:center;align-items:center;gap:20px;overflow:hidden;
}
.preview-label{
  font-size:12px;font-weight:700;letter-spacing:1px;text-transform:uppercase;
  color:#718096;
}
.sticker{
  position:relative;width:80mm;height:50mm;background:#fff;
  box-shadow:0 4px 24px rgba(0,0,0,0.2),0 1px 4px rgba(0,0,0,0.1);
  overflow:hidden;border-radius:3px;
}
.line{
  position:absolute;white-space:pre-wrap;word-break:break-word;
  padding-right:5px;box-sizing:border-box;
}

/* PRINT */
@media print{
  body*{visibility:hidden;}
  #sticker,#sticker *{visibility:visible;}
  #sticker{position:absolute;left:0;top:0;box-shadow:none;}
  @page{size:80mm 50mm;margin:0;}
}
</style>
</head>
<body>

<header>
  <div class="header-brand">
    <div class="brand-icon">‚öôÔ∏è</div>
    <div class="brand-text">
      <h1>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå</h1>
      <span>Sticker Template Configuration</span>
    </div>
  </div>
  <div class="header-actions">
    <button class="btn-header btn-print-test" onclick="window.printTest()">üñ®Ô∏è ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå</button>
    <button class="btn-header btn-home-h" onclick="location.href='index.html'">üè† ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
  </div>
</header>

<div class="layout">

  <div class="sidebar">

    <div class="sidebar-top">
      <label class="field-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå</label>
      <select id="templateType">
        <option value="queue">üè∑ ‡∏Ñ‡∏¥‡∏ß</option>
        <option value="cage">üîí ‡∏ï‡∏¥‡∏î‡∏Å‡∏£‡∏á</option>
        <option value="envelope">‚úâÔ∏è ‡∏ï‡∏¥‡∏î‡∏ã‡∏≠‡∏á‡∏¢‡∏≤</option>
        <option value="bag">üíä ‡∏ï‡∏¥‡∏î‡∏ñ‡∏∏‡∏á‡∏¢‡∏≤</option>
        <option value="vaccine">üìí ‡∏ï‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏°‡∏∏‡∏î‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô</option>
        <option value="microchip">üí≥ ‡∏ï‡∏¥‡∏î‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡∏ä‡∏¥‡∏ü</option>
      </select>
      <button class="btn btn-load" onclick="loadTemplate()">üîÑ ‡πÇ‡∏´‡∏•‡∏î Template</button>
    </div>

    <div class="sidebar-section" style="flex:1;overflow-y:auto;">
      <div class="section-title">‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</div>
      <div id="lineEditor"></div>
      <button class="btn btn-add" onclick="addLine()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î</button>
    </div>

    <div class="sidebar-section">
      <div class="vars-hint">
        <strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ï‡∏ß‡πå / ‡∏Ñ‡∏¥‡∏ß</strong>
        <code>{{queue_number}}</code> <code>{{animal_name}}</code> <code>{{species}}</code>
        <code>{{sex}}</code> <code>{{owner_name}}</code> <code>{{phone}}</code> <code>{{services}}</code>
        
        <strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤ (‡∏â‡∏•‡∏≤‡∏Å‡∏¢‡∏≤)</strong>
        <code>{{drug_id}}</code> <code>{{dose}}</code> <code>{{freq}}</code> 
        <code>{{days}}</code> <code>{{total_pills}}</code>
      </div>
    </div>

    <div class="sidebar-section">
      <button class="btn btn-save" onclick="saveTemplate()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Template</button>
    </div>

  </div>

  <div class="preview-pane">
    <span class="preview-label">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå (‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏£‡∏¥‡∏á 80√ó50 mm)</span>
    <div class="sticker" id="sticker"></div>
  </div>

</div>

<script type="module">
import { supabase } from "./js/supabase.js";

let currentConfig = [];

function renderPreview() {
  const box = document.getElementById("sticker");
  box.innerHTML = "";
  currentConfig.forEach(l => {
    const div = document.createElement("div");
    div.className = "line";
    div.style.left = l.x + "px";
    div.style.top  = l.y + "px";
    div.style.fontSize   = l.size + "px";
    div.style.fontWeight = l.weight;
    div.style.fontFamily = l.font;
    div.style.textAlign  = l.align || "left";
    div.style.width      = `calc(100% - ${l.x}px)`;
    
    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏•‡∏≠‡∏á
    div.innerText = l.text
      .replace("{{queue_number}}","1")
      .replace("{{animal_name}}","‡∏ô‡πâ‡∏≠‡∏á‡∏ñ‡∏∏‡∏á‡∏ó‡∏≠‡∏á")
      .replace("{{species}}","‡πÅ‡∏°‡∏ß")
      .replace("{{sex}}","‡∏ú‡∏π‡πâ")
      .replace("{{owner_name}}","‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ")
      .replace("{{phone}}","081-234-5678")
      .replace("{{services}}","‡∏ó‡∏≥‡∏´‡∏°‡∏±‡∏ô, ‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô")
      // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏¢‡∏≤
      .replace("{{drug_id}}","Amoxicillin 250mg")
      .replace("{{dose}}","‡∏Å‡∏¥‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡∏∞ 1 ‡πÄ‡∏°‡πá‡∏î")
      .replace("{{freq}}","‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡πÄ‡∏ä‡πâ‡∏≤-‡πÄ‡∏¢‡πá‡∏ô) ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£")
      .replace("{{days}}","5 ‡∏ß‡∏±‡∏ô")
      .replace("{{total_pills}}","10");
      
    box.appendChild(div);
  });
}

function renderEditor() {
  const area = document.getElementById("lineEditor");
  area.innerHTML = "";
  currentConfig.forEach((l, i) => {
    const block = document.createElement("div");
    block.className = "line-block";
    block.innerHTML = `
      <div class="line-block-header">
        <strong>‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà ${i+1}</strong>
        <button class="btn-del-line" onclick="removeLine(${i})">‡∏•‡∏ö</button>
      </div>
      <label class="field-label">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</label>
      <input value="${l.text}" oninput="updateLine(${i},'text',this.value)" style="margin-bottom:10px;">
      <div class="prop-grid">
        <div>
          <label class="field-label">Font</label>
          <select onchange="updateLine(${i},'font',this.value)">
            <option value="monospace" ${l.font==="monospace"?"selected":""}>Monospace</option>
            <option value="Tahoma" ${l.font==="Tahoma"?"selected":""}>Tahoma</option>
            <option value="'Segoe UI'" ${l.font==="'Segoe UI'"?"selected":""}>Segoe UI</option>
            <option value="'Prompt', sans-serif" ${l.font==="'Prompt', sans-serif"?"selected":""}>Prompt</option>
            <option value="'Kanit', sans-serif" ${l.font==="'Kanit', sans-serif"?"selected":""}>Kanit</option>
            <option value="'Sarabun', sans-serif" ${l.font==="'Sarabun', sans-serif"?"selected":""}>Sarabun</option>
          </select>
        </div>
        <div>
          <label class="field-label">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</label>
          <select onchange="updateLine(${i},'weight',this.value)">
            <option value="normal" ${l.weight==="normal"?"selected":""}>‡∏õ‡∏Å‡∏ï‡∏¥</option>
            <option value="bold"   ${l.weight==="bold"  ?"selected":""}>‡∏´‡∏ô‡∏≤</option>
          </select>
        </div>
        <div>
          <label class="field-label">‡∏à‡∏±‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
          <select onchange="updateLine(${i},'align',this.value)">
            <option value="left"   ${!l.align||l.align==="left"  ?"selected":""}>‡∏ã‡πâ‡∏≤‡∏¢</option>
            <option value="center" ${l.align==="center"?"selected":""}>‡∏Å‡∏•‡∏≤‡∏á</option>
            <option value="right"  ${l.align==="right" ?"selected":""}>‡∏Ç‡∏ß‡∏≤</option>
          </select>
        </div>
      </div>
      <div class="prop-mini">
        <div><label class="field-label">‡∏Ç‡∏ô‡∏≤‡∏î (px)</label><input type="number" value="${l.size}" oninput="updateLine(${i},'size',this.value)"></div>
        <div><label class="field-label">X (‡∏ã‡πâ‡∏≤‡∏¢)</label><input type="number" value="${l.x}" oninput="updateLine(${i},'x',this.value)"></div>
        <div><label class="field-label">Y (‡∏ö‡∏ô)</label><input type="number" value="${l.y}" oninput="updateLine(${i},'y',this.value)"></div>
      </div>
    `;
    area.appendChild(block);
  });
}

window.updateLine = function(i, key, val) {
  if (["size","x","y"].includes(key)) val = parseInt(val)||0;
  currentConfig[i][key] = val;
  renderPreview();
};
window.removeLine = function(i) {
  currentConfig.splice(i,1);
  renderEditor(); renderPreview();
};
window.addLine = function() {
  currentConfig.push({ text:"‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà", font:"'Prompt', sans-serif", size:16, x:10, y:10, weight:"normal", align:"left" });
  renderEditor(); renderPreview();
};
window.loadTemplate = async function() {
  const { data } = await supabase.from("vasd_print_template").select("*").eq("template_type", document.getElementById("templateType").value).single();
  currentConfig = data?.config || [];
  renderEditor(); renderPreview();
};
window.saveTemplate = async function() {
  const type = document.getElementById("templateType").value;
  const { error } = await supabase.from("vasd_print_template").upsert({ template_type:type, config:currentConfig },{ onConflict:"template_type" });
  if (error) alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: "+error.message);
  else alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Template \""+type+"\" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
};
window.printTest = function() {
  const contents = document.getElementById("sticker").innerHTML;
  const pw = window.open("","_blank","width=800,height=600");
  pw.document.write(`<html><head><title>Print Test</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&family=Prompt:wght@400;700&family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>body{margin:0}.sticker{position:relative;width:80mm;height:50mm;background:#fff;overflow:hidden}.line{position:absolute;white-space:pre-wrap;word-break:break-word;padding-right:5px;box-sizing:border-box;}@page{size:80mm 50mm;margin:0}</style>
    </head><body><div class="sticker">${contents}</div>
    <script>window.onload=function(){document.fonts.ready.then(()=>{setTimeout(()=>{window.print();window.close();},300);});}<\/script></body></html>`);
  pw.document.close();
};

loadTemplate();
</script>
</body>
</html>
