<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>VASD - ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:"Segoe UI",sans-serif;background:#f4f6f8;}
header{
  background:#fff;border-bottom:1px solid #ddd;
  padding:14px 20px;display:flex;
  justify-content:space-between;align-items:center;
}
.container{
  display:grid;
  grid-template-columns:400px 1fr;
  height:calc(100vh - 70px);
}
.sidebar{
  background:#fff;padding:15px;overflow:auto;
  border-right:1px solid #ddd;
}
.preview{
  display:flex;justify-content:center;align-items:center;
  background:#e9ecef;
}
/* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏ô‡∏≤‡∏î Sticker ‡∏ï‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á (80mm x 50mm) */
.sticker {
  position: relative;
  width: 80mm;
  height: 50mm;
  background: #fff;
  box-shadow: 0 0 10px rgba(0,0,0,0.2);
  overflow: hidden;
}
.line {
  position: absolute;
  white-space: nowrap;
}
input,select{width:100%;margin-bottom:8px;padding:5px;box-sizing:border-box;}
button{
  padding:8px 12px;border:none;
  border-radius:4px;background:#2c7be5;
  color:#fff;cursor:pointer;margin-bottom:6px;
  width: 100%;
}
button:hover{opacity:0.9;}
.line-block{
  border:1px solid #ddd;
  padding:10px;margin-bottom:12px;
  background: #fdffdf;
  border-radius: 5px;
}
.small{font-size:12px;color:#888;}
hr{margin: 15px 0; border: 0; border-top: 1px solid #eee;}

/* CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå */
@media print {
  body * { visibility: hidden; }
  #sticker, #sticker * { visibility: visible; }
  #sticker {
    position: absolute;
    left: 0;
    top: 0;
    box-shadow: none;
  }
}
</style>
</head>
<body>

<header>
  <h3>üñ® ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Sticker Template</h3>
  <div style="display:flex; gap:10px;">
    <button onclick="window.printTest()" style="background:#28a745; margin-bottom:0;">üñ®Ô∏è ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå</button>
    <button onclick="location.href='index.html'" style="background:#6c757d; margin-bottom:0; width:auto;">üè† Home</button>
  </div>
</header>

<div class="container">

<div class="sidebar">

<label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå</label>
<select id="templateType">
  <option value="queue">‡∏Ñ‡∏¥‡∏ß</option>
  <option value="cage">‡∏ï‡∏¥‡∏î‡∏Å‡∏£‡∏á</option>
  <option value="envelope">‡∏ï‡∏¥‡∏î‡∏ã‡∏≠‡∏á‡∏¢‡∏≤</option>
  <option value="bag">‡∏ï‡∏¥‡∏î‡∏ñ‡∏∏‡∏á‡∏¢‡∏≤</option>
  <option value="vaccine">‡∏ï‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏°‡∏∏‡∏î‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô</option>
  <option value="microchip">‡∏ï‡∏¥‡∏î‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡∏ä‡∏¥‡∏ü</option>
</select>

<button onclick="loadTemplate()" style="background:#17a2b8;">üîÑ ‡πÇ‡∏´‡∏•‡∏î Template</button>

<hr>

<div id="lineEditor"></div>

<button onclick="addLine()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î</button>
<button onclick="saveTemplate()" style="background:#2c7be5; font-weight:bold;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Template</button>

<p class="small">
<b>‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ:</b><br>
{{queue_number}}, {{animal_name}}, {{species}}, {{sex}}, {{owner_name}}
</p>

</div>

<div class="preview">
  <div class="sticker" id="sticker"></div>
</div>

</div>

<script type="module">
import { supabase } from "./js/supabase.js";

let currentConfig = [];

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î Sticker ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Preview
function renderPreview(){
  const box = document.getElementById("sticker");
  box.innerHTML = "";
  currentConfig.forEach((l)=>{
    const div = document.createElement("div");
    div.className="line";
    div.style.left=l.x+"px";
    div.style.top=l.y+"px";
    div.style.fontSize=l.size+"px";
    div.style.fontWeight=l.weight;
    div.style.fontFamily=l.font;
    
    // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏ï‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå
    let previewText = l.text
      .replace("{{queue_number}}", "A001")
      .replace("{{animal_name}}", "‡∏ô‡πâ‡∏≠‡∏á‡∏ñ‡∏∏‡∏á‡∏ó‡∏≠‡∏á")
      .replace("{{species}}", "‡πÅ‡∏°‡∏ß")
      .replace("{{owner_name}}", "‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ");
      
    div.innerText = previewText;
    box.appendChild(div);
  });
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Form ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
function renderEditor(){
  const area = document.getElementById("lineEditor");
  area.innerHTML="";
  currentConfig.forEach((l,i)=>{
    const block=document.createElement("div");
    block.className="line-block";
    block.innerHTML=`
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <b>‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà ${i+1}</b>
        <button onclick="removeLine(${i})" style="background:#dc3545; width:auto; padding:2px 8px;">‡∏•‡∏ö</button>
      </div>
      <label>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</label>
      <input value="${l.text}" oninput="updateLine(${i},'text',this.value)">
      
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px;">
        <div>
          <label>Font</label>
          <select onchange="updateLine(${i},'font',this.value)">
            <option value="monospace" ${l.font==="monospace"?"selected":""}>Monospace</option>
            <option value="Arial" ${l.font==="Arial"?"selected":""}>Arial</option>
            <option value="Tahoma" ${l.font==="Tahoma"?"selected":""}>Tahoma</option>
          </select>
        </div>
        <div>
          <label>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</label>
          <select onchange="updateLine(${i},'weight',this.value)">
            <option value="normal" ${l.weight==="normal"?"selected":""}>Normal</option>
            <option value="bold" ${l.weight==="bold"?"selected":""}>Bold</option>
          </select>
        </div>
      </div>

      <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px;">
        <div><label>‡∏Ç‡∏ô‡∏≤‡∏î(px)</label><input type="number" value="${l.size}" oninput="updateLine(${i},'size',this.value)"></div>
        <div><label>X (‡∏ã‡πâ‡∏≤‡∏¢)</label><input type="number" value="${l.x}" oninput="updateLine(${i},'x',this.value)"></div>
        <div><label>Y (‡∏ö‡∏ô)</label><input type="number" value="${l.y}" oninput="updateLine(${i},'y',this.value)"></div>
      </div>
    `;
    area.appendChild(block);
  });
}

window.updateLine=function(i,key,val){
  if(key==="size"||key==="x"||key==="y") val=parseInt(val) || 0;
  currentConfig[i][key]=val;
  renderPreview();
}

window.removeLine=function(i){
  currentConfig.splice(i,1);
  renderEditor();
  renderPreview();
}

window.addLine=function(){
  currentConfig.push({
    text:"‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà",
    font:"monospace",
    size:16,
    x:10,
    y:10,
    weight:"normal"
  });
  renderEditor();
  renderPreview();
}

window.loadTemplate=async function(){
  const { data, error } = await supabase
    .from("vasd_print_template")
    .select("*")
    .eq("template_type", document.getElementById("templateType").value)
    .single();

  if(data){
    currentConfig = data.config;
  }else{
    currentConfig = [];
  }
  renderEditor();
  renderPreview();
}

window.saveTemplate=async function(){
  const type = document.getElementById("templateType").value;
  const { error } = await supabase
    .from("vasd_print_template")
    .upsert({
      template_type: type,
      config: currentConfig
    }, { onConflict: 'template_type' });

  if(error) alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
  else alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Template " + type + " ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
}

// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå ---
window.printTest = function() {
  const printContents = document.getElementById('sticker').innerHTML;
  const printWindow = window.open('', '_blank', 'width=800,height=600');
  
  printWindow.document.write(`
    <html>
      <head>
        <title>Print Test</title>
        <style>
          body { margin: 0; padding: 0; }
          .sticker {
            position: relative;
            width: 80mm;
            height: 50mm;
            background: #fff;
            overflow: hidden;
          }
          .line {
            position: absolute;
            white-space: nowrap;
          }
          @page {
            size: 80mm 50mm;
            margin: 0;
          }
        </style>
      </head>
      <body>
        <div class="sticker">${printContents}</div>
        <script>
          window.onload = function() {
            window.print();
            window.close();
          };
        <\/script>
      </body>
    </html>
  `);
  printWindow.document.close();
}

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
loadTemplate();
</script>

</body>
</html>
