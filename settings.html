<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸à¸´à¸¡à¸à¹Œ â€“ RMUTTO VASD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DESIGN TOKENS (Shared with index.html)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --navy:       #0b1929;
  --navy-mid:   #112240;
  --navy-card:  #162d4a;
  --teal:       #0ea5a0;
  --teal-light: #14c4bc;
  --teal-glow:  rgba(14,165,160,0.25);
  --amber:      #f59e0b;
  --surface:    rgba(255,255,255,0.04);
  --surface-2:  rgba(255,255,255,0.08);
  --border:     rgba(255,255,255,0.08);
  --border-2:   rgba(255,255,255,0.14);
  --text:       #e2e8f0;
  --text-dim:   #94a3b8;
  --text-faint: #4a5568;

  --radius-sm:  10px;
  --radius:     16px;
  --radius-lg:  22px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: "Sarabun", "Outfit", sans-serif;
  background: var(--navy);
  color: var(--text);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  overflow-x: hidden;
}

/* Mesh background from index */
body::before {
  content: "";
  position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background:
    radial-gradient(ellipse 60% 50% at 20% 10%, rgba(14,165,160,0.12) 0%, transparent 70%),
    radial-gradient(ellipse 50% 40% at 80% 80%, rgba(99,102,241,0.08) 0%, transparent 60%);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
header {
  position: sticky; top: 0; z-index: 200;
  background: rgba(11,25,41,0.85);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-bottom: 1px solid var(--border);
  padding: 10px 20px;
  min-height: 64px;
  display: flex; align-items: center; justify-content: space-between;
}
.brand { display: flex; align-items: center; gap: 10px; }
.brand-logo {
  width: 40px; height: 32px;
  background: linear-gradient(135deg, var(--teal), var(--teal-light));
  border-radius: 8px; display: flex; align-items: center; justify-content: center;
  box-shadow: 0 0 15px var(--teal-glow);
}
.brand-name { font-family: "Outfit", sans-serif; font-size: 15px; font-weight: 700; color: #fff; }

.header-actions { display: flex; gap: 8px; }
.btn-header {
  padding: 8px 14px; font-size: 12px; font-weight: 600; font-family: "Sarabun", sans-serif;
  border-radius: var(--radius-sm); border: none; cursor: pointer; transition: 0.2s;
  display: flex; align-items: center; gap: 6px;
}
.btn-print { background: var(--teal); color: #fff; }
.btn-home { background: var(--surface-2); color: var(--text); border: 1px solid var(--border-2); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.layout {
  display: grid; grid-template-columns: 400px 1fr;
  flex: 1; position: relative; z-index: 1;
}

/* â”€â”€ Sidebar (Editor) â”€â”€ */
.sidebar {
  background: rgba(11, 25, 41, 0.4);
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column;
  height: calc(100vh - 64px);
}
.sidebar-scroll { flex: 1; overflow-y: auto; padding: 20px; }

.section-title {
  font-family: "Outfit", sans-serif; font-size: 12px; font-weight: 700;
  text-transform: uppercase; letter-spacing: 1px; color: var(--teal-light);
  margin-bottom: 16px; display: flex; align-items: center; gap: 8px;
}

/* â”€â”€ Form Elements â”€â”€ */
.field-group { margin-bottom: 20px; }
label { font-size: 12px; color: var(--text-dim); margin-bottom: 6px; display: block; }

input, select {
  width: 100%; padding: 10px 12px; font-size: 13px; font-family: "Sarabun", sans-serif;
  background: var(--navy-mid); border: 1px solid var(--border-2);
  border-radius: var(--radius-sm); color: var(--text); outline: none;
  transition: border-color 0.2s;
}
input:focus, select:focus { border-color: var(--teal); }

.line-block {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 16px; margin-bottom: 12px;
  position: relative; transition: 0.2s;
}
.line-block:hover { border-color: var(--border-2); background: var(--surface-2); }
.line-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.line-num { font-size: 13px; font-weight: 700; color: #fff; }

.btn-del {
  background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2);
  padding: 4px 8px; font-size: 11px; border-radius: 6px; cursor: pointer;
}

.prop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
.prop-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 8px; }

/* â”€â”€ Buttons â”€â”€ */
.btn-main {
  width: 100%; padding: 12px; font-weight: 700; border-radius: var(--radius-sm);
  border: none; cursor: pointer; font-family: "Sarabun", sans-serif; transition: 0.2s;
  margin-top: 10px;
}
.btn-save { background: linear-gradient(135deg, var(--teal), var(--teal-light)); color: #fff; }
.btn-add { background: var(--surface-2); color: var(--text); border: 1px solid var(--border-2); }

/* â”€â”€ Preview Pane â”€â”€ */
.preview-pane {
  background: rgba(0,0,0,0.2); display: flex; flex-direction: column;
  align-items: center; justify-content: center; padding: 40px;
}
.preview-info { font-size: 12px; color: var(--text-dim); margin-bottom: 20px; }

.sticker {
  position: relative; width: 80mm; height: 50mm; background: #fff;
  box-shadow: 0 20px 50px rgba(0,0,0,0.5); border-radius: 2px;
  overflow: hidden; color: #000; /* Force black text on white sticker */
}
.line { position: absolute; white-space: pre-wrap; word-break: break-word; line-height: 1.2; }

/* â”€â”€ Hint Box â”€â”€ */
.hint-box {
  background: rgba(14, 165, 160, 0.05); border: 1px solid var(--teal-glow);
  border-radius: var(--radius); padding: 16px; margin-top: 20px;
}
.hint-box code {
  background: var(--navy); color: var(--teal-light); padding: 2px 6px;
  border-radius: 4px; font-size: 11px; display: inline-block; margin: 2px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 900px) {
  .layout { grid-template-columns: 1fr; }
  .sidebar { height: auto; border-right: none; border-bottom: 1px solid var(--border); }
  .preview-pane { padding: 40px 10px; order: -1; }
  .sticker { transform: scale(0.9); }
}
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="brand-logo">âš™ï¸</div>
    <div class="brand-name">Printer Settings</div>
  </div>
  <div class="header-actions">
    <button class="btn-header btn-print" onclick="window.printTest()">ğŸ–¨ï¸ à¸—à¸”à¸ªà¸­à¸šà¸à¸´à¸¡à¸à¹Œ</button>
    <button class="btn-header btn-home" onclick="location.href='index.html'">ğŸ  à¸«à¸™à¹‰à¸²à¸«à¸¥à¸±à¸</button>
  </div>
</header>

<div class="layout">
  <aside class="sidebar">
    <div class="sidebar-scroll">
      
      <div class="field-group">
        <label>à¸›à¸£à¸°à¹€à¸ à¸—à¸ªà¸•à¸´à¹Šà¸à¹€à¸à¸­à¸£à¹Œ</label>
        <select id="templateType" onchange="loadTemplate()">
          <option value="queue">ğŸ· à¸„à¸´à¸§ (Queue)</option>
          <option value="cage">ğŸ”’ à¸•à¸´à¸”à¸à¸£à¸‡ (Cage)</option>
          <option value="envelope">âœ‰ï¸ à¸•à¸´à¸”à¸‹à¸­à¸‡à¸¢à¸² (Envelope)</option>
          <option value="bag">ğŸ’Š à¸•à¸´à¸”à¸–à¸¸à¸‡à¸¢à¸² (Bag)</option>
          <option value="vaccine">ğŸ“’ à¸•à¸´à¸”à¸«à¸™à¹‰à¸²à¸ªà¸¡à¸¸à¸”à¸§à¸±à¸„à¸‹à¸µà¸™</option>
          <option value="microchip">ğŸ’³ à¹ƒà¸šà¸£à¸±à¸šà¸£à¸­à¸‡à¹„à¸¡à¹‚à¸„à¸£à¸Šà¸´à¸Ÿ</option>
        </select>
      </div>

      <div class="section-title"><span>ğŸ“</span> à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸šà¸£à¸£à¸—à¸±à¸”</div>
      <div id="lineEditor"></div>
      
      <button class="btn-main btn-add" onclick="addLine()">â• à¹€à¸à¸´à¹ˆà¸¡à¸šà¸£à¸£à¸—à¸±à¸”à¹ƒà¸«à¸¡à¹ˆ</button>

      <div class="hint-box">
        <div class="section-title" style="margin-bottom:8px"><span>ğŸ’¡</span> à¸•à¸±à¸§à¹à¸›à¸£à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¹„à¸”à¹‰</div>
        <div style="font-size:11px; color:var(--text-dim); margin-bottom:8px">à¸ªà¸±à¸•à¸§à¹Œ: <code>{{animal_name}}</code> <code>{{species}}</code> <code>{{sex}}</code> <code>{{queue_number}}</code></div>
        <div style="font-size:11px; color:var(--text-dim)">à¸¢à¸²: <code>{{drug_id}}</code> <code>{{dose}}</code> <code>{{freq}}</code> <code>{{total_pills}}</code></div>
      </div>

      <div style="margin-top: 24px; padding-bottom: 40px;">
        <button class="btn-main btn-save" onclick="saveTemplate()">ğŸ’¾ à¸šà¸±à¸™à¸—à¸¶à¸à¸£à¸¹à¸›à¹à¸šà¸šà¸™à¸µà¹‰</button>
      </div>
    </div>
  </aside>

  <main class="preview-pane">
    <div class="preview-info">à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸šà¸™à¸ªà¸•à¸´à¹Šà¸à¹€à¸à¸­à¸£à¹Œà¸‚à¸™à¸²à¸” 80 x 50 mm</div>
    <div class="sticker" id="sticker"></div>
  </main>
</div>

<script type="module">
import { supabase } from "./js/supabase.js";

let currentConfig = [];

// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸ˆà¸³à¸¥à¸­à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸à¸£à¸µà¸§à¸´à¸§
function getPreviewText(template) {
  return template
    .replace("{{queue_number}}","1")
    .replace("{{animal_name}}","à¸™à¹‰à¸­à¸‡à¸–à¸¸à¸‡à¸—à¸­à¸‡")
    .replace("{{species}}","à¹à¸¡à¸§")
    .replace("{{sex}}","à¸œà¸¹à¹‰")
    .replace("{{owner_name}}","à¸ªà¸¡à¸Šà¸²à¸¢ à¹ƒà¸ˆà¸”à¸µ")
    .replace("{{phone}}","081-234-5678")
    .replace("{{services}}","à¸—à¸³à¸«à¸¡à¸±à¸™, à¸§à¸±à¸„à¸‹à¸µà¸™")
    .replace("{{drug_id}}","Amoxicillin 250mg")
    .replace("{{dose}}","à¸à¸´à¸™à¸„à¸£à¸±à¹‰à¸‡à¸¥à¸° 1 à¹€à¸¡à¹‡à¸”")
    .replace("{{freq}}","à¸§à¸±à¸™à¸¥à¸° 2 à¸„à¸£à¸±à¹‰à¸‡ à¸«à¸¥à¸±à¸‡à¸­à¸²à¸«à¸²à¸£")
    .replace("{{days}}","5 à¸§à¸±à¸™")
    .replace("{{total_pills}}","10");
}

function renderPreview() {
  const box = document.getElementById("sticker");
  box.innerHTML = "";
  currentConfig.forEach(l => {
    const div = document.createElement("div");
    div.className = "line";
    div.style.left = l.x + "px";
    div.style.top  = l.y + "px";
    div.style.fontSize   = l.size + "px";
    div.style.fontWeight = l.weight;
    div.style.fontFamily = l.font || "Sarabun";
    div.style.textAlign  = l.align || "left";
    div.style.width      = `calc(100% - ${l.x}px)`;
    div.innerText = getPreviewText(l.text);
    box.appendChild(div);
  });
}

function renderEditor() {
  const area = document.getElementById("lineEditor");
  area.innerHTML = "";
  currentConfig.forEach((l, i) => {
    const block = document.createElement("div");
    block.className = "line-block";
    block.innerHTML = `
      <div class="line-header">
        <span class="line-num">à¸šà¸£à¸£à¸—à¸±à¸”à¸—à¸µà¹ˆ ${i+1}</span>
        <button class="btn-del" onclick="removeLine(${i})">à¸¥à¸šà¸­à¸­à¸</button>
      </div>
      <input value="${l.text}" oninput="updateLine(${i},'text',this.value)" placeholder="à¹ƒà¸ªà¹ˆà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸«à¸£à¸·à¸­à¸•à¸±à¸§à¹à¸›à¸£..." style="margin-bottom:10px">
      
      <div class="prop-grid">
        <div>
          <label>à¸Ÿà¸­à¸™à¸•à¹Œ</label>
          <select onchange="updateLine(${i},'font',this.value)">
            <option value="'Sarabun', sans-serif" ${l.font?.includes("Sarabun")?"selected":""}>Sarabun</option>
            <option value="'Prompt', sans-serif" ${l.font?.includes("Prompt")?"selected":""}>Prompt</option>
            <option value="'Outfit', sans-serif" ${l.font?.includes("Outfit")?"selected":""}>Outfit (EN)</option>
            <option value="monospace" ${l.font==="monospace"?"selected":""}>Monospace</option>
          </select>
        </div>
        <div>
          <label>à¸à¸²à¸£à¸ˆà¸±à¸”à¸§à¸²à¸‡</label>
          <select onchange="updateLine(${i},'align',this.value)">
            <option value="left"   ${l.align==="left"?"selected":""}>à¸Šà¸´à¸”à¸‹à¹‰à¸²à¸¢</option>
            <option value="center" ${l.align==="center"?"selected":""}>à¸à¸¶à¹ˆà¸‡à¸à¸¥à¸²à¸‡</option>
            <option value="right"  ${l.align==="right"?"selected":""}>à¸Šà¸´à¸”à¸‚à¸§à¸²</option>
          </select>
        </div>
      </div>

      <div class="prop-3">
        <div><label>à¸‚à¸™à¸²à¸”(px)</label><input type="number" value="${l.size}" oninput="updateLine(${i},'size',this.value)"></div>
        <div><label>à¹à¸à¸™ X</label><input type="number" value="${l.x}" oninput="updateLine(${i},'x',this.value)"></div>
        <div><label>à¹à¸à¸™ Y</label><input type="number" value="${l.y}" oninput="updateLine(${i},'y',this.value)"></div>
      </div>
    `;
    area.appendChild(block);
  });
}

window.updateLine = (i, key, val) => {
  if (["size","x","y"].includes(key)) val = parseInt(val)||0;
  currentConfig[i][key] = val;
  renderPreview();
};

window.removeLine = (i) => {
  currentConfig.splice(i,1);
  renderEditor(); renderPreview();
};

window.addLine = () => {
  currentConfig.push({ text:"à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹ƒà¸«à¸¡à¹ˆ", font:"'Sarabun', sans-serif", size:14, x:10, y:10, weight:"normal", align:"left" });
  renderEditor(); renderPreview();
};

window.loadTemplate = async () => {
  const type = document.getElementById("templateType").value;
  const { data } = await supabase.from("vasd_print_template").select("*").eq("template_type", type).single();
  currentConfig = data?.config || [];
  renderEditor(); renderPreview();
};

window.saveTemplate = async () => {
  const type = document.getElementById("templateType").value;
  const { error } = await supabase.from("vasd_print_template").upsert({ template_type:type, config:currentConfig },{ onConflict:"template_type" });
  if (error) alert("âŒ à¸œà¸´à¸”à¸à¸¥à¸²à¸”: " + error.message);
  else alert("âœ… à¸šà¸±à¸™à¸—à¸¶à¸à¹à¸¡à¹ˆà¹à¸šà¸š \"" + type + "\" à¸ªà¸³à¹€à¸£à¹‡à¸ˆ");
};

window.printTest = () => {
  const contents = document.getElementById("sticker").innerHTML;
  const pw = window.open("","_blank","width=800,height=600");
  pw.document.write(`<html><head>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;700&family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
      body{margin:0; padding:0;}
      .sticker{position:relative; width:80mm; height:50mm; background:#fff; overflow:hidden;}
      .line{position:absolute; white-space:pre-wrap; word-break:break-word; color:#000;}
      @page{size:80mm 50mm; margin:0;}
    </style>
    </head><body><div class="sticker">${contents}</div>
    <script>window.onload=function(){setTimeout(()=>{window.print();window.close();},500);};<\/script></body></html>`);
  pw.document.close();
};

loadTemplate();
</script>
</body>
</html>
