<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>à¸à¸²à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸£à¸°à¸šà¸š â€“ VASD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DESIGN TOKENS (Same as index.html)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --navy:       #0b1929;
  --navy-mid:   #112240;
  --navy-card:  #162d4a;
  --teal:       #0ea5a0;
  --teal-light: #14c4bc;
  --teal-glow:  rgba(14,165,160,0.25);
  --amber:      #f59e0b;
  --rose:       #ef4444;
  --bg:         #08101a;
  --glass:      rgba(255, 255, 255, 0.03);
  --glass-border: rgba(255, 255, 255, 0.08);
  --text-main:  #e2e8f0;
  --text-dim:   #94a3b8;
  --radius:     16px;
}

* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'Sarabun', 'Outfit', sans-serif;
  background: var(--bg);
  color: var(--text-main);
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER & NAVIGATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
header {
  background: var(--navy);
  height: 70px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 30px;
  border-bottom: 1px solid var(--glass-border);
  flex-shrink: 0;
}
.brand { display: flex; align-items: center; gap: 15px; }
.brand-logo {
  width: 42px; height: 42px;
  background: linear-gradient(135deg, var(--teal), var(--teal-light));
  border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  font-size: 22px; box-shadow: 0 0 20px var(--teal-glow);
}
.brand-info h1 { font-family: 'Outfit'; font-size: 18px; font-weight: 700; color: #fff; }
.brand-info p { font-size: 12px; color: var(--text-dim); }

.nav-tabs {
  display: flex;
  background: var(--navy-mid);
  padding: 5px;
  border-radius: 12px;
  gap: 5px;
}
.tab-btn {
  padding: 8px 20px;
  border: none;
  background: transparent;
  color: var(--text-dim);
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  transition: all 0.2s;
}
.tab-btn.active {
  background: var(--teal);
  color: #fff;
}

.btn-home {
  background: var(--glass);
  border: 1px solid var(--glass-border);
  color: #fff;
  padding: 8px 16px;
  border-radius: 10px;
  cursor: pointer;
  text-decoration: none;
  font-size: 14px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.main-container {
  display: flex;
  flex: 1;
  overflow: hidden;
}

.content-panel {
  display: none; /* Hidden by default */
  width: 100%;
  height: 100%;
}
.content-panel.active { display: flex; }

/* Printer Section Sidebar */
.sidebar {
  width: 400px;
  background: var(--navy-mid);
  border-right: 1px solid var(--glass-border);
  display: flex;
  flex-direction: column;
  padding: 24px;
  overflow-y: auto;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COMPONENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.card-setting {
  background: var(--navy-card);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 20px;
}
.label-sm { font-size: 11px; color: var(--teal-light); text-transform: uppercase; letter-spacing: 1px; font-weight: 800; margin-bottom: 8px; display: block; }

input, select {
  width: 100%;
  background: rgba(0,0,0,0.2);
  border: 1px solid var(--glass-border);
  padding: 12px;
  border-radius: 10px;
  color: #fff;
  font-family: 'Sarabun';
  margin-bottom: 15px;
}

.line-item {
  background: var(--glass);
  border: 1px solid var(--glass-border);
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 12px;
}

.btn-primary {
  background: linear-gradient(to right, var(--teal), var(--teal-light));
  color: #fff;
  border: none;
  padding: 14px;
  border-radius: 12px;
  font-weight: 700;
  cursor: pointer;
  width: 100%;
}

.btn-ghost {
  background: var(--glass);
  color: var(--text-main);
  border: 1px solid var(--glass-border);
  padding: 10px;
  border-radius: 10px;
  cursor: pointer;
}

/* Preview Area */
.preview-area {
  flex: 1;
  background: #060c14;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 30px;
}

.sticker-wrap {
  position: relative;
  width: 80mm;
  height: 50mm;
  background: #fff;
  box-shadow: 0 0 50px rgba(0,0,0,0.5);
  border-radius: 4px;
  overflow: hidden;
  color: #000;
}
.line { position: absolute; white-space: pre-wrap; pointer-events: none; }

/* Admin DB Section */
.db-container {
  max-width: 800px;
  margin: 40px auto;
  width: 100%;
  padding: 0 20px;
}
.danger-zone {
  border: 1px dashed var(--rose);
  padding: 30px;
  border-radius: var(--radius);
  background: rgba(239, 68, 68, 0.05);
}

@media print {
  body * { visibility: hidden; }
  .sticker-wrap, .sticker-wrap * { visibility: visible; }
  .sticker-wrap { position: fixed; left: 0; top: 0; box-shadow: none; }
  @page { size: 80mm 50mm; margin: 0; }
}
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="brand-logo">âš™ï¸</div>
    <div class="brand-info">
      <h1>VASD SETTINGS</h1>
      <p>à¸à¸²à¸£à¸ˆà¸±à¸”à¸à¸²à¸£à¸£à¸°à¸šà¸šà¹à¸¥à¸°à¹€à¸—à¸¡à¹€à¸à¸¥à¸•</p>
    </div>
  </div>

  <div class="nav-tabs">
    <button class="tab-btn active" onclick="switchMainTab('printer', this)">ğŸ–¨ï¸ à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸à¸´à¸¡à¸à¹Œ</button>
    <button class="tab-btn" onclick="switchMainTab('database', this)">ğŸ—„ï¸ à¸ˆà¸±à¸”à¸à¸²à¸£à¸à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥</button>
  </div>

  <a href="index.html" class="btn-home">ğŸ  à¸à¸¥à¸±à¸šà¸«à¸™à¹‰à¸²à¹à¸£à¸</a>
</header>

<div class="main-container">
  
  <div id="tab-printer" class="content-panel active">
    <div class="sidebar">
      <span class="label-sm">Template Config</span>
      <select id="templateType" onchange="loadTemplate()">
        <option value="queue">ğŸ·ï¸ à¸„à¸´à¸§ (Queue Label)</option>
        <option value="envelope">âœ‰ï¸ à¸•à¸´à¸”à¸‹à¸­à¸‡à¸¢à¸² (RX Label)</option>
        <option value="cage">ğŸ”’ à¸•à¸´à¸”à¸à¸£à¸‡ (Cage Label)</option>
      </select>

      <div id="lineEditor" style="flex:1; margin-bottom: 20px;">
        </div>

      <button class="btn-ghost" onclick="addLine()" style="width:100%; margin-bottom: 10px;">â• à¹€à¸à¸´à¹ˆà¸¡à¸šà¸£à¸£à¸—à¸±à¸”à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡</button>
      <button class="btn-primary" onclick="saveTemplate()">ğŸ’¾ à¸šà¸±à¸™à¸—à¸¶à¸à¸à¸²à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²</button>
    </div>

    <div class="preview-area">
      <div style="text-align:center">
        <span class="label-sm" style="color:var(--text-dim)">Preview (80x50 mm)</span>
        <div class="sticker-wrap" id="sticker"></div>
      </div>
      <button class="btn-ghost" onclick="window.print()" style="padding: 12px 30px; border-radius: 30px; background:var(--teal)">ğŸ–¨ï¸ à¸—à¸”à¸ªà¸­à¸šà¸à¸´à¸¡à¸à¹Œ</button>
    </div>
  </div>

  <div id="tab-database" class="content-panel">
    <div class="db-container">
      <div class="card-setting">
        <h2 style="margin-bottom:20px;">ğŸ“¦ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸£à¸°à¸šà¸š</h2>
        <p style="color:var(--text-dim); margin-bottom:10px;">à¸ˆà¸±à¸”à¸à¸²à¸£à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸ˆà¸±à¸”à¹€à¸à¹‡à¸šà¸ à¸²à¸¢à¹ƒà¸™ Supabase</p>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:20px;">
            <div class="card-setting" style="background: rgba(255,255,255,0.05)">
                <span class="label-sm">Total Animals</span>
                <h1 id="count-total">-</h1>
            </div>
            <div class="card-setting" style="background: rgba(255,255,255,0.05)">
                <span class="label-sm">Today Events</span>
                <h1 id="count-today">-</h1>
            </div>
        </div>
      </div>

      <div class="danger-zone">
        <h3 style="color:var(--rose); margin-bottom:10px;">ğŸš¨ Danger Zone</h3>
        <p style="font-size:14px; color:var(--text-dim); margin-bottom:20px;">à¸à¸²à¸£à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£à¸”à¹‰à¸²à¸™à¸¥à¹ˆà¸²à¸‡à¸™à¸µà¹‰à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸¢à¹‰à¸­à¸™à¸à¸¥à¸±à¸šà¹„à¸”à¹‰ à¹‚à¸›à¸£à¸”à¸£à¸°à¸¡à¸±à¸”à¸£à¸°à¸§à¸±à¸‡</p>
        
        <button class="btn-ghost" onclick="clearDataToday()" style="border-color:var(--rose); color:var(--rose);">
            ğŸ—‘ï¸ à¸¥à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸±à¸•à¸§à¹Œà¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸‚à¸­à¸‡à¸§à¸±à¸™à¸™à¸µà¹‰
        </button>
      </div>
    </div>
  </div>

</div>

<script type="module">
import { supabase } from "./js/supabase.js";

let currentConfig = [];

// --- Tab Switching Logic ---
window.switchMainTab = (tabId, btn) => {
  document.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  
  document.getElementById(`tab-${tabId}`).classList.add('active');
  btn.classList.add('active');

  if(tabId === 'database') loadDbStats();
};

// --- Printer Logic ---
function renderPreview() {
  const box = document.getElementById("sticker");
  box.innerHTML = "";
  currentConfig.forEach(l => {
    const div = document.createElement("div");
    div.className = "line";
    div.style.left = l.x + "px";
    div.style.top = l.y + "px";
    div.style.fontSize = l.size + "px";
    div.style.fontWeight = l.weight || "normal";
    div.style.fontFamily = "Sarabun";
    div.innerText = l.text.replace(/{{queue_number}}/g, "001").replace(/{{animal_name}}/g, "à¸ªà¸¡à¸Šà¸²à¸¢ (à¹à¸¡à¸§)");
    box.appendChild(div);
  });
}

function renderEditor() {
  const area = document.getElementById("lineEditor");
  area.innerHTML = "";
  currentConfig.forEach((l, i) => {
    const div = document.createElement("div");
    div.className = "line-item";
    div.innerHTML = `
      <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
        <span class="label-sm">à¸šà¸£à¸£à¸—à¸±à¸”à¸—à¸µà¹ˆ ${i+1}</span>
        <button onclick="removeLine(${i})" style="background:none; border:none; color:var(--rose); cursor:pointer;">à¸¥à¸š</button>
      </div>
      <input type="text" value="${l.text}" oninput="updateLine(${i},'text',this.value)">
      <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px;">
        <input type="number" placeholder="Size" value="${l.size}" oninput="updateLine(${i},'size',this.value)">
        <input type="number" placeholder="X" value="${l.x}" oninput="updateLine(${i},'x',this.value)">
        <input type="number" placeholder="Y" value="${l.y}" oninput="updateLine(${i},'y',this.value)">
      </div>
    `;
    area.appendChild(div);
  });
}

window.updateLine = (i, key, val) => {
  currentConfig[i][key] = (key === 'text') ? val : parseInt(val);
  renderPreview();
};

window.addLine = () => {
  currentConfig.push({ text: "à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹ƒà¸«à¸¡à¹ˆ", size: 16, x: 10, y: 10 });
  renderEditor();
  renderPreview();
};

window.removeLine = (i) => {
  currentConfig.splice(i, 1);
  renderEditor();
  renderPreview();
};

window.loadTemplate = async () => {
  const type = document.getElementById("templateType").value;
  const { data } = await supabase.from("vasd_print_template").select("*").eq("template_type", type).single();
  currentConfig = data?.config || [];
  renderEditor();
  renderPreview();
};

window.saveTemplate = async () => {
  const type = document.getElementById("templateType").value;
  const { error } = await supabase.from("vasd_print_template").upsert({ 
    template_type: type, 
    config: currentConfig 
  }, { onConflict: "template_type" });
  
  if (error) alert(error.message);
  else alert("âœ… à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸³à¹€à¸£à¹‡à¸ˆ");
};

// --- Database Logic ---
async function loadDbStats() {
    const { count: total } = await supabase.from('vasd_animal').select('*', { count: 'exact', head: true });
    document.getElementById('count-total').innerText = total || 0;
}

window.clearDataToday = async () => {
    const pwd = prompt("à¸à¸£à¸¸à¸“à¸²à¹ƒà¸ªà¹ˆà¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¸œà¸¹à¹‰à¸”à¸¹à¹à¸¥à¸£à¸°à¸šà¸š (Admin Password):");
    if (!pwd) return;

    const { error } = await supabase.rpc('admin_delete_all_today', { p_admin_password: pwd });
    if (error) alert("âŒ " + error.message);
    else {
        alert("âœ… à¸¥à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸§à¸±à¸™à¸™à¸µà¹‰à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§");
        loadDbStats();
    }
};

// Init
loadTemplate();
</script>

</body>
</html>
