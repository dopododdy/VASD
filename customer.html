<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>à¸•à¸´à¸”à¸•à¸²à¸¡à¸ªà¸–à¸²à¸™à¸°à¸ªà¸±à¸•à¸§à¹Œà¹€à¸¥à¸µà¹‰à¸¢à¸‡ â€“ VASD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;800&family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOKENS & THEME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --navy:         #0b1929;
  --text:         #f8fafc;
  --text-dark:    #0f172a;
  
  /* Status Colors */
  --c-wait:       #9ca3af; /* à¸ªà¸µà¹€à¸—à¸² - à¸£à¸­à¸œà¹ˆà¸²à¸•à¸±à¸” */
  --c-anes:       #3b82f6; /* à¸ªà¸µà¸Ÿà¹‰à¸² - à¸§à¸²à¸‡à¸¢à¸² */
  --c-surg:       #ef4444; /* à¸ªà¸µà¹à¸”à¸‡ - à¸à¸³à¸¥à¸±à¸‡à¸œà¹ˆà¸² */
  --c-rec:        #86efac; /* à¸ªà¸µà¹€à¸‚à¸µà¸¢à¸§à¸­à¹ˆà¸­à¸™ - à¸à¸±à¸à¸Ÿà¸·à¹‰à¸™ */
  --c-ready:      #14532d; /* à¸ªà¸µà¹€à¸‚à¸µà¸¢à¸§à¹à¸à¹ˆ - à¸£à¸­à¸£à¸±à¸šà¸à¸¥à¸±à¸š */
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: "Sarabun", sans-serif;
  background: var(--navy);
  color: var(--text);
  min-height: 100vh;
  display: flex; flex-direction: column;
  overflow-x: hidden;
  padding-bottom: 20px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
header {
  position: sticky; top: 0; z-index: 100;
  background: rgba(11,25,41,0.9);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid rgba(255,255,255,0.1);
  padding: 12px 16px;
  text-align: center;
}
.brand-title { font-family: "Outfit", "Sarabun", sans-serif; font-size: 18px; font-weight: 700; color: #fff; }
.live-indicator {
  display: flex; align-items: center; justify-content: center; gap: 6px;
  font-size: 10px; font-weight: 600; color: #cbd5e1; margin-top: 4px;
}
.live-dot {
  width: 6px; height: 6px; background: #34d399; border-radius: 50%;
  animation: pulseDot 2s infinite;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN GRID (4 Columns for Mobile)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.wrap { padding: 16px; width: 100%; max-width: 800px; margin: 0 auto; }

#animalList {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px; /* à¸£à¸°à¸¢à¸°à¸«à¹ˆà¸²à¸‡à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡à¸à¸¥à¹ˆà¸­à¸‡ */
}

/* à¸à¸²à¸£à¹Œà¸”à¸ªà¸µà¹ˆà¹€à¸«à¸¥à¸µà¹ˆà¸¢à¸¡à¸¡à¸¸à¸¡à¸¡à¸™ */
.pet-card {
  aspect-ratio: 1; /* à¸—à¸³à¹ƒà¸«à¹‰à¹€à¸›à¹‡à¸™à¸ªà¸µà¹ˆà¹€à¸«à¸¥à¸µà¹ˆà¸¢à¸¡à¸ˆà¸±à¸•à¸¸à¸£à¸±à¸ª */
  border-radius: 12px;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  padding: 6px;
  text-align: center;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  transition: transform 0.2s;
  overflow: hidden;
}

.pet-card .q-num {
  font-family: "Outfit", sans-serif;
  font-size: 20px; font-weight: 800; line-height: 1;
  margin-bottom: 4px;
}
.pet-card .name {
  font-size: 11px; font-weight: 700;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  width: 100%; margin-bottom: 4px;
}
.pet-card .status {
  font-size: 10px; font-weight: 600;
  background: rgba(255,255,255,0.2);
  padding: 2px 6px; border-radius: 6px;
  white-space: nowrap; width: 100%; overflow: hidden; text-overflow: ellipsis;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COLORS CLASSES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bg-wait  { background: var(--c-wait); color: #fff; }
.bg-anes  { background: var(--c-anes); color: #fff; }
.bg-surg  { background: var(--c-surg); color: #fff; }
.bg-ready { background: var(--c-ready); color: #fff; }
.bg-rec   { background: var(--c-rec); color: var(--text-dark); } /* à¸à¸·à¹‰à¸™à¸ªà¸§à¹ˆà¸²à¸‡ à¸•à¸±à¸§à¸«à¸™à¸±à¸‡à¸ªà¸·à¸­à¹€à¸‚à¹‰à¸¡ */
.bg-rec .status { background: rgba(0,0,0,0.1); }

.empty-state {
  grid-column: 1 / -1; text-align: center; padding: 40px 10px; color: #94a3b8;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FULLSCREEN POPUP ANIMATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#popupOverlay {
  position: fixed; inset: 0; z-index: 9999;
  background: rgba(11,25,41,0.8);
  backdrop-filter: blur(5px);
  display: flex; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none;
  transition: opacity 0.3s ease;
}
#popupOverlay.active {
  opacity: 1; pointer-events: auto;
}

.popup-box {
  width: 280px; height: 280px;
  border-radius: 30px;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  text-align: center; padding: 20px;
  box-shadow: 0 20px 50px rgba(0,0,0,0.5);
  transform: scale(0.5);
  transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
#popupOverlay.active .popup-box {
  transform: scale(1);
}

.popup-box .q-num { font-family: "Outfit", sans-serif; font-size: 60px; font-weight: 800; line-height: 1; margin-bottom: 10px; }
.popup-box .name { font-size: 24px; font-weight: 700; margin-bottom: 16px; }
.popup-box .status { font-size: 20px; font-weight: 700; background: rgba(255,255,255,0.25); padding: 8px 20px; border-radius: 12px; }

@keyframes pulseDot {
  0% { box-shadow: 0 0 0 0 rgba(52,211,153,0.7); }
  70% { box-shadow: 0 0 0 6px rgba(52,211,153,0); }
  100% { box-shadow: 0 0 0 0 rgba(52,211,153,0); }
}

@media (max-width: 360px) {
  #animalList { gap: 4px; }
  .pet-card .q-num { font-size: 16px; }
  .pet-card .name, .pet-card .status { font-size: 9px; }
}
</style>
</head>
<body>

<header>
  <div class="brand-title">ğŸ¾ à¸ªà¸–à¸²à¸™à¸°à¸„à¸´à¸§à¸ªà¸±à¸•à¸§à¹Œà¹€à¸¥à¸µà¹‰à¸¢à¸‡</div>
  <div class="live-indicator"><div class="live-dot"></div> à¸­à¸±à¸›à¹€à¸”à¸•à¸¥à¹ˆà¸²à¸ªà¸¸à¸” (Real-Time)</div>
</header>

<div class="wrap">
  <div id="animalList">
    <div class="empty-state" id="emptyState">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸„à¸´à¸§...</div>
  </div>
</div>

<div id="popupOverlay">
  <div class="popup-box" id="popupBox">
    <div class="q-num" id="popupQ">#0</div>
    <div class="name" id="popupName">à¸Šà¸·à¹ˆà¸­à¸ªà¸±à¸•à¸§à¹Œ</div>
    <div class="status" id="popupStatus">à¸ªà¸–à¸²à¸™à¸°</div>
  </div>
</div>

<script type="module">
import { supabase } from "./js/supabase.js";

let isFirstLoad = true;
let oldStatuses = {}; // à¹€à¸à¹‡à¸šà¸ªà¸–à¸²à¸™à¸°à¹€à¸à¹ˆà¸²à¹€à¸à¸·à¹ˆà¸­à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸š { animal_id: "status" }

// à¸„à¸´à¸§à¸ªà¸³à¸«à¸£à¸±à¸šà¹à¸ªà¸”à¸‡ Popup (à¹€à¸œà¸·à¹ˆà¸­à¸­à¸±à¸›à¹€à¸”à¸•à¸à¸£à¹‰à¸­à¸¡à¸à¸±à¸™à¸«à¸¥à¸²à¸¢à¸•à¸±à¸§ à¸ˆà¸°à¹„à¸”à¹‰à¹à¸ªà¸”à¸‡à¸—à¸µà¸¥à¸°à¸•à¸±à¸§)
let popupQueue = [];
let isPopupShowing = false;

// à¹à¸œà¸™à¸—à¸µà¹ˆà¸ªà¸–à¸²à¸™à¸°à¹à¸¥à¸°à¸ªà¸µ
const statusMap = {
  ready_to_go_home: { text: "à¸£à¸­à¸£à¸±à¸šà¸à¸¥à¸±à¸š", colorClass: "bg-ready", weight: 1 },
  done:             { text: "à¸£à¸­à¸£à¸±à¸šà¸à¸¥à¸±à¸š", colorClass: "bg-ready", weight: 1 }, 
  recovery:         { text: "à¸à¸±à¸à¸Ÿà¸·à¹‰à¸™",   colorClass: "bg-rec",   weight: 2 },
  surgery:          { text: "à¸à¸³à¸¥à¸±à¸‡à¸œà¹ˆà¸²",  colorClass: "bg-surg",  weight: 3 },
  anesthesia:       { text: "à¸§à¸²à¸‡à¸¢à¸²",     colorClass: "bg-anes",  weight: 4 },
  waiting:          { text: "à¸£à¸­à¸œà¹ˆà¸²à¸•à¸±à¸”",  colorClass: "bg-wait",  weight: 5 },
  cancel:           { text: "à¸¢à¸à¹€à¸¥à¸´à¸",    colorClass: "bg-wait",  weight: 99 }
};

async function loadAnimals() {
  // à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹‚à¸”à¸¢à¹„à¸¡à¹ˆà¸à¸£à¸­à¸‡ event_id à¹à¸¥à¸°à¸§à¸±à¸™à¸—à¸µà¹ˆ
  const { data, error } = await supabase
    .from("vasd_animal")
    .select(`id, queue_number, animal_name, vasd_queue(status)`);

  if (error) {
    console.error("Database Fetch Error:", error);
    document.getElementById("animalList").innerHTML = `<div class="empty-state">à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸„à¸´à¸§</div>`;
    return;
  }
  
  const formattedData = data || [];
  
  // à¹€à¸£à¸µà¸¢à¸‡à¸¥à¸³à¸”à¸±à¸šà¸•à¸²à¸¡ Weight > à¸„à¸´à¸§
  formattedData.sort((a, b) => {
    const qDataA = Array.isArray(a.vasd_queue) ? a.vasd_queue[0] : a.vasd_queue;
    const qDataB = Array.isArray(b.vasd_queue) ? b.vasd_queue[0] : b.vasd_queue;
    const statA = qDataA?.status || "waiting";
    const statB = qDataB?.status || "waiting";
    
    const wA = statusMap[statA]?.weight || 99;
    const wB = statusMap[statB]?.weight || 99;
    if (wA !== wB) return wA - wB;
    return a.queue_number - b.queue_number;
  });

  renderGrid(formattedData);
}

function renderGrid(data) {
  const list = document.getElementById("animalList");
  
  // à¸à¸£à¸­à¸‡à¸•à¸±à¸§à¸¢à¸à¹€à¸¥à¸´à¸à¸­à¸­à¸
  const activeData = data.filter(a => {
    const qData = Array.isArray(a.vasd_queue) ? a.vasd_queue[0] : a.vasd_queue;
    return (qData?.status || "waiting") !== "cancel";
  });

  if (activeData.length === 0) {
    list.innerHTML = `<div class="empty-state">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸£à¸²à¸¢à¸à¸²à¸£à¸„à¸´à¸§à¹ƒà¸™à¸‚à¸“à¸°à¸™à¸µà¹‰</div>`;
    return;
  }

  let htmlContent = "";

  activeData.forEach(a => {
    const qData = Array.isArray(a.vasd_queue) ? a.vasd_queue[0] : a.vasd_queue;
    const newStatus = qData?.status || "waiting";
    const s = statusMap[newStatus] || statusMap.waiting;
    
    // à¸•à¸£à¸§à¸ˆà¸ˆà¸±à¸šà¸à¸²à¸£à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡à¸ªà¸–à¸²à¸™à¸° (à¸‚à¹‰à¸²à¸¡à¸£à¸­à¸šà¹‚à¸«à¸¥à¸”à¸„à¸£à¸±à¹‰à¸‡à¹à¸£à¸)
    if (!isFirstLoad && oldStatuses[a.id] && oldStatuses[a.id] !== newStatus) {
      // à¹€à¸­à¸²à¹€à¸‚à¹‰à¸²à¸„à¸´à¸§à¹à¸ªà¸”à¸‡ Popup
      enqueuePopup({
        queue: a.queue_number,
        name: a.animal_name,
        text: s.text,
        colorClass: s.colorClass
      });
    }
    oldStatuses[a.id] = newStatus; // à¸­à¸±à¸›à¹€à¸”à¸•à¸ªà¸–à¸²à¸™à¸°à¹ƒà¸™ Memory

    // à¸ªà¸£à¹‰à¸²à¸‡à¸à¸¥à¹ˆà¸­à¸‡ Grid
    htmlContent += `
      <div class="pet-card ${s.colorClass}">
        <div class="q-num">#${a.queue_number}</div>
        <div class="name">${a.animal_name || "à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸"}</div>
        <div class="status">${s.text}</div>
      </div>
    `;
  });

  list.innerHTML = htmlContent;
  isFirstLoad = false;
}

// â”€â”€ à¸£à¸°à¸šà¸šà¸„à¸´à¸§à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™ Popup â”€â”€
function enqueuePopup(animalData) {
  popupQueue.push(animalData);
  processPopupQueue();
}

function processPopupQueue() {
  if (isPopupShowing || popupQueue.length === 0) return;
  isPopupShowing = true;
  
  const target = popupQueue.shift();
  const overlay = document.getElementById("popupOverlay");
  const box = document.getElementById("popupBox");
  
  // à¹€à¸‹à¹‡à¸•à¸‚à¹‰à¸­à¸¡à¸¹à¸¥
  document.getElementById("popupQ").textContent = `#${target.queue}`;
  document.getElementById("popupName").textContent = target.name || "à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸Šà¸·à¹ˆà¸­";
  document.getElementById("popupStatus").textContent = target.text;
  
  // à¸¥à¹‰à¸²à¸‡à¸„à¸¥à¸²à¸ªà¸ªà¸µà¹€à¸à¹ˆà¸² à¹à¸¥à¹‰à¸§à¹ƒà¸ªà¹ˆà¸„à¸¥à¸²à¸ªà¸ªà¸µà¹ƒà¸«à¸¡à¹ˆ
  box.className = `popup-box ${target.colorClass}`;
  
  // à¹à¸ªà¸”à¸‡ Popup
  overlay.classList.add("active");
  
  // à¸«à¸™à¹ˆà¸§à¸‡à¹€à¸§à¸¥à¸² 3 à¸§à¸´à¸™à¸²à¸—à¸µ à¹à¸¥à¹‰à¸§à¸«à¸”à¸à¸¥à¸±à¸š
  setTimeout(() => {
    overlay.classList.remove("active");
    // à¸£à¸­ Animation à¸«à¸”à¸à¸¥à¸±à¸šà¹€à¸ªà¸£à¹‡à¸ˆ (0.3s) à¹à¸¥à¹‰à¸§à¸£à¸±à¸™à¸„à¸´à¸§à¸•à¹ˆà¸­à¹„à¸›
    setTimeout(() => {
      isPopupShowing = false;
      processPopupQueue();
    }, 300);
  }, 3000);
}

// â”€â”€ Real-time Listener â”€â”€
supabase.channel("vasd-customer-live")
  .on("postgres_changes", { event: "*", schema: "public", table: "vasd_queue" }, loadAnimals)
  .on("postgres_changes", { event: "*", schema: "public", table: "vasd_animal" }, loadAnimals)
  .subscribe();

// à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸„à¸£à¸±à¹‰à¸‡à¹à¸£à¸
loadAnimals();
</script>

</body>
</html>
