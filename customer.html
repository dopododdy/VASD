<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>à¸•à¸´à¸”à¸•à¸²à¸¡à¸ªà¸–à¸²à¸™à¸°à¸ªà¸±à¸•à¸§à¹Œà¹€à¸¥à¸µà¹‰à¸¢à¸‡ â€“ VASD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;800;900&family=Sarabun:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOKENS & THEME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --navy:         #0b1929;
  --text:         #f8fafc;
  --text-dark:    #064e3b;
  
  /* Status Gradients */
  --g-wait:       linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
  --g-anes:       linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
  --g-surg:       linear-gradient(135deg, #f87171 0%, #dc2626 100%);
  --g-rec:        linear-gradient(135deg, #a7f3d0 0%, #34d399 100%);
  --g-ready:      linear-gradient(135deg, #10b981 0%, #047857 100%);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: "Sarabun", sans-serif;
  background: var(--navy);
  color: var(--text);
  min-height: 100vh;
  display: flex; flex-direction: column;
  overflow-x: hidden;
  padding-bottom: 40px;
}
body::before {
  content: ""; position: fixed; inset: 0; z-index: -1;
  background: radial-gradient(circle at 50% -20%, rgba(14,165,160,0.15) 0%, transparent 70%);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER (Glassmorphism)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
header {
  position: sticky; top: 0; z-index: 100;
  background: rgba(11, 25, 41, 0.7);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border-bottom: 1px solid rgba(255,255,255,0.08);
  padding: clamp(12px, 2vw, 24px) 24px;
  text-align: center;
  box-shadow: 0 4px 30px rgba(0,0,0,0.3);
}
.brand-title { 
  font-family: "Sarabun", sans-serif; 
  font-size: clamp(20px, 3vw, 36px); 
  font-weight: 800; color: #fff; 
  letter-spacing: 0.5px;
}
.live-indicator {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  font-size: clamp(12px, 1.5vw, 18px); font-weight: 600; color: #cbd5e1; margin-top: 8px;
}
.live-dot {
  width: clamp(8px, 1vw, 12px); height: clamp(8px, 1vw, 12px); 
  background: #34d399; border-radius: 50%;
  animation: pulseDot 2s infinite;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN GRID (Auto Responsive)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.wrap { 
  padding: clamp(16px, 3vw, 40px); 
  width: 100%; 
  max-width: 1920px; /* à¸›à¸¥à¸”à¸¥à¹‡à¸­à¸à¸‚à¸™à¸²à¸”à¹ƒà¸«à¹‰à¸£à¸­à¸‡à¸£à¸±à¸šà¸ˆà¸­à¸—à¸µà¸§à¸µ 4K */
  margin: 0 auto; 
}

#animalList {
  display: grid;
  /* à¸«à¸±à¸§à¹ƒà¸ˆà¸ªà¸³à¸„à¸±à¸: à¸¢à¹ˆà¸­à¸‚à¸¢à¸²à¸¢à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œà¸•à¸²à¸¡à¸‚à¸™à¸²à¸”à¸ˆà¸­à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´ */
  grid-template-columns: repeat(auto-fill, minmax(clamp(140px, 20vw, 280px), 1fr));
  gap: clamp(12px, 2vw, 32px); 
}

/* à¸à¸²à¸£à¹Œà¸”à¸ªà¸µà¹ˆà¹€à¸«à¸¥à¸µà¹ˆà¸¢à¸¡ */
.pet-card {
  aspect-ratio: 1; 
  border-radius: clamp(16px, 2vw, 32px);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  padding: clamp(10px, 2vw, 24px);
  text-align: center;
  box-shadow: 0 10px 25px rgba(0,0,0,0.25);
  transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.3s;
  border: 1px solid rgba(255,255,255,0.1);
  /* à¹€à¸›à¸´à¸”à¹ƒà¸Šà¹‰à¸‡à¸²à¸™ View Transition */
  view-transition-name: card-var(--id); 
}
.pet-card:hover { transform: translateY(-5px) scale(1.02); box-shadow: 0 15px 35px rgba(0,0,0,0.4); }

.pet-card .q-num {
  font-family: "Outfit", sans-serif;
  font-size: clamp(32px, 6vw, 80px); 
  font-weight: 900; line-height: 1;
  margin-bottom: clamp(4px, 1vw, 12px);
  text-shadow: 0 2px 10px rgba(0,0,0,0.2);
}
.pet-card .name {
  font-size: clamp(14px, 2.5vw, 28px); font-weight: 700;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  width: 100%; margin-bottom: clamp(6px, 1.5vw, 16px);
}
.pet-card .status {
  font-size: clamp(12px, 2vw, 24px); font-weight: 700;
  background: rgba(255,255,255,0.25);
  backdrop-filter: blur(5px);
  padding: clamp(4px, 1vw, 8px) clamp(10px, 2vw, 20px); 
  border-radius: 50px;
  white-space: nowrap; width: max-content; max-width: 100%; 
  overflow: hidden; text-overflow: ellipsis;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COLORS CLASSES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bg-wait  { background: var(--g-wait); color: #fff; }
.bg-anes  { background: var(--g-anes); color: #fff; }
.bg-surg  { background: var(--g-surg); color: #fff; }
.bg-ready { background: var(--g-ready); color: #fff; }
.bg-rec   { background: var(--g-rec); color: var(--text-dark); } 
.bg-rec .status { background: rgba(0,0,0,0.08); }

.empty-state {
  grid-column: 1 / -1; text-align: center; padding: 10vh 20px; color: #94a3b8;
  font-size: clamp(18px, 3vw, 32px); font-weight: 600;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FULLSCREEN POPUP ANIMATION (TV Ready)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#popupOverlay {
  position: fixed; inset: 0; z-index: 9999;
  background: rgba(11,25,41,0.85);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  display: flex; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none;
  transition: opacity 0.4s ease;
}
#popupOverlay.active { opacity: 1; pointer-events: auto; }

.popup-box {
  width: min(80vw, 600px); aspect-ratio: 1;
  border-radius: clamp(30px, 5vw, 60px);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  text-align: center; padding: 32px;
  box-shadow: 0 30px 60px rgba(0,0,0,0.6), inset 0 2px 10px rgba(255,255,255,0.3);
  transform: scale(0.5) translateY(50px);
  transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
}
#popupOverlay.active .popup-box { transform: scale(1) translateY(0); }

.popup-box .q-num { font-family: "Outfit", sans-serif; font-size: clamp(80px, 15vw, 200px); font-weight: 900; line-height: 1; margin-bottom: 20px; text-shadow: 0 10px 30px rgba(0,0,0,0.3);}
.popup-box .name { font-size: clamp(30px, 5vw, 56px); font-weight: 800; margin-bottom: 24px; }
.popup-box .status { font-size: clamp(24px, 4vw, 42px); font-weight: 700; background: rgba(255,255,255,0.25); padding: 12px 32px; border-radius: 50px; }

@keyframes pulseDot {
  0% { box-shadow: 0 0 0 0 rgba(52,211,153,0.7); }
  70% { box-shadow: 0 0 0 clamp(6px, 1vw, 12px) rgba(52,211,153,0); }
  100% { box-shadow: 0 0 0 0 rgba(52,211,153,0); }
}

/* à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¹ƒà¸«à¹‰ View Transition à¸™à¸¸à¹ˆà¸¡à¸™à¸§à¸¥à¸‚à¸¶à¹‰à¸™ */
::view-transition-group(*) { animation-duration: 0.5s; animation-timing-function: cubic-bezier(0.25, 1, 0.5, 1); }
</style>
</head>
<body>

<header>
  <div class="brand-title">ğŸ¾ à¸ªà¸–à¸²à¸™à¸°à¸„à¸´à¸§à¸ªà¸±à¸•à¸§à¹Œà¹€à¸¥à¸µà¹‰à¸¢à¸‡ VASD</div>
  <div class="live-indicator"><div class="live-dot"></div> à¸­à¸±à¸›à¹€à¸”à¸•à¸¥à¹ˆà¸²à¸ªà¸¸à¸” (Real-Time)</div>
</header>

<div class="wrap">
  <div id="animalList">
    <div class="empty-state" id="emptyState">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸„à¸´à¸§...</div>
  </div>
</div>

<div id="popupOverlay">
  <div class="popup-box" id="popupBox">
    <div class="q-num" id="popupQ">#0</div>
    <div class="name" id="popupName">à¸Šà¸·à¹ˆà¸­à¸ªà¸±à¸•à¸§à¹Œ</div>
    <div class="status" id="popupStatus">à¸ªà¸–à¸²à¸™à¸°</div>
  </div>
</div>

<script type="module">
import { supabase } from "./js/supabase.js";

let isFirstLoad = true;
let oldStatuses = {}; 

let popupQueue = [];
let isPopupShowing = false;

const statusMap = {
  ready_to_go_home: { text: "à¸£à¸­à¸£à¸±à¸šà¸à¸¥à¸±à¸š", colorClass: "bg-ready", weight: 1 },
  done:             { text: "à¸£à¸­à¸£à¸±à¸šà¸à¸¥à¸±à¸š", colorClass: "bg-ready", weight: 1 }, 
  recovery:         { text: "à¸à¸±à¸à¸Ÿà¸·à¹‰à¸™",   colorClass: "bg-rec",   weight: 2 },
  surgery:          { text: "à¸à¸³à¸¥à¸±à¸‡à¸œà¹ˆà¸²",  colorClass: "bg-surg",  weight: 3 },
  anesthesia:       { text: "à¸§à¸²à¸‡à¸¢à¸²",     colorClass: "bg-anes",  weight: 4 },
  waiting:          { text: "à¸£à¸­à¸œà¹ˆà¸²à¸•à¸±à¸”",  colorClass: "bg-wait",  weight: 5 },
  cancel:           { text: "à¸¢à¸à¹€à¸¥à¸´à¸",    colorClass: "bg-wait",  weight: 99 }
};

async function loadAnimals() {
  const { data, error } = await supabase
    .from("vasd_animal")
    .select(`id, queue_number, animal_name, vasd_queue(status)`);

  if (error) {
    console.error("Database Fetch Error:", error);
    document.getElementById("animalList").innerHTML = `<div class="empty-state">à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸„à¸´à¸§</div>`;
    return;
  }
  
  const formattedData = data || [];
  
  formattedData.sort((a, b) => {
    const qDataA = Array.isArray(a.vasd_queue) ? a.vasd_queue[0] : a.vasd_queue;
    const qDataB = Array.isArray(b.vasd_queue) ? b.vasd_queue[0] : b.vasd_queue;
    const statA = qDataA?.status || "waiting";
    const statB = qDataB?.status || "waiting";
    
    const wA = statusMap[statA]?.weight || 99;
    const wB = statusMap[statB]?.weight || 99;
    if (wA !== wB) return wA - wB;
    return a.queue_number - b.queue_number;
  });

  renderGrid(formattedData);
}

function renderGrid(data) {
  const list = document.getElementById("animalList");
  
  const activeData = data.filter(a => {
    const qData = Array.isArray(a.vasd_queue) ? a.vasd_queue[0] : a.vasd_queue;
    return (qData?.status || "waiting") !== "cancel";
  });

  let htmlContent = "";

  if (activeData.length === 0) {
    htmlContent = `<div class="empty-state">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸£à¸²à¸¢à¸à¸²à¸£à¸„à¸´à¸§à¹ƒà¸™à¸‚à¸“à¸°à¸™à¸µà¹‰</div>`;
  } else {
    activeData.forEach(a => {
      const qData = Array.isArray(a.vasd_queue) ? a.vasd_queue[0] : a.vasd_queue;
      const newStatus = qData?.status || "waiting";
      const s = statusMap[newStatus] || statusMap.waiting;
      
      if (!isFirstLoad && oldStatuses[a.id] && oldStatuses[a.id] !== newStatus) {
        enqueuePopup({
          queue: a.queue_number,
          name: a.animal_name,
          text: s.text,
          colorClass: s.colorClass
        });
      }
      oldStatuses[a.id] = newStatus; 

      // à¹ƒà¸ªà¹ˆ style view-transition-name à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¸à¸²à¸£à¹Œà¸”à¸¥à¸­à¸¢à¸ªà¸¥à¸±à¸šà¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¹„à¸”à¹‰ (à¹€à¸‰à¸à¸²à¸°à¹€à¸šà¸£à¸²à¸§à¹Œà¹€à¸‹à¸­à¸£à¹Œà¸—à¸µà¹ˆà¸£à¸­à¸‡à¸£à¸±à¸š)
      htmlContent += `
        <div class="pet-card ${s.colorClass}" style="view-transition-name: card-${a.id};">
          <div class="q-num">#${a.queue_number}</div>
          <div class="name">${a.animal_name || "à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸"}</div>
          <div class="status">${s.text}</div>
        </div>
      `;
    });
  }

  // ğŸª„ à¹ƒà¸Šà¹‰ View Transitions API à¹€à¸à¸·à¹ˆà¸­à¸ªà¸£à¹‰à¸²à¸‡à¹à¸­à¸™à¸´à¹€à¸¡à¸Šà¸±à¸™à¹€à¸§à¸¥à¸²à¸„à¸´à¸§à¸‚à¸¢à¸±à¸šà¸ªà¸¥à¸±à¸šà¸•à¸³à¹à¸«à¸™à¹ˆà¸‡
  if (!isFirstLoad && document.startViewTransition) {
    document.startViewTransition(() => {
      list.innerHTML = htmlContent;
    });
  } else {
    list.innerHTML = htmlContent;
  }
  
  isFirstLoad = false;
}

function enqueuePopup(animalData) {
  popupQueue.push(animalData);
  processPopupQueue();
}

function processPopupQueue() {
  if (isPopupShowing || popupQueue.length === 0) return;
  isPopupShowing = true;
  
  const target = popupQueue.shift();
  const overlay = document.getElementById("popupOverlay");
  const box = document.getElementById("popupBox");
  
  document.getElementById("popupQ").textContent = `#${target.queue}`;
  document.getElementById("popupName").textContent = target.name || "à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸Šà¸·à¹ˆà¸­";
  document.getElementById("popupStatus").textContent = target.text;
  
  box.className = `popup-box ${target.colorClass}`;
  
  overlay.classList.add("active");
  
  setTimeout(() => {
    overlay.classList.remove("active");
    setTimeout(() => {
      isPopupShowing = false;
      processPopupQueue();
    }, 400); // à¹€à¸œà¸·à¹ˆà¸­à¹€à¸§à¸¥à¸²à¹ƒà¸«à¹‰ Animation CSS à¸«à¸”à¸à¸¥à¸±à¸šà¹€à¸ªà¸£à¹‡à¸ˆ
  }, 4000); // à¹ƒà¸«à¹‰à¸­à¸¢à¸¹à¹ˆà¸šà¸™à¸ˆà¸­à¸™à¸²à¸™à¸‚à¸¶à¹‰à¸™à¸™à¸´à¸”à¸™à¸¶à¸‡ (4 à¸§à¸´à¸™à¸²à¸—à¸µ) à¹€à¸œà¸·à¹ˆà¸­à¸ˆà¸­à¸—à¸µà¸§à¸µà¸„à¸™à¸¡à¸­à¸‡à¹„à¸¡à¹ˆà¸—à¸±à¸™
}

supabase.channel("vasd-customer-live")
  .on("postgres_changes", { event: "*", schema: "public", table: "vasd_queue" }, loadAnimals)
  .on("postgres_changes", { event: "*", schema: "public", table: "vasd_animal" }, loadAnimals)
  .subscribe();

loadAnimals();
</script>

</body>
</html>
