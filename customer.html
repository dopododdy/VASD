<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>à¸•à¸´à¸”à¸•à¸²à¸¡à¸ªà¸–à¸²à¸™à¸°à¸ªà¸±à¸•à¸§à¹Œà¹€à¸¥à¸µà¹‰à¸¢à¸‡ â€“ VASD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOKENS & THEME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --navy:         #0b1929;
  --navy-mid:     #112240;
  --teal:         #0ea5a0;
  --teal-light:   #14c4bc;
  --teal-glow:    rgba(14,165,160,0.25);
  
  --surface:      rgba(255,255,255,0.04);
  --surface-2:    rgba(255,255,255,0.07);
  --border:       rgba(255,255,255,0.08);
  --border-2:     rgba(255,255,255,0.14);
  
  --text:         #e2e8f0;
  --text-dim:     #94a3b8;
  
  --radius:       20px;

  /* Status Colors */
  --c-wait:       #94a3b8;
  --c-anes:       #60a5fa;
  --c-surg:       #f87171;
  --c-rec:        #c084fc;
  --c-ready:      #fbbf24;
  --c-done:       #34d399;
  --c-cancel:     #475569;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }

body {
  font-family: "Sarabun", sans-serif;
  background: var(--navy);
  color: var(--text);
  min-height: 100vh; min-height: 100dvh;
  display: flex; flex-direction: column;
  overflow-x: hidden;
  padding-bottom: 40px; /* Space at bottom */
}

/* Background mesh */
body::before {
  content: ""; position: fixed; inset: 0; z-index: -1; pointer-events: none;
  background:
    radial-gradient(circle at 15% 10%, rgba(14,165,160,0.12) 0%, transparent 60%),
    radial-gradient(circle at 85% 85%, rgba(99,102,241,0.08) 0%, transparent 60%);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
header {
  position: sticky; top: 0; z-index: 200;
  background: rgba(11,25,41,0.85);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-bottom: 1px solid var(--border);
  padding: 16px 20px;
  display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
  box-shadow: 0 4px 30px rgba(0,0,0,0.3);
}
.brand-title {
  font-family: "Outfit", "Sarabun", sans-serif;
  font-size: 18px; font-weight: 700; color: #fff;
  letter-spacing: 0.5px;
}
.brand-sub {
  font-size: 12px; color: var(--teal-light); font-weight: 500;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN WRAPPER & CARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.wrap {
  position: relative; z-index: 1;
  max-width: 600px; /* Optimized for mobile/tablet reading */
  margin: 0 auto;
  padding: 24px 16px;
  width: 100%;
}

.live-indicator {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  font-size: 11px; font-weight: 600; color: var(--text-dim);
  margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px;
}
.live-dot {
  width: 8px; height: 8px; background: var(--c-done); border-radius: 50%;
  animation: pulseDot 2s infinite;
}

#animalList {
  display: flex; flex-direction: column; gap: 14px;
}

/* â”€â”€ Customer Card â”€â”€ */
.customer-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 18px;
  display: flex; align-items: center; gap: 16px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  animation: slideIn 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) both;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  position: relative;
  overflow: hidden;
}

/* Left Accent Line */
.customer-card::before {
  content: ""; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
}
.card-ready::before { background: var(--c-ready); box-shadow: 0 0 10px var(--c-ready); }
.card-rec::before   { background: var(--c-rec); }
.card-surg::before  { background: var(--c-surg); }
.card-anes::before  { background: var(--c-anes); }
.card-wait::before  { background: var(--c-wait); }
.card-done::before  { background: var(--c-done); }

.queue-badge {
  font-family: "Outfit", sans-serif;
  font-size: 18px; font-weight: 800;
  width: 50px; height: 50px; border-radius: 14px;
  background: var(--surface-2); border: 1px solid var(--border-2);
  display: flex; align-items: center; justify-content: center;
  color: #fff; flex-shrink: 0;
}

.card-info { flex: 1; min-width: 0; }
.animal-name {
  font-size: 18px; font-weight: 700; color: #fff;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  margin-bottom: 4px; line-height: 1.2;
}
.animal-species {
  font-size: 13px; color: var(--text-dim); font-weight: 500;
  display: flex; align-items: center; gap: 4px;
}

.status-badge {
  padding: 8px 14px; border-radius: 30px;
  font-size: 13px; font-weight: 700; flex-shrink: 0;
  display: inline-flex; align-items: center; gap: 6px;
  text-align: center; white-space: nowrap;
}

/* Status Variations */
.sp-ready { background: rgba(251,191,36,0.15); color: var(--c-ready); border: 1px solid rgba(251,191,36,0.3); }
.sp-rec   { background: rgba(192,132,252,0.15); color: var(--c-rec); border: 1px solid rgba(192,132,252,0.3); }
.sp-surg  { background: rgba(248,113,113,0.15); color: var(--c-surg); border: 1px solid rgba(248,113,113,0.3); }
.sp-anes  { background: rgba(96,165,250,0.15); color: var(--c-anes); border: 1px solid rgba(96,165,250,0.3); }
.sp-wait  { background: rgba(148,163,184,0.15); color: var(--c-wait); border: 1px solid rgba(148,163,184,0.3); }
.sp-done  { background: rgba(52,211,153,0.15); color: var(--c-done); border: 1px solid rgba(52,211,153,0.3); }

/* Highlight Ready Status */
.card-ready {
  background: linear-gradient(to right, rgba(251,191,36,0.08), rgba(255,255,255,0.02));
  border-color: rgba(251,191,36,0.3);
}

.empty-state {
  text-align: center; padding: 60px 16px; color: var(--text-faint);
}
.empty-state-icon { font-size: 48px; margin-bottom: 14px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ANIMATIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@keyframes slideIn {
  from { opacity: 0; transform: translateY(20px) scale(0.98); }
  to   { opacity: 1; transform: translateY(0) scale(1); }
}
@keyframes pulseDot {
  0% { box-shadow: 0 0 0 0 rgba(52,211,153,0.7); }
  70% { box-shadow: 0 0 0 8px rgba(52,211,153,0); }
  100% { box-shadow: 0 0 0 0 rgba(52,211,153,0); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 480px) {
  .customer-card { flex-wrap: wrap; padding: 16px; gap: 12px; }
  .queue-badge { width: 44px; height: 44px; font-size: 16px; }
  .animal-name { font-size: 16px; }
  .status-badge { width: 100%; justify-content: center; padding: 10px; font-size: 14px; margin-top: 4px; }
}
</style>
</head>
<body>

<header>
  <div class="brand-title">ğŸ¾ à¸•à¸´à¸”à¸•à¸²à¸¡à¸ªà¸–à¸²à¸™à¸°à¸ªà¸±à¸•à¸§à¹Œà¹€à¸¥à¸µà¹‰à¸¢à¸‡</div>
  <div class="brand-sub">RMUTTO â€“ VASD</div>
</header>

<div class="wrap">
  <div class="live-indicator">
    <div class="live-dot"></div>
    Real-Time Update
  </div>

  <div id="animalList">
    <div class="empty-state" id="emptyState">
      <div class="empty-state-icon">ğŸ¾</div>
      <div class="empty-state-text">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸„à¸´à¸§...</div>
    </div>
  </div>
</div>

<script type="module">
import { supabase } from "./js/supabase.js";

// à¹à¸œà¸™à¸—à¸µà¹ˆà¸ˆà¸±à¸”à¹€à¸•à¸£à¸µà¸¢à¸¡à¸ªà¸–à¸²à¸™à¸°à¹à¸¥à¸°à¸„à¸¥à¸²à¸ªà¸ªà¸µ
const statusMap = {
  ready_to_go_home: { text: "à¸Ÿà¸·à¹‰à¸™à¹à¸¥à¹‰à¸§/à¸£à¸­à¸£à¸±à¸šà¸à¸¥à¸±à¸š", cardCls: "card-ready", pillCls: "sp-ready", icon: "ğŸŸ¢", weight: 1 },
  recovery:         { text: "à¸à¸³à¸¥à¸±à¸‡à¸à¸±à¸à¸Ÿà¸·à¹‰à¸™",      cardCls: "card-rec",   pillCls: "sp-rec",   icon: "ğŸŸ£", weight: 2 },
  surgery:          { text: "à¸à¸³à¸¥à¸±à¸‡à¸œà¹ˆà¸²à¸•à¸±à¸”",       cardCls: "card-surg",  pillCls: "sp-surg",  icon: "ğŸ”´", weight: 3 },
  anesthesia:       { text: "à¸à¸³à¸¥à¸±à¸‡à¸§à¸²à¸‡à¸¢à¸²",      cardCls: "card-anes",  pillCls: "sp-anes",  icon: "ğŸ”µ", weight: 4 },
  waiting:          { text: "à¸£à¸­à¸œà¹ˆà¸²à¸•à¸±à¸”",        cardCls: "card-wait",  pillCls: "sp-wait",  icon: "âšª", weight: 5 },
  done:             { text: "à¸£à¸±à¸šà¸à¸¥à¸±à¸šà¹à¸¥à¹‰à¸§",       cardCls: "card-done",  pillCls: "sp-done",  icon: "âœ…", weight: 6 },
  cancel:           { text: "à¸¢à¸à¹€à¸¥à¸´à¸",           cardCls: "card-wait",  pillCls: "sp-wait",  icon: "â¬›", weight: 99 } // à¸‹à¹ˆà¸­à¸™à¹„à¸§à¹‰à¸¥à¹ˆà¸²à¸‡à¸ªà¸¸à¸”
};

async function loadAnimals() {
  const { data: eventId } = await supabase.rpc("get_today_event");
  
  const { data, error } = await supabase
    .from("vasd_animal")
    .select(`id, queue_number, animal_name, species, vasd_queue(status)`)
    .eq("event_id", eventId);

  if (error) { console.error(error); return; }
  
  const formattedData = data || [];
  
  // à¹€à¸£à¸µà¸¢à¸‡à¸¥à¸³à¸”à¸±à¸šà¸•à¸²à¸¡à¸„à¸§à¸²à¸¡à¸ªà¸³à¸„à¸±à¸à¸‚à¸­à¸‡à¸ªà¸–à¸²à¸™à¸° (Weight) à¹à¸¥à¹‰à¸§à¸„à¹ˆà¸­à¸¢à¹€à¸£à¸µà¸¢à¸‡à¸•à¸²à¸¡à¹€à¸¥à¸‚à¸„à¸´à¸§
  formattedData.sort((a, b) => {
    const statusA = a.vasd_queue?.status || "waiting";
    const statusB = b.vasd_queue?.status || "waiting";
    
    const weightA = statusMap[statusA]?.weight || 99;
    const weightB = statusMap[statusB]?.weight || 99;

    if (weightA !== weightB) {
      return weightA - weightB;
    }
    return a.queue_number - b.queue_number;
  });

  renderCards(formattedData);
}

function renderCards(data) {
  const list = document.getElementById("animalList");
  const empty = document.getElementById("emptyState");

  // à¸à¸£à¸­à¸‡à¸•à¸±à¸§à¸—à¸µà¹ˆà¸¢à¸à¹€à¸¥à¸´à¸à¸­à¸­à¸à¸ˆà¸²à¸à¸à¸²à¸£à¹à¸ªà¸”à¸‡à¸œà¸¥à¸à¸±à¹ˆà¸‡à¸¥à¸¹à¸à¸„à¹‰à¸² (à¸–à¹‰à¸²à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹‚à¸Šà¸§à¹Œà¹ƒà¸«à¹‰à¹€à¸­à¸² .filter à¸­à¸­à¸)
  const activeData = data.filter(a => (a.vasd_queue?.status || "waiting") !== "cancel");

  if (activeData.length === 0) {
    list.innerHTML = "";
    empty.style.display = "block";
    empty.querySelector(".empty-state-text").textContent = "à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸£à¸²à¸¢à¸à¸²à¸£à¸„à¸´à¸§à¹ƒà¸™à¸‚à¸“à¸°à¸™à¸µà¹‰";
    list.appendChild(empty);
    return;
  }

  list.innerHTML = "";
  
  activeData.forEach((a, idx) => {
    const statusKey = a.vasd_queue?.status || "waiting";
    const s = statusMap[statusKey] || statusMap.waiting;
    const speciesText = a.species === "à¸¡" ? "à¹à¸¡à¸§" : "à¸ªà¸¸à¸™à¸±à¸‚";
    const speciesEmoji = a.species === "à¸¡" ? "ğŸ±" : "ğŸ¶";

    const card = document.createElement("div");
    card.className = `customer-card ${s.cardCls}`;
    // à¸«à¸™à¹ˆà¸§à¸‡à¹€à¸§à¸¥à¸² Animation à¸•à¸­à¸™à¹‚à¸«à¸¥à¸”à¸«à¸™à¹‰à¸²à¹à¸£à¸à¹ƒà¸«à¹‰à¹„à¸¥à¹ˆà¸¥à¸‡à¸¡à¸²à¸ªà¸§à¸¢à¹†
    card.style.animationDelay = `${idx * 0.08}s`; 

    card.innerHTML = `
      <div class="queue-badge">#${a.queue_number}</div>
      <div class="card-info">
        <div class="animal-name">${a.animal_name || "à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸Šà¸·à¹ˆà¸­"}</div>
        <div class="animal-species">${speciesEmoji} à¸™à¹‰à¸­à¸‡${speciesText}</div>
      </div>
      <div class="status-badge ${s.pillCls}">
        ${s.icon} ${s.text}
      </div>
    `;

    list.appendChild(card);
  });
}

// â”€â”€ Real-time Listener â”€â”€
// à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¸¡à¹ˆà¸—à¸±à¸™à¸—à¸µà¹€à¸¡à¸·à¹ˆà¸­à¸¡à¸µà¸à¸²à¸£à¸­à¸±à¸›à¹€à¸”à¸•à¸ˆà¸²à¸à¸à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥
supabase.channel("vasd-customer-live")
  .on("postgres_changes", { event: "*", schema: "public", table: "vasd_queue" }, loadAnimals)
  .on("postgres_changes", { event: "*", schema: "public", table: "vasd_animal" }, loadAnimals)
  .subscribe();

// Initial load
loadAnimals();
</script>

<script type="module" src="./js/global-alarm.js"></script>
</body>
</html>
