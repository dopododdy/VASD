<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>Sticker Designer ‚Äì RMUTTO VASD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@600;700&family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
<style>
:root {
  --navy: #0b1929; --navy-mid: #112240; --teal: #0ea5a0; --teal-light: #14c4bc;
  --surface: rgba(255,255,255,0.05); --border: rgba(255,255,255,0.1);
  --text: #e2e8f0; --text-dim: #94a3b8; --radius: 12px;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: "Sarabun", sans-serif; background: var(--navy); color: var(--text); padding-bottom: 100px; }

header {
  padding: 12px 15px; display: flex; align-items: center; justify-content: space-between;
  background: rgba(11,25,41,0.8); backdrop-filter: blur(15px); border-bottom: 1px solid var(--border);
  position: sticky; top: 0; z-index: 100;
}
.btn-back { width: 38px; height: 38px; border-radius: 10px; background: var(--surface); border: 1px solid var(--border); color: #fff; display: flex; align-items: center; justify-content: center; text-decoration: none; }
.btn-print { padding: 8px 16px; background: var(--teal); border: none; border-radius: 10px; color: #fff; font-weight: 600; font-size: 13px; cursor: pointer; }

/* Preview Container for Mobile */
.preview-section {
  padding: 20px; background: rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center;
  position: sticky; top: 63px; z-index: 90; border-bottom: 1px solid var(--border); backdrop-filter: blur(5px);
}
.sticker-wrapper { transform-origin: center; transition: 0.3s; }
.sticker {
  width: 80mm; height: 50mm; background: #fff; position: relative; color: #000; overflow: hidden;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5); border-radius: 2px;
}
.line { position: absolute; white-space: pre-wrap; word-break: break-word; line-height: 1.2; font-family: 'Sarabun'; }

.editor-section { padding: 20px; max-width: 500px; margin: 0 auto; }
.card { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 16px; margin-bottom: 16px; }
.label { font-size: 12px; color: var(--text-dim); margin-bottom: 6px; display: block; font-weight: 600; }

input, select {
  width: 100%; padding: 12px; background: var(--navy-mid); border: 1px solid var(--border);
  border-radius: 10px; color: #fff; font-size: 15px; outline: none; margin-bottom: 10px;
}

.prop-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px; }
.prop-3-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }

.btn-add { width: 100%; padding: 14px; background: var(--surface); border: 1px dotted var(--teal); color: var(--teal-light); border-radius: 12px; font-weight: 600; cursor: pointer; margin-bottom: 20px; }
.btn-save { width: 100%; padding: 16px; background: linear-gradient(135deg, var(--teal), var(--teal-light)); border: none; color: #fff; border-radius: 12px; font-weight: 700; font-size: 16px; cursor: pointer; box-shadow: 0 4px 15px var(--teal-glow); }
.btn-del { padding: 6px 12px; background: rgba(239,68,68,0.1); color: #ef4444; border: 1px solid #ef4444; border-radius: 6px; font-size: 11px; }

/* Scaling for small screens */
@media (max-width: 400px) { .sticker-wrapper { transform: scale(0.85); } }
@media (max-width: 350px) { .sticker-wrapper { transform: scale(0.75); } }

/* Desktop Adjustment */
@media (min-width: 900px) {
  body { display: flex; flex-direction: row; padding-bottom: 0; }
  header { position: fixed; width: 100%; }
  .preview-section { width: 60%; height: 100vh; position: fixed; right: 0; top: 0; padding-top: 80px; }
  .editor-section { width: 40%; margin: 0; padding-top: 80px; height: 100vh; overflow-y: auto; }
}
</style>
</head>
<body>

<header>
  <a href="settings.html" class="btn-back">‚Üê</a>
  <span style="font-family:'Outfit'; font-weight:700;">Designer</span>
  <button class="btn-print" onclick="window.printTest()">Test Print</button>
</header>

<section class="preview-section">
  <div class="sticker-wrapper">
    <div class="sticker" id="sticker"></div>
  </div>
</section>

<div class="editor-section">
  <div class="card">
    <label class="label">TEMPLATE TYPE</label>
    <select id="templateType" onchange="loadTemplate()">
      <option value="queue">üè∑ ‡∏Ñ‡∏¥‡∏ß (Queue)</option>
      <option value="envelope">‚úâÔ∏è ‡∏â‡∏•‡∏≤‡∏Å‡∏¢‡∏≤ (Envelope)</option>
      <option value="cage">üîí ‡∏ï‡∏¥‡∏î‡∏Å‡∏£‡∏á (Cage)</option>
    </select>
  </div>

  <div id="lineEditor"></div>
  
  <button class="btn-add" onclick="addLine()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î</button>
  <button class="btn-save" onclick="saveTemplate()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ</button>
</div>

<script type="module">
import { supabase } from "./js/supabase.js";
let currentConfig = [];

function renderPreview() {
  const box = document.getElementById("sticker");
  box.innerHTML = "";
  currentConfig.forEach(l => {
    const div = document.createElement("div");
    div.className = "line";
    div.style.left = l.x + "px"; div.style.top = l.y + "px";
    div.style.fontSize = l.size + "px"; div.style.textAlign = l.align || "left";
    div.style.width = `calc(100% - ${l.x}px)`;
    div.innerText = l.text.replace("{{queue_number}}","A01").replace("{{animal_name}}","‡∏ô‡πâ‡∏≠‡∏á‡πÅ‡∏°‡∏ß");
    box.appendChild(div);
  });
}

function renderEditor() {
  const area = document.getElementById("lineEditor");
  area.innerHTML = "";
  currentConfig.forEach((l, i) => {
    const block = document.createElement("div");
    block.className = "card";
    block.innerHTML = `
      <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
        <span style="font-size:12px; font-weight:700;">LINE ${i+1}</span>
        <button class="btn-del" onclick="removeLine(${i})">‡∏•‡∏ö</button>
      </div>
      <input value="${l.text}" oninput="updateLine(${i},'text',this.value)" placeholder="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...">
      <div class="prop-row">
        <select onchange="updateLine(${i},'align',this.value)">
          <option value="left" ${l.align==='left'?'selected':''}>‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢</option>
          <option value="center" ${l.align==='center'?'selected':''}>‡∏Å‡∏•‡∏≤‡∏á</option>
        </select>
        <div class="prop-3-row">
          <input type="number" value="${l.size}" oninput="updateLine(${i},'size',this.value)" placeholder="Size">
          <input type="number" value="${l.x}" oninput="updateLine(${i},'x',this.value)" placeholder="X">
          <input type="number" value="${l.y}" oninput="updateLine(${i},'y',this.value)" placeholder="Y">
        </div>
      </div>
    `;
    area.appendChild(block);
  });
}

window.updateLine = (i, k, v) => { if(['size','x','y'].includes(k)) v=parseInt(v)||0; currentConfig[i][k]=v; renderPreview(); };
window.removeLine = (i) => { currentConfig.splice(i,1); renderEditor(); renderPreview(); };
window.addLine = () => { currentConfig.push({text:"New Line", size:14, x:10, y:10, align:"left"}); renderEditor(); renderPreview(); };

window.loadTemplate = async () => {
  const type = document.getElementById("templateType").value;
  const { data } = await supabase.from("vasd_print_template").select("*").eq("template_type", type).single();
  currentConfig = data?.config || []; renderEditor(); renderPreview();
};

window.saveTemplate = async () => {
  const type = document.getElementById("templateType").value;
  await supabase.from("vasd_print_template").upsert({ template_type:type, config:currentConfig }, { onConflict:"template_type" });
  alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
};

loadTemplate();
</script>
</body>
</html>
