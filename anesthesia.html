<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>RMUTTO - VASD | ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î (Anesthesia & Surgery)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&family=Prompt:wght@300;400;500;700&family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>
:root {
  --navy:#0d1b2a; --teal:#1a6b72; --teal-light:#22919a; --accent:#00d4aa;
  --bg:#f0f4f8; --surface:#fff; --text:#1a202c; --text-muted:#718096;
  --border:#e2e8f0; --danger:#e53e3e; --success:#38a169; --warning:#d69e2e;
  --shadow-sm:0 1px 3px rgba(0,0,0,0.06); --shadow-md:0 4px 16px rgba(13,27,42,0.08);
  --radius:10px; --radius-sm:6px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{font-family:"Sarabun",sans-serif;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;}

/* HEADER */
header{
  background:var(--navy);padding:0 32px;display:flex;
  justify-content:space-between;align-items:center;height:68px;
  position:sticky;top:0;z-index:100;box-shadow:0 2px 20px rgba(0,0,0,0.25);flex-shrink:0;
}
.header-brand{display:flex;align-items:center;gap:14px;}
.brand-icon{
  width:40px;height:40px;background:linear-gradient(135deg,var(--teal-light),var(--accent));
  border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;
}
.brand-text h1{font-size:17px;font-weight:700;color:#fff;line-height:1.2;}
.brand-text span{font-size:11px;color:rgba(255,255,255,0.5);}
.btn-home{
  padding:8px 18px;font-size:13px;font-weight:600;font-family:"Sarabun",sans-serif;
  background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.9);
  border:1px solid rgba(255,255,255,0.2);border-radius:var(--radius-sm);cursor:pointer;
}

/* TABS */
.tabs-container { padding: 20px 32px 0 32px; background:var(--surface); border-bottom:1px solid var(--border); display:flex; gap:10px; }
.tab-btn {
  padding:12px 24px; font-size:15px; font-weight:700; font-family:"Sarabun",sans-serif;
  background:transparent; border:none; border-bottom:3px solid transparent; color:var(--text-muted);
  cursor:pointer; transition:all 0.2s;
}
.tab-btn.active { border-bottom-color:var(--teal); color:var(--teal); }
.tab-content { display:none; padding:24px 32px; flex:1; overflow-y:auto; }
.tab-content.active { display:block; animation:fadeIn 0.3s ease; }

/* GRID LAYOUTS */
.grid-waiting { display:grid; grid-template-columns:repeat(auto-fill, minmax(400px, 1fr)); gap:20px; }
.grid-surgery { display:grid; grid-template-columns:1fr; gap:24px; }

/* CARDS */
.card { background:var(--surface); border-radius:var(--radius); border:1px solid var(--border); box-shadow:var(--shadow-sm); padding:20px; }
.card-header { display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); padding-bottom:12px; margin-bottom:16px; }
.badge-q { background:var(--navy); color:#fff; padding:4px 10px; border-radius:20px; font-size:13px; font-weight:700; }

/* DRUG CALC BOX */
.calc-box { background:#f7fafc; border-left:4px solid var(--teal-light); padding:12px; margin-bottom:16px; border-radius:4px; font-size:13px; }
.calc-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:8px; }
.calc-item { background:#fff; padding:8px; border:1px solid var(--border); border-radius:4px; display:flex; justify-content:space-between; }
.calc-item span.vol { font-weight:700; color:var(--danger); }

/* FORMS & TABLES */
.form-group { display:flex; gap:10px; align-items:center; margin-bottom:12px; }
.form-group label { width:100px; font-size:13px; font-weight:600; color:var(--text-muted); }
.form-control { flex:1; padding:8px 12px; font-family:"Sarabun"; border:1px solid var(--border); border-radius:var(--radius-sm); outline:none; font-size:14px; }

.staff-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; background:#f0f4f8; padding:16px; border-radius:var(--radius-sm); margin-bottom:20px; }

.vital-table { width:100%; border-collapse:collapse; margin-bottom:12px; font-size:13px; }
.vital-table th { background:var(--bg); padding:10px; border:1px solid var(--border); text-align:left; color:var(--text-muted); }
.vital-table td { padding:10px; border:1px solid var(--border); text-align:center; }
.vital-form { display:flex; gap:6px; background:#fff; padding:12px; border:1px solid var(--border); border-radius:var(--radius-sm); margin-bottom:20px; flex-wrap:wrap; }
.vital-form input { flex:1; min-width:80px; padding:8px; font-size:13px; border:1px solid var(--border); border-radius:4px; }

/* BUTTONS */
.btn { padding:8px 16px; font-size:13px; font-weight:700; font-family:"Sarabun"; border:none; border-radius:6px; cursor:pointer; }
.btn-primary { background:var(--teal); color:#fff; }
.btn-primary:hover { background:var(--teal-light); }
.btn-success { background:var(--success); color:#fff; }
.btn-warning { background:var(--warning); color:#fff; }
.action-bar { display:flex; justify-content:flex-end; gap:12px; margin-top:20px; padding-top:16px; border-top:1px solid var(--border); }

/* MODAL */
.modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999; justify-content:center; align-items:center; }
.modal { background:#fff; width:90%; max-width:600px; border-radius:var(--radius); padding:24px; box-shadow:var(--shadow-md); }
.modal-header { font-size:18px; font-weight:700; margin-bottom:16px; border-bottom:1px solid var(--border); padding-bottom:12px; }

@keyframes fadeIn{from{opacity:0;transform:translateY(5px);}to{opacity:1;transform:translateY(0);}}
</style>
</head>
<body>

<header>
  <div class="header-brand">
    <div class="brand-icon">ü©∫</div>
    <div class="brand-text">
      <h1>‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î (Anesthesia & Surgery)</h1>
      <span>RMUTTO ‚Äì Veterinary Academic Service Division</span>
    </div>
  </div>
  <button class="btn-home" onclick="location.href='index.html'">üè† ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
</header>

<div class="tabs-container">
  <button class="tab-btn active" onclick="switchTab('tab-waiting', this)">1. ‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î / ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≤</button>
  <button class="tab-btn" onclick="switchTab('tab-surgery', this)">2. ‡πÇ‡∏ï‡πä‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î / ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Vitals</button>
</div>

<div id="tab-waiting" class="tab-content active">
  <div class="grid-waiting" id="waitingGrid">
    <p style="color:var(--text-muted);">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏¥‡∏ß...</p>
  </div>
</div>

<div id="tab-surgery" class="tab-content">
  <div class="grid-surgery" id="surgeryGrid">
    <p style="color:var(--text-muted);">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏ï‡πä‡∏∞‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î...</p>
  </div>
</div>

<div class="modal-overlay" id="rxModal">
  <div class="modal">
    <div class="modal-header">üíä ‡∏à‡∏±‡∏î‡∏¢‡∏≤ (Prescription) <span id="rxAnimalName" style="color:var(--teal);"></span></div>
    <div id="rxFormList" style="display:flex; flex-direction:column; gap:12px; max-height:400px; overflow-y:auto; margin-bottom:20px;">
      </div>
    <div class="action-bar">
      <button class="btn" onclick="closeRxModal()" style="background:#e2e8f0;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn btn-success" onclick="saveRx()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤</button>
    </div>
  </div>
</div>

<script type="module">
import { supabase } from "./js/supabase.js";

let currentEventId = null;
let currentRxAnimalId = null;

// ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏ï‡∏Ñ‡∏≠‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≤ (‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç mg/kg ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà)
const DRUG_PROTOCOL = {
  xylazine: { dose_mg_kg: 2, conc_mg_ml: 20, name: "Xylazine 20mg/ml" },
  zoletil:  { dose_mg_kg: 5, conc_mg_ml: 100, name: "Zoletil 100mg/ml" },
  tolfedine:{ dose_mg_kg: 4, conc_mg_ml: 40, name: "Tolfedine 40mg/ml" },
  penstrep: { dose_ml_kg: 1, name: "Pen-Strep" } // ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô ml/kg ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
};

window.switchTab = function(tabId, btn) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
  btn.classList.add('active');
};

async function init() {
  const { data: eventId } = await supabase.rpc("get_today_event");
  currentEventId = eventId;
  loadData();
}

async function loadData() {
  await loadWaiting();
  await loadSurgery();
}

// ==========================================
// TAB 1: ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î (Waiting)
// ==========================================
async function loadWaiting() {
  const { data, error } = await supabase
    .from("vasd_queue")
    .select(`
      id, animal_id, status,
      vasd_animal!inner(id, event_id, queue_number, animal_name, species, sex, actual_weight)
    `)
    .eq("vasd_animal.event_id", currentEventId)
    .eq("status", "waiting")
    .order("created_at");

  const grid = document.getElementById("waitingGrid");
  if (error || !data || data.length === 0) {
    grid.innerHTML = `<div style="text-align:center; padding:40px; color:var(--text-muted); width:100%;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î</div>`;
    return;
  }

  grid.innerHTML = data.map(q => {
    const a = q.vasd_animal;
    const w = parseFloat(a.actual_weight) || 0;
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏¢‡∏≤ (Volume ml)
    const volXyl = ((w * DRUG_PROTOCOL.xylazine.dose_mg_kg) / DRUG_PROTOCOL.xylazine.conc_mg_ml).toFixed(2);
    const volZol = ((w * DRUG_PROTOCOL.zoletil.dose_mg_kg) / DRUG_PROTOCOL.zoletil.conc_mg_ml).toFixed(2);
    const volTol = ((w * DRUG_PROTOCOL.tolfedine.dose_mg_kg) / DRUG_PROTOCOL.tolfedine.conc_mg_ml).toFixed(2);
    const volPen = (w * DRUG_PROTOCOL.penstrep.dose_ml_kg).toFixed(2);

    let tableOptions = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞ --</option>';
    for(let i=1; i<=20; i++) tableOptions += `<option value="${i}">‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà ${i}</option>`;

    return `
      <div class="card">
        <div class="card-header">
          <div style="font-size:16px; font-weight:700;">${a.animal_name}</div>
          <span class="badge-q">‡∏Ñ‡∏¥‡∏ß ${a.queue_number}</span>
        </div>
        <div style="font-size:14px; margin-bottom:12px;">
          ${a.species === '‡∏™' ? '‡∏™‡∏∏‡∏ô‡∏±‡∏Ç' : '‡πÅ‡∏°‡∏ß'} | ‡πÄ‡∏û‡∏®: ${a.sex} | <strong style="color:var(--teal);">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏à‡∏£‡∏¥‡∏á: ${w} kg</strong>
        </div>
        
        <div class="calc-box">
          <div style="font-weight:700; margin-bottom:4px;">üíâ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≤‡∏â‡∏µ‡∏î (Pre-med & Anesthesia)</div>
          <div class="calc-grid">
            <div class="calc-item"><span>${DRUG_PROTOCOL.xylazine.name}</span> <span class="vol">${volXyl} ml</span></div>
            <div class="calc-item"><span>${DRUG_PROTOCOL.zoletil.name}</span> <span class="vol">${volZol} ml</span></div>
            <div class="calc-item"><span>${DRUG_PROTOCOL.tolfedine.name}</span> <span class="vol">${volTol} ml</span></div>
            <div class="calc-item"><span>${DRUG_PROTOCOL.penstrep.name}</span> <span class="vol">${volPen} ml</span></div>
          </div>
        </div>

        <div class="form-group">
          <label>‡∏£‡∏∞‡∏ö‡∏∏‡πÇ‡∏ï‡πä‡∏∞‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î:</label>
          <select class="form-control" id="table-sel-${a.id}">
            ${tableOptions}
          </select>
        </div>
        
        <div style="text-align:right;">
          <button class="btn btn-primary" onclick="moveToTable('${a.id}')">‡∏ô‡∏≥‡∏Ç‡∏∂‡πâ‡∏ô‡πÇ‡∏ï‡πä‡∏∞‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î ‚Ä∫</button>
        </div>
      </div>
    `;
  }).join("");
}

// ‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡πÇ‡∏ï‡πä‡∏∞
window.moveToTable = async function(animalId) {
  const tableNum = document.getElementById(`table-sel-${animalId}`).value;
  if (!tableNum) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î");

  const { error } = await supabase
    .from("vasd_queue")
    .update({ status: "surgery", table_number: parseInt(tableNum), updated_at: new Date() })
    .eq("animal_id", animalId);

  if (!error) loadData();
};

// ==========================================
// TAB 2: ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏ï‡πä‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î (Surgery)
// ==========================================
async function loadSurgery() {
  const { data, error } = await supabase
    .from("vasd_queue")
    .select(`
      id, animal_id, status, table_number, surgeon_name, anesthesiologist_name, notes,
      vasd_animal!inner(
        id, event_id, queue_number, animal_name, species, sex, actual_weight, health_note,
        vasd_owner(owner_name, phone),
        vasd_service(service_type)
      ),
      vasd_vital_signs(*)
    `)
    .eq("vasd_animal.event_id", currentEventId)
    .eq("status", "surgery")
    .order("table_number");

  const grid = document.getElementById("surgeryGrid");
  if (error || !data || data.length === 0) {
    grid.innerHTML = `<div style="text-align:center; padding:40px; color:var(--text-muted);">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏™‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î</div>`;
    return;
  }

  grid.innerHTML = data.map(q => {
    const a = q.vasd_animal;
    const ownerName = a.vasd_owner?.owner_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    const phone = a.vasd_owner?.phone || '-';
    const services = (a.vasd_service || []).map(s => s.service_type).join(', ') || '-';
    
    // Parse Staff ‡∏à‡∏≤‡∏Å notes (‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å DB ‡∏°‡∏µ‡πÅ‡∏Ñ‡πà surgeon ‡∏Å‡∏±‡∏ö anes)
    let extraNotes = { assistant: '', nurse: '' };
    try { if(q.notes) extraNotes = JSON.parse(q.notes); } catch(e){}

    // ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Vitals ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤
    const vitals = (q.vasd_vital_signs || []).sort((x, y) => {
        const t1 = x.time_recorded || x.created_at || "";
        const t2 = y.time_recorded || y.created_at || "";
        return t1.localeCompare(t2);
    });
    
    let vitalRows = vitals.map(v => {
      let timeStr = v.time_recorded ? v.time_recorded.substring(0,5) : (v.created_at ? new Date(v.created_at).toLocaleTimeString("th-TH").substring(0,5) : '-');
      return `<tr>
        <td>${timeStr}</td><td>${v.hr||'-'}</td><td>${v.rr||'-'}</td><td>${v.temp||'-'}</td>
        <td>${v.spo2 ? v.spo2+'%' : '-'}</td><td>${v.zoletil_top||'-'}</td><td>${v.note||'-'}</td>
      </tr>`;
    }).join("");
    if(vitals.length === 0) vitalRows = `<tr><td colspan="7" style="text-align:center; color:#aaa;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</td></tr>`;

    return `
      <div class="card">
        <div class="card-header" style="background:#e6fffa; padding:16px; margin:-20px -20px 20px -20px; border-radius:10px 10px 0 0;">
          <div style="font-size:18px; font-weight:700; color:var(--teal);">‡πÇ‡∏ï‡πä‡∏∞‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î‡∏ó‡∏µ‡πà ${q.table_number}</div>
          <span class="badge-q">‡∏Ñ‡∏¥‡∏ß ${a.queue_number}</span>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
          <div>
            <div style="background:#f7fafc; padding:12px; border-radius:6px; margin-bottom:16px; font-size:14px; line-height:1.6;">
              <strong>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå:</strong> ${a.animal_name} (${a.species === '‡∏™' ? '‡∏™‡∏∏‡∏ô‡∏±‡∏Ç' : '‡πÅ‡∏°‡∏ß'} | ‡πÄ‡∏û‡∏® ${a.sex} | ‡∏ô‡∏ô. ${a.actual_weight} kg)<br>
              <strong>‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á:</strong> ${ownerName} (‡πÇ‡∏ó‡∏£: ${phone})<br>
              <strong>‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£:</strong> ${services}<br>
              <strong>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û:</strong> <span style="color:var(--danger);">${a.health_note || '-'}</span>
            </div>

            <div class="staff-grid">
              <div><label style="font-size:12px; color:var(--text-muted);">üë®‚Äç‚öïÔ∏è Surgeon (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label><input type="text" class="form-control" id="surg-${a.id}" value="${q.surgeon_name || ''}" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πÅ‡∏û‡∏ó‡∏¢‡πå"></div>
              <div><label style="font-size:12px; color:var(--text-muted);">üßë‚Äç‚öïÔ∏è Assistant</label><input type="text" class="form-control" id="asst-${a.id}" value="${extraNotes.assistant || ''}" placeholder="‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢"></div>
              <div><label style="font-size:12px; color:var(--text-muted);">üíâ Anesthetist</label><input type="text" class="form-control" id="anes-${a.id}" value="${q.anesthesiologist_name || ''}" placeholder="‡∏´‡∏°‡∏≠‡∏î‡∏°‡∏¢‡∏≤"></div>
              <div><label style="font-size:12px; color:var(--text-muted);">ü©∫ Nurse</label><input type="text" class="form-control" id="nurs-${a.id}" value="${extraNotes.nurse || ''}" placeholder="‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•"></div>
            </div>
            <button class="btn btn-primary" style="width:100%; margin-bottom:10px;" onclick="saveStaff('${a.id}')">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ Staff</button>
          </div>

          <div>
            <h4 style="font-size:14px; margin-bottom:8px; color:var(--navy);">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ä‡∏µ‡∏û (Vital Signs)</h4>
            <div class="vital-form">
              <input type="time" id="v-time-${a.id}" value="${new Date().toTimeString().substring(0,5)}" title="‡πÄ‡∏ß‡∏•‡∏≤">
              <input type="number" id="v-hr-${a.id}" placeholder="HR">
              <input type="number" id="v-rr-${a.id}" placeholder="RR">
              <input type="number" id="v-temp-${a.id}" placeholder="Temp(F)">
              <input type="number" id="v-spo2-${a.id}" placeholder="SpO2%">
              <input type="text" id="v-zol-${a.id}" placeholder="Zoletil (ml)">
              <input type="text" id="v-note-${a.id}" placeholder="Note" style="min-width:120px;">
              <button class="btn btn-primary" onclick="addVital('${a.id}')">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
            </div>
            
            <div style="max-height:200px; overflow-y:auto; border:1px solid var(--border); border-radius:6px;">
              <table class="vital-table" style="margin:0;">
                <thead style="position:sticky; top:0;"><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>HR</th><th>RR</th><th>Temp</th><th>O2%</th><th>Zoletil</th><th>Note</th></tr></thead>
                <tbody>${vitalRows}</tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="action-bar">
          <button class="btn btn-warning" onclick="openRxModal('${a.id}', '${a.animal_name}')">üíä ‡∏à‡∏±‡∏î‡∏¢‡∏≤ (Prescription)</button>
          <button class="btn btn-success" onclick="finishSurgery('${a.id}')">‡∏¢‡∏Å‡∏•‡∏á‡πÇ‡∏ï‡πä‡∏∞‡πÑ‡∏õ‡∏û‡∏±‡∏Å‡∏ü‡∏∑‡πâ‡∏ô ‚Ä∫</button>
        </div>
      </div>
    `;
  }).join("");
}

// ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠ Staff ‡∏•‡∏á DB (‡πÄ‡∏Å‡πá‡∏ö Asst/Nurse ‡πÉ‡∏ô notes ‡πÄ‡∏õ‡πá‡∏ô JSON)
window.saveStaff = async function(animalId) {
  const surg = document.getElementById(`surg-${animalId}`).value;
  const asst = document.getElementById(`asst-${animalId}`).value;
  const anes = document.getElementById(`anes-${animalId}`).value;
  const nurs = document.getElementById(`nurs-${animalId}`).value;

  const extraNotes = JSON.stringify({ assistant: asst, nurse: nurs });

  const { error } = await supabase.from('vasd_queue').update({
    surgeon_name: surg,
    anesthesiologist_name: anes,
    notes: extraNotes,
    updated_at: new Date()
  }).eq('animal_id', animalId);

  if(error) alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
  else alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ Staff ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
};

// ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Vital Signs
window.addVital = async function(animalId) {
  const timeInput = document.getElementById(`v-time-${animalId}`).value;
  if (!timeInput) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤");

  const { error } = await supabase.from('vasd_vital_signs').insert({
    animal_id: animalId,
    time_recorded: timeInput,
    hr: document.getElementById(`v-hr-${animalId}`).value || null,
    rr: document.getElementById(`v-rr-${animalId}`).value || null,
    temp: document.getElementById(`v-temp-${animalId}`).value || null,
    spo2: document.getElementById(`v-spo2-${animalId}`).value || null,
    zoletil_top: document.getElementById(`v-zol-${animalId}`).value || null,
    note: document.getElementById(`v-note-${animalId}`).value || null
  });

  if (error) alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
  else loadSurgery(); 
};

// ==========================================
// MODAL: ‡∏à‡∏±‡∏î‡∏¢‡∏≤ (Prescription)
// ==========================================
window.openRxModal = function(animalId, animalName) {
  currentRxAnimalId = animalId;
  document.getElementById("rxAnimalName").innerText = `- ${animalName}`;
  
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á Form ‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÜ 3 ‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏û‡∏¥‡∏°‡∏û‡πå‡∏à‡∏±‡∏î‡∏¢‡∏≤ (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á)
  let formHtml = '';
  for(let i=1; i<=3; i++) {
    formHtml += `
      <div style="display:flex; gap:10px; background:#f7fafc; padding:10px; border:1px solid var(--border); border-radius:6px;">
        <input type="text" id="rx-name-${i}" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤" style="flex:2;">
        <input type="text" id="rx-dose-${i}" class="form-control" placeholder="Dose (‡πÄ‡∏ä‡πà‡∏ô 1 ‡πÄ‡∏°‡πá‡∏î)">
        <input type="text" id="rx-freq-${i}" class="form-control" placeholder="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà (‡πÄ‡∏ä‡πà‡∏ô 2 ‡πÄ‡∏ß‡∏•‡∏≤)">
        <input type="number" id="rx-days-${i}" class="form-control" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô" style="width:80px;">
        <input type="number" id="rx-total-${i}" class="form-control" placeholder="‡∏£‡∏ß‡∏°‡πÄ‡∏°‡πá‡∏î" style="width:80px;">
      </div>
    `;
  }
  document.getElementById("rxFormList").innerHTML = formHtml;
  document.getElementById("rxModal").style.display = "flex";
};

window.closeRxModal = function() {
  document.getElementById("rxModal").style.display = "none";
  currentRxAnimalId = null;
};

window.saveRx = async function() {
  const rxInserts = [];
  for(let i=1; i<=3; i++) {
    const name = document.getElementById(`rx-name-${i}`).value;
    if(name.trim() !== '') {
      rxInserts.push({
        animal_id: currentRxAnimalId,
        drug_id: name, // ‡πÉ‡∏ä‡πâ‡∏ä‡πà‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡πÄ‡∏õ‡πá‡∏ô drug_id ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ UI ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
        dose: document.getElementById(`rx-dose-${i}`).value,
        freq: document.getElementById(`rx-freq-${i}`).value,
        days: parseInt(document.getElementById(`rx-days-${i}`).value) || null,
        total_pills: parseFloat(document.getElementById(`rx-total-${i}`).value) || 0
      });
    }
  }

  if(rxInserts.length > 0) {
    const { error } = await supabase.from("vasd_prescription").insert(rxInserts);
    if(error) {
      alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≤‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
      return;
    }
  }
  alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏¢‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏¢‡∏≤‡πÅ‡∏•‡πâ‡∏ß");
  closeRxModal();
};

// ==========================================
// ‡∏¢‡∏Å‡∏•‡∏á‡πÇ‡∏ï‡πä‡∏∞‡πÑ‡∏õ‡∏û‡∏±‡∏Å‡∏ü‡∏∑‡πâ‡∏ô
// ==========================================
window.finishSurgery = async function(animalId) {
  const surgInput = document.getElementById(`surg-${animalId}`).value;
  if(!surgInput || surgInput.trim() === "") {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠ Surgeon ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÑ‡∏õ‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å‡∏ü‡∏∑‡πâ‡∏ô!");
    document.getElementById(`surg-${animalId}`).focus();
    return;
  }

  if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡∏•‡∏á‡πÇ‡∏ï‡πä‡∏∞‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡∏û‡∏±‡∏Å‡∏ü‡∏∑‡πâ‡∏ô (Recovery)?")) return;

  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Staff ‡∏ó‡∏¥‡πâ‡∏á‡∏ó‡∏ß‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡πâ‡∏≤‡∏¢ Status
  await saveStaff(animalId);

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
  const { error } = await supabase
    .from("vasd_queue")
    .update({ status: "recovery", table_number: null, updated_at: new Date() })
    .eq("animal_id", animalId);

  if (error) alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
  else loadData();
};

// Real-time Update
supabase.channel("anesthesia-live")
  .on("postgres_changes", { event: "*", schema: "public", table: "vasd_queue" }, loadData)
  .on("postgres_changes", { event: "*", schema: "public", table: "vasd_vital_signs" }, loadSurgery)
  .subscribe();

init();
</script>
</body>
</html>
