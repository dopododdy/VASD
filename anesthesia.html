<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>à¹‚à¸•à¹Šà¸°à¸§à¸´à¸ªà¸±à¸à¸à¸µ â€“ VASD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOKENS (Match animals.html)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --navy:         #0b1929;
  --navy-mid:     #112240;
  --teal:         #0ea5a0;
  --teal-light:   #14c4bc;
  --teal-glow:    rgba(14,165,160,0.25);
  --amber:        #f59e0b;
  --amber-soft:   rgba(245,158,11,0.14);
  --rose:         #ef4444;
  --rose-soft:    rgba(239,68,68,0.12);

  --surface:      rgba(255,255,255,0.04);
  --surface-2:    rgba(255,255,255,0.07);
  --surface-3:    rgba(255,255,255,0.11);
  --border:       rgba(255,255,255,0.08);
  --border-2:     rgba(255,255,255,0.14);
  --text:         #e2e8f0;
  --text-dim:     #94a3b8;
  --text-faint:   #4a5568;

  --radius-md:    12px;
  --radius-sm:    10px;
  --radius:       16px;
  --radius-lg:    22px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }

body {
  font-family: "Sarabun", sans-serif;
  background: var(--navy);
  color: var(--text);
  min-height: 100vh; min-height: 100dvh;
  display: flex; flex-direction: column;
  overflow-x: hidden;
  padding-bottom: 90px;
}
body::before {
  content: ""; position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background:
    radial-gradient(ellipse 60% 50% at 15% 10%, rgba(14,165,160,0.10) 0%, transparent 70%),
    radial-gradient(ellipse 40% 50% at 85% 80%, rgba(99,102,241,0.07) 0%, transparent 60%);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
header {
  position: sticky; top: 0; z-index: 200;
  background: rgba(11,25,41,0.88);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-bottom: 1px solid var(--border);
  padding: 0 20px; height: 64px;
  display: flex; align-items: center; justify-content: space-between; gap: 12px;
}
.brand { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
.brand-icon { font-size: 22px; }
.brand-name {
  font-family: "Outfit", sans-serif;
  font-size: 16px; font-weight: 700; color: #fff; line-height: 1; letter-spacing: -0.3px;
}
.brand-sub { font-size: 10px; color: var(--text-dim); margin-top: 2px; }

.btn-home {
  padding: 8px 14px; font-size: 12px; font-weight: 600; font-family: "Sarabun", sans-serif;
  background: var(--surface-2); color: var(--text-dim);
  border: 1px solid var(--border-2); border-radius: var(--radius-sm); cursor: pointer;
  display: flex; align-items: center; gap: 5px;
  transition: background 0.2s, color 0.2s;
}
.btn-home:hover { background: var(--surface-3); color: var(--text); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WRAP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.wrap {
  position: relative; z-index: 1;
  max-width: 800px; margin: 0 auto;
  padding: 24px 16px 40px;
  width: 100%;
}
.section-title {
  font-size: 10px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase;
  color: var(--text-faint); margin-bottom: 14px;
  display: flex; align-items: center; gap: 8px;
}
.section-title::after { content: ""; flex: 1; height: 1px; background: var(--border); }
.section-count {
  font-size: 10px; font-weight: 600; color: var(--text-dim);
  background: var(--surface-2); border: 1px solid var(--border-2);
  border-radius: 20px; padding: 2px 10px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ANIMAL CARDS (Expandable Style)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#anesthesiaList { display: flex; flex-direction: column; gap: 10px; }

.animal-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  animation: slideUp 0.35s ease both;
  transition: border-color 0.2s;
}
.animal-card::before { content: ""; display: block; height: 3px; width: 100%; background: #64748b; }

.card-top {
  display: flex; align-items: center; gap: 10px;
  padding: 12px 14px 10px;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}
.queue-badge {
  font-family: "Outfit", sans-serif; font-size: 14px; font-weight: 800;
  min-width: 38px; height: 38px; border-radius: 50%;
  background: var(--surface-2); border: 1px solid var(--border-2);
  display: flex; align-items: center; justify-content: center;
  color: var(--teal-light); flex-shrink: 0;
}
.card-info { flex: 1; min-width: 0; }
.animal-name {
  font-size: 15px; font-weight: 700; color: #fff;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  display: flex; align-items: center;
}
.animal-meta { font-size: 12px; color: var(--text-dim); margin-top: 2px; }

.status-pill {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 4px 10px; border-radius: 20px;
  font-size: 11px; font-weight: 600; flex-shrink: 0;
  background: rgba(100,116,139,0.2); color: #94a3b8; border: 1px solid rgba(100,116,139,0.3);
}

.expand-icon { font-size: 16px; color: var(--text-dim); transition: transform 0.25s; flex-shrink: 0; }
.animal-card.open .expand-icon { transform: rotate(180deg); }

/* â”€â”€ Expandable Detail â”€â”€ */
.card-detail {
  max-height: 0; overflow: hidden;
  transition: max-height 0.4s cubic-bezier(0.4,0,0.2,1);
  border-top: 0px solid var(--border);
}
.animal-card.open .card-detail { max-height: 1200px; border-top: 1px solid var(--border); }
.detail-body { padding: 18px 14px; }

/* â”€â”€ Content inside detail â”€â”€ */
.svc-chip {
  background: var(--surface-3); border: 1px solid var(--border-2);
  border-radius: 50px; padding: 4px 12px; font-size: 12px; font-weight: 500; color: var(--text);
}
.health-note {
  display: flex; align-items: flex-start; gap: 10px;
  background: var(--rose-soft); border: 1px solid rgba(239,68,68,0.2);
  border-radius: var(--radius-sm); padding: 12px 14px;
  margin-bottom: 16px; color: var(--rose);
}

/* â”€â”€ Anesthesia specific â”€â”€ */
.est-weight-strip {
  background: var(--amber-soft); border-radius: var(--radius-sm);
  padding: 12px 14px; display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 16px;
}
.est-label { font-size: 12px; color: var(--amber); font-weight: 600; }
.est-val { font-size: 15px; font-weight: 700; color: var(--amber); }

.input-label { display: block; font-size: 12px; font-weight: 600; color: var(--slate-400); margin-bottom: 8px; text-transform: uppercase; }
.weight-input {
  width: 100%; background: var(--surface-2); border: 1px solid var(--border-2);
  border-radius: var(--radius-md); padding: 14px 16px; color: var(--white);
  font-size: 20px; font-weight: 800; transition: all 0.2s; margin-bottom: 20px;
}
.weight-input:focus { border-color: var(--teal); outline: none; box-shadow: 0 0 0 3px var(--teal-glow); }

.drug-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
.drug-table th { text-align: left; font-size: 11px; text-transform: uppercase; color: var(--text-faint); padding: 8px 4px; border-bottom: 1px solid var(--border-2); }
.drug-table td { padding: 12px 4px; font-size: 14px; border-bottom: 1px solid var(--border); }
.drug-name { font-weight: 700; color: var(--text); }
.drug-calc { font-weight: 800; color: var(--teal-light); text-align: right; font-size: 16px; }

.btn-primary {
  width: 100%; background: linear-gradient(135deg, var(--teal), var(--teal-light)); color: var(--navy); border: none;
  padding: 14px; border-radius: var(--radius-md); font-size: 15px; font-weight: 800;
  display: flex; align-items: center; justify-content: center; gap: 8px;
  cursor: pointer; transition: transform 0.1s, box-shadow 0.2s;
}
.btn-primary:active { transform: scale(0.97); }

.empty-state { text-align: center; padding: 60px 16px; color: var(--text-faint); animation: slideUp 0.4s ease both; }
.empty-state-icon { font-size: 48px; margin-bottom: 14px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOADING & NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#loading-overlay {
  position: fixed; inset: 0; background: var(--navy); z-index: 1000;
  display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px;
}
.spinner { width: 40px; height: 40px; border: 4px solid rgba(14,165,160,0.1); border-top-color: var(--teal); border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

.bottom-nav {
  display: none; position: fixed; bottom: 0; left: 0; right: 0; z-index: 300;
  background: rgba(11,25,41,0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  border-top: 1px solid var(--border-2); padding: 8px 0 max(8px, env(safe-area-inset-bottom));
  grid-template-columns: repeat(5, 1fr);
}
.nav-item {
  display: flex; flex-direction: column; align-items: center; gap: 3px; padding: 6px 4px;
  font-size: 9px; color: var(--text-dim); text-decoration: none; transition: color 0.2s; -webkit-tap-highlight-color: transparent;
}
.nav-icon { font-size: 21px; line-height: 1; }
.nav-item.active { color: var(--teal); }
.nav-item.active .nav-icon { filter: drop-shadow(0 0 6px var(--teal)); }

@keyframes slideUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }

@media (max-width: 640px) {
  header { height: 56px; padding: 0 14px; }
  .brand-sub { display: none; }
  .wrap { padding: 18px 12px 90px; }
  .bottom-nav { display: grid; }
}
</style>
</head>
<body>

<div id="loading-overlay">
  <div class="spinner"></div>
  <div style="font-weight:600; color:var(--teal-light)">à¸à¸³à¸¥à¸±à¸‡à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸„à¸´à¸§à¸§à¸²à¸‡à¸¢à¸²...</div>
</div>

<header>
  <div class="brand">
    <div class="brand-icon">ğŸ’‰</div>
    <div>
      <div class="brand-name">à¹‚à¸•à¹Šà¸°à¸§à¸´à¸ªà¸±à¸à¸à¸µ</div>
      <div class="brand-sub">RMUTTO â€“ Veterinary Academic Service Division</div>
    </div>
  </div>
  <button class="btn-home" onclick="location.href='index.html'">ğŸ  à¸«à¸™à¹‰à¸²à¸«à¸¥à¸±à¸</button>
</header>

<div class="wrap">
  <div class="section-title">
    à¹à¸•à¸°à¸—à¸µà¹ˆà¸£à¸²à¸¢à¸à¸²à¸£à¹€à¸à¸·à¹ˆà¸­à¸„à¸³à¸™à¸§à¸“à¸¢à¸²à¹à¸¥à¸°à¸ªà¹ˆà¸‡à¸œà¹ˆà¸²à¸•à¸±à¸”
    <span class="section-count" id="countBadge">0 à¸„à¸´à¸§</span>
  </div>

  <div id="anesthesiaList">
    </div>
</div>

<nav class="bottom-nav">
  <a class="nav-item" href="index.html"><span class="nav-icon">ğŸ </span>à¸«à¸™à¹‰à¸²à¸«à¸¥à¸±à¸</a>
  <a class="nav-item" href="animals.html"><span class="nav-icon">ğŸ¾</span>à¸ªà¸±à¸•à¸§à¹Œ</a>
  <a class="nav-item active" href="anesthesia.html"><span class="nav-icon">ğŸ’‰</span>à¸§à¸²à¸‡à¸¢à¸²</a>
  <a class="nav-item" href="surgery.html"><span class="nav-icon">ğŸ“‹</span>à¸œà¹ˆà¸²à¸•à¸±à¸”</a>
  <a class="nav-item" href="recovery.html"><span class="nav-icon">â¤ï¸â€ğŸ©¹</span>à¸à¸±à¸à¸Ÿà¸·à¹‰à¸™</a>
</nav>

<script type="module">
import { supabase } from './js/supabase.js';

const listContainer = document.getElementById("anesthesiaList");
const loading = document.getElementById("loading-overlay");

async function loadAnesthesiaQueue() {
  try {
    const { data: queueData, error } = await supabase
      .from("vasd_queue")
      .select(`
        id, animal_id, status,
        vasd_animal(
          id, queue_number, animal_name, species, sex, est_weight, actual_weight,
          health_note,
          vasd_owner(owner_name),
          vasd_service(service_type)
        )
      `)
      .eq("status", "waiting")
      .order("created_at", { ascending: true });

    if (error) throw error;
    loading.style.display = "none";

    document.getElementById("countBadge").textContent = `${queueData ? queueData.length : 0} à¸„à¸´à¸§`;

    if (!queueData || queueData.length === 0) {
      listContainer.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">âœ…</div>
          <div>à¹„à¸¡à¹ˆà¸¡à¸µà¸„à¸´à¸§à¸£à¸­à¸§à¸²à¸‡à¸¢à¸²à¹ƒà¸™à¸‚à¸“à¸°à¸™à¸µà¹‰</div>
        </div>
      `;
      return;
    }

    // à¹€à¸à¹‡à¸šà¸ªà¸–à¸²à¸™à¸°à¸à¸²à¸£à¹€à¸›à¸´à¸”/à¸›à¸´à¸”à¸‚à¸­à¸‡à¸à¸²à¸£à¹Œà¸”à¹„à¸§à¹‰à¸à¹ˆà¸­à¸™ Render à¹ƒà¸«à¸¡à¹ˆ
    const openIds = new Set([...listContainer.querySelectorAll(".animal-card.open")].map(el => el.dataset.id));

    listContainer.innerHTML = "";
    queueData.forEach((q, idx) => {
      const a = q.vasd_animal;
      const animalId = a.id;
      
      const speciesName = a.species === "à¸¡" ? "à¹à¸¡à¸§" : a.species === "à¸ª" ? "à¸ªà¸¸à¸™à¸±à¸‚" : "à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸";
      const sexName = a.sex === "à¸œà¸¹à¹‰" ? "à¹€à¸à¸¨à¸œà¸¹à¹‰" : a.sex === "à¹€à¸¡à¸µà¸¢" ? "à¹€à¸à¸¨à¹€à¸¡à¸µà¸¢" : (a.sex || "-");
      
      // à¸à¸²à¸£à¸ˆà¸±à¸”à¸à¸²à¸£à¸šà¸£à¸´à¸à¸²à¸£ (Services) à¹à¸šà¸š Array
      const services = a.vasd_service && a.vasd_service.length > 0
        ? a.vasd_service.map(srv => `<span class="svc-chip">${srv.service_type}</span>`).join("")
        : `<span style="font-size:11px; color:var(--text-faint);">à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸£à¸°à¸šà¸¸</span>`;

      // à¸à¸²à¸£à¸ˆà¸±à¸”à¸à¸²à¸£à¸‚à¹‰à¸­à¸„à¸§à¸£à¸£à¸°à¸§à¸±à¸‡
      const note = a.health_note ? a.health_note.trim() : "";
      const hasNote = note.length > 0;
      const noteMarkup = hasNote 
        ? `<div class="health-note">
             <span style="font-size:18px;">âš ï¸</span>
             <div>
               <div style="font-size:10px; font-weight:800; text-transform:uppercase; opacity:0.8;">à¸£à¸°à¸§à¸±à¸‡à¸à¸´à¹€à¸¨à¸© / à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸¸à¸‚à¸ à¸²à¸</div>
               <div style="font-weight:700;">${note}</div>
             </div>
           </div>`
        : "";

      const initialWeight = a.actual_weight || a.est_weight || "";

      // à¸£à¸²à¸¢à¸à¸²à¸£à¸¢à¸² (à¹à¸¢à¸à¸«à¸¡à¸²à¹à¸¡à¸§)
      let drugRows = `
        <tr>
          <td><span class="drug-name">Adrenaline (1:10,000)</span><br><small>Dose 0.01 mg/kg (0.1mg/ml)</small></td>
          <td class="drug-calc" id="calc-adre-${animalId}">-</td>
        </tr>
        <tr>
          <td><span class="drug-name">Atropine</span><br><small>0.04 mg/kg (1mg/ml)</small></td>
          <td class="drug-calc" id="calc-atro-${animalId}">-</td>
        </tr>
        <tr>
          <td><span class="drug-name">Xylazine</span><br><small>1 mg/kg (20mg/ml)</small></td>
          <td class="drug-calc" id="calc-xyla-${animalId}">-</td>
        </tr>
        <tr>
          <td><span class="drug-name">Zoletil</span><br><small>3 mg/kg (100mg/ml)</small></td>
          <td class="drug-calc" id="calc-zole-${animalId}">-</td>
        </tr>
      `;

      if (a.species === "à¸ª") {
        drugRows += `
        <tr>
          <td><span class="drug-name">Thiopental</span><br><small>5 mg/kg (10mg/ml)</small></td>
          <td class="drug-calc" id="calc-thio-${animalId}">-</td>
        </tr>`;
      }

      // à¸ªà¸£à¹‰à¸²à¸‡ Card
      const card = document.createElement("div");
      card.className = "animal-card";
      card.dataset.id = animalId;
      card.style.animationDelay = `${idx * 0.03}s`;

      card.innerHTML = `
        <div class="card-top" onclick="window.toggleCard(this)">
          <div class="queue-badge">#${a.queue_number || '??'}</div>
          <div class="card-info">
            <div class="animal-name">${a.animal_name} ${hasNote ? '<span title="à¸¡à¸µà¸‚à¹‰à¸­à¸„à¸§à¸£à¸£à¸°à¸§à¸±à¸‡" style="font-size:14px; margin-left:6px;">âš ï¸</span>' : ''}</div>
            <div class="animal-meta">${a.species === 'à¸¡' ? 'ğŸ±' : 'ğŸ¶'} ${speciesName} Â· ${sexName}</div>
          </div>
          <span class="status-pill">âšª à¸£à¸­à¸§à¸²à¸‡à¸¢à¸²</span>
          <span class="expand-icon">âŒ„</span>
        </div>

        <div class="card-detail">
          <div class="detail-body">
            
            <div style="margin-bottom: 16px;">
              <div style="font-size:10px; font-weight:700; color:var(--text-faint); text-transform:uppercase; margin-bottom:6px;">à¸šà¸£à¸´à¸à¸²à¸£à¸—à¸µà¹ˆà¹€à¸‚à¹‰à¸²à¸£à¸±à¸š</div>
              <div style="display:flex; flex-wrap:wrap; gap:6px;">
                ${services}
              </div>
            </div>

            ${noteMarkup}

            <div class="est-weight-strip">
              <span class="est-label">à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¸›à¸£à¸°à¹€à¸¡à¸´à¸™à¸ˆà¸²à¸à¹‚à¸•à¹Šà¸°à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™</span>
              <span class="est-val">${a.est_weight ? a.est_weight + ' kg' : 'à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸›à¸£à¸°à¹€à¸¡à¸´à¸™'}</span>
            </div>

            <label class="input-label">à¸£à¸°à¸šà¸¸à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¸ˆà¸£à¸´à¸‡ (Actual Weight - kg)</label>
            <input type="number" step="0.01" class="weight-input" 
              id="weight-${animalId}" 
              placeholder="0.00"
              value="${initialWeight}"
              oninput="window.calcDrugs('${animalId}')"
              onclick="event.stopPropagation()"> <table class="drug-table">
              <thead><tr><th>à¸£à¸²à¸¢à¸à¸²à¸£à¸¢à¸² (Drug List)</th><th style="text-align:right">à¸›à¸£à¸´à¸¡à¸²à¸“ (Dose)</th></tr></thead>
              <tbody>${drugRows}</tbody>
            </table>

            <button class="btn-primary" onclick="window.sendToSurgery('${animalId}')">
              <span>à¸šà¸±à¸™à¸—à¸¶à¸à¹à¸¥à¸°à¸ªà¹ˆà¸‡à¹€à¸‚à¹‰à¸²à¹‚à¸•à¹Šà¸°à¸œà¹ˆà¸²à¸•à¸±à¸”</span>
              <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M5 12h14m-7-7l7 7-7 7"></path></svg>
            </button>
            
          </div>
        </div>
      `;

      // à¸„à¸·à¸™à¸„à¹ˆà¸²à¸à¸²à¸£à¸‚à¸¢à¸²à¸¢ (Open) à¸‚à¸­à¸‡à¸à¸²à¸£à¹Œà¸”à¹€à¸”à¸´à¸¡
      if (openIds.has(animalId)) card.classList.add("open");
      
      listContainer.appendChild(card);
      if(initialWeight) window.calcDrugs(animalId);
    });

  } catch (err) {
    console.error(err);
    loading.style.display = "none";
    listContainer.innerHTML = `<div style="padding:20px; color:var(--rose);">à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”: ${err.message}</div>`;
  }
}

/* â”€â”€ UI Toggles â”€â”€ */
window.toggleCard = function(el) {
  el.closest('.animal-card').classList.toggle('open');
};

/* â”€â”€ Logic â”€â”€ */
window.calcDrugs = function(animalId) {
  const inputEl = document.getElementById(`weight-${animalId}`);
  if(!inputEl) return;
  
  const w = parseFloat(inputEl.value);
  const setV = (id, val) => {
    const el = document.getElementById(id);
    if(el) {
      el.innerText = val ? val + " ml" : "-";
      el.style.color = val ? "var(--teal-light)" : "var(--slate-400)";
    }
  };

  if (!w || w <= 0) {
    ["calc-adre-", "calc-atro-", "calc-xyla-", "calc-zole-", "calc-thio-"].forEach(p => setV(p + animalId, null));
    return;
  }

  setV(`calc-adre-${animalId}`, ((w * 0.01) / 0.1).toFixed(2));
  setV(`calc-atro-${animalId}`, ((w * 0.04) / 1).toFixed(2));
  setV(`calc-xyla-${animalId}`, ((w * 1) / 20).toFixed(2));
  setV(`calc-zole-${animalId}`, ((w * 3) / 100).toFixed(2));
  setV(`calc-thio-${animalId}`, ((w * 5) / 10).toFixed(2)); 
};

window.sendToSurgery = async function(animalId) {
  const weight = document.getElementById(`weight-${animalId}`).value;
  if (!weight) return alert("à¸à¸£à¸¸à¸“à¸²à¸£à¸°à¸šà¸¸à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¸ˆà¸£à¸´à¸‡à¸à¹ˆà¸­à¸™à¸ªà¹ˆà¸‡à¸„à¸´à¸§");
  
  if (!confirm("à¸¢à¸·à¸™à¸¢à¸±à¸™à¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¹à¸¥à¸°à¸ªà¹ˆà¸‡à¸ªà¸±à¸•à¸§à¹Œà¹€à¸‚à¹‰à¸²à¹‚à¸•à¹Šà¸°à¸œà¹ˆà¸²à¸•à¸±à¸”?")) return;

  try {
    await supabase.from("vasd_animal").update({ actual_weight: parseFloat(weight) }).eq("id", animalId);
    const { error } = await supabase.from("vasd_queue").update({ status: "surgery", updated_at: new Date() }).eq("animal_id", animalId);
    if (error) throw error;
    loadAnesthesiaQueue();
  } catch (err) {
    alert("Error: " + err.message);
  }
};

loadAnesthesiaQueue();

supabase.channel('anes-live')
  .on('postgres_changes', { event: '*', schema: 'public', table: 'vasd_queue' }, loadAnesthesiaQueue)
  .subscribe();
</script>
   <script type="module" src="./js/global-alarm.js"></script>
</body>
</html>
