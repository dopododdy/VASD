<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>RMUTTO - VASD | ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î (Anesthesia & Surgery)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&family=Prompt:wght@300;400;500;700&family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>
:root {
  --navy:#0d1b2a; --teal:#1a6b72; --teal-light:#22919a; --accent:#00d4aa;
  --bg:#f0f4f8; --surface:#fff; --text:#1a202c; --text-muted:#718096;
  --border:#e2e8f0; --danger:#e53e3e; --success:#38a169; --warning:#d69e2e;
  --shadow-sm:0 1px 3px rgba(0,0,0,0.06); --shadow-md:0 4px 16px rgba(13,27,42,0.08);
  --radius:14px; --radius-sm:8px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{font-family:"Sarabun",sans-serif;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;}

/* HEADER */
header{
  background:var(--navy);padding:0 32px;display:flex;
  justify-content:space-between;align-items:center;height:68px;
  position:sticky;top:0;z-index:100;box-shadow:0 2px 20px rgba(0,0,0,0.25);flex-shrink:0;
}
.header-brand{display:flex;align-items:center;gap:14px;}
.brand-icon{
  width:40px;height:40px;background:linear-gradient(135deg,var(--teal-light),var(--accent));
  border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;
}
.brand-text h1{font-size:17px;font-weight:700;color:#fff;line-height:1.2;}
.brand-text span{font-size:11px;color:rgba(255,255,255,0.5);}

.btn-home{
  padding:8px 18px;font-size:13px;font-weight:600;font-family:"Sarabun",sans-serif;
  background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.9);
  border:1px solid rgba(255,255,255,0.2);border-radius:var(--radius-sm);
  cursor:pointer;transition:background 0.2s;
}
.btn-home:hover{background:rgba(255,255,255,0.18);}

/* MAIN LAYOUT */
.layout { display:flex; flex:1; overflow:hidden; }

/* SIDEBAR QUEUE */
.sidebar {
  width: 320px; background:var(--surface); border-right:1px solid var(--border);
  display:flex; flex-direction:column; overflow:hidden;
}
.sidebar-header { padding:16px; border-bottom:1px solid var(--border); background:#fafbfc; }
.sidebar-header h3 { font-size:15px; color:var(--navy); }
.queue-list { flex:1; overflow-y:auto; padding:16px; display:flex; flex-direction:column; gap:10px; }
.queue-card {
  background:#fff; border:1px solid var(--border); border-radius:var(--radius-sm);
  padding:12px; box-shadow:var(--shadow-sm); cursor:pointer; transition:all 0.2s;
}
.queue-card:hover { border-color:var(--teal-light); transform:translateY(-1px); }
.q-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; }
.q-num { font-size:12px; font-weight:700; background:var(--navy); color:#fff; padding:2px 8px; border-radius:20px; }
.q-name { font-size:15px; font-weight:700; color:var(--text); }
.q-info { font-size:13px; color:var(--text-muted); }

/* MAIN CONTENT (SURGERY TABLES) */
.main-content { flex:1; overflow-y:auto; padding:24px; background:var(--bg); }
.tables-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(550px, 1fr)); gap:20px; }

/* TABLE CARD */
.table-card {
  background:var(--surface); border-radius:var(--radius); border:1px solid var(--border);
  box-shadow:var(--shadow-sm); overflow:hidden; animation:fadeUp 0.3s ease both;
  display:flex; flex-direction:column;
}
.tc-header {
  padding:16px 20px; background:#e6fffa; border-bottom:1px solid var(--border);
  display:flex; justify-content:space-between; align-items:center;
}
.tc-title { font-size:16px; font-weight:700; color:var(--teal); display:flex; align-items:center; gap:8px;}
.tc-body { padding:20px; flex:1; }

.info-box { background:#f7fafc; padding:12px; border-radius:var(--radius-sm); margin-bottom:16px; font-size:14px; }
.info-box strong { color:var(--navy); }

/* VITAL SIGNS */
.vital-table { width:100%; border-collapse:collapse; margin-bottom:12px; font-size:12px; }
.vital-table th { background:var(--bg); padding:8px; border:1px solid var(--border); text-align:left; color:var(--text-muted); }
.vital-table td { padding:8px; border:1px solid var(--border); text-align:center; }

.vital-form { display:flex; gap:6px; flex-wrap:wrap; background:var(--bg); padding:10px; border-radius:var(--radius-sm); margin-bottom:20px; }
.vital-form input {
  flex:1; min-width:60px; padding:6px 8px; font-size:12px; font-family:"Sarabun",sans-serif;
  border:1px solid var(--border); border-radius:4px; outline:none;
}
.vital-form input:focus { border-color:var(--teal); }
.btn-primary { background:var(--teal); color:#fff; border:none; border-radius:4px; padding:6px 12px; font-size:12px; font-weight:600; cursor:pointer; }
.btn-primary:hover { background:var(--teal-light); }

/* RX GRID */
.rx-section { border-top:1px solid var(--border); padding-top:16px; }
.rx-title { font-size:14px; font-weight:700; margin-bottom:10px; color:var(--navy); }
.rx-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.rx-item {
  border:1px solid var(--border); padding:10px; border-radius:var(--radius-sm);
  display:flex; flex-direction:column; gap:6px; transition:all 0.2s; background:#fff;
}
.rx-item.selected { border-color:var(--teal); background:#ebf8f6; }
.rx-head { display:flex; gap:8px; align-items:flex-start; font-size:13px; font-weight:600; cursor:pointer; }
.rx-inputs { display:none; flex-direction:column; gap:6px; margin-top:6px; padding-top:6px; border-top:1px dashed #cbd5e0; }
.rx-inputs input { width:100%; padding:4px 8px; font-size:12px; font-family:"Sarabun",sans-serif; border:1px solid var(--border); border-radius:4px; }

/* FOOTER ACTIONS */
.tc-footer { padding:16px 20px; border-top:1px solid var(--border); background:#fafbfc; display:flex; justify-content:space-between; }
.btn-cancel { background:#e2e8f0; color:var(--text); border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-weight:600; font-family:"Sarabun"; }
.btn-cancel:hover { background:var(--danger); color:#fff; }
.btn-finish { background:var(--success); color:#fff; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-weight:600; font-family:"Sarabun"; }
.btn-finish:hover { opacity:0.85; }

@keyframes fadeUp{from{opacity:0;transform:translateY(14px);}to{opacity:1;transform:translateY(0);}}
</style>
</head>
<body>

<header>
  <div class="header-brand">
    <div class="brand-icon">ü©∫</div>
    <div class="brand-text">
      <h1>‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î (Anesthesia & Surgery)</h1>
      <span>RMUTTO ‚Äì Veterinary Academic Service Division</span>
    </div>
  </div>
  <button class="btn-home" onclick="location.href='index.html'">üè† ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
</header>

<div class="layout">
  
  <div class="sidebar">
    <div class="sidebar-header">
      <h3>üìã ‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î / ‡∏ß‡∏≤‡∏á‡∏¢‡∏≤</h3>
    </div>
    <div class="queue-list" id="queueList">
      <p style="color:var(--text-muted); font-size:13px; text-align:center;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏¥‡∏ß...</p>
    </div>
  </div>

  <div class="main-content">
    <div class="tables-grid" id="tablesGrid">
      <p style="color:var(--text-muted); font-size:14px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏ï‡πä‡∏∞‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î...</p>
    </div>
  </div>

</div>

<script type="module">
import { supabase } from "./js/supabase.js";

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏°‡πá‡∏î‡∏¢‡∏≤
function roundToQuarter(val) { return Math.ceil(val * 4) / 4; }

let currentEventId = null;

async function init() {
  const { data: eventId } = await supabase.rpc("get_today_event");
  currentEventId = eventId;
  loadData();
}

async function loadData() {
  await loadQueue();
  await loadTables();
}

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠ (waiting)
async function loadQueue() {
  const { data, error } = await supabase
    .from("vasd_queue")
    .select(`
      id, animal_id, status,
      vasd_animal!inner(id, event_id, queue_number, animal_name, species, sex, actual_weight)
    `)
    .eq("vasd_animal.event_id", currentEventId)
    .eq("status", "waiting")
    .order("created_at");

  const list = document.getElementById("queueList");
  if (error || !data || data.length === 0) {
    list.innerHTML = `<div style="text-align:center; padding:20px; color:var(--text-muted); font-size:13px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î</div>`;
    return;
  }

  list.innerHTML = data.map(q => {
    const a = q.vasd_animal;
    const w = a.actual_weight || 0;
    return `
      <div class="queue-card" onclick="moveToTable('${q.animal_id}')">
        <div class="q-head">
          <span class="q-num">‡∏Ñ‡∏¥‡∏ß ${a.queue_number}</span>
          <span class="q-name">${a.animal_name}</span>
        </div>
        <div class="q-info">
          ${a.species === '‡∏™' ? '‡∏™‡∏∏‡∏ô‡∏±‡∏Ç' : '‡πÅ‡∏°‡∏ß'} | ‡πÄ‡∏û‡∏®: ${a.sex} | ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å: ${w} ‡∏Å‡∏Å.
        </div>
        <div style="margin-top:8px; text-align:right;">
          <button class="btn-primary" style="font-size:11px; padding:4px 10px;">‡∏ô‡∏≥‡∏Ç‡∏∂‡πâ‡∏ô‡πÇ‡∏ï‡πä‡∏∞‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î ‚Ä∫</button>
        </div>
      </div>
    `;
  }).join("");
}

// ‡∏¢‡πâ‡∏≤‡∏¢‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡πÇ‡∏ï‡πä‡∏∞‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î
window.moveToTable = async function(animalId) {
  const tableNum = prompt("‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î (‡πÄ‡∏ä‡πà‡∏ô 1, 2, 3):", "1");
  if (!tableNum) return;

  const { error } = await supabase
    .from("vasd_queue")
    .update({ status: "surgery", table_number: parseInt(tableNum), updated_at: new Date() })
    .eq("animal_id", animalId);

  if (!error) loadData();
};

// ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Checkbox
window.toggleRx = function(chk, animalId, drugId) {
  const item = document.getElementById(`rx-item-${animalId}-${drugId}`);
  const inputs = document.getElementById(`rx-inputs-${animalId}-${drugId}`);
  if(chk.checked) {
    item.classList.add("selected");
    inputs.style.display = "flex";
  } else {
    item.classList.remove("selected");
    inputs.style.display = "none";
  }
};

window.recalcTotal = function(animalId, did) {
  const dose = parseFloat((document.getElementById(`rx-dose-${animalId}-${did}`).value.match(/[\d.]+/) || [0])[0]);
  const freq = parseFloat((document.getElementById(`rx-freq-${animalId}-${did}`).value.match(/[\d.]+/) || [0])[0]);
  const days = parseFloat(document.getElementById(`rx-days-${animalId}-${did}`).value) || 0;
  document.getElementById(`rx-total-${animalId}-${did}`).value = dose * freq * days;
};

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏ï‡πä‡∏∞‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î (surgery)
async function loadTables() {
  const { data, error } = await supabase
    .from("vasd_queue")
    .select(`
      id, animal_id, status, table_number, surgeon_name, anesthesiologist_name,
      vasd_animal!inner(id, event_id, queue_number, animal_name, species, sex, actual_weight),
      vasd_vital_signs(*)
    `)
    .eq("vasd_animal.event_id", currentEventId)
    .eq("status", "surgery")
    .order("table_number");

  const grid = document.getElementById("tablesGrid");
  if (error || !data || data.length === 0) {
    grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:40px; color:var(--text-muted);">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î</div>`;
    return;
  }

  grid.innerHTML = "";

  data.forEach(q => {
    const a = q.vasd_animal;
    const w = parseFloat(a.actual_weight) || 0;

    // ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á Vital Signs
    const vitals = (q.vasd_vital_signs || []).sort((x, y) => {
        const t1 = x.time_recorded || x.created_at || "";
        const t2 = y.time_recorded || y.created_at || "";
        return t1.localeCompare(t2);
    });

    let vitalRows = vitals.map(v => {
      let timeStr = v.time_recorded ? v.time_recorded.substring(0,5) : (v.created_at ? new Date(v.created_at).toLocaleTimeString("th-TH").substring(0,5) : '-');
      return `
        <tr>
          <td>${timeStr}</td>
          <td>${v.hr || '-'}</td>
          <td>${v.rr || '-'}</td>
          <td>${v.temp || v.bt || '-'}</td>
          <td>${v.spo2 ? v.spo2+'%' : '-'}</td>
          <td>${v.zoletil_top || '-'}</td>
        </tr>
      `;
    }).join("");

    if(vitals.length === 0) vitalRows = `<tr><td colspan="6" style="text-align:center; color:#aaa;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</td></tr>`;

    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤ Rx
    const drugs = [
      {id:"dox",    name:"‡∏õ‡∏è‡∏¥‡∏ä‡∏µ‡∏ß‡∏ô‡∏∞ Doxycycline 100 mg", tabs: roundToQuarter((w*10)/100)||0.25, freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á", f:1, days:14},
      {id:"nor200", name:"‡∏õ‡∏è‡∏¥‡∏ä‡∏µ‡∏ß‡∏ô‡∏∞ Norfloxacin 200 mg", tabs: roundToQuarter((w*10)/200)||0.25, freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á", f:2, days:7},
      {id:"tolf60", name:"‡πÅ‡∏Å‡πâ‡∏õ‡∏ß‡∏î Tolfedine 60 mg",      tabs: roundToQuarter((w*4)/60)||0.25,   freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á", f:1, days:3}
    ];

    let rxHtml = drugs.map(d => `
      <div class="rx-item" id="rx-item-${a.id}-${d.id}">
        <label class="rx-head">
          <input type="checkbox" id="rx-chk-${a.id}-${d.id}" data-name="${d.name}" onchange="toggleRx(this, '${a.id}', '${d.id}')">
          <span>${d.name}</span>
        </label>
        <div class="rx-inputs" id="rx-inputs-${a.id}-${d.id}">
          <input type="text" id="rx-dose-${a.id}-${d.id}" value="‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡∏∞ ${d.tabs} ‡πÄ‡∏°‡πá‡∏î" oninput="recalcTotal('${a.id}','${d.id}')">
          <input type="text" id="rx-freq-${a.id}-${d.id}" value="${d.freq}" oninput="recalcTotal('${a.id}','${d.id}')">
          <div style="display:flex; gap:6px;">
            <input type="number" id="rx-days-${a.id}-${d.id}" value="${d.days}" title="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô" style="width:50%;" oninput="recalcTotal('${a.id}','${d.id}')">
            <input type="number" step="0.25" id="rx-total-${a.id}-${d.id}" value="${d.tabs * d.f * d.days}" title="‡∏£‡∏ß‡∏°‡πÄ‡∏°‡πá‡∏î" style="width:50%; font-weight:bold; color:var(--danger);" readonly>
          </div>
        </div>
      </div>
    `).join("");

    const card = document.createElement("div");
    card.className = "table-card";
    card.innerHTML = `
      <div class="tc-header">
        <div class="tc-title">‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà ${q.table_number || '-'}</div>
        <div style="font-size:13px; font-weight:600; background:rgba(26,107,114,0.1); color:var(--teal); padding:4px 10px; border-radius:20px;">‡∏Ñ‡∏¥‡∏ß ${a.queue_number}</div>
      </div>
      
      <div class="tc-body">
        <div class="info-box">
          <strong>${a.animal_name}</strong> (${a.species === '‡∏™' ? '‡∏™‡∏∏‡∏ô‡∏±‡∏Ç' : '‡πÅ‡∏°‡∏ß'}) | ‡πÄ‡∏û‡∏®: ${a.sex} | ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏à‡∏£‡∏¥‡∏á: ${w} ‡∏Å‡∏Å.
        </div>

        <h4 style="font-size:13px; margin-bottom:8px; color:var(--text-muted);">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ä‡∏µ‡∏û (Vital Signs)</h4>
        <table class="vital-table">
          <thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>HR</th><th>RR</th><th>Temp</th><th>SpO2</th><th>Top-up</th></tr></thead>
          <tbody>${vitalRows}</tbody>
        </table>
        
        <div class="vital-form">
          <input type="time" id="v-time-${a.id}" value="${new Date().toTimeString().substring(0,5)}" title="‡πÄ‡∏ß‡∏•‡∏≤">
          <input type="number" id="v-hr-${a.id}" placeholder="HR">
          <input type="number" id="v-rr-${a.id}" placeholder="RR">
          <input type="number" id="v-temp-${a.id}" placeholder="Temp">
          <input type="number" id="v-spo2-${a.id}" placeholder="SpO2%">
          <input type="text" id="v-top-${a.id}" placeholder="Zoletil Top">
          <button class="btn-primary" onclick="addVital('${a.id}')">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
        </div>

        <div class="rx-section">
          <div class="rx-title">üíä ‡∏™‡∏±‡πà‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤ (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å ${w} ‡∏Å‡∏Å.)</div>
          <div class="rx-grid">${rxHtml}</div>
        </div>
      </div>

      <div class="tc-footer">
        <button class="btn-cancel" onclick="cancelSurgery('${a.id}')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡∏¥‡∏ß)</button>
        <button class="btn-finish" onclick="finishSurgery('${a.id}')">‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô (‡∏™‡πà‡∏á‡∏û‡∏±‡∏Å‡∏ü‡∏∑‡πâ‡∏ô) ‚Ä∫</button>
      </div>
    `;
    grid.appendChild(card);
  });
}

// ---------------------------------------------
// ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Vital Signs ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ Temp ‡πÅ‡∏•‡∏∞ Time_recorded 
// ---------------------------------------------
window.addVital = async function(animalId) {
  const timeInput = document.getElementById("v-time-" + animalId).value;
  if (!timeInput) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤");

  const hrVal = document.getElementById("v-hr-" + animalId).value;
  const rrVal = document.getElementById("v-rr-" + animalId).value;
  const tempVal = document.getElementById("v-temp-" + animalId).value;
  const spo2Val = document.getElementById("v-spo2-" + animalId).value;
  const topVal = document.getElementById("v-top-" + animalId).value;

  const { error } = await supabase.from('vasd_vital_signs').insert({
    animal_id: animalId,
    time_recorded: timeInput,  // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    hr: hrVal || null,
    rr: rrVal || null,
    temp: tempVal || null,     // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Temp (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà bt)
    spo2: spo2Val || null,
    zoletil_top: topVal || null
  });

  if (error) {
    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
  } else {
    loadTables(); // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á
  }
};

// ---------------------------------------------
// ‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô (‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å‡∏ü‡∏∑‡πâ‡∏ô ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≤)
// ---------------------------------------------
window.finishSurgery = async function(animalId) {
  if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å‡∏ü‡∏∑‡πâ‡∏ô?")) return;

  // ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
  const rxInserts = [];
  document.querySelectorAll(`input[id^="rx-chk-${animalId}-"]:checked`).forEach(el => {
    const did = el.id.split("-").pop();
    rxInserts.push({
      animal_id: animalId,
      drug_id: el.dataset.name,
      dose: document.getElementById(`rx-dose-${animalId}-${did}`).value,
      freq: document.getElementById(`rx-freq-${animalId}-${did}`).value,
      days: parseInt(document.getElementById(`rx-days-${animalId}-${did}`).value) || 5,
      total_pills: parseFloat(document.getElementById(`rx-total-${animalId}-${did}`).value) || 0
    });
  });

  if(rxInserts.length > 0) {
    const { error: rxError } = await supabase.from("vasd_prescription").insert(rxInserts);
    if(rxError) console.error("Rx Error:", rxError);
  }

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô recovery
  const { error } = await supabase
    .from("vasd_queue")
    .update({ status: "recovery", table_number: null, updated_at: new Date() })
    .eq("animal_id", animalId);

  if (error) {
    alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
  } else {
    alert(`‚úÖ ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å‡∏ü‡∏∑‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ${rxInserts.length > 0 ? '(‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≤)' : ''}`);
    loadData();
  }
};

// ---------------------------------------------
// ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡∏¥‡∏ß
// ---------------------------------------------
window.cancelSurgery = async function(animalId) {
  if(!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
  await supabase
    .from("vasd_queue")
    .update({ status: "waiting", table_number: null, updated_at: new Date() })
    .eq("animal_id", animalId);
  loadData();
};

// Real-time
supabase.channel("anesthesia-live")
  .on("postgres_changes", { event: "*", schema: "public", table: "vasd_queue" }, loadData)
  .on("postgres_changes", { event: "*", schema: "public", table: "vasd_vital_signs" }, loadTables)
  .subscribe();

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
init();
</script>
</body>
</html>
