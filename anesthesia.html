<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡πÇ‡∏ï‡πä‡∏∞‡∏ß‡∏≤‡∏á‡∏¢‡∏≤‡∏™‡∏•‡∏ö (Anesthesia)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&family=Prompt:wght@300;400;500;700&family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>
:root {
  --navy:#0d1b2a; --teal:#1a6b72; --teal-light:#22919a; --accent:#00d4aa;
  --bg:#f0f4f8; --surface:#fff; --text:#1a202c; --text-muted:#718096;
  --border:#e2e8f0; --danger:#e53e3e; --success:#38a169; --warning:#d69e2e;
  --shadow-sm:0 1px 3px rgba(0,0,0,0.06); --shadow-md:0 4px 16px rgba(13,27,42,0.08);
  --radius:14px; --radius-sm:8px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{font-family:"Sarabun",sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}

/* HEADER */
header{
  background:var(--navy);padding:0 32px;display:flex;
  justify-content:space-between;align-items:center;height:68px;
  position:sticky;top:0;z-index:100;box-shadow:0 2px 20px rgba(0,0,0,0.25);
}
.header-brand{display:flex;align-items:center;gap:14px;}
.brand-icon{
  width:40px;height:40px;background:linear-gradient(135deg,var(--warning),#f6e05e);
  border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;
}
.brand-text h1{font-size:17px;font-weight:700;color:#fff;line-height:1.2;}
.brand-text span{font-size:11px;color:rgba(255,255,255,0.5);}

.btn-home{
  padding:8px 18px;font-size:13px;font-weight:600;font-family:"Sarabun",sans-serif;
  background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.9);
  border:1px solid rgba(255,255,255,0.2);border-radius:var(--radius-sm);
  cursor:pointer;transition:background 0.2s;
}
.btn-home:hover{background:rgba(255,255,255,0.18);}

/* MAIN */
.container{max-width:1000px;margin:0 auto;padding:28px 24px;}

.page-header{
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:24px;animation:fadeUp 0.4s ease both;
}
.page-header h2{font-size:22px;font-weight:700;color:var(--navy);}

/* CARD */
.card {
  background:var(--surface);border-radius:var(--radius);
  border:1px solid var(--border);box-shadow:var(--shadow-sm);
  margin-bottom:20px;padding:20px;animation:fadeUp 0.4s 0.05s ease both;
  display: flex; flex-direction: column; gap: 16px;
}
.card-header {
  display: flex; justify-content: space-between; align-items: center;
  border-bottom: 1px solid var(--border); padding-bottom: 12px;
}
.card-header h3 { font-size:18px; color:var(--navy); font-weight:700; margin:0; display: flex; align-items: center; gap:8px;}
.queue-badge {
  background: var(--navy); color: #fff; padding: 4px 10px; border-radius: 6px; font-size: 14px;
}

.card-body {
  display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
}
@media (max-width: 600px) { .card-body { grid-template-columns: 1fr; } }

.info-group { display: flex; flex-direction: column; gap: 4px; }
.info-label { font-size: 12px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; }
.info-value { font-size: 15px; color: var(--text); font-weight: 500; }

.input-group { display: flex; flex-direction: column; gap: 6px; }
.input-group label { font-size: 13px; font-weight: 600; color: var(--teal); }
.input-group input {
  padding: 10px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm);
  font-family: "Sarabun", sans-serif; font-size: 15px; outline: none; transition: all 0.2s;
}
.input-group input:focus { border-color: var(--teal); box-shadow: 0 0 0 3px rgba(34,145,154,0.1); }

/* DOSAGE CALC BOX */
.calc-box {
  background: #f8fafc; border: 1px dashed var(--border); border-radius: var(--radius-sm);
  padding: 12px; margin-top: 10px; font-size: 13px;
}
.calc-box h4 { font-size: 13px; color: var(--navy); margin-bottom: 8px; }
.calc-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #e2e8f0; }
.calc-row:last-child { border-bottom: none; }

.card-footer {
  display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid var(--border); padding-top: 16px;
}

/* BUTTONS */
.btn{
  padding:10px 20px;font-size:14px;font-weight:600;font-family:"Sarabun",sans-serif;
  border:none;border-radius:var(--radius-sm);cursor:pointer;
  transition:all 0.2s;display:inline-flex;align-items:center;gap:8px;
}
.btn:hover{opacity:0.85;transform:translateY(-1px);}
.btn-primary { background: var(--teal); color: #fff; }
.btn-danger { background: #fee2e2; color: var(--danger); }
.btn-danger:hover { background: var(--danger); color: #fff; }

.empty-state { text-align:center; padding:60px 20px; color:var(--text-muted); font-size:16px; }

@keyframes fadeUp{from{opacity:0;transform:translateY(14px);}to{opacity:1;transform:translateY(0);}}
</style>
</head>
<body>

<header>
  <div class="header-brand">
    <div class="brand-icon">üíâ</div>
    <div class="brand-text">
      <h1>‡πÇ‡∏ï‡πä‡∏∞‡∏ß‡∏≤‡∏á‡∏¢‡∏≤‡∏™‡∏•‡∏ö / ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß</h1>
      <span>RMUTTO ‚Äì Veterinary Academic Service Division</span>
    </div>
  </div>
  <button class="btn-home" onclick="location.href='index.html'">üè† ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
</header>

<div class="container">
  <div class="page-header">
    <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß / ‡∏ß‡∏≤‡∏á‡∏¢‡∏≤</h2>
  </div>
  <div id="anesthesia-container">
    <div class="empty-state">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
  </div>
</div>

<script type="module">
import { supabase } from "./js/supabase.js";

async function loadAnesthesiaQueue() {
  try {
    const { data: eventId } = await supabase.rpc("get_today_event");

    // ‡∏î‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà status = 'waiting' (‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î)
    const { data: queueData, error } = await supabase
      .from("vasd_queue")
      .select(`
        id, animal_id, status,
        vasd_animal ( 
          id, event_id, queue_number, animal_name, species, sex, est_weight, actual_weight,
          vasd_owner(owner_name),
          vasd_service(service_type)
        )
      `)
      .eq("status", "waiting")
      .order("created_at", { ascending: true });

    if (error) throw error;

    const animals = (queueData || []).filter(q => q.vasd_animal && q.vasd_animal.event_id === eventId);
    const container = document.getElementById("anesthesia-container");
    container.innerHTML = "";

    if (animals.length === 0) {
      container.innerHTML = `<div class="empty-state">‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</div>`;
      return;
    }

    animals.forEach((q, index) => {
      const a = q.vasd_animal;
      const ownerName = a.vasd_owner ? a.vasd_owner.owner_name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
      const species = a.species === "‡∏™" ? "‡∏™‡∏∏‡∏ô‡∏±‡∏Ç" : (a.species === "‡∏°" ? "‡πÅ‡∏°‡∏ß" : a.species);
      const services = a.vasd_service ? a.vasd_service.map(s => s.service_type).join(", ") : "-";
      
      // ‡∏ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏à‡∏£‡∏¥‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å
      const defaultWeight = a.actual_weight || a.est_weight || "";

      const card = document.createElement("div");
      card.className = "card";
      card.style.animationDelay = `${(index * 0.1)}s`; 
      
      card.innerHTML = `
        <div class="card-header">
          <h3>
            <span class="queue-badge">${a.queue_number || '-'}</span> 
            ${a.animal_name} <span style="font-size:14px; font-weight:normal; color:var(--text-muted);">(${species} ${a.sex})</span>
          </h3>
        </div>
        
        <div class="card-body">
          <div style="display:flex; flex-direction:column; gap:12px;">
            <div class="info-group">
              <span class="info-label">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</span>
              <span class="info-value">üë§ ${ownerName}</span>
            </div>
            <div class="info-group">
              <span class="info-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥</span>
              <span class="info-value">ü©∫ ${services}</span>
            </div>
            <div class="info-group">
              <span class="info-label">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô (‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô)</span>
              <span class="info-value">${a.est_weight || '-'} ‡∏Å‡∏Å.</span>
            </div>
          </div>

          <div>
            <div class="input-group">
              <label for="weight-${a.id}">‚öñÔ∏è ‡∏ä‡∏±‡πà‡∏á‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏à‡∏£‡∏¥‡∏á (‡∏Å‡∏Å.) <span style="color:var(--danger);">*</span></label>
              <input type="number" step="0.01" id="weight-${a.id}" value="${defaultWeight}" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏à‡∏£‡∏¥‡∏á..." oninput="calculateDose('${a.id}', this.value)">
            </div>
            
            <div class="calc-box">
              <h4>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏¢‡∏≤‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á)</h4>
              <div class="calc-row"><span>Atropine (0.04 mg/kg):</span> <strong id="calc-atro-${a.id}">- ml</strong></div>
              <div class="calc-row"><span>Xylazine 2% (1 mg/kg):</span> <strong id="calc-xyla-${a.id}">- ml</strong></div>
              <div class="calc-row"><span>Zoletil (5 mg/kg):</span> <strong id="calc-zole-${a.id}">- ml</strong></div>
            </div>
          </div>
        </div>

        <div class="card-footer">
          <button class="btn btn-primary" onclick="sendToSurgery('${a.id}')">ü©∫ ‡∏ß‡∏≤‡∏á‡∏¢‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô / ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î</button>
        </div>
      `;
      container.appendChild(card);
      
      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≤‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πå‡∏î
      if(defaultWeight) window.calculateDose(a.id, defaultWeight);
    });

  } catch (err) {
    console.error("Error:", err);
    document.getElementById("anesthesia-container").innerHTML = `<div class="empty-state text-danger">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}</div>`;
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≤ (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏π‡∏ï‡∏£‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏î‡πâ)
window.calculateDose = function(animalId, weightStr) {
  const w = parseFloat(weightStr);
  if (isNaN(w) || w <= 0) {
    document.getElementById(`calc-atro-${animalId}`).innerText = "- ml";
    document.getElementById(`calc-xyla-${animalId}`).innerText = "- ml";
    document.getElementById(`calc-zole-${animalId}`).innerText = "- ml";
    return;
  }
  
  // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô: Atropine (0.6 mg/ml), Xylazine (20 mg/ml), Zoletil (50 mg/ml)
  const doseAtro = ((w * 0.04) / 0.6).toFixed(2);
  const doseXyla = ((w * 1) / 20).toFixed(2);
  const doseZole = ((w * 5) / 50).toFixed(2);

  document.getElementById(`calc-atro-${animalId}`).innerText = `${doseAtro} ml`;
  document.getElementById(`calc-xyla-${animalId}`).innerText = `${doseXyla} ml`;
  document.getElementById(`calc-zole-${animalId}`).innerText = `${doseZole} ml`;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î
window.sendToSurgery = async function(animalId) {
  const weightInput = document.getElementById(`weight-${animalId}`).value;
  if (!weightInput) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏à‡∏£‡∏¥‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î");
    return;
  }

  if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î?\n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏à‡∏£‡∏¥‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î'")) return;

  try {
    // 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô vasd_animal
    await supabase
      .from("vasd_animal")
      .update({ actual_weight: parseFloat(weightInput) })
      .eq("id", animalId);

    // 2. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏õ‡πá‡∏ô surgery
    const { error } = await supabase
      .from("vasd_queue")
      .update({ status: "surgery", updated_at: new Date() })
      .eq("animal_id", animalId);

    if (error) throw error;
    
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà (‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏´‡∏•‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ waiting)
    loadAnesthesiaQueue();
    
  } catch (err) {
    alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
  }
};

// ‡∏™‡∏±‡πà‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
loadAnesthesiaQueue();

// Real-time Update
supabase.channel("vasd-anesthesia-live")
  .on("postgres_changes", { event: "*", schema: "public", table: "vasd_queue" }, loadAnesthesiaQueue)
  .subscribe();

</script>
</body>
</html>
