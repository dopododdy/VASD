<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>à¸§à¸²à¸‡à¸¢à¸²à¸ªà¸¥à¸š â€“ VASD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOKENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --navy:         #0b1929;
  --navy-mid:     #112240;
  --teal:         #0ea5a0;
  --teal-light:   #14c4bc;
  --teal-glow:    rgba(14,165,160,0.25);
  --amber:        #f59e0b;
  --amber-soft:   rgba(245,158,11,0.14);
  --rose:         #ef4444;
  --rose-soft:    rgba(239,68,68,0.12);
  --emerald:      #10b981;
  --emerald-soft: rgba(16,185,129,0.14);
  --violet:       #8b5cf6;

  --surface:      rgba(255,255,255,0.04);
  --surface-2:    rgba(255,255,255,0.07);
  --surface-3:    rgba(255,255,255,0.11);
  --border:       rgba(255,255,255,0.08);
  --border-2:     rgba(255,255,255,0.14);
  --text:         #e2e8f0;
  --text-dim:     #94a3b8;
  --text-faint:   #4a5568;

  --radius-xs: 6px;
  --radius-sm: 10px;
  --radius:    16px;
  --radius-lg: 22px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }

body {
  font-family: "Sarabun", sans-serif;
  background: var(--navy);
  color: var(--text);
  min-height: 100vh; min-height: 100dvh;
  display: flex; flex-direction: column;
  overflow-x: hidden;
}
body::before {
  content: ""; position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background:
    radial-gradient(ellipse 60% 50% at 20% 10%, rgba(245,158,11,0.08) 0%, transparent 70%),
    radial-gradient(ellipse 50% 40% at 80% 80%, rgba(14,165,160,0.07) 0%, transparent 60%);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
header {
  position: sticky; top: 0; z-index: 200;
  background: rgba(11,25,41,0.88);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-bottom: 1px solid var(--border);
  padding: 0 20px; height: 64px;
  display: flex; align-items: center; justify-content: space-between; gap: 12px;
}
.brand { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
.brand-logo {
  width: 38px; height: 38px;
  background: linear-gradient(135deg, var(--amber), #fbbf24);
  border-radius: 10px; display: flex; align-items: center; justify-content: center;
  font-size: 18px; box-shadow: 0 0 20px var(--amber-soft);
}
.brand-name {
  font-family: "Outfit", sans-serif;
  font-size: 15px; font-weight: 700; color: #fff; line-height: 1; letter-spacing: -0.3px;
}
.brand-sub { font-size: 10px; color: var(--text-dim); margin-top: 2px; }
.btn-home {
  padding: 8px 14px; font-size: 12px; font-weight: 600; font-family: "Sarabun", sans-serif;
  background: var(--surface-2); color: var(--text-dim);
  border: 1px solid var(--border-2); border-radius: var(--radius-sm); cursor: pointer;
  display: flex; align-items: center; gap: 5px;
  transition: background 0.2s, color 0.2s;
  -webkit-tap-highlight-color: transparent;
}
.btn-home:hover { background: var(--surface-3); color: var(--text); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WRAP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.wrap {
  position: relative; z-index: 1;
  max-width: 900px; margin: 0 auto;
  padding: 24px 16px 100px; 
  width: 100%;
}

.section-title {
  font-size: 10px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase;
  color: var(--text-faint); margin-bottom: 12px;
  display: flex; align-items: center; gap: 8px;
}
.section-title::after { content: ""; flex: 1; height: 1px; background: var(--border); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ANESTHESIA CARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#anesthesia-container { display: flex; flex-direction: column; gap: 14px; }

.anes-card {
  background: var(--surface);
  border: 1px solid var(--border-2);
  border-radius: var(--radius-lg);
  overflow: hidden;
  animation: slideUp 0.4s ease both;
}
/* amber top bar */
.anes-card::before {
  content: ""; display: block; height: 3px;
  background: linear-gradient(90deg, var(--amber), #fbbf24);
}

/* â”€â”€ Card Header â”€â”€ */
.ac-header {
  display: flex; align-items: center; gap: 12px;
  padding: 14px 16px 12px;
  border-bottom: 1px solid var(--border);
  background: var(--surface-2);
}
.queue-circle {
  font-family: "Outfit", sans-serif;
  width: 42px; height: 42px; border-radius: 50%;
  background: var(--amber-soft); border: 2px solid rgba(245,158,11,0.3);
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 800; color: var(--amber); flex-shrink: 0;
}
.ac-title-block { flex: 1; min-width: 0; }
.ac-animal-name {
  font-family: "Outfit", sans-serif;
  font-size: 16px; font-weight: 800; color: #fff; line-height: 1.1;
}
.ac-meta { font-size: 11px; color: var(--text-dim); margin-top: 3px; }
.ac-status-pill {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 5px 11px; border-radius: 20px;
  font-size: 10px; font-weight: 700; flex-shrink: 0;
  background: var(--amber-soft); color: var(--amber);
  border: 1px solid rgba(245,158,11,0.3);
  letter-spacing: 0.3px;
}

/* â”€â”€ Card Body â”€â”€ */
.ac-body { padding: 16px; display: flex; flex-direction: column; gap: 14px; }

/* info chips */
.info-chips { display: flex; flex-wrap: wrap; gap: 8px; }
.info-chip {
  display: flex; align-items: center; gap: 6px;
  background: var(--surface-2); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 7px 12px;
  font-size: 12px;
}
.info-chip .ic-label { color: var(--text-dim); margin-right: 2px; }
.info-chip .ic-val   { color: var(--text); font-weight: 600; }
.info-chip .ic-val.teal   { color: var(--teal-light); }

/* est weight strip */
.est-weight-strip {
  display: flex; align-items: center; gap: 8px;
  background: var(--amber-soft); border: 1px solid rgba(245,158,11,0.2);
  border-radius: var(--radius-sm); padding: 8px 12px;
  font-size: 12px; color: var(--amber);
}

/* weight input */
.weight-row {
  display: flex; align-items: flex-end; gap: 10px; flex-wrap: wrap;
}
.field-group { display: flex; flex-direction: column; gap: 4px; flex: 1; min-width: 140px; }
.field-label {
  font-size: 10px; font-weight: 700; letter-spacing: 0.8px; text-transform: uppercase;
  color: var(--text-faint);
}

.f-input {
  width: 100%; padding: 10px 12px;
  font-size: 15px; font-weight: 700; font-family: "Sarabun", sans-serif;
  background: var(--surface-2); border: 2px solid var(--border-2);
  border-radius: var(--radius-sm); color: var(--text); outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
  -webkit-appearance: none;
}
.f-input::placeholder { color: var(--text-faint); font-weight: 400; }
.f-input:focus {
  border-color: var(--amber);
  box-shadow: 0 0 0 3px var(--amber-soft);
}
.f-input.filled { border-color: var(--emerald); }

/* â”€â”€ Dose Calc Box â”€â”€ */
.calc-box {
  background: var(--surface-2);
  border: 1px solid var(--border-2);
  border-radius: var(--radius-sm);
  overflow: hidden;
}
.calc-box-header {
  padding: 9px 13px; background: var(--surface-3);
  font-size: 10px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;
  color: var(--text-dim); border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 6px;
}
.calc-row {
  display: flex; justify-content: space-between; align-items: center;
  padding: 10px 13px; border-bottom: 1px solid var(--border);
  font-size: 13px;
}
.calc-row:last-child { border-bottom: none; }
.calc-drug { color: var(--text-dim); }
.calc-dose {
  font-family: "Outfit", sans-serif;
  font-size: 15px; font-weight: 800; color: var(--teal-light);
  background: rgba(14,165,160,0.1); border: 1px solid rgba(14,165,160,0.2);
  border-radius: var(--radius-xs); padding: 2px 10px;
  min-width: 70px; text-align: center;
  transition: all 0.2s;
}
.calc-dose.pending { color: var(--text-faint); background: transparent; border-color: var(--border); font-size: 13px; font-weight: 400; }

/* â”€â”€ Card Footer â”€â”€ */
.ac-footer {
  display: flex; gap: 8px; flex-wrap: wrap;
  padding: 12px 16px;
  border-top: 1px solid var(--border);
  background: var(--surface-2);
}
.btn {
  padding: 10px 16px; font-size: 12px; font-weight: 600; font-family: "Sarabun", sans-serif;
  border: none; border-radius: var(--radius-sm); cursor: pointer;
  display: inline-flex; align-items: center; gap: 5px;
  transition: opacity 0.2s, transform 0.15s;
  -webkit-tap-highlight-color: transparent;
  white-space: nowrap;
}
.btn:active { transform: scale(0.96); }
.btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; }

.btn-send {
  background: linear-gradient(135deg, var(--teal), var(--teal-light));
  color: #fff; flex: 1; justify-content: center; font-size: 13px;
  box-shadow: 0 4px 14px var(--teal-glow);
}
.btn-send:hover { opacity: 0.9; }

/* â”€â”€ Empty State â”€â”€ */
.empty-state {
  text-align: center; padding: 60px 16px;
  color: var(--text-faint); animation: slideUp 0.4s ease both;
}
.empty-state-icon { font-size: 52px; margin-bottom: 14px; }
.empty-state-text { font-size: 14px; color: var(--text-dim); }
.empty-state-sub  { font-size: 12px; margin-top: 6px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOTTOM NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bottom-nav {
  position: fixed; bottom: 0; left: 0; right: 0;
  height: 64px;
  background: rgba(11,25,41,0.9);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-top: 1px solid var(--border);
  display: flex; justify-content: space-around; align-items: center;
  z-index: 200;
  padding-bottom: env(safe-area-inset-bottom);
}
.nav-item {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 4px; color: var(--text-dim); text-decoration: none;
  font-size: 10px; font-weight: 600; font-family: "Sarabun", sans-serif;
  width: 60px; height: 100%; transition: color 0.2s;
  -webkit-tap-highlight-color: transparent;
}
.nav-item.active { color: var(--amber); }
.nav-icon { font-size: 20px; margin-bottom: 2px; }
.nav-item:hover { color: var(--text); }
.nav-item.active:hover { color: var(--amber); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ANIMATIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@keyframes slideUp {
  from { opacity: 0; transform: translateY(18px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 640px) {
  header { height: 56px; padding: 0 14px; }
  .brand-sub { display: none; }
  .wrap { padding: 18px 12px 100px; }
  .ac-animal-name { font-size: 15px; }
}
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="brand-logo">ğŸ’‰</div>
    <div>
      <div class="brand-name">à¸§à¸²à¸‡à¸¢à¸²à¸ªà¸¥à¸š / à¹€à¸•à¸£à¸µà¸¢à¸¡à¸•à¸±à¸§</div>
      <div class="brand-sub">RMUTTO â€“ Veterinary Academic Service Division</div>
    </div>
  </div>
  <button class="btn-home" onclick="location.href='index.html'">ğŸ  à¸«à¸™à¹‰à¸²à¸«à¸¥à¸±à¸</button>
</header>

<div class="wrap">

  <div class="section-title">à¸„à¸´à¸§à¸£à¸­à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£</div>
  <div id="anesthesia-container">
    <div class="empty-state">
      <div class="empty-state-icon">ğŸ’‰</div>
      <div class="empty-state-text">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥...</div>
    </div>
  </div>

</div>

<nav class="bottom-nav">
  <a href="index.html" class="nav-item">
    <span class="nav-icon">ğŸ </span>
    <span>à¸«à¸™à¹‰à¸²à¸«à¸¥à¸±à¸</span>
  </a>
  <a href="animals.html" class="nav-item">
    <span class="nav-icon">ğŸ¾</span>
    <span>à¸ªà¸±à¸•à¸§à¹Œ</span>
  </a>
  <a href="#" class="nav-item active">
    <span class="nav-icon">ğŸ’‰</span>
    <span>à¸§à¸²à¸‡à¸¢à¸²</span>
  </a>
  <a href="surgery.html" class="nav-item">
    <span class="nav-icon">ğŸ›ï¸</span>
    <span>à¸œà¹ˆà¸²à¸•à¸±à¸”</span>
  </a>
  <a href="recovery.html" class="nav-item">
    <span class="nav-icon">â¤ï¸â€ğŸ©¹</span>
    <span>à¸à¸±à¸à¸Ÿà¸·à¹‰à¸™</span>
  </a>
</nav>

<script type="module">
import { supabase } from "./js/supabase.js";

/* â”€â”€ helper â”€â”€ */
function round(val) {
  const num = Math.ceil(val * 4) / 4;
  return num < 0.25 ? 0.25 : num;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOAD QUEUE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadAnesthesiaQueue() {
  const container = document.getElementById("anesthesia-container");
  try {
    const { data: eventId } = await supabase.rpc("get_today_event");
    const { data: queueData, error } = await supabase
      .from("vasd_queue")
      .select(`id, animal_id, status,
        vasd_animal(
          id, event_id, queue_number, animal_name, species, sex, est_weight, actual_weight,
          vasd_owner(owner_name),
          vasd_service(service_type)
        )`)
      .eq("status", "waiting")
      .order("created_at", { ascending: true });

    if (error) throw error;

    const animals = (queueData || []).filter(q => q.vasd_animal && q.vasd_animal.event_id === eventId);

    container.innerHTML = "";

    if (animals.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">âœ…</div>
          <div class="empty-state-text">à¹„à¸¡à¹ˆà¸¡à¸µà¸£à¸²à¸¢à¸à¸²à¸£à¸£à¸­à¹€à¸•à¸£à¸µà¸¢à¸¡à¸•à¸±à¸§à¹ƒà¸™à¸‚à¸“à¸°à¸™à¸µà¹‰</div>
          <div class="empty-state-sub">à¹€à¸¡à¸·à¹ˆà¸­à¸¡à¸µà¹€à¸„à¸ªà¹ƒà¸«à¸¡à¹ˆ à¸«à¸™à¹‰à¸²à¸ˆà¸­à¸ˆà¸°à¸­à¸±à¸›à¹€à¸”à¸•à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´</div>
        </div>`;
      return;
    }

    animals.forEach((q, idx) => {
      const a        = q.vasd_animal;
      const ownerName = a.vasd_owner?.owner_name || "à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸";
      const spText   = a.species === "à¸ª" ? "ğŸ¶ à¸ªà¸¸à¸™à¸±à¸‚" : "ğŸ± à¹à¸¡à¸§";
      const services = (a.vasd_service || []).map(s => s.service_type).join(", ") || "â€“";
      const defW     = a.actual_weight || a.est_weight || "";

      const card = document.createElement("div");
      card.className = "anes-card";
      card.style.animationDelay = `${idx * 0.07}s`;

      card.innerHTML = `
        <div class="ac-header">
          <div class="queue-circle">#${a.queue_number || "-"}</div>
          <div class="ac-title-block">
            <div class="ac-animal-name">${a.animal_name}</div>
            <div class="ac-meta">${spText} Â· ${a.sex} Â· à¹€à¸ˆà¹‰à¸²à¸‚à¸­à¸‡: ${ownerName}</div>
          </div>
          <span class="ac-status-pill">â³ à¸£à¸­à¸§à¸²à¸‡à¸¢à¸²</span>
        </div>

        <div class="ac-body">

          <div class="info-chips">
            <div class="info-chip">
              <span class="ic-label">ğŸ‘¤</span>
              <span class="ic-val">${ownerName}</span>
            </div>
            <div class="info-chip">
              <span class="ic-label">ğŸ©º</span>
              <span class="ic-val teal">${services}</span>
            </div>
          </div>

          <div class="est-weight-strip">
            âš–ï¸ à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¸›à¸£à¸°à¹€à¸¡à¸´à¸™ (à¸ˆà¸²à¸à¸ˆà¸¸à¸”à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™): <strong style="margin-left:4px;">${a.est_weight || "â€“"} à¸à¸.</strong>
          </div>

          <div class="weight-row">
            <div class="field-group">
              <span class="field-label">âš–ï¸ à¸Šà¸±à¹ˆà¸‡à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¸ˆà¸£à¸´à¸‡ (à¸à¸.) *</span>
              <input
                class="f-input"
                type="number" step="0.01" min="0"
                id="weight-${a.id}"
                value="${defW}"
                placeholder="à¸à¸£à¸­à¸à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¸ˆà¸£à¸´à¸‡..."
                oninput="calculateDose('${a.id}', this.value); this.classList.toggle('filled', !!this.value)"
              >
            </div>
          </div>

          <div class="calc-box">
            <div class="calc-box-header">ğŸ§ª Pre-med (à¹„à¸¡à¹ˆà¸£à¸§à¸¡ ATB, NSAIDs)</div>
            <div class="calc-row">
              <span class="calc-drug">Atropine 1 mg/ml <small style="color:var(--text-faint);">(0.04 mg/kg)</small></span>
              <span class="calc-dose pending" id="calc-atro-${a.id}">à¸£à¸­à¸™à¹‰à¸³à¸«à¸™à¸±à¸</span>
            </div>
            <div class="calc-row">
              <span class="calc-drug">Xylazine 20 mg/ml <small style="color:var(--text-faint);">(1 mg/kg)</small></span>
              <span class="calc-dose pending" id="calc-xyla-${a.id}">à¸£à¸­à¸™à¹‰à¸³à¸«à¸™à¸±à¸</span>
            </div>
            <div class="calc-row">
              <span class="calc-drug">Zoletil 100 mg/ml <small style="color:var(--text-faint);">(3 mg/kg)</small></span>
              <span class="calc-dose pending" id="calc-zole-${a.id}">à¸£à¸­à¸™à¹‰à¸³à¸«à¸™à¸±à¸</span>
            </div>
            <div class="calc-row">
              <span class="calc-drug">Thiopental 10 mg/ml <small style="color:var(--text-faint);">(5 mg/kg)</small></span>
              <span class="calc-dose pending" id="calc-thio-${a.id}">à¸£à¸­à¸™à¹‰à¸³à¸«à¸™à¸±à¸</span>
            </div>
          </div>

        </div><div class="ac-footer">
          <button class="btn btn-send" onclick="sendToSurgery('${a.id}')">
            ğŸ©º à¸ªà¹ˆà¸‡à¸•à¹ˆà¸­à¹‚à¸•à¹Šà¸°à¸œà¹ˆà¸²à¸•à¸±à¸”
          </button>
        </div>
      `;

      container.appendChild(card);
      if (defW) window.calculateDose(a.id, defW);
    });

  } catch (err) {
    console.error(err);
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-text" style="color:#fca5a5;">âŒ à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: ${err.message}</div>
      </div>`;
  }
}

/* â”€â”€ Calculate dose â”€â”€ */
window.calculateDose = function(animalId, weightStr) {
  const w = parseFloat(weightStr);
  const setVal = (id, txt, pending) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = txt;
    el.classList.toggle("pending", !!pending);
  };

  if (isNaN(w) || w <= 0) {
    setVal(`calc-atro-${animalId}`, "à¸£à¸­à¸™à¹‰à¸³à¸«à¸™à¸±à¸", true);
    setVal(`calc-xyla-${animalId}`, "à¸£à¸­à¸™à¹‰à¸³à¸«à¸™à¸±à¸", true);
    setVal(`calc-zole-${animalId}`, "à¸£à¸­à¸™à¹‰à¸³à¸«à¸™à¸±à¸", true);
    setVal(`calc-thio-${animalId}`, "à¸£à¸­à¸™à¹‰à¸³à¸«à¸™à¸±à¸", true);
    return;
  }

  // à¸›à¸£à¸±à¸šà¹à¸à¹‰à¸•à¸±à¸§à¸«à¸²à¸£à¸•à¸²à¸¡à¸„à¸§à¸²à¸¡à¹€à¸‚à¹‰à¸¡à¸‚à¹‰à¸™à¸‚à¸­à¸‡à¸¢à¸²à¹ƒà¸«à¸¡à¹ˆ
  setVal(`calc-atro-${animalId}`, `${((w * 0.04) / 1).toFixed(2)} ml`, false);
  setVal(`calc-xyla-${animalId}`, `${((w * 1) / 20).toFixed(2)} ml`, false);
  setVal(`calc-zole-${animalId}`, `${((w * 3) / 100).toFixed(2)} ml`, false);
  setVal(`calc-thio-${animalId}`, `${((w * 5) / 10).toFixed(2)} ml`, false);
};

/* â”€â”€ Send to surgery â”€â”€ */
window.sendToSurgery = async function(animalId) {
  const weightInput = document.getElementById(`weight-${animalId}`).value;
  if (!weightInput) {
    alert("à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¸ˆà¸£à¸´à¸‡à¸à¹ˆà¸­à¸™à¸ªà¹ˆà¸‡à¸•à¹ˆà¸­à¹‚à¸•à¹Šà¸°à¸œà¹ˆà¸²à¸•à¸±à¸”");
    document.getElementById(`weight-${animalId}`).focus();
    return;
  }
  if (!confirm("à¸¢à¸·à¸™à¸¢à¸±à¸™à¸à¸²à¸£à¸ªà¹ˆà¸‡à¸ªà¸±à¸•à¸§à¹Œà¹€à¸‚à¹‰à¸²à¹‚à¸•à¹Šà¸°à¸œà¹ˆà¸²à¸•à¸±à¸”?\nà¸£à¸°à¸šà¸šà¸ˆà¸°à¸­à¸±à¸›à¹€à¸”à¸•à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¸ˆà¸£à¸´à¸‡à¹à¸¥à¸°à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸ªà¸–à¸²à¸™à¸°")) return;

  try {
    await supabase.from("vasd_animal").update({ actual_weight: parseFloat(weightInput) }).eq("id", animalId);
    const { error } = await supabase.from("vasd_queue").update({ status: "surgery", updated_at: new Date() }).eq("animal_id", animalId);
    if (error) throw error;
    loadAnesthesiaQueue();
  } catch (err) {
    alert("âŒ à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”: " + err.message);
  }
};

/* â”€â”€ Real-time â”€â”€ */
supabase.channel("vasd-anesthesia-live")
  .on("postgres_changes", { event: "*", schema: "public", table: "vasd_queue" }, loadAnesthesiaQueue)
  .subscribe();

loadAnesthesiaQueue();
</script>
</body>
</html>
