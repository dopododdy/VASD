<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>à¸§à¸²à¸‡à¸¢à¸²à¸ªà¸¥à¸š â€“ VASD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOKENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --navy:         #0b1929;
  --navy-mid:     #112240;
  --teal:         #0ea5a0;
  --teal-light:   #14c4bc;
  --teal-glow:    rgba(14,165,160,0.25);
  --amber:        #f59e0b;
  --amber-soft:   rgba(245,158,11,0.14);
  --rose:         #ef4444;
  --rose-soft:    rgba(239,68,68,0.12);
  --emerald:      #10b981;
  --emerald-soft: rgba(16,185,129,0.14);
  --violet:       #8b5cf6;

  --surface:    rgba(255,255,255,0.04);
  --surface-2:  rgba(255,255,255,0.07);
  --surface-3:  rgba(255,255,255,0.11);
  --border:     rgba(255,255,255,0.08);
  --border-2:   rgba(255,255,255,0.14);
  --text:       #e2e8f0;
  --text-dim:   #94a3b8;
  --text-faint: #4a5568;

  --radius-xs: 6px;
  --radius-sm: 10px;
  --radius:    16px;
  --radius-lg: 22px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }

body {
  font-family: "Sarabun", sans-serif;
  background: var(--navy);
  color: var(--text);
  min-height: 100vh; min-height: 100dvh;
  display: flex; flex-direction: column;
  overflow-x: hidden;
}
body::before {
  content: ""; position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background:
    radial-gradient(ellipse 60% 50% at 20% 10%, rgba(245,158,11,0.08) 0%, transparent 70%),
    radial-gradient(ellipse 50% 40% at 80% 80%, rgba(14,165,160,0.07) 0%, transparent 60%);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
header {
  position: sticky; top: 0; z-index: 200;
  background: rgba(11,25,41,0.88);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-bottom: 1px solid var(--border);
  padding: 0 20px; height: 64px;
  display: flex; align-items: center; justify-content: space-between; gap: 12px;
}
.brand { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
.brand-logo {
  width: 38px; height: 38px;
  background: linear-gradient(135deg, var(--amber), #fbbf24);
  border-radius: 10px; display: flex; align-items: center; justify-content: center;
  font-size: 18px; box-shadow: 0 0 20px var(--amber-soft);
}
.brand-name {
  font-family: "Outfit", sans-serif;
  font-size: 15px; font-weight: 700; color: #fff; line-height: 1; letter-spacing: -0.3px;
}
.brand-sub { font-size: 10px; color: var(--text-dim); margin-top: 2px; }
.btn-home {
  padding: 8px 14px; font-size: 12px; font-weight: 600; font-family: "Sarabun", sans-serif;
  background: var(--surface-2); color: var(--text-dim);
  border: 1px solid var(--border-2); border-radius: var(--radius-sm); cursor: pointer;
  display: flex; align-items: center; gap: 5px;
  transition: background 0.2s, color 0.2s;
  -webkit-tap-highlight-color: transparent;
}
.btn-home:hover { background: var(--surface-3); color: var(--text); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WRAP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.wrap {
  position: relative; z-index: 1;
  max-width: 900px; margin: 0 auto;
  padding: 24px 16px 60px; width: 100%;
}

.page-header {
  display: flex; align-items: flex-start; justify-content: space-between;
  margin-bottom: 22px; flex-wrap: wrap; gap: 10px;
  animation: slideUp 0.4s ease both;
}
.page-title {
  font-family: "Outfit", sans-serif;
  font-size: 20px; font-weight: 800; color: #fff; letter-spacing: -0.5px;
}
.page-sub { font-size: 12px; color: var(--text-dim); margin-top: 3px; }

.section-title {
  font-size: 10px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase;
  color: var(--text-faint); margin-bottom: 12px;
  display: flex; align-items: center; gap: 8px;
}
.section-title::after { content: ""; flex: 1; height: 1px; background: var(--border); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ANESTHESIA CARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#anesthesia-container { display: flex; flex-direction: column; gap: 14px; }

.anes-card {
  background: var(--surface);
  border: 1px solid var(--border-2);
  border-radius: var(--radius-lg);
  overflow: hidden;
  animation: slideUp 0.4s ease both;
}
/* amber top bar */
.anes-card::before {
  content: ""; display: block; height: 3px;
  background: linear-gradient(90deg, var(--amber), #fbbf24);
}

/* â”€â”€ Card Header â”€â”€ */
.ac-header {
  display: flex; align-items: center; gap: 12px;
  padding: 14px 16px 12px;
  border-bottom: 1px solid var(--border);
  background: var(--surface-2);
}
.queue-circle {
  font-family: "Outfit", sans-serif;
  width: 42px; height: 42px; border-radius: 50%;
  background: var(--amber-soft); border: 2px solid rgba(245,158,11,0.3);
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 800; color: var(--amber); flex-shrink: 0;
}
.ac-title-block { flex: 1; min-width: 0; }
.ac-animal-name {
  font-family: "Outfit", sans-serif;
  font-size: 16px; font-weight: 800; color: #fff; line-height: 1.1;
}
.ac-meta { font-size: 11px; color: var(--text-dim); margin-top: 3px; }
.ac-status-pill {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 5px 11px; border-radius: 20px;
  font-size: 10px; font-weight: 700; flex-shrink: 0;
  background: var(--amber-soft); color: var(--amber);
  border: 1px solid rgba(245,158,11,0.3);
  letter-spacing: 0.3px;
}

/* â”€â”€ Card Body â”€â”€ */
.ac-body { padding: 16px; display: flex; flex-direction: column; gap: 14px; }

/* info chips */
.info-chips { display: flex; flex-wrap: wrap; gap: 8px; }
.info-chip {
  display: flex; align-items: center; gap: 6px;
  background: var(--surface-2); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 7px 12px;
  font-size: 12px;
}
.info-chip .ic-label { color: var(--text-dim); margin-right: 2px; }
.info-chip .ic-val   { color: var(--text); font-weight: 600; }
.info-chip .ic-val.teal   { color: var(--teal-light); }
.info-chip .ic-val.amber  { color: var(--amber); }

/* est weight strip */
.est-weight-strip {
  display: flex; align-items: center; gap: 8px;
  background: var(--amber-soft); border: 1px solid rgba(245,158,11,0.2);
  border-radius: var(--radius-sm); padding: 8px 12px;
  font-size: 12px; color: var(--amber);
}

/* weight input */
.weight-row {
  display: flex; align-items: flex-end; gap: 10px; flex-wrap: wrap;
}
.field-group { display: flex; flex-direction: column; gap: 4px; flex: 1; min-width: 140px; }
.field-label {
  font-size: 10px; font-weight: 700; letter-spacing: 0.8px; text-transform: uppercase;
  color: var(--text-faint);
}

.f-input {
  width: 100%; padding: 10px 12px;
  font-size: 15px; font-weight: 700; font-family: "Sarabun", sans-serif;
  background: var(--surface-2); border: 2px solid var(--border-2);
  border-radius: var(--radius-sm); color: var(--text); outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
  -webkit-appearance: none;
}
.f-input::placeholder { color: var(--text-faint); font-weight: 400; }
.f-input:focus {
  border-color: var(--amber);
  box-shadow: 0 0 0 3px var(--amber-soft);
}
.f-input.filled { border-color: var(--emerald); }

/* â”€â”€ Dose Calc Box â”€â”€ */
.calc-box {
  background: var(--surface-2);
  border: 1px solid var(--border-2);
  border-radius: var(--radius-sm);
  overflow: hidden;
}
.calc-box-header {
  padding: 9px 13px; background: var(--surface-3);
  font-size: 10px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;
  color: var(--text-dim); border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 6px;
}
.calc-row {
  display: flex; justify-content: space-between; align-items: center;
  padding: 10px 13px; border-bottom: 1px solid var(--border);
  font-size: 13px;
}
.calc-row:last-child { border-bottom: none; }
.calc-drug { color: var(--text-dim); }
.calc-dose {
  font-family: "Outfit", sans-serif;
  font-size: 15px; font-weight: 800; color: var(--teal-light);
  background: rgba(14,165,160,0.1); border: 1px solid rgba(14,165,160,0.2);
  border-radius: var(--radius-xs); padding: 2px 10px;
  min-width: 70px; text-align: center;
  transition: all 0.2s;
}
.calc-dose.pending { color: var(--text-faint); background: transparent; border-color: var(--border); font-size: 13px; font-weight: 400; }

/* â”€â”€ Card Footer â”€â”€ */
.ac-footer {
  display: flex; gap: 8px; flex-wrap: wrap;
  padding: 12px 16px;
  border-top: 1px solid var(--border);
  background: var(--surface-2);
}
.btn {
  padding: 10px 16px; font-size: 12px; font-weight: 600; font-family: "Sarabun", sans-serif;
  border: none; border-radius: var(--radius-sm); cursor: pointer;
  display: inline-flex; align-items: center; gap: 5px;
  transition: opacity 0.2s, transform 0.15s;
  -webkit-tap-highlight-color: transparent;
  white-space: nowrap;
}
.btn:active { transform: scale(0.96); }
.btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; }

.btn-rx {
  background: var(--amber-soft); color: var(--amber);
  border: 1px solid rgba(245,158,11,0.3); flex: 1; justify-content: center;
}
.btn-rx:hover { background: rgba(245,158,11,0.22); }

.btn-send {
  background: linear-gradient(135deg, var(--teal), var(--teal-light));
  color: #fff; flex: 1; justify-content: center; font-size: 13px;
  box-shadow: 0 4px 14px var(--teal-glow);
}
.btn-send:hover { opacity: 0.9; }

/* â”€â”€ Empty State â”€â”€ */
.empty-state {
  text-align: center; padding: 60px 16px;
  color: var(--text-faint); animation: slideUp 0.4s ease both;
}
.empty-state-icon { font-size: 52px; margin-bottom: 14px; }
.empty-state-text { font-size: 14px; color: var(--text-dim); }
.empty-state-sub  { font-size: 12px; margin-top: 6px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL (RX) â€” bottom sheet on mobile
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-overlay {
  position: fixed; inset: 0; z-index: 500;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
  display: none; justify-content: center; align-items: flex-end;
}
@media (min-width: 600px) {
  .modal-overlay { align-items: center; padding: 20px; }
}
.modal-overlay.active { display: flex; }

.modal-box {
  background: var(--navy-mid);
  border: 1px solid var(--border-2);
  width: 100%; max-width: 680px;
  border-radius: var(--radius-lg) var(--radius-lg) 0 0;
  max-height: 90vh; display: flex; flex-direction: column;
  animation: slideUp 0.3s ease both;
}
@media (min-width: 600px) {
  .modal-box { border-radius: var(--radius-lg); max-height: 85vh; }
}

.modal-header {
  padding: 16px 18px; border-bottom: 1px solid var(--border);
  display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
}
.modal-title    { font-family: "Outfit", sans-serif; font-size: 16px; font-weight: 700; color: #fff; }
.modal-subtitle { font-size: 12px; color: var(--text-dim); margin-top: 2px; }
.btn-close {
  width: 32px; height: 32px; border-radius: 50%;
  background: var(--surface-3); border: 1px solid var(--border-2);
  color: var(--text-dim); cursor: pointer; font-size: 16px;
  display: flex; align-items: center; justify-content: center;
  transition: background 0.2s, color 0.2s;
  -webkit-tap-highlight-color: transparent;
}
.btn-close:hover { background: var(--rose-soft); color: var(--rose); }

.modal-body { padding: 16px; overflow-y: auto; flex: 1; }

.rx-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
@media (max-width: 480px) { .rx-grid { grid-template-columns: 1fr; } }

.rx-card {
  background: var(--surface);
  border: 1px solid var(--border-2);
  border-radius: var(--radius-sm); padding: 13px;
  cursor: pointer; transition: border-color 0.2s, background 0.2s;
}
.rx-card:hover { border-color: rgba(14,165,160,0.4); }
.rx-card.selected { border-color: var(--teal); background: rgba(14,165,160,0.08); }

.rx-card-top { display: flex; align-items: flex-start; gap: 9px; }
.rx-card input[type="checkbox"] { display: none; }
.rx-checkbox {
  width: 18px; height: 18px; border-radius: 5px; flex-shrink: 0; margin-top: 1px;
  border: 2px solid var(--border-2); background: var(--surface-2);
  display: flex; align-items: center; justify-content: center;
  transition: background 0.2s, border-color 0.2s;
  font-size: 11px; color: transparent;
}
.rx-card.selected .rx-checkbox { background: var(--teal); border-color: var(--teal); color: #fff; }
.rx-drug-info { flex: 1; }
.rx-cat  { font-size: 9px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; color: var(--text-faint); margin-bottom: 3px; }
.rx-name { font-size: 13px; font-weight: 600; color: var(--text); line-height: 1.3; }

.rx-fields {
  display: none; flex-direction: column; gap: 7px;
  margin-top: 11px; padding-top: 11px; border-top: 1px dashed var(--border-2);
}
.rx-card.selected .rx-fields { display: flex; }

.rx-field-row { display: flex; align-items: center; gap: 8px; }
.rx-field-label { font-size: 10px; font-weight: 700; text-transform: uppercase; color: var(--teal-light); width: 54px; flex-shrink: 0; }
.rx-field-input {
  flex: 1; padding: 6px 9px; font-size: 12px; font-family: "Sarabun", sans-serif;
  background: var(--surface-2); border: 1px solid var(--border-2);
  border-radius: var(--radius-xs); color: var(--text); outline: none;
  transition: border-color 0.2s;
}
.rx-field-input:focus { border-color: var(--teal); }
.rx-field-sm    { width: 58px; flex: none; }
.rx-field-total { width: 58px; flex: none; font-weight: 700; color: var(--rose); }

.modal-footer {
  padding: 12px 16px; border-top: 1px solid var(--border);
  display: flex; gap: 8px; flex-shrink: 0;
}
.btn-modal-cancel {
  padding: 10px 18px; font-size: 13px; font-weight: 600; font-family: "Sarabun", sans-serif;
  background: var(--surface-3); color: var(--text-dim);
  border: 1px solid var(--border-2); border-radius: var(--radius-sm); cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}
.btn-modal-save {
  flex: 1; padding: 10px 18px; font-size: 13px; font-weight: 700; font-family: "Sarabun", sans-serif;
  background: linear-gradient(135deg, var(--teal), var(--teal-light));
  color: #fff; border: none; border-radius: var(--radius-sm); cursor: pointer;
  display: flex; align-items: center; justify-content: center; gap: 6px;
  box-shadow: 0 4px 16px var(--teal-glow);
  -webkit-tap-highlight-color: transparent;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ANIMATIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@keyframes slideUp {
  from { opacity: 0; transform: translateY(18px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 640px) {
  header { height: 56px; padding: 0 14px; }
  .brand-sub { display: none; }
  .wrap { padding: 18px 12px 50px; }
  .page-title { font-size: 18px; }
  .ac-animal-name { font-size: 15px; }
}
</style>
</head>
<body>

<!-- â”€â”€ HEADER â”€â”€ -->
<header>
  <div class="brand">
    <div class="brand-logo">ğŸ’‰</div>
    <div>
      <div class="brand-name">à¸§à¸²à¸‡à¸¢à¸²à¸ªà¸¥à¸š / à¹€à¸•à¸£à¸µà¸¢à¸¡à¸•à¸±à¸§</div>
      <div class="brand-sub">RMUTTO â€“ Veterinary Academic Service Division</div>
    </div>
  </div>
  <button class="btn-home" onclick="location.href='index.html'">ğŸ  à¸«à¸™à¹‰à¸²à¸«à¸¥à¸±à¸</button>
</header>

<!-- â”€â”€ CONTENT â”€â”€ -->
<div class="wrap">

  <div class="page-header">
    <div>
      <div class="page-title">à¸£à¸²à¸¢à¸à¸²à¸£à¸£à¸­à¹€à¸•à¸£à¸µà¸¢à¸¡à¸•à¸±à¸§ / à¸§à¸²à¸‡à¸¢à¸²</div>
      <div class="page-sub">à¸Šà¸±à¹ˆà¸‡à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¸ˆà¸£à¸´à¸‡à¹à¸¥à¸°à¸„à¸³à¸™à¸§à¸“à¸¢à¸²à¸à¹ˆà¸­à¸™à¸ªà¹ˆà¸‡à¹€à¸‚à¹‰à¸²à¸«à¹‰à¸­à¸‡à¸œà¹ˆà¸²à¸•à¸±à¸”</div>
    </div>
  </div>

  <div class="section-title">à¸„à¸´à¸§à¸£à¸­à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£</div>
  <div id="anesthesia-container">
    <div class="empty-state">
      <div class="empty-state-icon">ğŸ’‰</div>
      <div class="empty-state-text">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥...</div>
    </div>
  </div>

</div>

<!-- â”€â”€ RX MODAL â”€â”€ -->
<div class="modal-overlay" id="rxModal">
  <div class="modal-box">
    <div class="modal-header">
      <div>
        <div class="modal-title">ğŸ’Š à¸ªà¸±à¹ˆà¸‡à¸ˆà¹ˆà¸²à¸¢à¸¢à¸²</div>
        <div class="modal-subtitle" id="rxModalSub"></div>
      </div>
      <button class="btn-close" onclick="closeRxModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="rx-grid" id="rxModalGrid"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-modal-cancel" onclick="closeRxModal()">à¸¢à¸à¹€à¸¥à¸´à¸</button>
      <button class="btn-modal-save"   onclick="saveNewRx()">ğŸ’¾ à¸šà¸±à¸™à¸—à¸¶à¸à¸à¸²à¸£à¸ªà¸±à¹ˆà¸‡à¸¢à¸²</button>
    </div>
  </div>
</div>

<script type="module">
import { supabase } from "./js/supabase.js";

let currentRxAnimalId = null;

/* â”€â”€ helper â”€â”€ */
function round(val) {
  const num = Math.ceil(val * 4) / 4;
  return num < 0.25 ? 0.25 : num;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOAD QUEUE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadAnesthesiaQueue() {
  const container = document.getElementById("anesthesia-container");
  try {
    const { data: eventId } = await supabase.rpc("get_today_event");
    const { data: queueData, error } = await supabase
      .from("vasd_queue")
      .select(`id, animal_id, status,
        vasd_animal(
          id, event_id, queue_number, animal_name, species, sex, est_weight, actual_weight,
          vasd_owner(owner_name),
          vasd_service(service_type)
        )`)
      .eq("status", "waiting")
      .order("created_at", { ascending: true });

    if (error) throw error;

    const animals = (queueData || []).filter(q => q.vasd_animal && q.vasd_animal.event_id === eventId);

    container.innerHTML = "";

    if (animals.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">âœ…</div>
          <div class="empty-state-text">à¹„à¸¡à¹ˆà¸¡à¸µà¸£à¸²à¸¢à¸à¸²à¸£à¸£à¸­à¹€à¸•à¸£à¸µà¸¢à¸¡à¸•à¸±à¸§à¹ƒà¸™à¸‚à¸“à¸°à¸™à¸µà¹‰</div>
          <div class="empty-state-sub">à¹€à¸¡à¸·à¹ˆà¸­à¸¡à¸µà¹€à¸„à¸ªà¹ƒà¸«à¸¡à¹ˆ à¸«à¸™à¹‰à¸²à¸ˆà¸­à¸ˆà¸°à¸­à¸±à¸›à¹€à¸”à¸•à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´</div>
        </div>`;
      return;
    }

    animals.forEach((q, idx) => {
      const a        = q.vasd_animal;
      const ownerName = a.vasd_owner?.owner_name || "à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸";
      const spText   = a.species === "à¸ª" ? "ğŸ¶ à¸ªà¸¸à¸™à¸±à¸‚" : "ğŸ± à¹à¸¡à¸§";
      const services = (a.vasd_service || []).map(s => s.service_type).join(", ") || "â€“";
      const defW     = a.actual_weight || a.est_weight || "";

      const card = document.createElement("div");
      card.className = "anes-card";
      card.style.animationDelay = `${idx * 0.07}s`;

      card.innerHTML = `
        <!-- Header -->
        <div class="ac-header">
          <div class="queue-circle">#${a.queue_number || "-"}</div>
          <div class="ac-title-block">
            <div class="ac-animal-name">${a.animal_name}</div>
            <div class="ac-meta">${spText} Â· ${a.sex} Â· à¹€à¸ˆà¹‰à¸²à¸‚à¸­à¸‡: ${ownerName}</div>
          </div>
          <span class="ac-status-pill">â³ à¸£à¸­à¸§à¸²à¸‡à¸¢à¸²</span>
        </div>

        <!-- Body -->
        <div class="ac-body">

          <!-- Info chips -->
          <div class="info-chips">
            <div class="info-chip">
              <span class="ic-label">ğŸ‘¤</span>
              <span class="ic-val">${ownerName}</span>
            </div>
            <div class="info-chip">
              <span class="ic-label">ğŸ©º</span>
              <span class="ic-val teal">${services}</span>
            </div>
          </div>

          <!-- Est weight strip -->
          <div class="est-weight-strip">
            âš–ï¸ à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¸›à¸£à¸°à¹€à¸¡à¸´à¸™ (à¸ˆà¸²à¸à¸ˆà¸¸à¸”à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™): <strong style="margin-left:4px;">${a.est_weight || "â€“"} à¸à¸.</strong>
          </div>

          <!-- Real weight input -->
          <div class="weight-row">
            <div class="field-group">
              <span class="field-label">âš–ï¸ à¸Šà¸±à¹ˆà¸‡à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¸ˆà¸£à¸´à¸‡ (à¸à¸.) *</span>
              <input
                class="f-input"
                type="number" step="0.01" min="0"
                id="weight-${a.id}"
                value="${defW}"
                placeholder="à¸à¸£à¸­à¸à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¸ˆà¸£à¸´à¸‡..."
                oninput="calculateDose('${a.id}', this.value); this.classList.toggle('filled', !!this.value)"
              >
            </div>
          </div>

          <!-- Dose calc -->
          <div class="calc-box">
            <div class="calc-box-header">ğŸ§ª à¸›à¸£à¸´à¸¡à¸²à¸“à¸¢à¸²à¹€à¸šà¸·à¹‰à¸­à¸‡à¸•à¹‰à¸™ (à¸­à¹‰à¸²à¸‡à¸­à¸´à¸‡)</div>
            <div class="calc-row">
              <span class="calc-drug">Atropine 0.6 mg/ml <small style="color:var(--text-faint);">(0.04 mg/kg)</small></span>
              <span class="calc-dose pending" id="calc-atro-${a.id}">à¸£à¸­à¸™à¹‰à¸³à¸«à¸™à¸±à¸</span>
            </div>
            <div class="calc-row">
              <span class="calc-drug">Xylazine 2% <small style="color:var(--text-faint);">(1 mg/kg)</small></span>
              <span class="calc-dose pending" id="calc-xyla-${a.id}">à¸£à¸­à¸™à¹‰à¸³à¸«à¸™à¸±à¸</span>
            </div>
            <div class="calc-row">
              <span class="calc-drug">Zoletil 50 mg/ml <small style="color:var(--text-faint);">(5 mg/kg)</small></span>
              <span class="calc-dose pending" id="calc-zole-${a.id}">à¸£à¸­à¸™à¹‰à¸³à¸«à¸™à¸±à¸</span>
            </div>
          </div>

        </div><!-- /.ac-body -->

        <!-- Footer -->
        <div class="ac-footer">
          <button class="btn btn-rx"
            onclick="openRxModal('${a.id}', '${a.animal_name}', document.getElementById('weight-${a.id}').value || '${defW}', '${a.species}')">
            ğŸ’Š à¸ªà¸±à¹ˆà¸‡à¸ˆà¹ˆà¸²à¸¢à¸¢à¸² (Rx)
          </button>
          <button class="btn btn-send" onclick="sendToSurgery('${a.id}')">
            ğŸ©º à¸ªà¹ˆà¸‡à¹€à¸‚à¹‰à¸²à¸«à¹‰à¸­à¸‡à¸œà¹ˆà¸²à¸•à¸±à¸”
          </button>
        </div>
      `;

      container.appendChild(card);
      if (defW) window.calculateDose(a.id, defW);
    });

  } catch (err) {
    console.error(err);
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-text" style="color:#fca5a5;">âŒ à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: ${err.message}</div>
      </div>`;
  }
}

/* â”€â”€ Calculate dose â”€â”€ */
window.calculateDose = function(animalId, weightStr) {
  const w = parseFloat(weightStr);
  const setVal = (id, txt, pending) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = txt;
    el.classList.toggle("pending", !!pending);
  };

  if (isNaN(w) || w <= 0) {
    setVal(`calc-atro-${animalId}`, "à¸£à¸­à¸™à¹‰à¸³à¸«à¸™à¸±à¸", true);
    setVal(`calc-xyla-${animalId}`, "à¸£à¸­à¸™à¹‰à¸³à¸«à¸™à¸±à¸", true);
    setVal(`calc-zole-${animalId}`, "à¸£à¸­à¸™à¹‰à¸³à¸«à¸™à¸±à¸", true);
    return;
  }

  setVal(`calc-atro-${animalId}`, `${((w * 0.04) / 0.6).toFixed(2)} ml`, false);
  setVal(`calc-xyla-${animalId}`, `${((w * 1) / 20).toFixed(2)} ml`, false);
  setVal(`calc-zole-${animalId}`, `${((w * 5) / 50).toFixed(2)} ml`, false);
};

/* â”€â”€ Send to surgery â”€â”€ */
window.sendToSurgery = async function(animalId) {
  const weightInput = document.getElementById(`weight-${animalId}`).value;
  if (!weightInput) {
    alert("à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¸ˆà¸£à¸´à¸‡à¸à¹ˆà¸­à¸™à¸ªà¹ˆà¸‡à¹€à¸‚à¹‰à¸²à¸«à¹‰à¸­à¸‡à¸œà¹ˆà¸²à¸•à¸±à¸”");
    document.getElementById(`weight-${animalId}`).focus();
    return;
  }
  if (!confirm("à¸¢à¸·à¸™à¸¢à¸±à¸™à¸à¸²à¸£à¸ªà¹ˆà¸‡à¸ªà¸±à¸•à¸§à¹Œà¹€à¸‚à¹‰à¸²à¸«à¹‰à¸­à¸‡à¸œà¹ˆà¸²à¸•à¸±à¸”?\nà¸£à¸°à¸šà¸šà¸ˆà¸°à¸­à¸±à¸›à¹€à¸”à¸•à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¸ˆà¸£à¸´à¸‡à¹à¸¥à¸°à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸ªà¸–à¸²à¸™à¸°")) return;

  try {
    await supabase.from("vasd_animal").update({ actual_weight: parseFloat(weightInput) }).eq("id", animalId);
    const { error } = await supabase.from("vasd_queue").update({ status: "surgery", updated_at: new Date() }).eq("animal_id", animalId);
    if (error) throw error;
    loadAnesthesiaQueue();
  } catch (err) {
    alert("âŒ à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”: " + err.message);
  }
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RX MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.openRxModal = function(animalId, animalName, w, species) {
  currentRxAnimalId = animalId;
  w = parseFloat(w) || 0;
  document.getElementById("rxModalSub").textContent = `${animalName} Â· à¸™à¹‰à¸³à¸«à¸™à¸±à¸ ${w} à¸à¸.`;

  const drugs = [
    { id:"dox",   cat:"Antibiotic",    name:"Doxycycline 100 mg",   tabs: round((w*10)/100), freq:"à¸§à¸±à¸™à¸¥à¸° 1 à¸„à¸£à¸±à¹‰à¸‡ à¸«à¸¥à¸±à¸‡à¸­à¸²à¸«à¸²à¸£",   f_num:1, days:14 },
    { id:"n200",  cat:"Antibiotic",    name:"Norfloxacin 200 mg",   tabs: round((w*20)/200), freq:"à¸§à¸±à¸™à¸¥à¸° 2 à¸„à¸£à¸±à¹‰à¸‡ à¹€à¸Šà¹‰à¸²-à¹€à¸¢à¹‡à¸™",   f_num:2, days:7  },
    { id:"n100",  cat:"Antibiotic",    name:"Norfloxacin 100 mg",   tabs: round((w*20)/100), freq:"à¸§à¸±à¸™à¸¥à¸° 2 à¸„à¸£à¸±à¹‰à¸‡ à¹€à¸Šà¹‰à¸²-à¹€à¸¢à¹‡à¸™",   f_num:2, days:7  },
    { id:"t60",   cat:"NSAID",         name:"Tolfedine 60 mg",      tabs: round((w*4)/60),   freq:"à¸§à¸±à¸™à¸¥à¸° 1 à¸„à¸£à¸±à¹‰à¸‡ à¸«à¸¥à¸±à¸‡à¸­à¸²à¸«à¸²à¸£",   f_num:1, days:3  },
    { id:"t6",    cat:"NSAID",         name:"Tolfedine 6 mg",       tabs: round((w*4)/6),    freq:"à¸§à¸±à¸™à¸¥à¸° 1 à¸„à¸£à¸±à¹‰à¸‡ à¸«à¸¥à¸±à¸‡à¸­à¸²à¸«à¸²à¸£",   f_num:1, days:3  },
    { id:"fbc",   cat:"Blood support", name:"FBC à¸šà¸³à¸£à¸¸à¸‡à¹€à¸¥à¸·à¸­à¸”",       tabs: w >= 10 ? 1 : 0.5, freq:"à¸§à¸±à¸™à¸¥à¸° 1 à¸„à¸£à¸±à¹‰à¸‡ à¸«à¸¥à¸±à¸‡à¸­à¸²à¸«à¸²à¸£",   f_num:1, days:14 },
    { id:"cstm",  cat:"à¸­à¸·à¹ˆà¸™à¹†",         name:"",                     tabs: 1,                 freq:"à¸§à¸±à¸™à¸¥à¸° 1 à¸„à¸£à¸±à¹‰à¸‡",              f_num:1, days:5, isCustom: true },
  ];

  document.getElementById("rxModalGrid").innerHTML = drugs.map(d => `
    <div class="rx-card" id="rxcard-${d.id}" onclick="toggleRx('${d.id}')">
      <div class="rx-card-top">
        <input type="checkbox" id="rxchk-${d.id}" data-name="${d.name}">
        <div class="rx-checkbox" id="rxbox-${d.id}">âœ“</div>
        <div class="rx-drug-info">
          <div class="rx-cat">${d.cat}</div>
          ${d.isCustom
            ? `<input class="f-input" type="text" id="custom-name-${d.id}" placeholder="à¸à¸´à¸¡à¸à¹Œà¸Šà¸·à¹ˆà¸­à¸¢à¸²..." style="font-size:12px;margin-top:4px;padding:7px 9px;" onclick="event.stopPropagation()">`
            : `<div class="rx-name">${d.name}</div>`}
        </div>
      </div>
      <div class="rx-fields">
        <div class="rx-field-row">
          <span class="rx-field-label">à¸›à¸£à¸´à¸¡à¸²à¸“</span>
          <input class="rx-field-input" id="rxdose-${d.id}" value="à¸›à¹‰à¸­à¸™à¸„à¸£à¸±à¹‰à¸‡à¸¥à¸° ${d.tabs} à¹€à¸¡à¹‡à¸”" oninput="recalcRx('${d.id}',${d.f_num})">
        </div>
        <div class="rx-field-row">
          <span class="rx-field-label">à¸„à¸§à¸²à¸¡à¸–à¸µà¹ˆ</span>
          <input class="rx-field-input" id="rxfreq-${d.id}" value="${d.freq}" oninput="recalcRx('${d.id}',${d.f_num})">
        </div>
        <div class="rx-field-row">
          <span class="rx-field-label">à¸ˆà¸™.à¸§à¸±à¸™</span>
          <input class="rx-field-input rx-field-sm" type="number" id="rxdays-${d.id}" value="${d.days}" oninput="recalcRx('${d.id}',${d.f_num})">
          <span class="rx-field-label" style="color:var(--text-dim);margin-left:6px;">à¸£à¸§à¸¡</span>
          <input class="rx-field-input rx-field-total" type="number" id="rxtotal-${d.id}" value="${Math.ceil(d.tabs * d.f_num * d.days)}">
        </div>
      </div>
    </div>`).join("");

  document.getElementById("rxModal").classList.add("active");
};

window.toggleRx = function(did) {
  const card = document.getElementById(`rxcard-${did}`);
  const chk  = document.getElementById(`rxchk-${did}`);
  chk.checked = !chk.checked;
  card.classList.toggle("selected", chk.checked);
};

window.recalcRx = function(did, fNum) {
  const dose = parseFloat((document.getElementById(`rxdose-${did}`).value || "").match(/[\d.]+/)?.[0]) || 0;
  const freq = parseFloat((document.getElementById(`rxfreq-${did}`).value || "").match(/[\d.]+/)?.[0]) || fNum || 1;
  const days = parseFloat(document.getElementById(`rxdays-${did}`).value) || 0;
  document.getElementById(`rxtotal-${did}`).value = Math.ceil(dose * freq * days);
};

window.closeRxModal = function() {
  document.getElementById("rxModal").classList.remove("active");
  currentRxAnimalId = null;
};

window.saveNewRx = async function() {
  if (!currentRxAnimalId) return;
  const checked = [...document.querySelectorAll(`input[id^="rxchk-"]:checked`)];
  if (checked.length === 0) return alert("à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¸¢à¸²à¸­à¸¢à¹ˆà¸²à¸‡à¸™à¹‰à¸­à¸¢ 1 à¸£à¸²à¸¢à¸à¸²à¸£");

  const rxInserts = checked.map(el => {
    const did = el.id.replace("rxchk-", "");
    let drugName = el.dataset.name;
    if (did === "cstm") {
      const cn = document.getElementById(`custom-name-${did}`);
      drugName = cn?.value.trim() || "à¸¢à¸²à¹€à¸à¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡";
    }
    return {
      animal_id:   currentRxAnimalId,
      drug_id:     drugName,
      dose:        document.getElementById(`rxdose-${did}`).value,
      freq:        document.getElementById(`rxfreq-${did}`).value,
      days:        parseInt(document.getElementById(`rxdays-${did}`).value) || 5,
      total_pills: parseFloat(document.getElementById(`rxtotal-${did}`).value) || 0,
    };
  });

  const { error } = await supabase.from("vasd_prescription").insert(rxInserts);
  if (error) alert("âŒ à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: " + error.message);
  else { alert("âœ… à¸šà¸±à¸™à¸—à¸¶à¸à¸à¸²à¸£à¸ªà¸±à¹ˆà¸‡à¸¢à¸²à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢ à¸ªà¹ˆà¸‡à¹„à¸›à¸—à¸µà¹ˆà¸«à¹‰à¸­à¸‡à¸ˆà¹ˆà¸²à¸¢à¸¢à¸²à¹à¸¥à¹‰à¸§"); closeRxModal(); }
};

/* â”€â”€ Real-time â”€â”€ */
supabase.channel("vasd-anesthesia-live")
  .on("postgres_changes", { event: "*", schema: "public", table: "vasd_queue" }, loadAnesthesiaQueue)
  .subscribe();

loadAnesthesiaQueue();
</script>
</body>
</html>
