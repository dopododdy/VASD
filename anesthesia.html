<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>วางยาสลบ – VASD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* ═══════════════════════════════════════════
   TOKENS
═══════════════════════════════════════════ */
:root {
  --navy:         #0b1929;
  --navy-mid:     #112240;
  --teal:         #0ea5a0;
  --teal-light:   #14c4bc;
  --teal-glow:    rgba(14,165,160,0.25);
  --amber:        #f59e0b;
  --amber-soft:   rgba(245,158,11,0.14);
  --rose:         #ef4444;
  --rose-soft:    rgba(239,68,68,0.12);
  --emerald:      #10b981;
  --emerald-soft: rgba(16,185,129,0.12);
  --slate-400:    #94a3b8;
  --slate-300:    #cbd5e1;
  --white:        #ffffff;
  --radius-lg:    20px;
  --radius-md:    12px;
  --radius-sm:    8px;
  --shadow-sm:    0 4px 20px rgba(0,0,0,0.2);
  --font-main:    'Outfit', 'Sarabun', sans-serif;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
  margin: 0; padding: 0;
  background-color: var(--navy);
  color: var(--white);
  font-family: var(--font-main);
  line-height: 1.5;
  padding-bottom: 80px;
}

/* ═══════════════════════════════════════════
   LAYOUT
═══════════════════════════════════════════ */
.top-nav {
  position: sticky; top: 0; z-index: 100;
  background: rgba(11, 25, 41, 0.85);
  backdrop-filter: blur(12px);
  padding: 16px 20px;
  display: flex; align-items: center; justify-content: space-between;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}
.nav-title { font-size: 20px; font-weight: 800; color: var(--teal-light); letter-spacing: -0.5px; }

.container { padding: 16px; max-width: 600px; margin: 0 auto; }

/* ═══════════════════════════════════════════
   QUEUE CARD
═══════════════════════════════════════════ */
.anesthesia-card {
  background: var(--navy-mid);
  border-radius: var(--radius-lg);
  margin-bottom: 20px;
  overflow: hidden;
  border: 1px solid rgba(255,255,255,0.06);
  box-shadow: var(--shadow-sm);
  animation: fadeIn 0.4s ease-out;
}
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

.ac-header {
  padding: 16px 20px;
  background: rgba(255,255,255,0.03);
  display: flex; justify-content: space-between; align-items: center;
}
.q-num { font-size: 24px; font-weight: 800; color: var(--teal-light); }
.animal-name { font-size: 18px; font-weight: 700; color: var(--white); }

.ac-body { padding: 20px; }

.info-chips { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
.chip {
  padding: 4px 12px; border-radius: 50px; font-size: 12px; font-weight: 600;
  background: rgba(255,255,255,0.08); color: var(--slate-300);
}

/* Health Note Display */
.health-note-strip {
  display: flex; align-items: flex-start; gap: 10px;
  background: var(--rose-soft); 
  border: 1px solid rgba(239,68,68,0.2);
  border-radius: var(--radius-sm); 
  padding: 12px 14px;
  font-size: 14px; color: var(--rose);
  margin-bottom: 12px;
}

.est-weight-strip {
  background: var(--amber-soft);
  border-radius: var(--radius-sm);
  padding: 10px 14px;
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 16px;
}
.est-label { font-size: 11px; color: var(--amber); font-weight: 800; text-transform: uppercase; }
.est-val { font-size: 15px; font-weight: 700; color: var(--amber); }

/* Weight Input */
.input-label { display: block; font-size: 13px; font-weight: 600; color: var(--slate-400); margin-bottom: 8px; }
.weight-input {
  width: 100%; background: rgba(0,0,0,0.2); border: 2px solid rgba(255,255,255,0.1);
  border-radius: var(--radius-md); padding: 14px 16px; color: var(--white);
  font-size: 20px; font-weight: 800; transition: all 0.2s;
  margin-bottom: 20px;
}
.weight-input:focus { border-color: var(--teal); outline: none; background: rgba(14,165,160,0.05); }

/* Drug Table */
.drug-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
.drug-table th { text-align: left; font-size: 11px; text-transform: uppercase; color: var(--slate-400); padding: 8px 4px; border-bottom: 1px solid rgba(255,255,255,0.05); }
.drug-table td { padding: 12px 4px; font-size: 14px; border-bottom: 1px solid rgba(255,255,255,0.03); }
.drug-name { font-weight: 700; color: var(--slate-300); }
.drug-calc { font-weight: 800; color: var(--teal-light); text-align: right; font-size: 16px; }

/* Buttons */
.btn-primary {
  width: 100%; background: var(--teal); color: var(--navy); border: none;
  padding: 16px; border-radius: var(--radius-md); font-size: 16px; font-weight: 800;
  display: flex; align-items: center; justify-content: center; gap: 8px;
  cursor: pointer; transition: transform 0.1s;
}
.btn-primary:active { transform: scale(0.97); }

/* Loading State */
#loading-overlay {
  position: fixed; inset: 0; background: var(--navy); z-index: 1000;
  display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px;
}
.spinner { width: 40px; height: 40px; border: 4px solid rgba(14,165,160,0.1); border-top-color: var(--teal); border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

</style>
</head>
<body>

<div id="loading-overlay">
  <div class="spinner"></div>
  <div style="font-weight:600; color:var(--teal-light)">กำลังดึงข้อมูลคิววางยา...</div>
</div>

<nav class="top-nav">
  <div class="nav-title">ANESTHESIA</div>
  <div id="user-display" style="font-size: 12px; color: var(--slate-400);"></div>
</nav>

<div class="container" id="anesthesia-container">
  </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script type="module">
import { SUPABASE_URL, SUPABASE_KEY } from './config.js';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const container = document.getElementById("anesthesia-container");
const loading = document.getElementById("loading-overlay");

async function loadAnesthesiaQueue() {
  try {
    const { data: queueData, error } = await supabase
      .from("vasd_queue")
      .select(`
        id, animal_id, status,
        vasd_animal(
          id, queue_number, animal_name, species, sex, est_weight, actual_weight,
          health_note,
          vasd_owner(owner_name),
          vasd_service(service_type)
        )
      `)
      .eq("status", "waiting")
      .order("created_at", { ascending: true });

    if (error) throw error;

    // ซ่อน Loading ทันทีเมื่อดึงข้อมูลสำเร็จ
    loading.style.display = "none";

    if (!queueData || queueData.length === 0) {
      container.innerHTML = `
        <div style="text-align:center; padding:60px 20px; color:var(--slate-400);">
          <div style="font-size: 40px; margin-bottom: 10px;">✅</div>
          <div>ไม่มีเคสรอวางยาในขณะนี้</div>
        </div>
      `;
      return;
    }

    container.innerHTML = "";
    queueData.forEach(q => {
      const a = q.vasd_animal;
      const animalId = a.id;
      
      const card = document.createElement("div");
      card.className = "anesthesia-card";

      // logic แสดงบันทึกสุขภาพ
      const noteMarkup = a.health_note 
        ? `<div class="health-note-strip">
             <span style="font-size:18px;">⚠️</span>
             <div>
               <div style="font-size:10px; font-weight:800; text-transform:uppercase; opacity:0.8;">ระวังพิเศษ / บันทึกสุขภาพ</div>
               <div style="font-weight:700;">${a.health_note}</div>
             </div>
           </div>`
        : "";

      card.innerHTML = `
        <div class="ac-header">
          <div class="q-num">#${a.queue_number || '??'}</div>
          <div class="animal-name">${a.animal_name}</div>
        </div>
        
        <div class="ac-body">
          <div class="info-chips">
            <div class="chip">${a.species || 'ไม่ระบุ'}</div>
            <div class="chip">${a.sex || '-'}</div>
            <div class="chip">${a.vasd_service?.service_type || 'General'}</div>
          </div>

          ${noteMarkup}

          <div class="est-weight-strip">
            <span class="est-label">น้ำหนักแจ้ง (Est.)</span>
            <span class="est-val">${a.est_weight || '??'} kg</span>
          </div>

          <label class="input-label">ระบุน้ำหนักจริง (Actual Weight)</label>
          <input type="number" step="0.01" class="weight-input" 
            id="weight-${animalId}" 
            placeholder="0.00"
            value="${a.actual_weight || ''}"
            oninput="window.calcDrugs('${animalId}')">

          <table class="drug-table">
            <thead>
              <tr><th>Drug List</th><th style="text-align:right">Dose (ml)</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><span class="drug-name">Atropine</span><br><small>0.04 mg/kg (1mg/ml)</small></td>
                <td class="drug-calc" id="calc-atro-${animalId}">-</td>
              </tr>
              <tr>
                <td><span class="drug-name">Xylazine</span><br><small>1 mg/kg (20mg/ml)</small></td>
                <td class="drug-calc" id="calc-xyla-${animalId}">-</td>
              </tr>
              <tr>
                <td><span class="drug-name">Zoletil</span><br><small>3 mg/kg (100mg/ml)</small></td>
                <td class="drug-calc" id="calc-zole-${animalId}">-</td>
              </tr>
            </tbody>
          </table>

          <button class="btn-primary" onclick="window.sendToSurgery('${animalId}')">
            <span>ส่งเข้าโต๊ะผ่าตัด</span>
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M5 12h14m-7-7l7 7-7 7"></path></svg>
          </button>
        </div>
      `;
      container.appendChild(card);
      if(a.actual_weight) window.calcDrugs(animalId);
    });

  } catch (err) {
    console.error("Critical Error:", err);
    loading.style.display = "none"; // ปิด Loading แม้จะพังเพื่อให้เห็น Error
    container.innerHTML = `
      <div style="background:var(--rose-soft); padding:20px; border-radius:12px; color:var(--rose); border:1px solid var(--rose);">
        <strong>เกิดข้อผิดพลาดในการโหลดข้อมูล:</strong><br>
        <small>${err.message}</small><br><br>
        <button onclick="location.reload()" style="background:var(--rose); color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer;">ลองใหม่อีกครั้ง</button>
      </div>
    `;
  }
}

/* ── Logic ── */
window.calcDrugs = function(animalId) {
  const w = parseFloat(document.getElementById(`weight-${animalId}`).value);
  const setV = (id, val) => {
    const el = document.getElementById(id);
    if(el) {
      el.innerText = val ? val + " ml" : "-";
      el.style.color = val ? "var(--teal-light)" : "var(--slate-400)";
    }
  };

  if (!w || w <= 0) {
    ["calc-atro-", "calc-xyla-", "calc-zole-"].forEach(p => setV(p + animalId, null));
    return;
  }

  setV(`calc-atro-${animalId}`, ((w * 0.04) / 1).toFixed(2));
  setV(`calc-xyla-${animalId}`, ((w * 1) / 20).toFixed(2));
  setV(`calc-zole-${animalId}`, ((w * 3) / 100).toFixed(2));
};

window.sendToSurgery = async function(animalId) {
  const weight = document.getElementById(`weight-${animalId}`).value;
  if (!weight) return alert("กรุณาระบุน้ำหนักจริง");
  
  if (!confirm("ยืนยันการส่งเข้าผ่าตัด?")) return;

  try {
    // อัปเดตน้ำหนัก
    await supabase.from("vasd_animal").update({ actual_weight: parseFloat(weight) }).eq("id", animalId);
    // เปลี่ยนสถานะคิว
    const { error } = await supabase.from("vasd_queue").update({ 
      status: "surgery", 
      updated_at: new Date() 
    }).eq("animal_id", animalId);

    if (error) throw error;
    loadAnesthesiaQueue();
  } catch (err) {
    alert("Error: " + err.message);
  }
};

// Init
loadAnesthesiaQueue();

// Realtime
supabase.channel('anes-live')
  .on('postgres_changes', { event: '*', schema: 'public', table: 'vasd_queue' }, loadAnesthesiaQueue)
  .subscribe();

</script>
</body>
</html>
