<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>RMUTTO - VASD | ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --navy:#0d1b2a; --teal:#1a6b72; --teal-light:#22919a; --accent:#00d4aa;
  --bg:#f0f4f8; --surface:#fff; --text:#1a202c; --text-muted:#718096;
  --border:#e2e8f0; --danger:#e53e3e; --success:#38a169; --warning:#d69e2e;
  --orange:#dd6b20; --purple:#6b46c1; --blue:#3182ce;
  --shadow-sm:0 1px 3px rgba(0,0,0,0.06); --shadow-md:0 4px 16px rgba(13,27,42,0.08);
  --radius:14px; --radius-sm:8px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{font-family:"Sarabun",sans-serif;background:var(--bg);color:var(--text);
  min-height:100vh;display:flex;flex-direction:column;}

/* ‚îÄ‚îÄ‚îÄ HEADER & TAB ‚îÄ‚îÄ‚îÄ */
header{
  background:var(--navy);padding:0 28px;display:flex;
  justify-content:space-between;align-items:center;height:64px;
  flex-shrink:0;box-shadow:0 2px 20px rgba(0,0,0,0.25);z-index:200;
}
.header-brand{display:flex;align-items:center;gap:12px;}
.brand-icon{
  width:38px;height:38px;background:linear-gradient(135deg,var(--teal-light),var(--accent));
  border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;
}
.brand-text h1{font-size:16px;font-weight:700;color:#fff;line-height:1.2;}
.brand-text span{font-size:11px;color:rgba(255,255,255,0.5);}
.btn-home{
  padding:7px 14px;font-size:13px;font-weight:600;font-family:"Sarabun",sans-serif;
  background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.85);
  border:1px solid rgba(255,255,255,0.2);border-radius:var(--radius-sm);cursor:pointer;
}
.btn-home:hover{background:rgba(255,255,255,0.18);}

.tab-bar{
  background:var(--surface);border-bottom:2px solid var(--border);
  display:flex;flex-shrink:0;padding:0 28px;
}
.tab-btn{
  padding:14px 20px;font-size:14px;font-weight:600;font-family:"Sarabun",sans-serif;
  background:none;border:none;border-bottom:3px solid transparent;margin-bottom:-2px;
  cursor:pointer;color:var(--text-muted);transition:all 0.2s;display:flex;align-items:center;gap:7px;
}
.tab-btn:hover{color:var(--navy);}
.tab-btn.active{color:var(--teal-light);border-bottom-color:var(--teal-light);}
.tab-badge{
  background:var(--danger);color:#fff;font-size:11px;font-weight:700;
  padding:1px 7px;border-radius:20px;min-width:20px;text-align:center;
}

.tab-pane{display:none;flex:1;overflow-y:auto;padding:24px 28px;}
.tab-pane.active{display:block;}
.section-label{
  font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;
  color:var(--text-muted);margin-bottom:12px;
}
.empty{text-align:center;padding:56px 20px;color:var(--text-muted);
  background:var(--surface);border-radius:var(--radius);border:1px solid var(--border);}
.empty-icon{font-size:44px;margin-bottom:10px;}

/* ‚îÄ‚îÄ‚îÄ QUEUE CARD ‚îÄ‚îÄ‚îÄ */
.queue-card{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
  box-shadow:var(--shadow-sm);margin-bottom:16px;overflow:hidden;transition:box-shadow 0.2s;
}
.queue-card:hover{box-shadow:var(--shadow-md);}
.qcard-header{
  background:linear-gradient(135deg,var(--navy),#1a2f47);
  padding:14px 20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;
}
.qcard-title{font-size:16px;font-weight:700;color:#fff;margin-bottom:6px;}
.qcard-meta{display:flex;gap:6px;flex-wrap:wrap;}
.meta-tag{font-size:11px;color:rgba(255,255,255,0.75);background:rgba(255,255,255,0.12);
  border:1px solid rgba(255,255,255,0.15);border-radius:20px;padding:2px 9px;}
.qcard-body{padding:18px 20px;}

.weight-row{display:flex;align-items:center;gap:10px;margin-bottom:16px;flex-wrap:wrap;}
.weight-row label{font-size:13px;font-weight:600;color:var(--text);white-space:nowrap;}
.weight-input{
  width:100px;padding:8px 10px;font-size:15px;font-weight:700;font-family:"Sarabun",sans-serif;
  border:2px solid var(--teal-light);border-radius:var(--radius-sm);color:var(--navy);text-align:center;outline:none;
}
.weight-input:focus{box-shadow:0 0 0 3px rgba(34,145,154,0.15);}
.species-tag{font-size:12px;background:#edf2f7;color:var(--text-muted);border-radius:6px;padding:4px 10px;font-weight:600;}

.drug-section-title{font-size:12px;font-weight:700;letter-spacing:0.5px;color:var(--text-muted);
  margin-bottom:8px;text-transform:uppercase;}
.drug-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;margin-bottom:16px;}
.drug-card{background:linear-gradient(135deg,#f8fafc,#f0f4f8);border:1px solid var(--border);
  border-radius:var(--radius-sm);padding:12px 14px;}
.drug-name{font-size:12px;font-weight:700;color:var(--text-muted);margin-bottom:2px;}
.drug-conc{font-size:10px;color:var(--text-muted);}
.drug-dose{font-size:22px;font-weight:700;color:var(--navy);line-height:1;margin:6px 0 2px;}
.drug-unit{font-size:12px;color:var(--teal-light);font-weight:600;}

.assign-row{display:flex;align-items:center;gap:10px;padding-top:14px;
  border-top:1px solid var(--border);flex-wrap:wrap;}
.assign-row label{font-size:13px;font-weight:600;color:var(--text);}
.assign-select{padding:8px 12px;font-size:13px;font-family:"Sarabun",sans-serif;
  border:1px solid var(--border);border-radius:var(--radius-sm);outline:none;min-width:130px;}

.btn{padding:8px 18px;font-size:13px;font-weight:700;font-family:"Sarabun",sans-serif;
  border:none;border-radius:var(--radius-sm);cursor:pointer;
  transition:opacity 0.2s,transform 0.15s;display:inline-flex;align-items:center;gap:6px;}
.btn:hover{opacity:0.87;transform:translateY(-1px);}
.btn-assign{background:linear-gradient(135deg,var(--orange),#f6ad55);color:#fff;}
.btn-start{background:linear-gradient(135deg,var(--teal),var(--accent));color:#fff;}
.btn-danger{background:linear-gradient(135deg,var(--danger),#fc8181);color:#fff;}
.btn-secondary{background:#edf2f7;color:var(--text);}
.btn-sm{padding:5px 12px;font-size:12px;}

/* ‚îÄ‚îÄ‚îÄ TABLE GRID (tab2) ‚îÄ‚îÄ‚îÄ */
.tables-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
.tables-header h2{font-size:20px;font-weight:700;color:var(--navy);}
.table-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:8px;margin-bottom:22px;}
.table-tile{
  background:var(--surface);border:2px solid var(--border);border-radius:var(--radius-sm);
  padding:12px 8px;text-align:center;cursor:pointer;transition:all 0.2s;
}
.table-tile:hover{border-color:var(--teal-light);box-shadow:var(--shadow-md);}
.table-tile.occupied{border-color:#feb2b2;background:#fff5f5;}
.table-tile.selected-tile{border-color:var(--teal-light);background:#e6f6f4;box-shadow:0 0 0 3px rgba(34,145,154,0.2);}
.table-num{font-size:18px;font-weight:800;color:var(--navy);margin-bottom:3px;}
.table-animal-name{font-size:11px;font-weight:600;color:var(--danger);line-height:1.3;}
.table-empty-lbl{font-size:11px;color:var(--text-muted);}

/* ‚îÄ‚îÄ‚îÄ SURGERY PANEL ‚îÄ‚îÄ‚îÄ */
.surgery-panel{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
  box-shadow:var(--shadow-md);overflow:hidden;}
.spanel-header{background:linear-gradient(135deg,var(--navy),#1a2f47);
  padding:16px 22px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;}
.spanel-title{color:#fff;font-size:17px;font-weight:700;}
.spanel-sub{color:rgba(255,255,255,0.6);font-size:12px;margin-top:3px;}
.spanel-body{padding:20px 22px;}

.health-alert {
  background-color: #fef2f2; border-left: 4px solid var(--danger); padding: 12px 16px; 
  margin-bottom: 16px; border-radius: 4px; display:flex; flex-direction: column; gap: 4px;
}
.health-alert strong { color: var(--danger); font-size: 13px; }
.health-alert p { color: #7f1d1d; font-size: 13px; margin: 0; }

.surgeon-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px;}
@media(max-width:600px){.surgeon-grid{grid-template-columns:1fr;}}
.field{display:flex;flex-direction:column;gap:4px;}
.field label{font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;}
.field input{padding:9px 12px;font-size:13px;font-family:"Sarabun",sans-serif;
  border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);outline:none;}
.field input:focus{border-color:var(--teal-light);box-shadow:0 0 0 3px rgba(34,145,154,0.12);}

/* ‚îÄ‚îÄ‚îÄ VITALS TABLE ‚îÄ‚îÄ‚îÄ */
.vitals-toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.vitals-log{background:#fafbfc;border:1px solid var(--border);border-radius:var(--radius-sm);
  max-height:260px;overflow-y:auto;margin-bottom:14px;}

.vitals-table { width: 100%; border-collapse: collapse; font-size: 13px; text-align: center; }
.vitals-table th { background: #f0f4f8; padding: 10px 8px; color: var(--text-muted); font-weight: 700; border-bottom: 2px solid var(--border); letter-spacing: 0.3px; }
.vitals-table th:first-child { text-align: left; }
.vitals-table td { padding: 8px 6px; border-bottom: 1px solid var(--border); color: var(--navy); font-weight: 600; vertical-align: middle; }
.vitals-table td:first-child { text-align: left; color: var(--text-muted); font-size: 11px; font-weight: 700; }
.vitals-table tr:last-child td { border-bottom: none; }
.vitals-table tr.is-form { background: #f0fdf9; }

.vi{width:100%; padding:5px; font-size:12px; font-family:"Sarabun",sans-serif;
  border:1px solid var(--border); border-radius:5px; text-align:center; outline:none; box-sizing:border-box;}
.vi-note { text-align: left; }
.vi:focus{border-color:var(--teal-light);}
.btn-vi-save { background: var(--teal); color: #fff; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-family:"Sarabun",sans-serif; font-size: 12px; font-weight: bold; }
.btn-vi-save:hover { background: var(--teal-light); }

/* ‚îÄ‚îÄ‚îÄ PRESCRIPTION ‚îÄ‚îÄ‚îÄ */
.rx-section{border-top:1px solid var(--border);padding-top:16px;margin-top:16px;}
.rx-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;}
@media(max-width:560px){.rx-grid{grid-template-columns:1fr;}}
.rx-card{border:2px solid var(--border);border-radius:var(--radius-sm);padding:12px;
  cursor:pointer;transition:all 0.2s;}
.rx-card.selected{border-color:var(--teal-light);background:#e6f6f4;}
.rx-card label{display:flex;align-items:flex-start;gap:10px;cursor:pointer;}
.rx-card input[type="checkbox"]{width:16px;height:16px;accent-color:var(--teal-light);flex-shrink:0;margin-top:2px;}
.rx-cat{font-size:10px;font-weight:700;letter-spacing:0.5px;text-transform:uppercase;color:var(--text-muted);margin-bottom:3px;}
.rx-name{font-size:13px;font-weight:700;color:var(--navy);}

.rx-custom-inputs { display: none; flex-direction: column; gap: 8px; margin-top: 10px; padding-left: 26px; }
.rx-input-group { display: flex; align-items: center; gap: 8px; }
.rx-input-group label { font-size: 11px; color: var(--teal); font-weight:600; width: 45px; flex-shrink: 0; }
.rx-input-group input { flex: 1; padding: 6px 10px; font-size: 12px; font-family:"Sarabun",sans-serif; border: 1px solid var(--border); border-radius: 4px; outline:none; }
.rx-input-group input:focus{border-color:var(--teal-light);}

.divider{border:none;border-top:1px solid var(--border);margin:16px 0;}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}
.animate{animation:fadeUp 0.3s ease both;}
</style>
</head>
<body>

<header>
  <div class="header-brand">
    <div class="brand-icon">ü©∫</div>
    <div class="brand-text">
      <h1>‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î</h1>
      <span>RMUTTO ‚Äì Veterinary Academic Service Division</span>
    </div>
  </div>
  <button class="btn-home" onclick="location.href='index.html'">üè† ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
</header>

<div class="tab-bar">
  <button class="tab-btn active" id="tab-btn-central" onclick="switchTab('central')">
    üíâ ‡πÇ‡∏ï‡πä‡∏∞‡∏Å‡∏•‡∏≤‡∏á (‡∏ß‡∏≤‡∏á‡∏¢‡∏≤‡∏™‡∏•‡∏ö)
    <span class="tab-badge" id="badge-central">0</span>
  </button>
  <button class="tab-btn" id="tab-btn-tables" onclick="switchTab('tables')">
    üî™ ‡πÇ‡∏ï‡πä‡∏∞‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î (20 ‡πÇ‡∏ï‡πä‡∏∞)
    <span class="tab-badge" id="badge-tables" style="background:var(--orange);">0</span>
  </button>
</div>

<div class="tab-pane active" id="tab-central">
  <div class="section-label">‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏£‡∏≠‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î ‚Äî ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≤‡∏ß‡∏≤‡∏á‡∏™‡∏•‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</div>
  <div id="central-list"></div>
</div>

<div class="tab-pane" id="tab-tables">
  <div class="tables-header">
    <h2>‡πÇ‡∏ï‡πä‡∏∞‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î</h2>
    <span style="font-size:13px;color:var(--text-muted);">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÇ‡∏ï‡πä‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span>
  </div>
  <div class="table-grid" id="table-grid"></div>
  <div id="surgery-detail"></div>
</div>

<script type="module">
import { supabase } from "./js/supabase.js";

/* ‚îÄ‚îÄ REFERENCE RANGES ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö VITALS (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà) ‚îÄ‚îÄ */
const VITAL_REFS = {
  hr:   { min: 70, max: 160 },   // Heart Rate (bpm)
  rr:   { min: 10, max: 40 },    // Respiratory Rate (bpm)
  spo2: { min: 95, max: 100 },   // SpO2 (%)
  bt:   { min: 99, max: 102.5 }  // Body Temp (¬∞F)
};

function getVitalColor(key, val) {
  const num = parseFloat(val);
  if (isNaN(num)) return "var(--navy)";
  const ref = VITAL_REFS[key];
  if (!ref) return "var(--navy)";
  
  if (num < ref.min) return "var(--blue)";     // ‡∏™‡∏µ‡∏ü‡πâ‡∏≤ (‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå)
  if (num > ref.max) return "var(--danger)";   // ‡∏™‡∏µ‡πÅ‡∏î‡∏á (‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå)
  return "var(--navy)";                        // ‡∏™‡∏µ‡∏î‡∏≥/‡∏Å‡∏£‡∏° (‡∏õ‡∏Å‡∏ï‡∏¥)
}

/* ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ */
const nowStr = () => new Date().toLocaleTimeString("th-TH",{hour:"2-digit",minute:"2-digit"});
const fmt2 = v => (isNaN(v)||v<=0) ? "‚Äì" : v.toFixed(2);

function calcDrugs(w, species) {
  const isdog = species === "‡∏™";
  const zol_rate = isdog ? 7 : 10;
  return {
    xyl_ml: (w * 1) / 20,
    zol_ml: (w * zol_rate) / 100,
    pen_ml: w / 10,
    tolf_ml: (w * 4) / 40,
    zol_rate
  };
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡∏•‡∏∞ 1/4 ‡πÄ‡∏°‡πá‡∏î (0.25, 0.5, 0.75, 1, 1.25 ...)
function round(val) {
  return Math.ceil(val * 4) / 4;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
window.recalcTotalRx = function(aid, did) {
  const doseStr = document.getElementById(`rxdose-${aid}-${did}`).value;
  const freqStr = document.getElementById(`rxfreq-${aid}-${did}`).value;
  const daysStr = document.getElementById(`rxdays-${aid}-${did}`).value;

  const doseMatch = doseStr.match(/[\d.]+/);
  const dose = doseMatch ? parseFloat(doseMatch[0]) : 0;
  
  const freqMatch = freqStr.match(/[\d.]+/);
  const freq = freqMatch ? parseFloat(freqMatch[0]) : 0;
  
  const days = parseFloat(daysStr) || 0;

  const total = dose * freq * days;
  document.getElementById(`rxtotal-${aid}-${did}`).value = total;
};

/* ‚îÄ‚îÄ STATE ‚îÄ‚îÄ */
let centralData = [];
let tableData = {}; 
let selectedTbl = null;
let vitalsCache = {}; 

/* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
window.switchTab = function(t) {
  document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
  document.querySelectorAll(".tab-pane").forEach(p => p.classList.remove("active"));
  document.getElementById("tab-btn-"+t).classList.add("active");
  document.getElementById("tab-"+t).classList.add("active");
};

/* ‚îÄ‚îÄ DATA LOADING ‚îÄ‚îÄ */
async function loadCentral() {
  const { data:eventId } = await supabase.rpc("get_today_event");
  const { data } = await supabase
    .from("vasd_queue")
    .select(`animal_id, status,
             vasd_animal(id, event_id, queue_number, animal_name, species, sex, est_weight, actual_weight)`)
    .eq("status","anesthesia");

  centralData = (data||[]).filter(r => r.vasd_animal && r.vasd_animal.event_id === eventId);
  centralData.sort((a,b) => a.vasd_animal.queue_number - b.vasd_animal.queue_number);

  document.getElementById("badge-central").textContent = centralData.length;
  renderCentral();
}

async function loadTables() {
  const { data:eventId } = await supabase.rpc("get_today_event");

  const { data } = await supabase
    .from("vasd_queue")
    .select(`animal_id, table_number, surgeon_name, anesthesiologist_name, notes,
             vasd_animal(id,event_id,animal_name,species,sex,actual_weight,est_weight,health_note)`)
    .eq("status","surgery");

  const todayRows = (data||[]).filter(r => r.vasd_animal && r.vasd_animal.event_id === eventId);
  const tableMap = JSON.parse(localStorage.getItem("vasd_table_map") || "{}");

  tableData = {};
  todayRows.forEach(r => {
    const tbl = r.table_number || tableMap[r.animal_id];
    if (tbl) tableData[tbl] = r;
  });

  const animalIds = Object.values(tableData).map(r => r.vasd_animal.id);
  if (animalIds.length > 0) {
    const { data: vData } = await supabase
      .from("vasd_vital_signs")
      .select("*")
      .in("animal_id", animalIds)
      .order("recorded_at", { ascending: true });
      
    vitalsCache = {}; 
    if (vData) {
      vData.forEach(v => {
        if (!vitalsCache[v.animal_id]) vitalsCache[v.animal_id] = [];
        const timeStr = new Date(v.recorded_at).toLocaleTimeString("th-TH", { hour: "2-digit", minute: "2-digit" });
        vitalsCache[v.animal_id].push({
          time: timeStr, hr: v.hr, rr: v.rr, spo2: v.spo2, bt: v.bt, zol: v.zoletil_top, note: v.note
        });
      });
    }
  } else {
    vitalsCache = {};
  }

  document.getElementById("badge-tables").textContent = Object.keys(tableData).length;
  renderGrid();
  if (selectedTbl) renderDetail(selectedTbl);
}

/* ‚îÄ‚îÄ UI: CENTRAL TAB ‚îÄ‚îÄ */
function renderDrugCards(d) {
  return [
    {name:"Xylazine", conc:"20 mg/ml ¬∑ 1 mg/kg", val:d.xyl_ml},
    {name:"Zoletil",  conc:`100 mg/ml ¬∑ ${d.zol_rate} mg/kg`, val:d.zol_ml},
    {name:"Pen-Strep", conc:"1 ml / 10 ‡∏Å‡∏Å.", val:d.pen_ml},
    {name:"Tolfedine", conc:"40 mg/ml ¬∑ 4 mg/kg", val:d.tolf_ml},
  ].map(({name,conc,val})=>`
    <div class="drug-card">
      <div class="drug-name">${name}</div>
      <div class="drug-conc">${conc}</div>
      <div class="drug-dose">${fmt2(val)}</div>
      <div class="drug-unit">ml</div>
    </div>`).join("");
}

function renderCentral() {
  const box = document.getElementById("central-list");
  box.innerHTML = "";
  if (!centralData.length) {
    box.innerHTML = `<div class="empty animate">
      <div class="empty-icon">‚úÖ</div><p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏£‡∏≠‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p></div>`;
    return;
  }

  centralData.forEach((row, i) => {
    const a = row.vasd_animal;
    const w = parseFloat(a.actual_weight || a.est_weight || 0);
    const d = calcDrugs(w, a.species);
    const spc = a.species==="‡∏™"?"‡∏™‡∏∏‡∏ô‡∏±‡∏Ç":"‡πÅ‡∏°‡∏ß";

    const div = document.createElement("div");
    div.className = "queue-card animate";
    div.style.animationDelay = (i * 0.05) + "s";
    div.innerHTML = `
      <div class="qcard-header">
        <div>
          <div class="qcard-title">‡∏Ñ‡∏¥‡∏ß #${a.queue_number} ‚Äî ${a.animal_name}</div>
          <div class="qcard-meta">
            <span class="meta-tag">${spc}</span>
            <span class="meta-tag">${a.sex}</span>
            <span class="meta-tag">‡∏ô‡∏ô.‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô: ${a.est_weight||"-"} ‡∏Å‡∏Å.</span>
          </div>
        </div>
      </div>
      <div class="qcard-body">
        <div class="weight-row">
          <label>‚öñÔ∏è ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏à‡∏£‡∏¥‡∏á (‡∏ä‡∏±‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏≤‡∏á‡∏¢‡∏≤)</label>
          <input type="number" step="0.1" class="weight-input" id="w-${a.id}" value="${w}" 
                 onchange="updateCentralWeight('${a.id}', this.value, '${a.species}')">
          <label>‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°</label>
        </div>
        
        <div class="drug-section-title">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏¢‡∏≤‡∏â‡∏µ‡∏î (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏à‡∏£‡∏¥‡∏á)</div>
        <div class="drug-grid" id="dgrid-${a.id}">
          ${renderDrugCards(d)}
        </div>

        <div class="assign-row">
          <label>‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡πÇ‡∏ï‡πä‡∏∞‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î</label>
          <select class="assign-select" id="sel-${a.id}">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞ --</option>
            ${Array.from({length:20}, (_,k)=>`<option value="${k+1}">‡πÇ‡∏ï‡πä‡∏∞ ${k+1}</option>`).join("")}
          </select>
          <button class="btn btn-start" onclick="moveToSurgery('${a.id}')">‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î üî™</button>
        </div>
      </div>
    `;
    box.appendChild(div);
  });
}

window.updateCentralWeight = async function(aid, wVal, species) {
  const w = parseFloat(wVal)||0;
  const d = calcDrugs(w, species);
  document.getElementById(`dgrid-${aid}`).innerHTML = renderDrugCards(d);
  await supabase.from("vasd_animal").update({ actual_weight: w }).eq("id", aid);
};

window.moveToSurgery = async function(animalId) {
  const tbl = document.getElementById(`sel-${animalId}`).value;
  if (!tbl) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î");

  const wVal = document.getElementById(`w-${animalId}`).value;
  await supabase.from("vasd_animal").update({ actual_weight: wVal }).eq("id", animalId);
  
  await supabase.from("vasd_queue").update({ 
    status: "surgery", table_number: tbl, updated_at: new Date() 
  }).eq("animal_id", animalId);

  let map = JSON.parse(localStorage.getItem("vasd_table_map") || "{}");
  map[animalId] = tbl;
  localStorage.setItem("vasd_table_map", JSON.stringify(map));

  loadCentral(); loadTables();
  switchTab("tables");
  selectedTbl = tbl;
  setTimeout(()=> renderDetail(tbl), 300);
};

/* ‚îÄ‚îÄ UI: TABLES TAB ‚îÄ‚îÄ */
function renderGrid() {
  const grid = document.getElementById("table-grid");
  grid.innerHTML = "";
  for(let i=1; i<=20; i++) {
    const r = tableData[i];
    const div = document.createElement("div");
    div.className = "table-tile" + (r ? " occupied" : "") + (selectedTbl==i ? " selected-tile" : "");
    div.onclick = () => { selectedTbl = i; renderGrid(); renderDetail(i); };

    if (r) {
      div.innerHTML = `<div class="table-num">${i}</div>
                       <div class="table-animal-name">${r.vasd_animal.animal_name}</div>`;
    } else {
      div.innerHTML = `<div class="table-num" style="color:#cbd5e0;">${i}</div>
                       <div class="table-empty-lbl">‡∏ß‡πà‡∏≤‡∏á</div>`;
    }
    grid.appendChild(div);
  }
}

// ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞ 6 ‡∏ä‡∏ô‡∏¥‡∏î ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
function rxHTML(w, species, aid) {
  const drugs = [
    {id:"dox",    cat:"Antibiotic",    name:"‡∏õ‡∏è‡∏¥‡∏ä‡∏µ‡∏ß‡∏ô‡∏∞ Doxycycline 100 mg",  tabs: round((w*10)/100), freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏¢‡πá‡∏ô)", f_num:1, days:14},
    {id:"nor200", cat:"Antibiotic",    name:"‡∏õ‡∏è‡∏¥‡∏ä‡∏µ‡∏ß‡∏ô‡∏∞ Norfloxacin 200 mg",  tabs: round((w*10)/200), freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡πÄ‡∏ä‡πâ‡∏≤-‡πÄ‡∏¢‡πá‡∏ô ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£)", f_num:2, days:7},
    {id:"nor100", cat:"Antibiotic",    name:"‡∏õ‡∏è‡∏¥‡∏ä‡∏µ‡∏ß‡∏ô‡∏∞ Norfloxacin 100 mg",  tabs: round((w*10)/100), freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡πÄ‡∏ä‡πâ‡∏≤-‡πÄ‡∏¢‡πá‡∏ô ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£)", f_num:2, days:7},
    {id:"tolf60", cat:"NSAID",         name:"‡πÅ‡∏Å‡πâ‡∏õ‡∏ß‡∏î Tolfedine 60 mg",      tabs: round((w*4)/60),   freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏¢‡πá‡∏ô)", f_num:1, days:3},
    {id:"tolf6",  cat:"NSAID",         name:"‡πÅ‡∏Å‡πâ‡∏õ‡∏ß‡∏î Tolfedine 6 mg",       tabs: round((w*4)/6),    freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏¢‡πá‡∏ô)", f_num:1, days:3},
    {id:"fbc",    cat:"Blood support", name:"‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏î FBC",              tabs: round((w*1)/10)||0.25, freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏ä‡πâ‡∏≤)", f_num:1, days:14},
  ];

  return drugs.map(d => `
    <div class="rx-card" id="rxcard-${aid}-${d.id}">
      <label>
        <input type="checkbox" id="rxchk-${aid}-${d.id}" data-name="${d.name}" onchange="toggleRx(this, '${aid}', '${d.id}')">
        <div>
          <div class="rx-cat">${d.cat}</div>
          <div class="rx-name">${d.name}</div>
        </div>
      </label>
      <div class="rx-custom-inputs" id="rxcustom-${aid}-${d.id}">
        <div class="rx-input-group">
          <label>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì</label>
          <input type="text" id="rxdose-${aid}-${d.id}" value="‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡∏∞ ${d.tabs} ‡πÄ‡∏°‡πá‡∏î" oninput="recalcTotalRx('${aid}', '${d.id}')">
        </div>
        <div class="rx-input-group">
          <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà</label>
          <input type="text" id="rxfreq-${aid}-${d.id}" value="${d.freq}" oninput="recalcTotalRx('${aid}', '${d.id}')">
        </div>
        <div class="rx-input-group" style="display:flex; gap:10px;">
          <div style="display:flex; align-items:center; gap:8px;">
            <label>‡∏à‡∏ô.‡∏ß‡∏±‡∏ô</label>
            <input type="number" id="rxdays-${aid}-${d.id}" value="${d.days}" style="width:60px;" oninput="recalcTotalRx('${aid}', '${d.id}')">
          </div>
          <div style="display:flex; align-items:center; gap:8px;">
            <label style="color:var(--danger);">‡∏£‡∏ß‡∏°</label>
            <input type="number" step="0.25" id="rxtotal-${aid}-${d.id}" value="${d.tabs * d.f_num * d.days}" style="width:60px; font-weight:bold; color:var(--danger);">
          </div>
        </div>
      </div>
    </div>`).join("");
}

window.toggleRx = function(chk, aid, did) {
  const card = document.getElementById(`rxcard-${aid}-${did}`);
  if(chk.checked) card.classList.add("selected");
  else card.classList.remove("selected");
};

function renderDetail(tblNum) {
  const box = document.getElementById("surgery-detail");
  const r = tableData[tblNum];

  if (!r) {
    box.innerHTML = `<div class="empty animate">
      <div class="empty-icon">üõèÔ∏è</div><p>‡πÇ‡∏ï‡πä‡∏∞ ${tblNum} ‡∏ß‡πà‡∏≤‡∏á<br><small>‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏ï‡πä‡∏∞‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡πÅ‡∏ó‡πá‡∏ö "‡πÇ‡∏ï‡πä‡∏∞‡∏Å‡∏•‡∏≤‡∏á"</small></p></div>`;
    return;
  }

  const a = r.vasd_animal;
  const w = parseFloat(a.actual_weight || a.est_weight || 0);
  const log = vitalsCache[a.id] || [];
  
  let healthAlertHTML = '';
  if (a.health_note) {
    healthAlertHTML = `
      <div class="health-alert">
        <strong>‚ö†Ô∏è ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û / ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ‡∏¢‡∏≤:</strong>
        <p>${a.health_note}</p>
      </div>`;
  }

  let vitalsRows = log.map(v => `
    <tr>
      <td>${v.time}</td>
      <td style="color:${getVitalColor('hr', v.hr)}">${v.hr || "-"}</td>
      <td style="color:${getVitalColor('rr', v.rr)}">${v.rr || "-"}</td>
      <td style="color:${getVitalColor('spo2', v.spo2)}">${v.spo2 || "-"}</td>
      <td style="color:${getVitalColor('bt', v.bt)}">${v.bt || "-"}</td>
      <td>${v.zol || "-"}</td>
      <td class="vi-note" style="font-weight:normal;">${v.note || ""}</td>
    </tr>
  `).join("");

  box.innerHTML = `
    <div class="surgery-panel animate">
      <div class="spanel-header">
        <div>
          <div class="spanel-title">‡πÇ‡∏ï‡πä‡∏∞‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î ${tblNum} ‚Äî ${a.animal_name}</div>
          <div class="spanel-sub">‡∏ô‡∏ô.‡∏à‡∏£‡∏¥‡∏á: ${w} ‡∏Å‡∏Å. | ‡∏™‡∏±‡∏ï‡∏ß‡πå: ${a.species==="‡∏™"?"‡∏™‡∏∏‡∏ô‡∏±‡∏Ç":"‡πÅ‡∏°‡∏ß"} (${a.sex})</div>
        </div>
      </div>
      <div class="spanel-body">
        
        ${healthAlertHTML}

        <div class="surgeon-grid">
          <div class="field">
            <label>‡∏®‡∏±‡∏•‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå (Surgeon)</label>
            <input type="text" id="s-surg" value="${r.surgeon_name||''}" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ú‡∏π‡πâ‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î">
          </div>
          <div class="field">
            <label>‡∏ß‡∏¥‡∏™‡∏±‡∏ç‡∏ç‡∏µ‡πÅ‡∏û‡∏ó‡∏¢‡πå (Anesthesiologist)</label>
            <input type="text" id="s-anes" value="${r.anesthesiologist_name||''}" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏î‡∏°‡∏¢‡∏≤">
          </div>
        </div>

        <div class="vitals-toolbar">
          <label style="font-size:12px;font-weight:700;color:var(--navy);">üìà VITAL SIGNS LOG</label>
          <button class="btn btn-secondary btn-sm" onclick="addVitalRow('${a.id}')">‚ûï ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤</button>
        </div>
        
        <div class="vitals-log">
          <table class="vitals-table" id="vitals-table-${a.id}">
            <thead>
              <tr>
                <th width="12%">‡πÄ‡∏ß‡∏•‡∏≤</th>
                <th width="12%">HR</th>
                <th width="12%">RR</th>
                <th width="12%">SpO‚ÇÇ</th>
                <th width="12%">Temp</th>
                <th width="12%">Zoletil (ml)</th>
                <th>Note</th>
                <th width="8%"></th>
              </tr>
            </thead>
            <tbody id="vitals-${a.id}">
              ${vitalsRows || `<tr><td colspan="8" style="text-align:center;color:#a0aec0;font-weight:400;padding:20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Vitals</td></tr>`}
            </tbody>
          </table>
        </div>

        <div class="rx-section">
          <div class="vitals-toolbar">
            <label style="font-size:12px;font-weight:700;color:var(--navy);">üíä ‡∏™‡∏±‡πà‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤ (PRESCRIPTION)</label>
          </div>
          <div class="rx-grid">
            ${rxHTML(w, a.species, a.id)}
          </div>
        </div>

        <div style="display:flex; justify-content:space-between; margin-top:20px; border-top:1px solid var(--border); padding-top:16px;">
          <button class="btn btn-danger" onclick="cancelSurgery('${a.id}')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏Ñ‡∏™ üö´</button>
          <button class="btn btn-start" onclick="endSurgery('${a.id}')">‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à -> ‡∏û‡∏±‡∏Å‡∏ü‡∏∑‡πâ‡∏ô üü¢</button>
        </div>
      </div>
    </div>
  `;
}

window.addVitalRow = function(aid) {
  const tbody = document.getElementById("vitals-" + aid);
  if(tbody.querySelector("td[colspan]")) tbody.innerHTML = "";

  const t = nowStr();
  const tr = document.createElement("tr");
  tr.className = "is-form";
  tr.innerHTML = `
    <td>${t}</td>
    <td><input class="vi" id="vi-hr" placeholder="HR"></td>
    <td><input class="vi" id="vi-rr" placeholder="RR"></td>
    <td><input class="vi" id="vi-spo2" placeholder="O‚ÇÇ"></td>
    <td><input class="vi" id="vi-bt" placeholder="¬∞F"></td>
    <td><input class="vi" id="vi-zol" placeholder="ml"></td>
    <td><input class="vi vi-note" id="vi-note" placeholder="‡∏Ç‡πâ‡∏≠‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï..."></td>
    <td><button class="btn-vi-save" onclick="saveVital('${aid}', '${t}', this.closest('tr'))">üíæ</button></td>`;
  tbody.appendChild(tr);
  tr.querySelector("#vi-hr").focus();

  tr.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      tr.querySelector(".btn-vi-save").click();
    }
  });
};

window.saveVital = async function(aid, t, tr) {
  const hr = tr.querySelector("#vi-hr").value;
  const rr = tr.querySelector("#vi-rr").value;
  const spo2 = tr.querySelector("#vi-spo2").value;
  const bt = tr.querySelector("#vi-bt").value;
  const zol = tr.querySelector("#vi-zol").value;
  const note = tr.querySelector("#vi-note").value;

  tr.innerHTML = `
    <td>${t}</td>
    <td style="color:${getVitalColor('hr', hr)}">${hr||"-"}</td>
    <td style="color:${getVitalColor('rr', rr)}">${rr||"-"}</td>
    <td style="color:${getVitalColor('spo2', spo2)}">${spo2||"-"}</td>
    <td style="color:${getVitalColor('bt', bt)}">${bt||"-"}</td>
    <td>${zol||"-"}</td>
    <td class="vi-note" style="font-weight:normal;">${note||""}</td>
  `;
  tr.classList.remove("is-form");

  if(!vitalsCache[aid]) vitalsCache[aid] = [];
  vitalsCache[aid].push({time:t, hr, rr, spo2, bt, zol, note});

  await supabase.from("vasd_vital_signs").insert({
    animal_id: aid, hr, rr, spo2, bt, zoletil_top: zol, note
  });
};

// ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤, ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì, ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà ‡∏Ø‡∏•‡∏Ø)
let queueAnimalId = null;
window.endSurgery = async function(animalId) {
  if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß?")) return;
  queueAnimalId = animalId;

  const rxInserts = [];
  Array.from(document.querySelectorAll(`input[id^="rxchk-${animalId}-"]:checked`)).forEach(el => {
    const did = el.id.split("-").pop();
    rxInserts.push({
      animal_id:    animalId,
      drug_id:      el.dataset.name, 
      dose:         document.getElementById(`rxdose-${animalId}-${did}`).value,
      freq:         document.getElementById(`rxfreq-${animalId}-${did}`).value,
      days:         parseInt(document.getElementById(`rxdays-${animalId}-${did}`).value) || 5,
      total_pills:  parseFloat(document.getElementById(`rxtotal-${animalId}-${did}`).value) || 0 
    });
  });

  if(rxInserts.length){
    const {error}=await supabase.from("vasd_prescription").insert(rxInserts);
    if(error) console.warn("rx:",error);
  }

  await supabase.from("vasd_queue").update({
    status:"recovery",
    surgeon_name:        document.getElementById("s-surg")?.value||"",
    anesthesiologist_name:document.getElementById("s-anes")?.value||"",
    table_number:null,
    updated_at:new Date()
  }).eq("animal_id",queueAnimalId);

  selectedTbl=null;
  document.getElementById("surgery-detail").innerHTML="";
  loadTables();
  alert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚Äî ‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏û‡∏±‡∏Å‡∏ü‡∏∑‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß${rxInserts.length?" ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏±‡πà‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤ "+rxInserts.length+" ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£":""}`);
};

window.cancelSurgery = async function(animalId) {
  if(!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡πÇ‡∏ï‡πä‡∏∞‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
  await supabase.from("vasd_queue").update({
    status:"cancel", table_number:null, updated_at:new Date()
  }).eq("animal_id",animalId);

  selectedTbl=null;
  document.getElementById("surgery-detail").innerHTML="";
  loadTables();
};

/* ‚îÄ‚îÄ‚îÄ REALTIME ‚îÄ‚îÄ‚îÄ */
supabase.channel("vasd-main-rt")
  .on("postgres_changes", { event: "*", schema: "public", table: "vasd_queue" }, () => {
    loadCentral(); 
    loadTables();
  })
  .subscribe();

/* ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ */
loadCentral();
loadTables();
</script>
</body>
</html>
