<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡πÇ‡∏ï‡πä‡∏∞‡∏ß‡∏≤‡∏á‡∏¢‡∏≤‡∏™‡∏•‡∏ö (Anesthesia)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&family=Prompt:wght@300;400;500;700&family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>
:root {
  --navy:#0d1b2a; --teal:#1a6b72; --teal-light:#22919a; --accent:#00d4aa;
  --bg:#f0f4f8; --surface:#fff; --text:#1a202c; --text-muted:#718096;
  --border:#e2e8f0; --danger:#e53e3e; --success:#38a169; --warning:#d69e2e;
  --shadow-sm:0 1px 3px rgba(0,0,0,0.06); --shadow-md:0 4px 16px rgba(13,27,42,0.08);
  --shadow-lg:0 12px 40px rgba(13,27,42,0.12);
  --radius:14px; --radius-sm:8px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{font-family:"Sarabun",sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}

/* HEADER */
header{
  background:var(--navy);padding:0 32px;display:flex;
  justify-content:space-between;align-items:center;height:68px;
  position:sticky;top:0;z-index:100;box-shadow:0 2px 20px rgba(0,0,0,0.25);
}
.header-brand{display:flex;align-items:center;gap:14px;}
.brand-icon{
  width:40px;height:40px;background:linear-gradient(135deg,var(--warning),#f6e05e);
  border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;
}
.brand-text h1{font-size:17px;font-weight:700;color:#fff;line-height:1.2;}
.brand-text span{font-size:11px;color:rgba(255,255,255,0.5);}

.btn-home{
  padding:8px 18px;font-size:13px;font-weight:600;font-family:"Sarabun",sans-serif;
  background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.9);
  border:1px solid rgba(255,255,255,0.2);border-radius:var(--radius-sm);
  cursor:pointer;transition:background 0.2s;
}
.btn-home:hover{background:rgba(255,255,255,0.18);}

/* MAIN */
.container{max-width:1000px;margin:0 auto;padding:28px 24px;}

.page-header{
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:24px;animation:fadeUp 0.4s ease both;
}
.page-header h2{font-size:22px;font-weight:700;color:var(--navy);}

/* CARD */
.card {
  background:var(--surface);border-radius:var(--radius);
  border:1px solid var(--border);box-shadow:var(--shadow-sm);
  margin-bottom:20px;padding:20px;animation:fadeUp 0.4s 0.05s ease both;
  display: flex; flex-direction: column; gap: 16px;
}
.card-header {
  display: flex; justify-content: space-between; align-items: center;
  border-bottom: 1px solid var(--border); padding-bottom: 12px;
}
.card-header h3 { font-size:18px; color:var(--navy); font-weight:700; margin:0; display: flex; align-items: center; gap:8px;}
.queue-badge {
  background: var(--navy); color: #fff; padding: 4px 10px; border-radius: 6px; font-size: 14px;
}

.card-body {
  display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
}
@media (max-width: 600px) { .card-body { grid-template-columns: 1fr; } }

.info-group { display: flex; flex-direction: column; gap: 4px; }
.info-label { font-size: 12px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; }
.info-value { font-size: 15px; color: var(--text); font-weight: 500; }

.input-group { display: flex; flex-direction: column; gap: 6px; }
.input-group label { font-size: 13px; font-weight: 600; color: var(--teal); }
.input-group input {
  padding: 10px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm);
  font-family: "Sarabun", sans-serif; font-size: 15px; outline: none; transition: all 0.2s;
}
.input-group input:focus { border-color: var(--teal); box-shadow: 0 0 0 3px rgba(34,145,154,0.1); }

/* DOSAGE CALC BOX */
.calc-box {
  background: #f8fafc; border: 1px dashed var(--border); border-radius: var(--radius-sm);
  padding: 12px; margin-top: 10px; font-size: 13px;
}
.calc-box h4 { font-size: 13px; color: var(--navy); margin-bottom: 8px; }
.calc-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #e2e8f0; }
.calc-row:last-child { border-bottom: none; }

.card-footer {
  display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid var(--border); padding-top: 16px;
}

/* BUTTONS */
.btn{
  padding:10px 20px;font-size:14px;font-weight:600;font-family:"Sarabun",sans-serif;
  border:none;border-radius:var(--radius-sm);cursor:pointer;
  transition:all 0.2s;display:inline-flex;align-items:center;gap:8px;
}
.btn:hover{opacity:0.85;transform:translateY(-1px);}
.btn-primary { background: var(--teal); color: #fff; }
.btn-warning { background: var(--warning); color: #fff; }
.btn-success { background: var(--success); color: #fff; }
.btn-danger { background: #fee2e2; color: var(--danger); }
.btn-danger:hover { background: var(--danger); color: #fff; }

.empty-state { text-align:center; padding:60px 20px; color:var(--text-muted); font-size:16px; }

/* ‚îÄ‚îÄ‚îÄ MODAL ADD RX ‚îÄ‚îÄ‚îÄ */
.modal-overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(13, 27, 42, 0.7); z-index: 1000;
  display: none; justify-content: center; align-items: center;
  padding: 20px; backdrop-filter: blur(2px);
}
.modal-overlay.active { display: flex; }
.modal-content {
  background: var(--surface); width: 100%; max-width: 700px;
  border-radius: var(--radius); box-shadow: var(--shadow-lg);
  animation: fadeUp 0.3s ease both; max-height: 90vh; display: flex; flex-direction: column;
}
.modal-header {
  padding: 18px 24px; border-bottom: 1px solid var(--border);
  display: flex; justify-content: space-between; align-items: center; background: #fafbfc; border-radius: var(--radius) var(--radius) 0 0;
}
.modal-header h3 { font-size: 18px; color: var(--navy); margin: 0; display:flex; align-items:center; gap:8px;}
.btn-close-modal { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text-muted); padding:4px;}
.btn-close-modal:hover { color: var(--danger); }
.modal-body { padding: 24px; overflow-y: auto; background:#f8fafc; }
.modal-footer {
  padding: 16px 24px; border-top: 1px solid var(--border);
  display: flex; justify-content: flex-end; gap: 10px; background: #fff; border-radius: 0 0 var(--radius) var(--radius);
}

/* ‚îÄ‚îÄ‚îÄ RX GRID ‚îÄ‚îÄ‚îÄ */
.rx-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
@media(max-width:560px){.rx-grid{grid-template-columns:1fr;}}
.rx-card-item{background:#fff; border:2px solid var(--border);border-radius:var(--radius-sm);padding:14px;
  cursor:pointer;transition:all 0.2s;}
.rx-card-item.selected{border-color:var(--teal-light);background:#e6f6f4;box-shadow:0 2px 8px rgba(34,145,154,0.15);}
.rx-card-item label{display:flex;align-items:flex-start;gap:10px;cursor:pointer; margin:0;}
.rx-card-item input[type="checkbox"]{width:18px;height:18px;accent-color:var(--teal-light);flex-shrink:0;margin-top:2px;}
.rx-cat{font-size:11px;font-weight:700;letter-spacing:0.5px;text-transform:uppercase;color:var(--text-muted);margin-bottom:3px;}
.rx-name{font-size:14px;font-weight:700;color:var(--navy);}
.rx-custom-inputs { display: none; flex-direction: column; gap: 8px; margin-top: 12px; padding-top:12px; border-top:1px dashed #cbd5e0;}
.rx-input-group { display: flex; align-items: center; gap: 8px; }
.rx-input-group label { font-size: 12px; color: var(--teal); font-weight:600; width: 50px; flex-shrink: 0; }
.rx-input-group input { flex: 1; padding: 6px 10px; font-size: 13px; font-family:"Sarabun",sans-serif; border: 1px solid var(--border); border-radius: 4px; outline:none; }
.rx-input-group input:focus{border-color:var(--teal-light);}

@keyframes fadeUp{from{opacity:0;transform:translateY(14px);}to{opacity:1;transform:translateY(0);}}
</style>
</head>
<body>

<header>
  <div class="header-brand">
    <div class="brand-icon">üíâ</div>
    <div class="brand-text">
      <h1>‡πÇ‡∏ï‡πä‡∏∞‡∏ß‡∏≤‡∏á‡∏¢‡∏≤‡∏™‡∏•‡∏ö / ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß</h1>
      <span>RMUTTO ‚Äì Veterinary Academic Service Division</span>
    </div>
  </div>
  <button class="btn-home" onclick="location.href='index.html'">üè† ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
</header>

<div class="container">
  <div class="page-header">
    <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß / ‡∏ß‡∏≤‡∏á‡∏¢‡∏≤</h2>
  </div>
  <div id="anesthesia-container">
    <div class="empty-state">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
  </div>
</div>

<div class="modal-overlay" id="rxModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>üíä ‡∏™‡∏±‡πà‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤ (Prescription)</h3>
      <button class="btn-close-modal" onclick="closeRxModal()">‚úñ</button>
    </div>
    <div class="modal-body">
      <div style="margin-bottom: 14px; font-size:13px; color:var(--text-muted);" id="rxModalAnimalName"></div>
      <div class="rx-grid" id="rxModalGrid">
        </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger" onclick="closeRxModal()" style="background:#e2e8f0; color:var(--text);">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn btn-success" onclick="saveNewRx()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏¢‡∏≤</button>
    </div>
  </div>
</div>

<script type="module">
import { supabase } from "./js/supabase.js";

/* ‚îÄ‚îÄ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ‚îÄ‚îÄ */
function round(val) { 
  let num = Math.ceil(val * 4) / 4; 
  return num < 0.25 ? 0.25 : num;
}

window.recalcTotalRxNew = function(did) {
  const doseStr = document.getElementById(`newrxdose-${did}`).value;
  const freqStr = document.getElementById(`newrxfreq-${did}`).value;
  const daysStr = document.getElementById(`newrxdays-${did}`).value;

  const doseMatch = doseStr.match(/[\d.]+/);
  const dose = doseMatch ? parseFloat(doseMatch[0]) : 0;
  
  const freqMatch = freqStr.match(/[\d.]+/);
  const freq = freqMatch ? parseFloat(freqMatch[0]) : 0;
  
  const days = parseFloat(daysStr) || 0;

  const total = Math.ceil(dose * freq * days);
  document.getElementById(`newrxtotal-${did}`).value = total;
};

window.toggleNewRx = function(chk, did) {
  const card = document.getElementById(`newrxcard-${did}`);
  const inputs = document.getElementById(`newrxcustom-${did}`);
  if(chk.checked) {
    card.classList.add("selected");
    inputs.style.display = "flex";
  } else {
    card.classList.remove("selected");
    inputs.style.display = "none";
  }
};

let currentRxAnimalId = null;

// ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏™‡∏±‡πà‡∏á‡∏¢‡∏≤ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏£‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì/‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
window.openRxModal = function(animalId, animalName, w, species) {
  currentRxAnimalId = animalId;
  w = parseFloat(w) || 0;
  
  document.getElementById("rxModalAnimalName").innerHTML = `‡∏™‡∏±‡πà‡∏á‡∏¢‡∏≤‡πÉ‡∏´‡πâ: <strong>${animalName}</strong> (‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å: ${w} ‡∏Å‡∏Å.)`;
  const grid = document.getElementById("rxModalGrid");
  
  // ‚úÖ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏¢‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà
  const drugs = [
    {id:"dox",    cat:"Antibiotic",    name:"‡∏õ‡∏è‡∏¥‡∏ä‡∏µ‡∏ß‡∏ô‡∏∞ Doxycycline 100 mg",  tabs: round((w*10)/100), freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏¢‡πá‡∏ô", f_num:1, days:14},
    {id:"nor200", cat:"Antibiotic",    name:"‡∏õ‡∏è‡∏¥‡∏ä‡∏µ‡∏ß‡∏ô‡∏∞ Norfloxacin 200 mg",  tabs: round((w*20)/200), freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÄ‡∏ä‡πâ‡∏≤-‡πÄ‡∏¢‡πá‡∏ô ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£", f_num:2, days:7},
    {id:"nor100", cat:"Antibiotic",    name:"‡∏õ‡∏è‡∏¥‡∏ä‡∏µ‡∏ß‡∏ô‡∏∞ Norfloxacin 100 mg",  tabs: round((w*20)/100), freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÄ‡∏ä‡πâ‡∏≤-‡πÄ‡∏¢‡πá‡∏ô ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£", f_num:2, days:7},
    {id:"tolf60", cat:"NSAID",         name:"‡πÅ‡∏Å‡πâ‡∏õ‡∏ß‡∏î Tolfedine 60 mg",      tabs: round((w*4)/60),   freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏¢‡πá‡∏ô", f_num:1, days:3},
    {id:"tolf6",  cat:"NSAID",         name:"‡πÅ‡∏Å‡πâ‡∏õ‡∏ß‡∏î Tolfedine 6 mg",       tabs: round((w*4)/6),    freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏¢‡πá‡∏ô", f_num:1, days:3},
    {id:"fbc",    cat:"Blood support", name:"‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏î FBC",              tabs: (w>=10?1:0.5),     freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏ä‡πâ‡∏≤", f_num:1, days:14},
    {id:"custom1",cat:"‡∏≠‡∏∑‡πà‡∏ô‡πÜ",         name:"‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≤‡πÄ‡∏≠‡∏á...",                tabs: 1, freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á", f_num:1, days:5, isCustom:true}
  ];

  grid.innerHTML = drugs.map(d => `
    <div class="rx-card-item" id="newrxcard-${d.id}">
      <label>
        <input type="checkbox" id="newrxchk-${d.id}" data-name="${d.name}" onchange="toggleNewRx(this, '${d.id}')">
        <div style="width:100%;">
          <div class="rx-cat">${d.cat}</div>
          ${d.isCustom ? 
            `<input type="text" id="custom-name-${d.id}" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤..." class="rx-input" style="border:1px solid #cbd5e0; background:#fff; margin-top:4px;" onclick="event.preventDefault();">` : 
            `<div class="rx-name">${d.name}</div>`
          }
        </div>
      </label>
      <div class="rx-custom-inputs" id="newrxcustom-${d.id}">
        <div class="rx-input-group">
          <label>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì</label>
          <input type="text" id="newrxdose-${d.id}" value="‡∏õ‡πâ‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡∏∞ ${d.tabs} ‡πÄ‡∏°‡πá‡∏î" oninput="recalcTotalRxNew('${d.id}')">
        </div>
        <div class="rx-input-group">
          <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà</label>
          <input type="text" id="newrxfreq-${d.id}" value="${d.freq}" oninput="recalcTotalRxNew('${d.id}')">
        </div>
        <div class="rx-input-group" style="display:flex; gap:10px;">
          <div style="display:flex; align-items:center; gap:8px;">
            <label>‡∏à‡∏ô.‡∏ß‡∏±‡∏ô</label>
            <input type="number" id="newrxdays-${d.id}" value="${d.days}" style="width:60px;" oninput="recalcTotalRxNew('${d.id}')">
          </div>
          <div style="display:flex; align-items:center; gap:8px;">
            <label style="color:var(--danger);">‡∏£‡∏ß‡∏°</label>
            <input type="number" step="1" id="newrxtotal-${d.id}" value="${Math.ceil(d.tabs * d.f_num * d.days)}" style="width:60px; font-weight:bold; color:var(--danger);">
          </div>
        </div>
      </div>
    </div>`).join("");

  document.getElementById("rxModal").classList.add("active");
};

window.closeRxModal = function() {
  document.getElementById("rxModal").classList.remove("active");
  currentRxAnimalId = null;
};

// ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≤‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
window.saveNewRx = async function() {
  if(!currentRxAnimalId) return;
  const rxInserts = [];
  
  Array.from(document.querySelectorAll(`input[id^="newrxchk-"]:checked`)).forEach(el => {
    const did = el.id.replace("newrxchk-", "");
    
    let drugName = el.dataset.name;
    if(did.startsWith("custom")) {
      const customNameInput = document.getElementById(`custom-name-${did}`);
      if(customNameInput && customNameInput.value.trim() !== "") {
        drugName = customNameInput.value.trim();
      } else {
        drugName = "‡∏¢‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°";
      }
    }

    rxInserts.push({
      animal_id:    currentRxAnimalId,
      drug_id:      drugName, 
      dose:         document.getElementById(`newrxdose-${did}`).value,
      freq:         document.getElementById(`newrxfreq-${did}`).value,
      days:         parseInt(document.getElementById(`newrxdays-${did}`).value) || 5,
      total_pills:  parseFloat(document.getElementById(`newrxtotal-${did}`).value) || 0 
    });
  });

  if(rxInserts.length === 0) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
    return;
  }

  const { error } = await supabase.from("vasd_prescription").insert(rxInserts);
  if(error) {
    alert("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
  } else {
    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤");
    closeRxModal();
  }
};

/* ‚îÄ‚îÄ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠‡∏ß‡∏≤‡∏á‡∏¢‡∏≤ ‚îÄ‚îÄ */
async function loadAnesthesiaQueue() {
  try {
    const { data: eventId } = await supabase.rpc("get_today_event");

    const { data: queueData, error } = await supabase
      .from("vasd_queue")
      .select(`
        id, animal_id, status,
        vasd_animal ( 
          id, event_id, queue_number, animal_name, species, sex, est_weight, actual_weight,
          vasd_owner(owner_name),
          vasd_service(service_type)
        )
      `)
      .eq("status", "waiting")
      .order("created_at", { ascending: true });

    if (error) throw error;

    const animals = (queueData || []).filter(q => q.vasd_animal && q.vasd_animal.event_id === eventId);
    const container = document.getElementById("anesthesia-container");
    container.innerHTML = "";

    if (animals.length === 0) {
      container.innerHTML = `<div class="empty-state">‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</div>`;
      return;
    }

    animals.forEach((q, index) => {
      const a = q.vasd_animal;
      const ownerName = a.vasd_owner ? a.vasd_owner.owner_name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
      const species = a.species === "‡∏™" ? "‡∏™‡∏∏‡∏ô‡∏±‡∏Ç" : (a.species === "‡∏°" ? "‡πÅ‡∏°‡∏ß" : a.species);
      const services = a.vasd_service ? a.vasd_service.map(s => s.service_type).join(", ") : "-";
      
      const defaultWeight = a.actual_weight || a.est_weight || "";

      const card = document.createElement("div");
      card.className = "card";
      card.style.animationDelay = `${(index * 0.1)}s`; 
      
      card.innerHTML = `
        <div class="card-header">
          <h3>
            <span class="queue-badge">${a.queue_number || '-'}</span> 
            ${a.animal_name} <span style="font-size:14px; font-weight:normal; color:var(--text-muted);">(${species} ${a.sex})</span>
          </h3>
        </div>
        
        <div class="card-body">
          <div style="display:flex; flex-direction:column; gap:12px;">
            <div class="info-group">
              <span class="info-label">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</span>
              <span class="info-value">üë§ ${ownerName}</span>
            </div>
            <div class="info-group">
              <span class="info-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥</span>
              <span class="info-value">ü©∫ ${services}</span>
            </div>
            <div class="info-group">
              <span class="info-label">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô (‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô)</span>
              <span class="info-value">${a.est_weight || '-'} ‡∏Å‡∏Å.</span>
            </div>
          </div>

          <div>
            <div class="input-group">
              <label for="weight-${a.id}">‚öñÔ∏è ‡∏ä‡∏±‡πà‡∏á‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏à‡∏£‡∏¥‡∏á (‡∏Å‡∏Å.) <span style="color:var(--danger);">*</span></label>
              <input type="number" step="0.01" id="weight-${a.id}" value="${defaultWeight}" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏à‡∏£‡∏¥‡∏á..." oninput="calculateDose('${a.id}', this.value)">
            </div>
            
            <div class="calc-box">
              <h4>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏¢‡∏≤‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á)</h4>
              <div class="calc-row"><span>Atropine (0.04 mg/kg):</span> <strong id="calc-atro-${a.id}">- ml</strong></div>
              <div class="calc-row"><span>Xylazine 2% (1 mg/kg):</span> <strong id="calc-xyla-${a.id}">- ml</strong></div>
              <div class="calc-row"><span>Zoletil (5 mg/kg):</span> <strong id="calc-zole-${a.id}">- ml</strong></div>
            </div>
          </div>
        </div>

        <div class="card-footer">
          <button class="btn btn-warning" onclick="openRxModal('${a.id}', '${a.animal_name}', document.getElementById('weight-${a.id}').value, '${a.species}')">üíä ‡∏™‡∏±‡πà‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤ (Rx)</button>
          
          <button class="btn btn-primary" onclick="sendToSurgery('${a.id}')">ü©∫ ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î</button>
        </div>
      `;
      container.appendChild(card);
      
      if(defaultWeight) window.calculateDose(a.id, defaultWeight);
    });

  } catch (err) {
    console.error("Error:", err);
    document.getElementById("anesthesia-container").innerHTML = `<div class="empty-state text-danger">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}</div>`;
  }
}

// ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≤ Pre-med
window.calculateDose = function(animalId, weightStr) {
  const w = parseFloat(weightStr);
  if (isNaN(w) || w <= 0) {
    document.getElementById(`calc-atro-${animalId}`).innerText = "- ml";
    document.getElementById(`calc-xyla-${animalId}`).innerText = "- ml";
    document.getElementById(`calc-zole-${animalId}`).innerText = "- ml";
    return;
  }
  
  const doseAtro = ((w * 0.04) / 0.6).toFixed(2);
  const doseXyla = ((w * 1) / 20).toFixed(2);
  const doseZole = ((w * 5) / 50).toFixed(2);

  document.getElementById(`calc-atro-${animalId}`).innerText = `${doseAtro} ml`;
  document.getElementById(`calc-xyla-${animalId}`).innerText = `${doseXyla} ml`;
  document.getElementById(`calc-zole-${animalId}`).innerText = `${doseZole} ml`;
}

// ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î
window.sendToSurgery = async function(animalId) {
  const weightInput = document.getElementById(`weight-${animalId}`).value;
  if (!weightInput) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏à‡∏£‡∏¥‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î");
    return;
  }

  if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î?\n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏à‡∏£‡∏¥‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î'")) return;

  try {
    await supabase.from("vasd_animal").update({ actual_weight: parseFloat(weightInput) }).eq("id", animalId);
    const { error } = await supabase.from("vasd_queue").update({ status: "surgery", updated_at: new Date() }).eq("animal_id", animalId);
    if (error) throw error;
    
    loadAnesthesiaQueue();
  } catch (err) {
    alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
  }
};

loadAnesthesiaQueue();

supabase.channel("vasd-anesthesia-live")
  .on("postgres_changes", { event: "*", schema: "public", table: "vasd_queue" }, loadAnesthesiaQueue)
  .subscribe();

</script>
</body>
</html>
