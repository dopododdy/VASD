<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏ß‡∏≤‡∏á‡∏¢‡∏≤‡∏™‡∏•‡∏ö</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&family=Prompt:wght@300;400;500;700&family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>
:root {
  --navy:#0d1b2a; --teal:#1a6b72; --teal-light:#22919a; --accent:#00d4aa;
  --bg:#f0f4f8; --surface:#fff; --text:#1a202c; --text-muted:#718096;
  --border:#e2e8f0; --danger:#e53e3e; --success:#38a169; --warning:#d69e2e;
  --shadow-sm:0 1px 3px rgba(0,0,0,0.06); --shadow-md:0 4px 16px rgba(13,27,42,0.08);
  --radius:10px; --radius-sm:6px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{font-family:"Sarabun",sans-serif;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;}

/* HEADER */
header{
  background:var(--navy);padding:0 32px;display:flex;
  justify-content:space-between;align-items:center;height:68px;
  position:sticky;top:0;z-index:100;box-shadow:0 2px 20px rgba(0,0,0,0.25);flex-shrink:0;
}
.header-brand{display:flex;align-items:center;gap:14px;}
.brand-icon{
  width:40px;height:40px;background:linear-gradient(135deg,var(--teal-light),var(--accent));
  border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;
}
.brand-text h1{font-size:17px;font-weight:700;color:#fff;line-height:1.2;}
.brand-text span{font-size:11px;color:rgba(255,255,255,0.5);}
.btn-home{
  padding:8px 18px;font-size:13px;font-weight:600;font-family:"Sarabun",sans-serif;
  background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.9);
  border:1px solid rgba(255,255,255,0.2);border-radius:var(--radius-sm);cursor:pointer;
}

/* MAIN CONTENT */
.main-content { padding: 24px 32px; flex: 1; overflow-y: auto; }
.page-title { margin-bottom: 20px; font-size: 20px; font-weight: 700; color: var(--navy); display: flex; align-items: center; gap: 10px; }

/* GRID LAYOUT */
.grid-waiting { display:grid; grid-template-columns:repeat(auto-fill, minmax(400px, 1fr)); gap:20px; }

/* CARDS */
.card { background:var(--surface); border-radius:var(--radius); border:1px solid var(--border); box-shadow:var(--shadow-sm); padding:20px; }
.card-header { display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); padding-bottom:12px; margin-bottom:16px; }
.badge-q { background:var(--navy); color:#fff; padding:4px 10px; border-radius:20px; font-size:13px; font-weight:700; }

/* DRUG CALC BOX */
.calc-box { background:#f7fafc; border-left:4px solid var(--teal-light); padding:12px; margin-bottom:16px; border-radius:4px; font-size:13px; }
.calc-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:8px; }
.calc-item { background:#fff; padding:8px; border:1px solid var(--border); border-radius:4px; display:flex; justify-content:space-between; align-items:center; }
.calc-item span.vol { font-weight:700; color:var(--danger); }

/* FORMS */
.form-control { padding:8px 12px; font-family:"Sarabun"; border:1px solid var(--border); border-radius:var(--radius-sm); outline:none; font-size:14px; }
.form-control:focus { border-color:var(--teal); }

/* BUTTONS */
.btn { padding:10px 16px; font-size:14px; font-weight:700; font-family:"Sarabun"; border:none; border-radius:6px; cursor:pointer; transition: 0.2s; }
.btn-warning { background:var(--warning); color:#fff; }
.btn-warning:hover { background:#b7791f; }

@keyframes fadeIn{from{opacity:0;transform:translateY(5px);}to{opacity:1;transform:translateY(0);}}
</style>
</head>
<body>

<header>
  <div class="header-brand">
    <div class="brand-icon">üíâ</div>
    <div class="brand-text">
      <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏™‡∏•‡∏ö (Anesthesia)</h1>
      <span>RMUTTO ‚Äì Veterinary Academic Service Division</span>
    </div>
  </div>
  <button class="btn-home" onclick="location.href='index.html'">üè† ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
</header>

<div class="main-content">
  <div class="page-title">
    üìã ‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠‡∏ß‡∏≤‡∏á‡∏¢‡∏≤‡∏™‡∏•‡∏ö / ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≤
  </div>
  
  <div class="grid-waiting" id="waitingGrid">
    <p style="color:var(--text-muted);">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏¥‡∏ß...</p>
  </div>
</div>

<script type="module">
import { supabase } from "./js/supabase.js";

let currentEventId = null;

// ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏ï‡∏Ñ‡∏≠‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≤
const DRUG_PROTOCOL = {
  xylazine: { dose_mg_kg: 2, conc_mg_ml: 20, name: "Xylazine 20mg/ml" },
  zoletil:  { dose_mg_kg: 5, conc_mg_ml: 100, name: "Zoletil 100mg/ml" },
  tolfedine:{ dose_mg_kg: 4, conc_mg_ml: 40, name: "Tolfedine 40mg/ml" },
  penstrep: { dose_ml_kg: 0.1, name: "Pen-Strep (1ml/10kg)" }
};

async function init() {
  const { data: eventId } = await supabase.rpc("get_today_event");
  currentEventId = eventId;
  loadWaiting();
}

// ==========================================
// ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠‡∏ß‡∏≤‡∏á‡∏¢‡∏≤‡∏™‡∏•‡∏ö (Waiting)
// ==========================================
async function loadWaiting() {
  const { data, error } = await supabase
    .from("vasd_queue")
    .select(`
      id, animal_id, status,
      vasd_animal!inner(id, event_id, queue_number, animal_name, species, sex, actual_weight)
    `)
    .eq("vasd_animal.event_id", currentEventId)
    .eq("status", "waiting")
    .order("created_at");

  const grid = document.getElementById("waitingGrid");
  if (error || !data || data.length === 0) {
    grid.innerHTML = `<div style="text-align:center; padding:40px; color:var(--text-muted); width:100%; grid-column: 1 / -1;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠‡∏ß‡∏≤‡∏á‡∏¢‡∏≤‡∏™‡∏•‡∏ö</div>`;
    return;
  }

  grid.innerHTML = data.map(q => {
    const a = q.vasd_animal;
    const w = parseFloat(a.actual_weight) || 0;
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏¢‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    const volXyl = ((w * DRUG_PROTOCOL.xylazine.dose_mg_kg) / DRUG_PROTOCOL.xylazine.conc_mg_ml).toFixed(2);
    const volZol = ((w * DRUG_PROTOCOL.zoletil.dose_mg_kg) / DRUG_PROTOCOL.zoletil.conc_mg_ml).toFixed(2);
    const volTol = ((w * DRUG_PROTOCOL.tolfedine.dose_mg_kg) / DRUG_PROTOCOL.tolfedine.conc_mg_ml).toFixed(2);
    const volPen = (w * DRUG_PROTOCOL.penstrep.dose_ml_kg).toFixed(2);

    return `
      <div class="card">
        <div class="card-header">
          <div style="font-size:16px; font-weight:700;">${a.animal_name}</div>
          <span class="badge-q">‡∏Ñ‡∏¥‡∏ß ${a.queue_number}</span>
        </div>
        <div style="font-size:14px; margin-bottom:12px; display:flex; align-items:center; gap:8px;">
          ${a.species === '‡∏™' ? '‡∏™‡∏∏‡∏ô‡∏±‡∏Ç' : '‡πÅ‡∏°‡∏ß'} | ‡πÄ‡∏û‡∏®: ${a.sex} | 
          <strong style="color:var(--teal);">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏à‡∏£‡∏¥‡∏á:</strong>
          <input type="number" id="weight-${a.id}" value="${w}" step="0.01" class="form-control" style="width: 80px; padding: 4px 8px;" oninput="recalcDrugs('${a.id}')"> kg
        </div>
        
        <div class="calc-box">
          <div style="font-weight:700; margin-bottom:4px;">üíâ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≤‡∏â‡∏µ‡∏î (Pre-med & Anesthesia)</div>
          <div class="calc-grid">
            <div class="calc-item"><span>${DRUG_PROTOCOL.xylazine.name}</span> <span class="vol" id="vol-xyl-${a.id}">${volXyl} ml</span></div>
            <div class="calc-item"><span>${DRUG_PROTOCOL.zoletil.name}</span> <span class="vol" id="vol-zol-${a.id}">${volZol} ml</span></div>
            <div class="calc-item"><span>${DRUG_PROTOCOL.tolfedine.name}</span> <span class="vol" id="vol-tol-${a.id}">${volTol} ml</span></div>
            <div class="calc-item"><span>${DRUG_PROTOCOL.penstrep.name}</span> <span class="vol" id="vol-pen-${a.id}">${volPen} ml</span></div>
          </div>
        </div>
        
        <div style="text-align:right; margin-top:16px;">
          <button class="btn btn-warning" onclick="sendToAnesthesia('${a.id}')" style="width: 100%;">üíâ ‡∏ß‡∏≤‡∏á‡∏¢‡∏≤‡∏™‡∏•‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡∏Ç‡∏∂‡πâ‡∏ô‡πÇ‡∏ï‡πä‡∏∞‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î ‚Ä∫</button>
        </div>
      </div>
    `;
  }).join("");
}

// ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å
window.recalcDrugs = function(animalId) {
  const w = parseFloat(document.getElementById(`weight-${animalId}`).value) || 0;
  
  const volXyl = ((w * DRUG_PROTOCOL.xylazine.dose_mg_kg) / DRUG_PROTOCOL.xylazine.conc_mg_ml).toFixed(2);
  const volZol = ((w * DRUG_PROTOCOL.zoletil.dose_mg_kg) / DRUG_PROTOCOL.zoletil.conc_mg_ml).toFixed(2);
  const volTol = ((w * DRUG_PROTOCOL.tolfedine.dose_mg_kg) / DRUG_PROTOCOL.tolfedine.conc_mg_ml).toFixed(2);
  const volPen = (w * DRUG_PROTOCOL.penstrep.dose_ml_kg).toFixed(2);

  document.getElementById(`vol-xyl-${animalId}`).innerText = volXyl + " ml";
  document.getElementById(`vol-zol-${animalId}`).innerText = volZol + " ml";
  document.getElementById(`vol-tol-${animalId}`).innerText = volTol + " ml";
  document.getElementById(`vol-pen-${animalId}`).innerText = volPen + " ml";
};

// ‡∏¢‡πâ‡∏≤‡∏¢‡πÄ‡∏Ñ‡∏™‡πÑ‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏≤‡∏á‡∏¢‡∏≤‡∏™‡∏•‡∏ö'
window.sendToAnesthesia = async function(animalId) {
  const newWeight = parseFloat(document.getElementById(`weight-${animalId}`).value) || 0;
  if (newWeight <= 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡∏¢‡∏≤");

  if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡∏¢‡∏≤‡∏™‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÄ‡∏Ñ‡∏™‡πÑ‡∏õ‡∏£‡∏≠‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°?")) return;

  // 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏£‡∏≤‡∏á vasd_animal
  await supabase.from("vasd_animal").update({ actual_weight: newWeight }).eq("id", animalId);

  // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô anesthesia (‡∏£‡∏≠‡∏Ç‡∏∂‡πâ‡∏ô‡πÇ‡∏ï‡πä‡∏∞)
  const { error } = await supabase
    .from("vasd_queue")
    .update({ status: "anesthesia", updated_at: new Date() })
    .eq("animal_id", animalId);

  if (!error) {
    loadWaiting(); // ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏Ñ‡∏™‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)
  } else {
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
  }
};

// Real
