<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>à¸§à¸²à¸‡à¸¢à¸²à¸ªà¸¥à¸š â€“ VASD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOKENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --navy:         #0b1929;
  --navy-mid:     #112240;
  --teal:         #0ea5a0;
  --teal-light:   #14c4bc;
  --teal-glow:    rgba(14,165,160,0.25);
  --amber:        #f59e0b;
  --amber-soft:   rgba(245,158,11,0.14);
  --rose:         #ef4444;
  --rose-soft:    rgba(239,68,68,0.12);
  --emerald:      #10b981;
  --emerald-soft: rgba(16,185,129,0.15);
  --surface:      rgba(255,255,255,0.04);
  --surface-2:    rgba(255,255,255,0.07);
  --border:       rgba(255,255,255,0.08);
  --border-2:     rgba(255,255,255,0.14);
  --text:         #e2e8f0;
  --text-dim:     #94a3b8;
  --text-faint:   #4a5568;

  --radius-xs:  6px;
  --radius-sm:  10px;
  --radius:     16px;
  --radius-lg:  22px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: "Sarabun", sans-serif; background: var(--navy); color: var(--text);
  min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden;
}

header {
  position: sticky; top: 0; z-index: 200;
  background: rgba(11,25,41,0.85); backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border); padding: 10px 20px;
  display: flex; align-items: center; justify-content: space-between; height: 64px;
}
.brand { display: flex; align-items: center; gap: 10px; }
.brand-logo {
  width: 38px; height: 38px; background: linear-gradient(135deg, var(--amber), #fcd34d);
  border-radius: 10px; display: flex; align-items: center; justify-content: center;
  font-size: 18px; box-shadow: 0 0 20px rgba(245,158,11,0.25);
}
.brand-name { font-family: "Outfit", sans-serif; font-size: 15px; font-weight: 700; color: #fff; line-height: 1; }
.brand-sub { font-size: 10px; color: var(--text-dim); margin-top: 2px; }

.wrap { max-width: 800px; margin: 0 auto; padding: 24px 16px 100px; width: 100%; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.anes-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius-lg); padding: 20px; margin-bottom: 16px;
  animation: slideUp 0.4s ease both;
}

.card-top {
  display: flex; justify-content: space-between; align-items: flex-start;
  border-bottom: 1px solid var(--border); padding-bottom: 14px; margin-bottom: 14px;
}
.card-top h3 { font-size: 18px; font-weight: 700; color: #fff; margin-bottom: 4px; }
.card-top p { font-size: 12px; color: var(--text-dim); }

.q-badge {
  background: var(--amber-soft); color: var(--amber); border: 1px solid rgba(245,158,11,0.3);
  padding: 6px 14px; border-radius: 30px; font-weight: 700; font-family: "Outfit", sans-serif; font-size: 14px;
}

/* Weight Row */
.weight-row {
  display: flex; align-items: flex-end; gap: 12px;
  background: var(--surface-2); padding: 14px; border-radius: var(--radius-sm); margin-bottom: 16px;
}
.weight-row .field { flex: 1; }
.field label { display: block; font-size: 11px; color: var(--text-faint); text-transform: uppercase; margin-bottom: 6px; letter-spacing: 0.5px; }
.field input {
  width: 100%; padding: 10px 12px; font-size: 16px; font-weight: 600; font-family: "Sarabun", sans-serif;
  background: var(--navy-mid); border: 1px solid var(--border-2); border-radius: 8px; color: #fff; text-align: center;
  transition: border-color 0.2s; outline: none;
}
.field input:focus { border-color: var(--amber); }

.btn {
  padding: 10px 16px; font-size: 13px; font-weight: 600; font-family: "Sarabun", sans-serif;
  border: none; border-radius: 8px; cursor: pointer; transition: transform 0.15s, opacity 0.2s; white-space: nowrap;
}
.btn:active { transform: scale(0.96); }
.btn-calc { background: var(--amber); color: #000; }
.btn-calc:hover { background: #fcd34d; }
.btn-forward { background: var(--emerald-soft); color: var(--emerald); border: 1px solid rgba(16,185,129,0.3); width: 100%; margin-top: 16px; padding: 14px; font-size: 14px; }
.btn-forward:hover { background: rgba(16,185,129,0.25); }

/* Drug Grid */
.drug-grid {
  display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 16px;
}
.drug-box {
  background: rgba(0,0,0,0.2); border: 1px solid var(--border);
  padding: 12px; border-radius: var(--radius-sm); text-align: center;
}
.drug-name { font-size: 11px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
.drug-val { font-family: "Outfit", sans-serif; font-size: 18px; font-weight: 700; color: var(--teal-light); }
.drug-val.empty { color: var(--text-faint); font-size: 14px; font-weight: 500; font-family: "Sarabun", sans-serif; }

/* Bottom Nav */
.bottom-nav {
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 300;
  background: rgba(11,25,41,0.95); backdrop-filter: blur(20px); border-top: 1px solid var(--border-2);
  padding: 8px 0 max(8px, env(safe-area-inset-bottom));
  display: grid; grid-template-columns: repeat(5, 1fr);
}
.nav-item {
  display: flex; flex-direction: column; align-items: center; gap: 3px;
  font-size: 9px; color: var(--text-dim); text-decoration: none;
}
.nav-item.active { color: var(--amber); }
.nav-icon { font-size: 21px; }

@keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="brand-logo">ğŸ’‰</div>
    <div>
      <div class="brand-name">à¹‚à¸•à¹Šà¸°à¸§à¸²à¸‡à¸¢à¸²à¸ªà¸¥à¸š</div>
      <div class="brand-sub">Anesthesia & Pre-med</div>
    </div>
  </div>
</header>

<div class="wrap" id="anesList">
  <div style="text-align: center; color: var(--text-dim); padding: 40px;">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸„à¸´à¸§...</div>
</div>

<nav class="bottom-nav">
  <a class="nav-item" href="index.html"><span class="nav-icon">ğŸ </span>à¸«à¸™à¹‰à¸²à¸«à¸¥à¸±à¸</a>
  <a class="nav-item" href="animals.html"><span class="nav-icon">ğŸ¾</span>à¸ªà¸±à¸•à¸§à¹Œ</a>
  <a class="nav-item active" href="anesthesia.html"><span class="nav-icon">ğŸ’‰</span>à¸§à¸²à¸‡à¸¢à¸²</a>
  <a class="nav-item" href="surgery.html"><span class="nav-icon">ğŸ›ï¸</span>à¸œà¹ˆà¸²à¸•à¸±à¸”</a>
  <a class="nav-item" href="recovery.html"><span class="nav-icon">â¤ï¸â€ğŸ©¹</span>à¸à¸±à¸à¸Ÿà¸·à¹‰à¸™</a>
</nav>

<script type="module">
import { supabase } from "./js/supabase.js";

// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¹à¸›à¸¥à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸›à¹‰à¸­à¸‡à¸à¸±à¸™ HTML injection
function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

async function loadAnesthesiaQueue() {
  const container = document.getElementById("anesList");
  try {
    const { data: eventId } = await supabase.rpc("get_today_event");

    const { data: queueData, error } = await supabase
      .from("vasd_queue")
      .select(`id, animal_id, status, vasd_animal(id, event_id, queue_number, animal_name, species, sex, est_weight, actual_weight, health_note)`)
      .eq("status", "waiting")
      .order("created_at", { ascending: true });

    if (error) throw error;

    const animals = (queueData || []).filter(q => q.vasd_animal && q.vasd_animal.event_id === eventId);
    container.innerHTML = "";

    if (animals.length === 0) {
      container.innerHTML = `<div style="text-align:center; padding: 60px 20px; color: var(--text-dim);">âœ… à¹„à¸¡à¹ˆà¸¡à¸µà¸„à¸´à¸§à¸£à¸­à¸§à¸²à¸‡à¸¢à¸²à¹ƒà¸™à¸‚à¸“à¸°à¸™à¸µà¹‰</div>`;
      return;
    }

    animals.forEach(q => {
      const a = q.vasd_animal;
      const spText = a.species === "à¸ª" ? "à¸ªà¸¸à¸™à¸±à¸‚" : "à¹à¸¡à¸§";
      const preWeight = a.actual_weight || a.est_weight || "";
      
      const healthNoteHtml = a.health_note ? ` <span style="color:var(--rose); font-size:14px; font-weight:600;">(âš ï¸ ${escapeHtml(a.health_note)})</span>` : '';

      const card = document.createElement("div");
      card.className = "anes-card";
      card.innerHTML = `
        <div class="card-top">
          <div>
            <h3>${escapeHtml(a.animal_name)} <span style="font-weight:400; font-size:14px; color:var(--text-dim)">(${spText} ${a.sex})</span>${healthNoteHtml}</h3>
            <p>à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¸›à¸£à¸°à¹€à¸¡à¸´à¸™à¸•à¸­à¸™à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™: ${a.est_weight || "-"} kg</p>
          </div>
          <div class="q-badge">Q-${a.queue_number}</div>
        </div>

        <div class="weight-row">
          <div class="field">
            <label>à¸Šà¸±à¹ˆà¸‡à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¸ˆà¸£à¸´à¸‡ (KG) *</label>
            <input type="number" id="weight-${a.id}" value="${preWeight}" step="0.1" placeholder="0.0">
          </div>
          <button class="btn btn-calc" onclick="calcDrugs('${a.id}')">ğŸ§® à¸„à¸³à¸™à¸§à¸“à¸¢à¸²</button>
        </div>

        <div class="drug-grid">
          <div class="drug-box">
            <div class="drug-name">Atropine</div>
            <div class="drug-val empty" id="calc-atro-${a.id}">à¸£à¸­à¸™à¹‰à¸³à¸«à¸™à¸±à¸</div>
          </div>
          <div class="drug-box">
            <div class="drug-name">Xylazine</div>
            <div class="drug-val empty" id="calc-xyla-${a.id}">à¸£à¸­à¸™à¹‰à¸³à¸«à¸™à¸±à¸</div>
          </div>
          <div class="drug-box">
            <div class="drug-name">Zoletil</div>
            <div class="drug-val empty" id="calc-zole-${a.id}">à¸£à¸­à¸™à¹‰à¸³à¸«à¸™à¸±à¸</div>
          </div>
          <div class="drug-box">
            <div class="drug-name">Thiopental</div>
            <div class="drug-val empty" id="calc-thio-${a.id}">à¸£à¸­à¸™à¹‰à¸³à¸«à¸™à¸±à¸</div>
          </div>
        </div>

        <button class="btn btn-forward" onclick="sendToSurgery('${a.id}')">â¡ï¸ à¸ªà¸¥à¸šà¹à¸¥à¹‰à¸§ â€“ à¸ªà¹ˆà¸‡à¸•à¹ˆà¸­à¹‚à¸•à¹Šà¸°à¸œà¹ˆà¸²à¸•à¸±à¸”</button>
      `;
      container.appendChild(card);
      
      if (preWeight) window.calcDrugs(a.id);
    });

  } catch (err) {
    console.error(err);
    container.innerHTML = `<div style="text-align:center; padding: 40px; color: #fca5a5;">âŒ à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ</div>`;
  }
}

/* â”€â”€ Calculate Drugs â”€â”€ */
window.calcDrugs = function(animalId) {
  const wInput = document.getElementById(`weight-${animalId}`).value;
  const w = parseFloat(wInput);

  const setVal = (id, val, isEmpty) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = val;
    if (isEmpty) el.classList.add("empty");
    else el.classList.remove("empty");
  };

  if (!w || isNaN(w) || w <= 0) {
    setVal(`calc-atro-${animalId}`, "à¸£à¸­à¸™à¹‰à¸³à¸«à¸™à¸±à¸", true);
    setVal(`calc-xyla-${animalId}`, "à¸£à¸­à¸™à¹‰à¸³à¸«à¸™à¸±à¸", true);
    setVal(`calc-zole-${animalId}`, "à¸£à¸­à¸™à¹‰à¸³à¸«à¸™à¸±à¸", true);
    setVal(`calc-thio-${animalId}`, "à¸£à¸­à¸™à¹‰à¸³à¸«à¸™à¸±à¸", true);
    return;
  }

  // à¸›à¸£à¸±à¸šà¹à¸à¹‰à¸•à¸±à¸§à¸«à¸²à¸£à¸•à¸²à¸¡à¸„à¸§à¸²à¸¡à¹€à¸‚à¹‰à¸¡à¸‚à¹‰à¸™à¸‚à¸­à¸‡à¸¢à¸²à¹ƒà¸«à¸¡à¹ˆ
  setVal(`calc-atro-${animalId}`, `${((w * 0.04) / 1).toFixed(2)} ml`, false);
  setVal(`calc-xyla-${animalId}`, `${((w * 1) / 20).toFixed(2)} ml`, false);
  setVal(`calc-zole-${animalId}`, `${((w * 3) / 100).toFixed(2)} ml`, false);
  setVal(`calc-thio-${animalId}`, `${((w * 5) / 10).toFixed(2)} ml`, false);
};

/* â”€â”€ Send to surgery â”€â”€ */
window.sendToSurgery = async function(animalId) {
  const weightInput = document.getElementById(`weight-${animalId}`).value;
  if (!weightInput) {
    alert("à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¸ˆà¸£à¸´à¸‡à¸à¹ˆà¸­à¸™à¸ªà¹ˆà¸‡à¸•à¹ˆà¸­à¹‚à¸•à¹Šà¸°à¸œà¹ˆà¸²à¸•à¸±à¸”");
    document.getElementById(`weight-${animalId}`).focus();
    return;
  }
  if (!confirm("à¸¢à¸·à¸™à¸¢à¸±à¸™à¸à¸²à¸£à¸ªà¹ˆà¸‡à¸ªà¸±à¸•à¸§à¹Œà¹€à¸‚à¹‰à¸²à¹‚à¸•à¹Šà¸°à¸œà¹ˆà¸²à¸•à¸±à¸”?\nà¸£à¸°à¸šà¸šà¸ˆà¸°à¸­à¸±à¸›à¹€à¸”à¸•à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¸ˆà¸£à¸´à¸‡à¹à¸¥à¸°à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸ªà¸–à¸²à¸™à¸°")) return;

  try {
    await supabase.from("vasd_animal").update({ actual_weight: parseFloat(weightInput) }).eq("id", animalId);
    const { error } = await supabase.from("vasd_queue").update({ status: "surgery", updated_at: new Date() }).eq("animal_id", animalId);
    if (error) throw error;
  } catch (err) {
    alert("à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”: " + err.message);
  }
};

/* â”€â”€ Auto Reload â”€â”€ */
supabase.channel('anes-live')
  .on('postgres_changes', { event: '*', schema: 'public', table: 'vasd_queue' }, loadAnesthesiaQueue)
  .on('postgres_changes', { event: '*', schema: 'public', table: 'vasd_animal' }, loadAnesthesiaQueue)
  .subscribe();

loadAnesthesiaQueue();
</script>
<script type="module" src="./js/global-alarm.js"></script>
</body>
</html>
