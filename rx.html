<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>RMUTTO - VASD | ‡∏´‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤ (Rx)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&family=Prompt:wght@300;400;500;700&family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>
:root {
  --navy:#0d1b2a; --teal:#1a6b72; --teal-light:#22919a; --accent:#00d4aa;
  --bg:#f0f4f8; --surface:#fff; --text:#1a202c; --text-muted:#718096;
  --border:#e2e8f0; --danger:#e53e3e; --success:#38a169; --warning:#d69e2e;
  --shadow-sm:0 1px 3px rgba(0,0,0,0.06); --shadow-md:0 4px 16px rgba(13,27,42,0.08);
  --shadow-lg:0 12px 40px rgba(13,27,42,0.12);
  --radius:14px; --radius-sm:8px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{font-family:"Sarabun",sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}

/* HEADER */
header{
  background:var(--navy);padding:0 32px;display:flex;
  justify-content:space-between;align-items:center;height:68px;
  position:sticky;top:0;z-index:100;box-shadow:0 2px 20px rgba(0,0,0,0.25);
}
.header-brand{display:flex;align-items:center;gap:14px;}
.brand-icon{
  width:40px;height:40px;background:linear-gradient(135deg,var(--teal-light),var(--accent));
  border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;
}
.brand-text h1{font-size:17px;font-weight:700;color:#fff;line-height:1.2;}
.brand-text span{font-size:11px;color:rgba(255,255,255,0.5);}

.btn-home{
  padding:8px 18px;font-size:13px;font-weight:600;font-family:"Sarabun",sans-serif;
  background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.9);
  border:1px solid rgba(255,255,255,0.2);border-radius:var(--radius-sm);
  cursor:pointer;transition:background 0.2s;
}
.btn-home:hover{background:rgba(255,255,255,0.18);}

/* MAIN */
.container{max-width:1200px;margin:0 auto;padding:28px 24px;}

.page-header{
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:24px;animation:fadeUp 0.4s ease both;
}
.page-header h2{font-size:22px;font-weight:700;color:var(--navy);}

/* RX CARD */
.rx-card {
  background:var(--surface);border-radius:var(--radius);
  border:1px solid var(--border);box-shadow:var(--shadow-sm);
  margin-bottom:24px;overflow:hidden;animation:fadeUp 0.4s 0.05s ease both;
  transition:box-shadow 0.2s;
}
.rx-card:hover { box-shadow:var(--shadow-md); }

.rx-header {
  padding:16px 20px; background:#fafbfc; border-bottom:1px solid var(--border);
  display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;
}
.rx-header h3 { font-size:16px; color:var(--navy); font-weight:700; margin:0;}
.rx-header span { color:var(--text-muted); font-size:14px; font-weight:400; }
.rx-header-actions { display: flex; gap: 10px; flex-wrap:wrap; }

/* TABLE INSIDE CARD */
.table-responsive{overflow-x:auto;-webkit-overflow-scrolling:touch;}
table{width:100%;border-collapse:collapse;min-width:700px;}
thead tr{background:linear-gradient(135deg,var(--navy),#1a2f47);}
thead th{
  padding:12px 10px;text-align:left;font-size:12px;font-weight:700;
  letter-spacing:0.5px;text-transform:uppercase;color:rgba(255,255,255,0.8);
  border:none;white-space:nowrap;
}
tbody tr{border-bottom:1px solid var(--border);transition:background 0.15s;}
tbody td{padding:8px 10px;text-align:left;font-size:14px;border:none;vertical-align:middle;}
tbody tr:last-child{border-bottom:none;}

/* INPUT IN TABLE */
.rx-input {
  width:100%; padding:6px 8px; font-size:14px; font-family:"Sarabun", sans-serif;
  border:1px solid transparent; border-radius:6px; background:transparent; color:var(--text);
  outline:none; transition:all 0.2s;
}
.rx-input:not([readonly]) {
  border-color:var(--border); background:#fff;
}
.rx-input:focus:not([readonly]) {
  border-color:var(--teal-light); box-shadow:0 0 0 2px rgba(34,145,154,0.1);
}

/* BUTTONS */
.btn{
  padding:8px 16px;font-size:13px;font-weight:600;font-family:"Sarabun",sans-serif;
  border:none;border-radius:6px;cursor:pointer;
  transition:opacity 0.2s,transform 0.15s;display:inline-flex;align-items:center;gap:6px;
}
.btn:hover{opacity:0.85;transform:translateY(-1px);}
.btn-sm{padding:5px 8px; font-size:12px; gap:4px; border-radius:4px; margin-right:2px;}

.btn-dispense {background:var(--success);color:#fff;}
.btn-print-all {background:var(--navy);color:#fff;}
.btn-print {background:var(--navy);color:#fff;}
.btn-edit {background:var(--teal-light);color:#fff;}
.btn-add-rx {background:linear-gradient(135deg,var(--teal),var(--accent));color:#fff;}
.btn-save {background:var(--success);color:#fff;}
.btn-delete {background:#e2e8f0;color:var(--danger);}
.btn-delete:hover {background:var(--danger);color:#fff;}

/* UTILS */
.text-danger { color:var(--danger); font-weight:700; }
.text-muted { color:var(--text-muted); font-size:12px; }
.empty-state { text-align:center; padding:60px 20px; color:var(--text-muted); font-size:16px; }

@keyframes fadeUp{from{opacity:0;transform:translateY(14px);}to{opacity:1;transform:translateY(0);}}

/* ‚îÄ‚îÄ‚îÄ MODAL ADD RX ‚îÄ‚îÄ‚îÄ */
.modal-overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(13, 27, 42, 0.7); z-index: 1000;
  display: none; justify-content: center; align-items: center;
  padding: 20px; backdrop-filter: blur(2px);
}
.modal-overlay.active { display: flex; }
.modal-content {
  background: var(--surface); width: 100%; max-width: 700px;
  border-radius: var(--radius); box-shadow: var(--shadow-lg);
  animation: fadeUp 0.3s ease both; max-height: 90vh; display: flex; flex-direction: column;
}
.modal-header {
  padding: 18px 24px; border-bottom: 1px solid var(--border);
  display: flex; justify-content: space-between; align-items: center; background: #fafbfc; border-radius: var(--radius) var(--radius) 0 0;
}
.modal-header h3 { font-size: 18px; color: var(--navy); margin: 0; display:flex; align-items:center; gap:8px;}
.btn-close-modal { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text-muted); padding:4px;}
.btn-close-modal:hover { color: var(--danger); }
.modal-body { padding: 24px; overflow-y: auto; background:#f8fafc; }
.modal-footer {
  padding: 16px 24px; border-top: 1px solid var(--border);
  display: flex; justify-content: flex-end; gap: 10px; background: #fff; border-radius: 0 0 var(--radius) var(--radius);
}

/* ‚îÄ‚îÄ‚îÄ RX GRID (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î) ‚îÄ‚îÄ‚îÄ */
.rx-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
@media(max-width:560px){.rx-grid{grid-template-columns:1fr;}}
.rx-card-item{background:#fff; border:2px solid var(--border);border-radius:var(--radius-sm);padding:14px;
  cursor:pointer;transition:all 0.2s;}
.rx-card-item.selected{border-color:var(--teal-light);background:#e6f6f4;box-shadow:0 2px 8px rgba(34,145,154,0.15);}
.rx-card-item label{display:flex;align-items:flex-start;gap:10px;cursor:pointer; margin:0;}
.rx-card-item input[type="checkbox"]{width:18px;height:18px;accent-color:var(--teal-light);flex-shrink:0;margin-top:2px;}
.rx-cat{font-size:11px;font-weight:700;letter-spacing:0.5px;text-transform:uppercase;color:var(--text-muted);margin-bottom:3px;}
.rx-name{font-size:14px;font-weight:700;color:var(--navy);}
.rx-custom-inputs { display: none; flex-direction: column; gap: 8px; margin-top: 12px; padding-top:12px; border-top:1px dashed #cbd5e0;}
.rx-input-group { display: flex; align-items: center; gap: 8px; }
.rx-input-group label { font-size: 12px; color: var(--teal); font-weight:600; width: 50px; flex-shrink: 0; }
.rx-input-group input { flex: 1; padding: 6px 10px; font-size: 13px; font-family:"Sarabun",sans-serif; border: 1px solid var(--border); border-radius: 4px; outline:none; }
.rx-input-group input:focus{border-color:var(--teal-light);}

/* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå */
@media print {
  body { background: white; padding: 0; }
  header, .btn-home, .page-header button, .btn-dispense, .btn-print-all, .btn-add-rx, .btn-sm { display: none !important; }
  .container { padding: 0; max-width: 100%; }
  .rx-card { box-shadow: none; border: 1px solid #000; break-inside: avoid; margin-bottom: 20px; }
  .rx-header { background: #f0f0f0 !important; border-bottom: 1px solid #000; }
  table { border: 1px solid #000; }
  thead tr { background: #e0e0e0 !important; }
  thead th { color: #000 !important; border-bottom: 1px solid #000; }
  tbody td { border-bottom: 1px solid #ccc; color: #000; }
  .rx-input { border:none !important; background:transparent !important; padding:0 !important; }
  .modal-overlay { display: none !important; }
}
</style>
</head>
<body>

<header>
  <div class="header-brand">
    <div class="brand-icon">üíä</div>
    <div class="brand-text">
      <h1>‡∏´‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤ (Rx)</h1>
      <span>RMUTTO ‚Äì Veterinary Academic Service Division</span>
    </div>
  </div>
  <button class="btn-home" onclick="location.href='index.html'">üè† ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
</header>

<div class="container">
  <div class="page-header">
    <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏¢‡∏≤ / ‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤</h2>
  </div>
  <div id="rx-container">
    <div class="empty-state">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
  </div>
</div>

<div class="modal-overlay" id="rxModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>üíä ‡∏™‡∏±‡πà‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h3>
      <button class="btn-close-modal" onclick="closeRxModal()">‚úñ</button>
    </div>
    <div class="modal-body">
      <div style="margin-bottom: 14px; font-size:13px; color:var(--text-muted);" id="rxModalAnimalName"></div>
      <div class="rx-grid" id="rxModalGrid">
        </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-delete" onclick="closeRxModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn btn-save" onclick="saveNewRx()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏¢‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
    </div>
  </div>
</div>

<script type="module">
import { supabase } from "./js/supabase.js";

/* ‚îÄ‚îÄ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏¢‡∏≤ ‚îÄ‚îÄ */
function round(val) { return Math.ceil(val * 4) / 4; }

window.recalcTotalRxNew = function(did) {
  const doseStr = document.getElementById(`newrxdose-${did}`).value;
  const freqStr = document.getElementById(`newrxfreq-${did}`).value;
  const daysStr = document.getElementById(`newrxdays-${did}`).value;

  const doseMatch = doseStr.match(/[\d.]+/);
  const dose = doseMatch ? parseFloat(doseMatch[0]) : 0;
  
  const freqMatch = freqStr.match(/[\d.]+/);
  const freq = freqMatch ? parseFloat(freqMatch[0]) : 0;
  
  const days = parseFloat(daysStr) || 0;

  const total = dose * freq * days;
  document.getElementById(`newrxtotal-${did}`).value = total;
};

window.toggleNewRx = function(chk, did) {
  const card = document.getElementById(`newrxcard-${did}`);
  const inputs = document.getElementById(`newrxcustom-${did}`);
  if(chk.checked) {
    card.classList.add("selected");
    inputs.style.display = "flex"; // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
  } else {
    card.classList.remove("selected");
    inputs.style.display = "none";
  }
};

let currentRxAnimalId = null;

// ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏™‡∏±‡πà‡∏á‡∏¢‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°
window.openRxModal = function(animalId, animalName, w, species) {
  currentRxAnimalId = animalId;
  w = parseFloat(w) || 0;
  
  document.getElementById("rxModalAnimalName").innerHTML = `‡∏™‡∏±‡πà‡∏á‡∏¢‡∏≤‡πÉ‡∏´‡πâ: <strong>${animalName}</strong> (‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á: ${w} ‡∏Å‡∏Å.)`;
  const grid = document.getElementById("rxModalGrid");
  
  // ‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏¢‡∏≤‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Anesthesia ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° Custom ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á
  const drugs = [
    {id:"dox",    cat:"Antibiotic",    name:"‡∏õ‡∏è‡∏¥‡∏ä‡∏µ‡∏ß‡∏ô‡∏∞ Doxycycline 100 mg",  tabs: round((w*10)/100), freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏¢‡πá‡∏ô)", f_num:1, days:14},
    {id:"nor200", cat:"Antibiotic",    name:"‡∏õ‡∏è‡∏¥‡∏ä‡∏µ‡∏ß‡∏ô‡∏∞ Norfloxacin 200 mg",  tabs: round((w*10)/200), freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡πÄ‡∏ä‡πâ‡∏≤-‡πÄ‡∏¢‡πá‡∏ô ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£)", f_num:2, days:7},
    {id:"nor100", cat:"Antibiotic",    name:"‡∏õ‡∏è‡∏¥‡∏ä‡∏µ‡∏ß‡∏ô‡∏∞ Norfloxacin 100 mg",  tabs: round((w*10)/100), freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡πÄ‡∏ä‡πâ‡∏≤-‡πÄ‡∏¢‡πá‡∏ô ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£)", f_num:2, days:7},
    {id:"tolf60", cat:"NSAID",         name:"‡πÅ‡∏Å‡πâ‡∏õ‡∏ß‡∏î Tolfedine 60 mg",      tabs: round((w*4)/60),   freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏¢‡πá‡∏ô)", f_num:1, days:3},
    {id:"tolf6",  cat:"NSAID",         name:"‡πÅ‡∏Å‡πâ‡∏õ‡∏ß‡∏î Tolfedine 6 mg",       tabs: round((w*4)/6),    freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏¢‡πá‡∏ô)", f_num:1, days:3},
    {id:"fbc",    cat:"Blood support", name:"‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏î FBC",              tabs: round((w*1)/10)||0.25, freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏ä‡πâ‡∏≤)", f_num:1, days:14},
    {id:"custom1",cat:"‡∏≠‡∏∑‡πà‡∏ô‡πÜ",         name:"‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≤‡πÄ‡∏≠‡∏á...",                tabs: 1, freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á", f_num:1, days:5, isCustom:true}
  ];

  grid.innerHTML = drugs.map(d => `
    <div class="rx-card-item" id="newrxcard-${d.id}">
      <label>
        <input type="checkbox" id="newrxchk-${d.id}" data-name="${d.name}" onchange="toggleNewRx(this, '${d.id}')">
        <div style="width:100%;">
          <div class="rx-cat">${d.cat}</div>
          ${d.isCustom ? 
            `<input type="text" id="custom-name-${d.id}" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤..." class="rx-input" style="border:1px solid #cbd5e0; background:#fff; margin-top:4px;" onclick="event.preventDefault();">` : 
            `<div class="rx-name">${d.name}</div>`
          }
        </div>
      </label>
      <div class="rx-custom-inputs" id="newrxcustom-${d.id}">
        <div class="rx-input-group">
          <label>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì</label>
          <input type="text" id="newrxdose-${d.id}" value="‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡∏∞ ${d.tabs} ‡πÄ‡∏°‡πá‡∏î" oninput="recalcTotalRxNew('${d.id}')">
        </div>
        <div class="rx-input-group">
          <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà</label>
          <input type="text" id="newrxfreq-${d.id}" value="${d.freq}" oninput="recalcTotalRxNew('${d.id}')">
        </div>
        <div class="rx-input-group" style="display:flex; gap:10px;">
          <div style="display:flex; align-items:center; gap:8px;">
            <label>‡∏à‡∏ô.‡∏ß‡∏±‡∏ô</label>
            <input type="number" id="newrxdays-${d.id}" value="${d.days}" style="width:60px;" oninput="recalcTotalRxNew('${d.id}')">
          </div>
          <div style="display:flex; align-items:center; gap:8px;">
            <label style="color:var(--danger);">‡∏£‡∏ß‡∏°</label>
            <input type="number" step="0.25" id="newrxtotal-${d.id}" value="${d.tabs * d.f_num * d.days}" style="width:60px; font-weight:bold; color:var(--danger);">
          </div>
        </div>
      </div>
    </div>`).join("");

  document.getElementById("rxModal").classList.add("active");
};

window.closeRxModal = function() {
  document.getElementById("rxModal").classList.remove("active");
  currentRxAnimalId = null;
};

// ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
window.saveNewRx = async function() {
  if(!currentRxAnimalId) return;
  const rxInserts = [];
  
  Array.from(document.querySelectorAll(`input[id^="newrxchk-"]:checked`)).forEach(el => {
    const did = el.id.replace("newrxchk-", "");
    
    // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Custom ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á Input
    let drugName = el.dataset.name;
    if(did.startsWith("custom")) {
      const customNameInput = document.getElementById(`custom-name-${did}`);
      if(customNameInput && customNameInput.value.trim() !== "") {
        drugName = customNameInput.value.trim();
      } else {
        drugName = "‡∏¢‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°";
      }
    }

    rxInserts.push({
      animal_id:    currentRxAnimalId,
      drug_id:      drugName, 
      dose:         document.getElementById(`newrxdose-${did}`).value,
      freq:         document.getElementById(`newrxfreq-${did}`).value,
      days:         parseInt(document.getElementById(`newrxdays-${did}`).value) || 5,
      total_pills:  parseFloat(document.getElementById(`newrxtotal-${did}`).value) || 0 
    });
  });

  if(rxInserts.length === 0) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
    return;
  }

  const btnSave = document.querySelector("#rxModal .btn-save");
  btnSave.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
  btnSave.disabled = true;

  const { error } = await supabase.from("vasd_prescription").insert(rxInserts);
  
  btnSave.innerText = "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏¢‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°";
  btnSave.disabled = false;

  if(error) {
    alert("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
  } else {
    closeRxModal();
    // loadPrescriptions ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ú‡πà‡∏≤‡∏ô Real-time listener
  }
};

/* ‚îÄ‚îÄ MAIN LOGIC ‚îÄ‚îÄ */
async function loadPrescriptions() {
  try {
    const { data: eventId } = await supabase.rpc("get_today_event");

    // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á actual_weight ‡πÅ‡∏•‡∏∞ est_weight ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≤
    const { data: queueData, error } = await supabase
      .from("vasd_queue")
      .select(`
        id, animal_id, status,
        vasd_animal ( 
          event_id, queue_number, animal_name, species, sex, actual_weight, est_weight,
          vasd_owner(owner_name, phone),
          vasd_service(service_type),
          vasd_prescription ( id, drug_id, dose, freq, days, total_pills )
        )
      `)
      .in("status", ["recovery", "ready_to_go_home"])
      .order("updated_at", { ascending: false });

    if (error) {
      console.error("Error fetching Rx:", error);
      document.getElementById("rx-container").innerHTML = `<div class="empty-state text-danger">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${error.message}</div>`;
      return;
    }

    const animalsWithRx = (queueData || []).filter(q => 
      q.vasd_animal && 
      q.vasd_animal.event_id === eventId && 
      q.vasd_animal.vasd_prescription && 
      q.vasd_animal.vasd_prescription.length > 0
    );

    const container = document.getElementById("rx-container");
    container.innerHTML = "";

    if (animalsWithRx.length === 0) {
      container.innerHTML = `<div class="empty-state">‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏¢‡∏≤‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</div>`;
      return;
    }

    animalsWithRx.forEach((q, index) => {
      const animal = q.vasd_animal;
      const ownerName = animal.vasd_owner ? animal.vasd_owner.owner_name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
      const species = animal.species === "‡∏™" ? "‡∏™‡∏∏‡∏ô‡∏±‡∏Ç" : (animal.species === "‡∏°" ? "‡πÅ‡∏°‡∏ß" : animal.species);
      const rxList = animal.vasd_prescription; 
      const weight = animal.actual_weight || animal.est_weight || 0;

      const allRxIds = rxList.map(rx => rx.id).join(",");

      let rxRows = rxList.map((rx, idx) => `
        <tr id="rx-row-${rx.id}">
          <td style="width:5%; text-align:center;">${idx + 1}</td>
          <td style="width:25%;">
            <input type="text" class="rx-input rx-drug" value="${rx.drug_id || ''}" readonly placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤">
          </td>
          <td style="width:20%;">
            <input type="text" class="rx-input rx-dose" value="${rx.dose || ''}" readonly placeholder="‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì">
          </td>
          <td style="width:20%;">
            <input type="text" class="rx-input rx-freq" value="${rx.freq || ''}" readonly placeholder="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà">
          </td>
          <td style="width:10%;">
            <input type="number" class="rx-input rx-days" value="${rx.days || ''}" readonly placeholder="‡∏ß‡∏±‡∏ô" style="width:60px;">
          </td>
          <td style="width:10%;">
            <input type="number" step="0.25" class="rx-input rx-total text-danger" value="${rx.total_pills || 0}" readonly placeholder="‡πÄ‡∏°‡πá‡∏î" style="width:60px; font-weight:bold;">
          </td>
          <td style="width:10%; white-space:nowrap;">
            <button class="btn btn-print btn-sm" onclick="printRx('${rx.id}')" title="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏â‡∏•‡∏≤‡∏Å‡∏¢‡∏≤">üñ®Ô∏è</button>
            <button class="btn btn-edit btn-sm btn-action-edit" onclick="editRx(this)" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‚úèÔ∏è</button>
            <button class="btn btn-save btn-sm btn-action-save" onclick="saveRx(this, '${rx.id}')" style="display:none;" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å">üíæ</button>
            <button class="btn btn-delete btn-sm" onclick="deleteRx('${rx.id}')" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">üóëÔ∏è</button>
          </td>
        </tr>
      `).join("");

      const card = document.createElement("div");
      card.className = "rx-card";
      card.style.animationDelay = `${(index * 0.1) + 0.1}s`; 
      
      card.innerHTML = `
        <div class="rx-header">
          <h3>üêæ ${animal.animal_name} <span style="font-weight:normal;">(${species})</span> <span style="margin-left:8px;font-size:13px;">| ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á: ${ownerName}</span></h3>
          <div class="rx-header-actions">
            <button class="btn btn-add-rx" onclick="openRxModal('${q.animal_id}', '${animal.animal_name}', ${weight}, '${animal.species}')">üíä ‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
            <button class="btn btn-print-all" onclick="printMultipleRx('${allRxIds}')">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button class="btn btn-dispense" onclick="markAsDispensed('${q.animal_id}')">‚úîÔ∏è ‡∏à‡∏±‡∏î‡∏¢‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>
          </div>
        </div>
        <div class="table-responsive">
          <table>
            <thead>
              <tr>
                <th style="text-align:center;">#</th>
                <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤ (Drug ID)</th>
                <th>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì/‡∏Ñ‡∏£‡∏±‡πâ‡∏á</th>
                <th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà</th>
                <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô</th>
                <th>‡∏£‡∏ß‡∏° (‡πÄ‡∏°‡πá‡∏î)</th>
                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody>
              ${rxRows}
            </tbody>
          </table>
        </div>
      `;
      container.appendChild(card);
    });
  } catch (err) {
    console.error("Javascript Error:", err);
    document.getElementById("rx-container").innerHTML = `<div class="empty-state text-danger">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö: ${err.message}</div>`;
  }
}

// ------------------------------------
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô ‡∏à‡∏±‡∏î‡∏¢‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô (‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≠‡∏Å)
// ------------------------------------
window.markAsDispensed = async function(animalId) {
  if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß?\n(‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô '‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß')")) {
    const { error } = await supabase
      .from("vasd_queue")
      .update({ status: "done", updated_at: new Date() })
      .eq("animal_id", animalId);
      
    if (error) {
      alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
      console.error(error);
    } else {
      loadPrescriptions();
    }
  }
};

// ------------------------------------
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡πÅ‡∏•‡∏∞ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≤
// ------------------------------------
window.editRx = function(btn) {
  const tr = btn.closest("tr");
  const inputs = tr.querySelectorAll(".rx-input");
  inputs.forEach(input => input.removeAttribute("readonly"));
  
  tr.querySelector(".btn-action-edit").style.display = "none";
  tr.querySelector(".btn-action-save").style.display = "inline-flex";
};

window.saveRx = async function(btn, rxId) {
  const tr = btn.closest("tr");
  
  const drug_id = tr.querySelector(".rx-drug").value;
  const dose = tr.querySelector(".rx-dose").value;
  const freq = tr.querySelector(".rx-freq").value;
  const days = parseInt(tr.querySelector(".rx-days").value) || 0;
  const total_pills = parseFloat(tr.querySelector(".rx-total").value) || 0;

  const { error } = await supabase
    .from("vasd_prescription")
    .update({ drug_id, dose, freq, days, total_pills })
    .eq("id", rxId);

  if (error) {
    alert("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
    return;
  }

  const inputs = tr.querySelectorAll(".rx-input");
  inputs.forEach(input => input.setAttribute("readonly", true));

  tr.querySelector(".btn-action-save").style.display = "none";
  tr.querySelector(".btn-action-edit").style.display = "inline-flex";
};

// ------------------------------------
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤
// ------------------------------------
window.deleteRx = async function(rxId) {
  if(!confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;

  const { error } = await supabase
    .from("vasd_prescription")
    .delete()
    .eq("id", rxId);

  if (error) {
    alert("‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
  } else {
    document.getElementById(`rx-row-${rxId}`).remove();
  }
};

// ------------------------------------
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô ‡∏î‡∏∂‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏ó‡∏ô‡∏Ñ‡πà‡∏≤ Template ‡∏¢‡∏≤
// ------------------------------------
async function generateStickerHTML(rxId) {
  const { data: rx, error } = await supabase
    .from("vasd_prescription")
    .select(`
      *,
      vasd_animal (
        queue_number, animal_name, species, sex,
        vasd_owner ( owner_name, phone ),
        vasd_service ( service_type )
      )
    `)
    .eq("id", rxId)
    .single();

  if (error || !rx) return null;

  let { data: tmpl } = await supabase.from("vasd_print_template").select("config").eq("template_type", "envelope").single();
  if (!tmpl || !tmpl.config) {
    const { data: bagTmpl } = await supabase.from("vasd_print_template").select("config").eq("template_type", "bag").single();
    tmpl = bagTmpl;
  }
  if (!tmpl || !tmpl.config) return null;

  const a = rx.vasd_animal;
  const spcText = a.species === "‡∏™" ? "‡∏™‡∏∏‡∏ô‡∏±‡∏Ç" : (a.species === "‡∏°" ? "‡πÅ‡∏°‡∏ß" : a.species);
  const ownerName = a.vasd_owner?.owner_name || "";
  const phone = a.vasd_owner?.phone || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
  const services = a.vasd_service?.map(s => s.service_type).join(", ") || "-";

  let html = `<div class="sticker-page">`;
  tmpl.config.forEach(l => {
    let text = l.text
      .replace("{{queue_number}}", a.queue_number || "")
      .replace("{{animal_name}}", a.animal_name || "")
      .replace("{{species}}", spcText)
      .replace("{{sex}}", a.sex || "")
      .replace("{{owner_name}}", ownerName)
      .replace("{{phone}}", phone)
      .replace("{{services}}", services)
      .replace("{{drug_id}}", rx.drug_id || "")
      .replace("{{dose}}", rx.dose || "")
      .replace("{{freq}}", rx.freq || "")
      .replace("{{days}}", rx.days ? rx.days + " ‡∏ß‡∏±‡∏ô" : "")
      .replace("{{total_pills}}", rx.total_pills ? rx.total_pills + " ‡πÄ‡∏°‡πá‡∏î" : "");

    html += `<div class="line" style="left:${l.x||0}px;right:0;top:${l.y||0}px;font-size:${l.size}px;font-weight:${l.weight};font-family:${l.font};text-align:${l.align||"left"};">${text}</div>`;
  });
  html += `</div>`;
  
  return html;
}

// ------------------------------------
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏¢‡∏≤ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
// ------------------------------------
window.printRx = async function(rxId) {
  const content = await generateStickerHTML(rxId);
  if (!content) { alert("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Template ‡∏ã‡∏≠‡∏á‡∏¢‡∏≤/‡∏ñ‡∏∏‡∏á‡∏¢‡∏≤"); return; }
  openPrintWindow(content);
};

// ------------------------------------
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏¢‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡πâ‡∏ô
// ------------------------------------
window.printMultipleRx = async function(rxIdsStr) {
  const rxIds = rxIdsStr.split(",");
  let allContents = "";

  for (let id of rxIds) {
    const content = await generateStickerHTML(id);
    if (content) allContents += content;
  }

  if (allContents === "") { alert("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå"); return; }
  openPrintWindow(allContents);
};

function openPrintWindow(htmlContent) {
  const pw = window.open("","_blank","width=800,height=600");
  pw.document.write(`<html><head><title>Print Rx</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&family=Prompt:wght@400;700&family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
      body { margin: 0; }
      .sticker-page { position: relative; width: 80mm; height: 50mm; background: #fff; overflow: hidden; page-break-after: always; }
      .line { position: absolute; white-space: pre-wrap; word-break: break-word; padding-right: 5px; box-sizing: border-box; color: #000 !important; }
      @page { size: 80mm 50mm; margin: 0; }
    </style>
    </head><body>${htmlContent}
    <script>window.onload=function(){document.fonts.ready.then(()=>{setTimeout(()=>{window.print();window.close();},300);});}<\/script></body></html>`);
  pw.document.close();
}

// ‡∏™‡∏±‡πà‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
loadPrescriptions();

// ‡πÄ‡∏õ‡∏¥‡∏î Realtime
supabase.channel("vasd-rx-live")
  .on("postgres_changes", { event: "*", schema: "public", table: "vasd_queue" }, loadPrescriptions)
  .on("postgres_changes", { event: "*", schema: "public", table: "vasd_prescription" }, loadPrescriptions)
  .subscribe();
</script>
</body>
</html>
