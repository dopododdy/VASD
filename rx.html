<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>RMUTTO - VASD | ‡∏´‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤ (Rx)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&family=Prompt:wght@300;400;500;700&family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>
:root {
  --navy:#0d1b2a; --teal:#1a6b72; --teal-light:#22919a; --accent:#00d4aa;
  --bg:#f0f4f8; --surface:#fff; --text:#1a202c; --text-muted:#718096;
  --border:#e2e8f0; --danger:#e53e3e; --success:#38a169; --warning:#d69e2e;
  --shadow-sm:0 1px 3px rgba(0,0,0,0.06); --shadow-md:0 4px 16px rgba(13,27,42,0.08);
  --radius:14px; --radius-sm:8px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{font-family:"Sarabun",sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}

/* HEADER */
header{
  background:var(--navy);padding:0 32px;display:flex;
  justify-content:space-between;align-items:center;height:68px;
  position:sticky;top:0;z-index:100;box-shadow:0 2px 20px rgba(0,0,0,0.25);
}
.header-brand{display:flex;align-items:center;gap:14px;}
.brand-icon{
  width:40px;height:40px;background:linear-gradient(135deg,var(--teal-light),var(--accent));
  border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;
}
.brand-text h1{font-size:17px;font-weight:700;color:#fff;line-height:1.2;}
.brand-text span{font-size:11px;color:rgba(255,255,255,0.5);}

.btn-home{
  padding:8px 18px;font-size:13px;font-weight:600;font-family:"Sarabun",sans-serif;
  background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.9);
  border:1px solid rgba(255,255,255,0.2);border-radius:var(--radius-sm);
  cursor:pointer;transition:background 0.2s;
}
.btn-home:hover{background:rgba(255,255,255,0.18);}

/* MAIN */
.container{max-width:1200px;margin:0 auto;padding:28px 24px;}

.page-header{
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:24px;animation:fadeUp 0.4s ease both;
}
.page-header h2{font-size:22px;font-weight:700;color:var(--navy);}

/* RX CARD (‡πÅ‡∏ó‡∏ô Table Wrap ‡πÄ‡∏î‡∏¥‡∏° ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏µ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏™) */
.rx-card {
  background:var(--surface);border-radius:var(--radius);
  border:1px solid var(--border);box-shadow:var(--shadow-sm);
  margin-bottom:24px;overflow:hidden;animation:fadeUp 0.4s 0.05s ease both;
  transition:box-shadow 0.2s;
}
.rx-card:hover { box-shadow:var(--shadow-md); }

.rx-header {
  padding:16px 20px; background:#fafbfc; border-bottom:1px solid var(--border);
  display:flex; justify-content:space-between; align-items:center;
}
.rx-header h3 { font-size:16px; color:var(--navy); font-weight:700; }
.rx-header span { color:var(--text-muted); font-size:14px; font-weight:400; }

/* TABLE INSIDE CARD */
.table-responsive{overflow-x:auto;-webkit-overflow-scrolling:touch;}
table{width:100%;border-collapse:collapse;min-width:600px;}
thead tr{background:linear-gradient(135deg,var(--navy),#1a2f47);}
thead th{
  padding:12px 16px;text-align:left;font-size:12px;font-weight:700;
  letter-spacing:0.5px;text-transform:uppercase;color:rgba(255,255,255,0.8);
  border:none;white-space:nowrap;
}
tbody tr{border-bottom:1px solid var(--border);transition:background 0.15s;}
tbody td{padding:12px 16px;text-align:left;font-size:14px;border:none;vertical-align:middle;}
tbody tr:last-child{border-bottom:none;}

/* BUTTONS */
.btn{
  padding:8px 16px;font-size:13px;font-weight:600;font-family:"Sarabun",sans-serif;
  border:none;border-radius:6px;cursor:pointer;
  transition:opacity 0.2s,transform 0.15s;display:inline-flex;align-items:center;gap:6px;
}
.btn:hover{opacity:0.85;transform:translateY(-1px);}
.btn-print {background:var(--navy);color:#fff;}
.btn-dispense {background:var(--success);color:#fff;}

/* UTILS */
.text-danger { color:var(--danger); font-weight:700; }
.text-muted { color:var(--text-muted); font-size:12px; }
.empty-state { text-align:center; padding:60px 20px; color:var(--text-muted); font-size:16px; }

@keyframes fadeUp{from{opacity:0;transform:translateY(14px);}to{opacity:1;transform:translateY(0);}}

/* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå (PRINT) */
@media print {
  body { background: white; padding: 0; }
  header, .btn-home, .page-header button, .btn-dispense { display: none !important; }
  .container { padding: 0; max-width: 100%; }
  .rx-card { box-shadow: none; border: 1px solid #000; break-inside: avoid; margin-bottom: 20px; }
  .rx-header { background: #f0f0f0 !important; border-bottom: 1px solid #000; }
  table { border: 1px solid #000; }
  thead tr { background: #e0e0e0 !important; }
  thead th { color: #000 !important; border-bottom: 1px solid #000; }
  tbody td { border-bottom: 1px solid #ccc; color: #000; }
}
</style>
</head>
<body>

<header>
  <div class="header-brand">
    <div class="brand-icon">üíä</div>
    <div class="brand-text">
      <h1>‡∏´‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤ (Rx)</h1>
      <span>RMUTTO ‚Äì Veterinary Academic Service Division</span>
    </div>
  </div>
  <button class="btn-home" onclick="location.href='index.html'">üè† ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
</header>

<div class="container">

  <div class="page-header">
    <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏¢‡∏≤ / ‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤</h2>
    <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏¢‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
  </div>

  <div id="rx-container">
    <div class="empty-state">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
  </div>

</div>

<script type="module">
import { supabase } from "./js/supabase.js";

async function loadPrescriptions() {
  // ‡∏î‡∏∂‡∏á Event ID ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏Ñ‡∏™‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
  const { data: eventId } = await supabase.rpc("get_today_event");

  // ‡∏î‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏±‡∏Å‡∏ü‡∏∑‡πâ‡∏ô (recovery), ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö (ready_to_go_home) ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤
  const { data: queueData, error } = await supabase
    .from("vasd_queue")
    .select(`
      id, animal_id, status,
      vasd_animal ( event_id, animal_name, species, vasd_owner(owner_name) ),
      vasd_prescription ( id, drug_id, dose, freq, days, total_pills )
    `)
    .in("status", ["recovery", "ready_to_go_home"])
    .order("updated_at", { ascending: false });

  if (error) {
    console.error("Error fetching Rx:", error);
    document.getElementById("rx-container").innerHTML = `<div class="empty-state text-danger">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
    return;
  }

  // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏Ñ‡∏™‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏¢‡∏≤ (vasd_prescription ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
  const animalsWithRx = queueData.filter(q => 
    q.vasd_animal && 
    q.vasd_animal.event_id === eventId && 
    q.vasd_prescription && 
    q.vasd_prescription.length > 0
  );

  const container = document.getElementById("rx-container");
  container.innerHTML = "";

  if (animalsWithRx.length === 0) {
    container.innerHTML = `<div class="empty-state">‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏¢‡∏≤‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</div>`;
    return;
  }

  // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤
  animalsWithRx.forEach((q, index) => {
    const animal = q.vasd_animal;
    const ownerName = animal.vasd_owner ? animal.vasd_owner.owner_name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    const species = animal.species === "‡∏™" ? "‡∏™‡∏∏‡∏ô‡∏±‡∏Ç" : (animal.species === "‡∏°" ? "‡πÅ‡∏°‡∏ß" : animal.species);
    const rxList = q.vasd_prescription;

    let rxRows = rxList.map((rx, idx) => `
      <tr>
        <td style="width:5%;">${idx + 1}</td>
        <td style="width:35%;"><strong>‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏≤: ${rx.drug_id}</strong> <br><span class="text-muted">‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡∏à‡∏≤‡∏Å Catalog ‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á</span></td>
        <td style="width:20%;">${rx.dose || '-'}</td>
        <td style="width:20%;">${rx.freq || '-'}</td>
        <td style="width:10%;">${rx.days ? rx.days + ' ‡∏ß‡∏±‡∏ô' : '-'}</td>
        <td style="width:10%;" class="text-danger">${rx.total_pills || 0} ‡πÄ‡∏°‡πá‡∏î</td>
      </tr>
    `).join("");

    const card = document.createElement("div");
    card.className = "rx-card";
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° delay ‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡πâ‡πÑ‡∏•‡πà‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏•‡∏á‡∏°‡∏≤‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
    card.style.animationDelay = `${(index * 0.1) + 0.1}s`; 
    
    card.innerHTML = `
      <div class="rx-header">
        <h3>üêæ ${animal.animal_name} <span style="font-weight:normal;">(${species})</span> <span>| ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á: ${ownerName}</span></h3>
        <button class="btn btn-dispense" onclick="markAsDispensed('${q.animal_id}')">‚úîÔ∏è ‡∏à‡∏±‡∏î‡∏¢‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>
      </div>
      <div class="table-responsive">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤ (Drug ID)</th>
              <th>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì/‡∏Ñ‡∏£‡∏±‡πâ‡∏á</th>
              <th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà</th>
              <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô</th>
              <th>‡∏£‡∏ß‡∏°</th>
            </tr>
          </thead>
          <tbody>
            ${rxRows}
          </tbody>
        </table>
      </div>
    `;
    container.appendChild(card);
  });
}

window.markAsDispensed = async function(animalId) {
  if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß?\n(‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô '‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß')")) {
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô done (‡∏´‡∏£‡∏∑‡∏≠ ready_to_go_home ‡∏ï‡∏≤‡∏° Workflow ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å)
    const { error } = await supabase
      .from("vasd_queue")
      .update({ status: "done", updated_at: new Date() })
      .eq("animal_id", animalId);
      
    if (error) {
      alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
      console.error(error);
    } else {
      loadPrescriptions(); // ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
    }
  }
};

// ‡∏™‡∏±‡πà‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
loadPrescriptions();

// ‡πÄ‡∏õ‡∏¥‡∏î Realtime ‡∏î‡∏±‡∏Å‡∏ü‡∏±‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏¥‡∏ß ‡πÅ‡∏•‡∏∞ ‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏¢‡∏≤
supabase.channel("vasd-rx-live")
  .on("postgres_changes", { event: "*", schema: "public", table: "vasd_queue" }, () => {
    console.log("üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á vasd_queue");
    loadPrescriptions();
  })
  .on("postgres_changes", { event: "*", schema: "public", table: "vasd_prescription" }, () => {
    console.log("üíä ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á vasd_prescription");
    loadPrescriptions();
  })
  .subscribe();
</script>
</body>
</html>
