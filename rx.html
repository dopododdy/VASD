<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡πÇ‡∏ï‡πä‡∏∞‡∏à‡∏±‡∏î‡∏¢‡∏≤ ‚Äì VASD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TOKENS & BASE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
:root {
  --navy:         #0b1929;
  --navy-mid:      #112240;
  --sky:           #0ea5e9; 
  --sky-light:     #38bdf8;
  --teal:          #0ea5a0;
  --emerald:       #10b981;
  --violet:        #8b5cf6;
  --rose:          #ef4444;

  --surface:    rgba(255,255,255,0.04);
  --surface-2:  rgba(255,255,255,0.07);
  --border:     rgba(255,255,255,0.08);
  --border-2:   rgba(255,255,255,0.14);
  --text:       #e2e8f0;
  --text-dim:   #94a3b8;

  --radius-sm: 10px;
  --radius-lg: 22px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: "Sarabun", sans-serif;
  background: var(--navy); color: var(--text);
  min-height: 100vh; display: flex; flex-direction: column;
  overflow-x: hidden; padding-bottom: 100px;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   HEADER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
header {
  position: sticky; top: 0; z-index: 200;
  background: rgba(11,25,41,0.88); backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  padding: 15px 20px; display: flex; align-items: center; justify-content: space-between;
}
.brand { display: flex; align-items: center; gap: 10px; }
.brand-logo {
  width: 38px; height: 38px;
  background: linear-gradient(135deg, var(--sky), var(--sky-light));
  border-radius: 10px; display: flex; align-items: center; justify-content: center;
  font-size: 18px; box-shadow: 0 0 20px rgba(14, 165, 233, 0.3);
}
.brand-name { font-family: "Outfit", sans-serif; font-size: 16px; font-weight: 700; color: #fff; line-height: 1; }
.brand-sub { font-size: 11px; color: var(--text-dim); margin-top: 2px; }

.badge-count {
  background: rgba(14, 165, 233, 0.15); border: 1px solid rgba(14, 165, 233, 0.3);
  color: var(--sky-light); font-size: 12px; font-weight: 600;
  padding: 6px 14px; border-radius: 20px;
}

.wrap { max-width: 800px; margin: 0 auto; padding: 20px 16px; width: 100%; }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RX CARD
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.rx-card {
  background: var(--surface); border: 1px solid var(--border-2);
  border-radius: var(--radius-lg); overflow: hidden; margin-bottom: 16px;
  animation: slideUp 0.4s ease both;
}
.card-header {
  display: flex; align-items: center; gap: 12px; padding: 16px;
  border-bottom: 1px solid var(--border); background: var(--surface-2);
}
.q-circle {
  font-family: "Outfit", sans-serif; width: 46px; height: 46px; border-radius: 50%;
  background: var(--sky); color: #fff;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px; font-weight: 800; flex-shrink: 0;
  box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
}
.sc-title-block { flex: 1; }
.sc-animal-name { font-family: "Outfit", sans-serif; font-size: 18px; font-weight: 800; color: #fff; }
.sc-meta { font-size: 12px; color: var(--text-dim); margin-top: 4px; display: flex; align-items: center; flex-wrap: wrap; gap: 6px; }

.rx-list-container { padding: 16px; }
.rx-list-title { font-size: 12px; font-weight: 700; color: var(--text-dim); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }

.rx-item {
  display: flex; gap: 12px; background: var(--surface-2); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 14px; margin-bottom: 10px; align-items: center;
}
.rx-idx {
  width: 24px; height: 24px; border-radius: 50%; background: rgba(255,255,255,0.1);
  display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; color: var(--text-dim);
  flex-shrink: 0; align-self: flex-start;
}
.rx-details { flex: 1; }
.rx-name { font-size: 15px; font-weight: 700; color: #fff; margin-bottom: 6px; }
.rx-desc { font-size: 13px; color: var(--text-dim); margin-bottom: 2px; }
.rx-desc b { color: var(--sky-light); }

.btn-print-single {
  background: rgba(14, 165, 233, 0.1); border: 1px solid var(--sky);
  color: var(--sky-light); border-radius: 8px; padding: 8px 12px;
  cursor: pointer; font-size: 12px; font-weight: 600; font-family: "Sarabun", sans-serif;
  transition: 0.2s; white-space: nowrap; flex-shrink: 0;
}
.btn-print-single:hover { background: var(--sky); color: #fff; }

.card-footer {
  display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
  padding: 16px; background: var(--surface-2); border-top: 1px solid var(--border);
}
@media (max-width: 500px) { .card-footer { grid-template-columns: 1fr; } }

.btn {
  padding: 12px 16px; font-size: 14px; font-weight: 600; font-family: "Sarabun", sans-serif;
  border: none; border-radius: var(--radius-sm); cursor: pointer; text-align: center; transition: 0.2s;
}
.btn-sky { background: rgba(14, 165, 233, 0.15); color: var(--sky-light); border: 1px solid rgba(14, 165, 233, 0.3); }
.btn-sky:hover { background: rgba(14, 165, 233, 0.25); }
.btn-emerald { background: linear-gradient(135deg, var(--emerald), #34d399); color: #fff; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25); }
.btn-emerald:hover { opacity: 0.9; transform: translateY(-1px); }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BOTTOM NAV
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.bottom-nav {
  display: grid; position: fixed; bottom: 0; left: 0; right: 0; z-index: 300;
  background: rgba(11,25,41,0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  border-top: 1px solid var(--border-2);
  padding: 8px 0 max(8px, env(safe-area-inset-bottom));
  grid-template-columns: repeat(5, 1fr);
}
.nav-item {
  display: flex; flex-direction: column; align-items: center; gap: 3px; padding: 6px 4px;
  font-size: 9px; color: var(--text-dim); text-decoration: none; transition: color 0.2s;
}
.nav-item.active { color: var(--teal); }
.nav-icon { font-size: 21px; line-height: 1; }

@keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PRINT STYLES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#printArea { display: none; }
@media print {
  body > :not(#printArea) { display: none !important; }
  #printArea { display: block !important; color: #000; background: #fff; }
  .print-page { padding: 20px; page-break-after: always; font-family: "Sarabun", sans-serif; }
  .p-title { font-size: 20px; font-weight: 700; text-align: center; margin-bottom: 10px; border-bottom: 2px solid #000; padding-bottom: 10px; }
  .p-meta { font-size: 14px; margin-bottom: 20px; }
  .p-rx-item { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #ccc; }
  .p-rx-name { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
  .p-rx-desc { font-size: 14px; margin-bottom: 2px; }
}
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="brand-logo">üíä</div>
    <div>
      <div class="brand-name">‡πÇ‡∏ï‡πä‡∏∞‡∏à‡∏±‡∏î‡∏¢‡∏≤ (Pharmacy)</div>
      <div class="brand-sub">‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</div>
    </div>
  </div>
  <div class="badge-count" id="count-badge">0 ‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏¢‡∏≤</div>
</header>

<div class="wrap" id="rx-container">
  <div style="text-align: center; color: var(--text-dim); padding: 40px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
</div>

<nav class="bottom-nav">
  <a class="nav-item" href="index.html"><span class="nav-icon">üè†</span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
  <a class="nav-item" href="animals.html"><span class="nav-icon">üêæ</span>‡∏™‡∏±‡∏ï‡∏ß‡πå</a>
  <a class="nav-item" href="anesthesia.html"><span class="nav-icon">üíâ</span>‡∏ß‡∏≤‡∏á‡∏¢‡∏≤</a>
  <a class="nav-item" href="surgery.html"><span class="nav-icon">üõèÔ∏è</span>‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î</a>
  <a class="nav-item" href="recovery.html"><span class="nav-icon">‚ù§Ô∏è‚Äçü©π</span>‡∏û‡∏±‡∏Å‡∏ü‡∏∑‡πâ‡∏ô</a>
</nav>

<div id="printArea"></div>

<script type="module">
import { supabase } from "./js/supabase.js";

// ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå
window.rxDataMap = {}; 

async function loadRxQueue() {
  const container = document.getElementById("rx-container");
  
  try {
    // ‡∏î‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î, ‡∏û‡∏±‡∏Å‡∏ü‡∏∑‡πâ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô
    const { data: queueData, error } = await supabase
      .from("vasd_queue")
      .select(`
        id, animal_id, status, 
        vasd_animal(id, queue_number, animal_name, species, actual_weight,
          vasd_owner(owner_name),
          vasd_prescription(*)
        )
      `)
      .in("status", ["surgery", "recovery", "ready_to_go_home"])
      .order("updated_at", { ascending: true });

    if (error) throw error;

    // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏¢‡∏≤‡∏™‡∏±‡πà‡∏á‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß
    const animals = (queueData || []).filter(q => {
      if (!q.vasd_animal) return false;
      const hasRx = q.vasd_animal.vasd_prescription && q.vasd_animal.vasd_prescription.length > 0;
      return hasRx || q.status === "ready_to_go_home";
    });
    
    if (animals.length === 0) {
      document.getElementById("count-badge").innerText = "0 ‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏¢‡∏≤";
      container.innerHTML = `<div style="text-align:center; padding: 60px 20px; color: var(--text-dim);">‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏¢‡∏≤‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</div>`;
      return;
    }

    document.getElementById("count-badge").innerText = `${animals.length} ‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏¢‡∏≤`;
    container.innerHTML = "";
    window.rxDataMap = {}; // Reset map

    animals.forEach(q => {
      const a = q.vasd_animal;
      const ownerName = a.vasd_owner?.owner_name || "-";
      window.rxDataMap[a.id] = a; // Save for printing
      
      let rxHtml = "";
      if (a.vasd_prescription && a.vasd_prescription.length > 0) {
        rxHtml = a.vasd_prescription.map((rx, i) => `
          <div class="rx-item">
            <div class="rx-idx">${i + 1}</div>
            <div class="rx-details">
              <div class="rx-name">${rx.drug_id}</div>
              <div class="rx-desc">‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ: ‡∏õ‡πâ‡∏≠‡∏ô <b>${rx.dose}</b> ¬∑ ${rx.freq}</div>
              <div class="rx-desc">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢: <b>${rx.total_pills}</b> ‡πÄ‡∏°‡πá‡∏î (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${rx.days} ‡∏ß‡∏±‡∏ô)</div>
            </div>
            <button class="btn-print-single" onclick="printSingleRx('${a.id}', ${i})">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
          </div>
        `).join('');
      } else {
        rxHtml = `<div style="color:var(--text-dim); font-size:13px; text-align:center; padding:20px; background:var(--surface-2); border-radius:10px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ</div>`;
      }

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡πâ‡∏≤‡∏¢‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
      let statusBadge = "";
      if (q.status === 'surgery') {
        statusBadge = '<span style="background:var(--rose); color:#fff; padding:2px 6px; border-radius:6px; font-size:10px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î</span>';
      } else if (q.status === 'recovery') {
        statusBadge = '<span style="background:var(--violet); color:#fff; padding:2px 6px; border-radius:6px; font-size:10px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏Å‡∏ü‡∏∑‡πâ‡∏ô</span>';
      } else if (q.status === 'ready_to_go_home') {
        statusBadge = '<span style="background:var(--emerald); color:#fff; padding:2px 6px; border-radius:6px; font-size:10px;">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô</span>';
      }

      const card = document.createElement("div");
      card.className = "rx-card";
      card.innerHTML = `
        <div class="card-header">
          <div class="q-circle">#${a.queue_number || "-"}</div>
          <div class="sc-title-block">
            <div class="sc-animal-name">${a.animal_name}</div>
            <div class="sc-meta">
              <span>‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á: ${ownerName}</span>
              <span>¬∑ ‡∏ô‡∏ô.: ${a.actual_weight || "-"} kg</span>
              ${statusBadge}
            </div>
          </div>
        </div>
        <div class="rx-list-container">
          <div class="rx-list-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏à‡πà‡∏≤‡∏¢</div>
          ${rxHtml}
        </div>
        <div class="card-footer">
          <button class="btn btn-sky" onclick="printRx('${a.id}')">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏¢‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
          <button class="btn btn-emerald" onclick="markAsDone('${q.animal_id}', '${q.status}')">‚úÖ ‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô)</button>
        </div>
      `;
      container.appendChild(card);
    });

  } catch (err) {
    console.error(err);
    container.innerHTML = `<div style="text-align:center; padding: 40px; color: #fca5a5;">‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>`;
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏¢‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ï‡∏ß‡πå 1 ‡∏ï‡∏±‡∏ß)
window.printRx = function(animalId) {
  const a = window.rxDataMap[animalId];
  if (!a) return;

  const ownerName = a.vasd_owner?.owner_name || "-";
  const dateStr = new Date().toLocaleDateString('th-TH', { year:'numeric', month:'long', day:'numeric' });

  let rxHtml = "";
  if (a.vasd_prescription && a.vasd_prescription.length > 0) {
    rxHtml = a.vasd_prescription.map(rx => `
      <div class="p-rx-item">
        <div class="p-rx-name">${rx.drug_id}</div>
        <div class="p-rx-desc"><b>‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ:</b> ‡∏õ‡πâ‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡∏∞ ${rx.dose} ${rx.freq}</div>
        <div class="p-rx-desc"><b>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</b> ${rx.total_pills} ‡πÄ‡∏°‡πá‡∏î (‡∏ó‡∏≤‡∏ô ${rx.days} ‡∏ß‡∏±‡∏ô)</div>
      </div>
    `).join('');
  } else {
    rxHtml = `<div>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤</div>`;
  }

  const printArea = document.getElementById("printArea");
  printArea.innerHTML = `
    <div class="print-page">
      <div class="p-title">‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏¢‡∏≤‡∏£‡∏ß‡∏° / Prescriptions</div>
      <div class="p-meta">
        <b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</b> ${dateStr} <br>
        <b>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á:</b> ${ownerName} <br>
        <b>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå:</b> ${a.animal_name} (‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà ${a.queue_number}) <br>
        <b>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å:</b> ${a.actual_weight || '-'} kg
      </div>
      <h3 style="margin-bottom: 10px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤</h3>
      ${rxHtml}
      <div style="margin-top: 30px; text-align: center; font-size: 14px;">
        *** ‡πÇ‡∏õ‡∏£‡∏î‡∏õ‡πâ‡∏≠‡∏ô‡∏¢‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ç‡∏≠‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πÅ‡∏û‡∏ó‡∏¢‡πå ***
      </div>
    </div>
  `;
  window.print();
};

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡∏â‡∏•‡∏≤‡∏Å‡∏¢‡∏≤‡πÅ‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏ï‡∏±‡∏ß (Single Drug)
window.printSingleRx = function(animalId, rxIndex) {
  const a = window.rxDataMap[animalId];
  if (!a || !a.vasd_prescription || !a.vasd_prescription[rxIndex]) return;

  const rx = a.vasd_prescription[rxIndex];
  const ownerName = a.vasd_owner?.owner_name || "-";
  const dateStr = new Date().toLocaleDateString('th-TH', { year:'numeric', month:'long', day:'numeric' });

  const printArea = document.getElementById("printArea");
  printArea.innerHTML = `
    <div class="print-page">
      <div class="p-title">‡∏â‡∏•‡∏≤‡∏Å‡∏¢‡∏≤ / Drug Label</div>
      <div class="p-meta">
        <b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</b> ${dateStr} <br>
        <b>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á:</b> ${ownerName} <br>
        <b>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå:</b> ${a.animal_name} (‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà ${a.queue_number})
      </div>
      <div class="p-rx-item" style="border: none; padding: 0;">
        <div class="p-rx-name" style="font-size: 18px; color: #000;">${rx.drug_id}</div>
        <div class="p-rx-desc" style="font-size: 15px; margin-top: 8px;"><b>‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ:</b> ‡∏õ‡πâ‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡∏∞ ${rx.dose} ${rx.freq}</div>
        <div class="p-rx-desc" style="font-size: 15px;"><b>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</b> ${rx.total_pills} ‡πÄ‡∏°‡πá‡∏î (‡∏ó‡∏≤‡∏ô ${rx.days} ‡∏ß‡∏±‡∏ô)</div>
      </div>
    </div>
  `;
  window.print();
};

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô (Done)
window.markAsDone = async function(animalId, currentStatus) {
  if (currentStatus !== 'ready_to_go_home') {
    if (!confirm("‚ö†Ô∏è ‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î/‡∏û‡∏±‡∏Å‡∏ü‡∏∑‡πâ‡∏ô ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ?")) return;
  } else {
    if (!confirm("‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô?")) return;
  }
  
  try {
    const { error } = await supabase.from("vasd_queue").update({ 
      status: "done", 
      updated_at: new Date() 
    }).eq("animal_id", animalId);
    if (error) throw error;
  } catch (err) {
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
  }
};

// Realtime Update (‡πÄ‡∏ù‡πâ‡∏≤‡∏î‡∏π‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡∏∞‡∏¢‡∏≤)
supabase.channel('rx-realtime')
  .on('postgres_changes', { event: '*', schema: 'public', table: 'vasd_queue' }, loadRxQueue)
  .on('postgres_changes', { event: '*', schema: 'public', table: 'vasd_prescription' }, loadRxQueue)
  .subscribe();

loadRxQueue();
</script>
   <script type="module" src="./js/global-alarm.js"></script>
</body>
</html>
