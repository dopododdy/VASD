<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>à¹‚à¸•à¹Šà¸°à¸ˆà¸±à¸”à¸¢à¸² â€“ VASD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&family=Sarabun:wght@300;400;500;600;700&family=Prompt:wght@400;600&family=Kanit:wght@400;600&display=swap" rel="stylesheet">

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOKENS & BASE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --navy:         #0b1929;
  --navy-mid:      #112240;
  --sky:           #0ea5e9; 
  --sky-light:     #38bdf8;
  --teal:          #0ea5a0;
  --emerald:       #10b981;
  --violet:        #8b5cf6;
  --rose:          #ef4444;
  --amber:         #f59e0b;

  --surface:    rgba(255,255,255,0.04);
  --surface-2:  rgba(255,255,255,0.07);
  --border:     rgba(255,255,255,0.08);
  --border-2:   rgba(255,255,255,0.14);
  --text:       #e2e8f0;
  --text-dim:   #94a3b8;

  --radius-sm: 10px;
  --radius-lg: 22px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: "Sarabun", sans-serif;
  background: var(--navy); color: var(--text);
  min-height: 100vh; display: flex; flex-direction: column;
  overflow-x: hidden; padding-bottom: 100px;
}

header {
  position: sticky; top: 0; z-index: 200;
  background: rgba(11,25,41,0.88); backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  padding: 15px 20px; display: flex; align-items: center; justify-content: space-between;
}
.brand { display: flex; align-items: center; gap: 10px; }
.brand-logo {
  width: 38px; height: 38px;
  background: linear-gradient(135deg, var(--sky), var(--sky-light));
  border-radius: 10px; display: flex; align-items: center; justify-content: center;
  font-size: 18px; box-shadow: 0 0 20px rgba(14, 165, 233, 0.3);
}
.brand-name { font-family: "Outfit", sans-serif; font-size: 16px; font-weight: 700; color: #fff; line-height: 1; }
.brand-sub { font-size: 11px; color: var(--text-dim); margin-top: 2px; }

.badge-count {
  background: rgba(14, 165, 233, 0.15); border: 1px solid rgba(14, 165, 233, 0.3);
  color: var(--sky-light); font-size: 12px; font-weight: 600;
  padding: 6px 14px; border-radius: 20px;
}

.wrap { max-width: 800px; margin: 0 auto; padding: 20px 16px; width: 100%; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RX CARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.rx-card {
  background: var(--surface); border: 1px solid var(--border-2);
  border-radius: var(--radius-lg); overflow: hidden; margin-bottom: 16px;
  animation: slideUp 0.4s ease both;
}
.card-header {
  display: flex; align-items: center; gap: 12px; padding: 16px;
  border-bottom: 1px solid var(--border); background: var(--surface-2);
}
.q-circle {
  font-family: "Outfit", sans-serif; width: 46px; height: 46px; border-radius: 50%;
  background: var(--sky); color: #fff;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px; font-weight: 800; flex-shrink: 0;
  box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
}
.sc-title-block { flex: 1; }
.sc-animal-name { font-family: "Outfit", sans-serif; font-size: 18px; font-weight: 800; color: #fff; }
.sc-meta { font-size: 12px; color: var(--text-dim); margin-top: 4px; display: flex; align-items: center; flex-wrap: wrap; gap: 6px; }

.rx-list-container { padding: 16px; }
.rx-list-title { font-size: 12px; font-weight: 700; color: var(--text-dim); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }

.rx-item {
  display: flex; gap: 12px; background: var(--surface-2); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 14px; margin-bottom: 10px; align-items: center;
}
.rx-idx {
  width: 24px; height: 24px; border-radius: 50%; background: rgba(255,255,255,0.1);
  display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; color: var(--text-dim);
  flex-shrink: 0; align-self: flex-start;
}
.rx-details { flex: 1; }
.rx-name { font-size: 15px; font-weight: 700; color: #fff; margin-bottom: 6px; }
.rx-desc { font-size: 13px; color: var(--text-dim); margin-bottom: 2px; }
.rx-desc b { color: var(--sky-light); }

.service-item {
  background: rgba(245, 158, 11, 0.1); border: 1px dashed rgba(245, 158, 11, 0.3);
  color: var(--amber); padding: 10px 14px; border-radius: 8px; margin-bottom: 8px; font-size: 14px; font-weight: 500;
}

.btn-print-single {
  background: rgba(14, 165, 233, 0.1); border: 1px solid var(--sky);
  color: var(--sky-light); border-radius: 8px; padding: 8px 12px;
  cursor: pointer; font-size: 12px; font-weight: 600; font-family: "Sarabun", sans-serif;
  transition: 0.2s; white-space: nowrap; flex-shrink: 0;
}
.btn-print-single:hover { background: var(--sky); color: #fff; }

.card-footer {
  display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
  padding: 16px; background: var(--surface-2); border-top: 1px solid var(--border);
}
.card-actions {
  grid-column: 1 / -1; display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;
}
@media (max-width: 500px) { .card-footer { grid-template-columns: 1fr; } }

.btn {
  padding: 12px 16px; font-size: 14px; font-weight: 600; font-family: "Sarabun", sans-serif;
  border: none; border-radius: var(--radius-sm); cursor: pointer; text-align: center; transition: 0.2s;
}
.btn-sky { background: rgba(14, 165, 233, 0.15); color: var(--sky-light); border: 1px solid rgba(14, 165, 233, 0.3); }
.btn-sky:hover { background: rgba(14, 165, 233, 0.25); }
.btn-emerald { background: linear-gradient(135deg, var(--emerald), #34d399); color: #fff; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25); }
.btn-emerald:hover { opacity: 0.9; transform: translateY(-1px); }
.btn-sm { padding: 8px 12px; font-size: 12px; background: var(--surface); border: 1px solid var(--border-2); color: var(--text); border-radius: 8px; cursor: pointer; }
.btn-sm:hover { background: var(--surface-2); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOTTOM NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bottom-nav {
  display: grid; position: fixed; bottom: 0; left: 0; right: 0; z-index: 300;
  background: rgba(11,25,41,0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  border-top: 1px solid var(--border-2);
  padding: 8px 0 max(8px, env(safe-area-inset-bottom));
  grid-template-columns: repeat(5, 1fr);
}
.nav-item {
  display: flex; flex-direction: column; align-items: center; gap: 3px; padding: 6px 4px;
  font-size: 9px; color: var(--text-dim); text-decoration: none; transition: color 0.2s;
}
.nav-item.active { color: var(--teal); }
.nav-icon { font-size: 21px; line-height: 1; }

@keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="brand-logo">ğŸ’Š</div>
    <div>
      <div class="brand-name">à¹‚à¸•à¹Šà¸°à¸ˆà¸±à¸”à¸¢à¸² (Pharmacy)</div>
      <div class="brand-sub">à¸ˆà¹ˆà¸²à¸¢à¸¢à¸² à¸šà¸£à¸´à¸à¸²à¸£ à¹à¸¥à¸°à¹ƒà¸«à¹‰à¸„à¸³à¹à¸™à¸°à¸™à¸³</div>
    </div>
  </div>
  <div class="badge-count" id="count-badge">0 à¸£à¸­à¸ˆà¸±à¸”à¸¢à¸²</div>
</header>

<div class="wrap" id="rx-container">
  <div style="text-align: center; color: var(--text-dim); padding: 40px;">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥...</div>
</div>

<nav class="bottom-nav">
  <a class="nav-item" href="index.html"><span class="nav-icon">ğŸ </span>à¸«à¸™à¹‰à¸²à¸«à¸¥à¸±à¸</a>
  <a class="nav-item" href="animals.html"><span class="nav-icon">ğŸ¾</span>à¸ªà¸±à¸•à¸§à¹Œ</a>
  <a class="nav-item" href="anesthesia.html"><span class="nav-icon">ğŸ’‰</span>à¸§à¸²à¸‡à¸¢à¸²</a>
  <a class="nav-item" href="surgery.html"><span class="nav-icon">ğŸ›ï¸</span>à¸œà¹ˆà¸²à¸•à¸±à¸”</a>
  <a class="nav-item" href="recovery.html"><span class="nav-icon">â¤ï¸â€ğŸ©¹</span>à¸à¸±à¸à¸Ÿà¸·à¹‰à¸™</a>
</nav>

<script type="module">
import { supabase } from "./js/supabase.js";

window.rxDataMap = {}; 

const getDates = () => {
  const now = new Date();
  const next7 = new Date(); next7.setDate(now.getDate() + 7);
  const fmt = (d) => d.toLocaleDateString('th-TH', { day:'2-digit', month:'2-digit', year:'numeric' });
  return { today: fmt(now), next: fmt(next7) };
};

async function loadRxQueue() {
  const container = document.getElementById("rx-container");
  
  try {
    // à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ Queue à¸à¸£à¹‰à¸­à¸¡à¸œà¸¹à¸à¸ªà¸±à¸¡à¸à¸±à¸™à¸˜à¹Œà¸•à¸²à¸£à¸²à¸‡à¸‰à¸šà¸±à¸š Version 2.3
    const { data: queueData, error } = await supabase
      .from("vasd_queue")
      .select(`
        id, animal_id, status, 
        vasd_animal(id, queue_number, animal_name, species, sex, actual_weight,
          vasd_owner(owner_name, id_card, address, phone),
          vasd_prescription(*),
          vasd_service(*)
        )
      `)
      .in("status", ["surgery", "recovery", "ready_to_go_home"])
      .order("updated_at", { ascending: true });

    if (error) throw error;

    // à¸à¸£à¸­à¸‡à¹€à¸­à¸²à¹€à¸‰à¸à¸²à¸°à¹€à¸„à¸ªà¸—à¸µà¹ˆà¸¡à¸µà¸¢à¸² à¸«à¸£à¸·à¸­à¸¡à¸µà¸šà¸£à¸´à¸à¸²à¸£ à¸«à¸£à¸·à¸­à¸à¸£à¹‰à¸­à¸¡à¸à¸¥à¸±à¸šà¸šà¹‰à¸²à¸™à¹à¸¥à¹‰à¸§
    const animals = (queueData || []).filter(q => {
      if (!q.vasd_animal) return false;
      const hasRx = q.vasd_animal.vasd_prescription && q.vasd_animal.vasd_prescription.length > 0;
      const hasService = q.vasd_animal.vasd_service && q.vasd_animal.vasd_service.length > 0;
      return hasRx || hasService || q.status === "ready_to_go_home";
    });
    
    if (animals.length === 0) {
      document.getElementById("count-badge").innerText = "0 à¸£à¸­à¸ˆà¸±à¸”à¸¢à¸²";
      container.innerHTML = `<div style="text-align:center; padding: 60px 20px; color: var(--text-dim);">âœ… à¹„à¸¡à¹ˆà¸¡à¸µà¸„à¸´à¸§à¸£à¸­à¸ˆà¸±à¸”à¸¢à¸²à¹ƒà¸™à¸‚à¸“à¸°à¸™à¸µà¹‰</div>`;
      return;
    }

    document.getElementById("count-badge").innerText = `${animals.length} à¸£à¸­à¸ˆà¸±à¸”à¸¢à¸²`;
    container.innerHTML = "";
    window.rxDataMap = {};

    animals.forEach(q => {
      const a = q.vasd_animal;
      const ownerName = a.vasd_owner?.owner_name || "-";
      window.rxDataMap[a.id] = a; 
      
      let rxHtml = "";
      if (a.vasd_prescription && a.vasd_prescription.length > 0) {
        rxHtml = a.vasd_prescription.map((rx, i) => `
          <div class="rx-item">
            <div class="rx-idx">${i + 1}</div>
            <div class="rx-details">
              <div class="rx-name">${rx.drug_id}</div>
              <div class="rx-desc">à¸§à¸´à¸˜à¸µà¹ƒà¸Šà¹‰: à¸›à¹‰à¸­à¸™ <b>${rx.dose}</b> Â· ${rx.freq}</div>
              <div class="rx-desc">à¸ˆà¸³à¸™à¸§à¸™à¸—à¸µà¹ˆà¸ˆà¹ˆà¸²à¸¢: <b>${rx.total_pills}</b> à¹€à¸¡à¹‡à¸”</div>
            </div>
            <button class="btn-print-single" onclick="printSingleRx('${a.id}', ${i})">ğŸ–¨ï¸ à¸ªà¸•à¸´à¸à¹€à¸à¸­à¸£à¹Œ</button>
          </div>
        `).join('');
      } else {
        rxHtml = `<div style="color:var(--text-dim); font-size:13px; text-align:center; padding:15px; background:var(--surface-2); border-radius:10px;">à¹„à¸¡à¹ˆà¸¡à¸µà¸à¸²à¸£à¸ªà¸±à¹ˆà¸‡à¸ˆà¹ˆà¸²à¸¢à¸¢à¸²</div>`;
      }

      // à¹€à¸Šà¹‡à¸„à¸šà¸£à¸´à¸à¸²à¸£
      let serviceHtml = "";
      let hasVaccine = false;
      let hasMicrochip = false;

      if (a.vasd_service && a.vasd_service.length > 0) {
        serviceHtml += `<div class="rx-list-title" style="margin-top:20px;">à¸šà¸£à¸´à¸à¸²à¸£à¸—à¸µà¹ˆà¹„à¸”à¹‰à¸£à¸±à¸š</div>`;
        a.vasd_service.forEach(t => {
          const tName = t.service_type || "à¸šà¸£à¸´à¸à¸²à¸£à¸—à¸±à¹ˆà¸§à¹„à¸›";
          serviceHtml += `<div class="service-item">âœ¨ ${tName}</div>`;
          if (tName.includes("à¸§à¸±à¸„à¸‹à¸µà¸™")) hasVaccine = true;
          if (tName.includes("à¹„à¸¡à¹‚à¸„à¸£à¸Šà¸´à¸") || tName.includes("à¹„à¸¡à¹‚à¸„à¸£à¸Šà¸´à¸›")) hasMicrochip = true;
        });
      }

      let statusBadge = "";
      if (q.status === 'surgery') statusBadge = '<span style="background:var(--rose); color:#fff; padding:2px 6px; border-radius:6px; font-size:10px;">à¸à¸³à¸¥à¸±à¸‡à¸œà¹ˆà¸²à¸•à¸±à¸”</span>';
      else if (q.status === 'recovery') statusBadge = '<span style="background:var(--violet); color:#fff; padding:2px 6px; border-radius:6px; font-size:10px;">à¸à¸³à¸¥à¸±à¸‡à¸à¸±à¸à¸Ÿà¸·à¹‰à¸™</span>';
      else if (q.status === 'ready_to_go_home') statusBadge = '<span style="background:var(--emerald); color:#fff; padding:2px 6px; border-radius:6px; font-size:10px;">à¸à¸£à¹‰à¸­à¸¡à¸à¸¥à¸±à¸šà¸šà¹‰à¸²à¸™</span>';

     // à¸›à¸¸à¹ˆà¸¡à¸­à¸±à¸ˆà¸‰à¸£à¸´à¸¢à¸° (Smart Actions)
      let smartButtons = `
        <button class="btn-sm" onclick="printStickerAction('drug_bag', '${a.id}')">ğŸ›ï¸ à¸à¸´à¸¡à¸à¹Œà¸«à¸™à¹‰à¸²à¸–à¸¸à¸‡à¸¢à¸²</button>
        <button class="btn-sm" onclick="printStickerAction('microchip_sticker', '${a.id}')">ğŸ·ï¸ à¸ªà¸•à¸´à¸à¹€à¸à¸­à¸£à¹Œà¹„à¸¡à¹‚à¸„à¸£à¸Šà¸´à¸</button>
      `;
      if(hasVaccine) smartButtons += `<button class="btn-sm" onclick="printStickerAction('vaccine', '${a.id}')">ğŸ“’ à¸ªà¸¡à¸¸à¸”à¸§à¸±à¸„à¸‹à¸µà¸™</button>`;
      if(hasMicrochip) smartButtons += `<button class="btn-sm" onclick="printStickerAction('microchip', '${a.id}')">ğŸ’³ à¸ªà¸¡à¸¸à¸”à¹„à¸¡à¹‚à¸„à¸£à¸Šà¸´à¸</button>`;
      const card = document.createElement("div");
      card.className = "rx-card";
      card.innerHTML = `
        <div class="card-header">
          <div class="q-circle">#${a.queue_number || "-"}</div>
          <div class="sc-title-block">
            <div class="sc-animal-name">${a.animal_name}</div>
            <div class="sc-meta">
              <span>à¹€à¸ˆà¹‰à¸²à¸‚à¸­à¸‡: ${ownerName}</span>
              <span>Â· à¸™à¸™.: ${a.actual_weight || "-"} kg</span>
              ${statusBadge}
            </div>
          </div>
        </div>
        <div class="rx-list-container">
          <div class="rx-list-title">à¸£à¸²à¸¢à¸à¸²à¸£à¸¢à¸²à¸—à¸µà¹ˆà¸ªà¸±à¹ˆà¸‡à¸ˆà¹ˆà¸²à¸¢</div>
          ${rxHtml}
          ${serviceHtml}
        </div>
        <div class="card-footer">
          <div class="card-actions">
             ${smartButtons}
          </div>
          <button class="btn btn-sky" onclick="printAllRx('${a.id}')">ğŸ–¨ï¸ à¸à¸´à¸¡à¸à¹Œà¸ªà¸•à¸´à¸à¹€à¸à¸­à¸£à¹Œà¸‹à¸­à¸‡à¸¢à¸²à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</button>
          <button class="btn btn-emerald" onclick="markAsDone('${q.animal_id}', '${q.status}')">âœ… à¸ˆà¹ˆà¸²à¸¢à¸¢à¸²à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢ (à¸à¸¥à¸±à¸šà¸šà¹‰à¸²à¸™)</button>
        </div>
      `;
      container.appendChild(card);
    });

  } catch (err) {
    console.error(err);
    container.innerHTML = `<div style="text-align:center; padding: 40px; color: #fca5a5;">âŒ à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ</div>`;
  }
}

// ==========================================
// à¸£à¸°à¸šà¸šà¸à¸´à¸¡à¸à¹Œ Sticker à¸ˆà¸²à¸ Template
// ==========================================
async function renderStickers(templateType, dataArray) {
  const { data } = await supabase.from("vasd_print_template").select("config").eq("template_type", templateType).maybeSingle();
  const config = data?.config || [];

  if (config.length === 0) {
    alert("à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸£à¸¹à¸›à¹à¸šà¸šà¸ªà¸•à¸´à¸à¹€à¸à¸­à¸£à¹Œà¸ªà¸³à¸«à¸£à¸±à¸š: " + templateType + "\nà¸à¸£à¸¸à¸“à¸²à¹„à¸›à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¹ƒà¸™à¹€à¸¡à¸™à¸¹ Designer Pro à¸à¹ˆà¸­à¸™à¸„à¸£à¸±à¸š");
    return;
  }

  const dates = getDates();
  let htmlStr = "";

  dataArray.forEach(item => {
    htmlStr += `<div class="sticker">`;
    config.forEach(l => {
      // à¹à¸—à¸™à¸„à¹ˆà¸²à¸•à¸±à¸§à¹à¸›à¸£à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸•à¸²à¸¡à¹‚à¸„à¸£à¸‡à¸ªà¸£à¹‰à¸²à¸‡ v2.3
      let txt = l.text
        .replace(/{{queue_number}}/g, item.queue_number || "")
        .replace(/{{animal_name}}/g, item.animal_name || "")
        .replace(/{{species}}/g, item.species || "")
        .replace(/{{sex}}/g, item.sex || "")
        .replace(/{{owner_name}}/g, item.owner_name || "")
        .replace(/{{id_card}}/g, item.id_card || "")
        .replace(/{{address}}/g, item.address || "")
        .replace(/{{phone}}/g, item.phone || "")
        .replace(/{{drug_name}}/g, item.drug_name || "")
        .replace(/{{dose}}/g, item.dose || "")
        .replace(/{{freq}}/g, item.freq || "")
        .replace(/{{total_amount}}/g, item.total_amount || "")
        .replace(/{{todayDate}}/g, dates.today)
        .replace(/{{next7days}}/g, dates.next);

      htmlStr += `<div class="line" style="left:${l.x}px; top:${l.y}px; font-size:${l.size}px; text-align:${l.align}; font-family:'${l.font}', sans-serif; font-weight:${l.bold?'600':'400'}; width:${l.align==='center'?'100%':`calc(100% - ${l.x}px)`}; ${l.align==='center'?'left:0px;':''}">${txt}</div>`;
    });
    htmlStr += `</div>`;
  });

  const pw = window.open("","_blank","width=800,height=600");
  pw.document.write(`<html><head><style>
    @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@600;700&family=Sarabun:wght@400;600&family=Prompt:wght@400;600&family=Kanit:wght@400;600&display=swap');
    body{margin:0; background:#e2e8f0; display:flex; flex-direction:column; align-items:center; padding:20px;}
    .sticker{position:relative; width:80mm; height:50mm; background:#fff; overflow:hidden; margin-bottom: 20px; box-shadow:0 4px 10px rgba(0,0,0,0.1); page-break-after:always;}
    .line{position:absolute; white-space:pre-wrap; word-break:break-word; color:#000; line-height:1.2;}
    @page{size:80mm 50mm; margin:0;}
    @media print { body{background:#fff; padding:0;} .sticker{margin:0; box-shadow:none;} }
  </style></head><body>${htmlStr}
  <script>window.onload=function(){window.print();window.close();};<\/script></body></html>`);
  pw.document.close();
}

// à¹€à¸•à¸£à¸µà¸¢à¸¡ Data à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸´à¸¡à¸à¹Œà¸•à¸²à¸¡à¸›à¸£à¸°à¹€à¸ à¸— (à¸ªà¸¡à¸¸à¸”à¸§à¸±à¸„à¸‹à¸µà¸™, à¹„à¸¡à¹‚à¸„à¸£à¸Šà¸´à¸, à¸–à¸¸à¸‡à¸¢à¸²)
window.printStickerAction = (type, animalId) => {
  const a = window.rxDataMap[animalId];
  if (!a) return;
  const baseData = {
    queue_number: a.queue_number, animal_name: a.animal_name, species: a.species, sex: a.sex,
    owner_name: a.vasd_owner?.owner_name, id_card: a.vasd_owner?.id_card, address: a.vasd_owner?.address, phone: a.vasd_owner?.phone
  };
  renderStickers(type, [baseData]);
};

// à¸à¸´à¸¡à¸à¹Œà¸¢à¸²à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” (à¸§à¸™à¸¥à¸¹à¸›à¸•à¸²à¸¡à¸ˆà¸³à¸™à¸§à¸™à¸£à¸²à¸¢à¸à¸²à¸£à¸¢à¸²)
window.printAllRx = (animalId) => {
  const a = window.rxDataMap[animalId];
  if (!a || !a.vasd_prescription || a.vasd_prescription.length === 0) return alert("à¹„à¸¡à¹ˆà¸¡à¸µà¸£à¸²à¸¢à¸à¸²à¸£à¸¢à¸²");
  
  const drugsData = a.vasd_prescription.map(rx => ({
    queue_number: a.queue_number, animal_name: a.animal_name, species: a.species, sex: a.sex,
    owner_name: a.vasd_owner?.owner_name, id_card: a.vasd_owner?.id_card, address: a.vasd_owner?.address, phone: a.vasd_owner?.phone,
    drug_name: rx.drug_id, dose: rx.dose, freq: rx.freq, total_amount: rx.total_pills + " à¹€à¸¡à¹‡à¸”"
  }));
  // à¹€à¸£à¸µà¸¢à¸ Template à¸Šà¸·à¹ˆà¸­ drug_envelope
  renderStickers('drug_envelope', drugsData);
};

// à¸à¸´à¸¡à¸à¹Œà¸¢à¸²à¹€à¸‰à¸à¸²à¸°à¸•à¸±à¸§à¸—à¸µà¹ˆà¹€à¸¥à¸·à¸­à¸
window.printSingleRx = (animalId, rxIndex) => {
  const a = window.rxDataMap[animalId];
  if (!a || !a.vasd_prescription || !a.vasd_prescription[rxIndex]) return;
  const rx = a.vasd_prescription[rxIndex];
  
  const drugData = {
    queue_number: a.queue_number, animal_name: a.animal_name, species: a.species, sex: a.sex,
    owner_name: a.vasd_owner?.owner_name, id_card: a.vasd_owner?.id_card, address: a.vasd_owner?.address, phone: a.vasd_owner?.phone,
    drug_name: rx.drug_id, dose: rx.dose, freq: rx.freq, total_amount: rx.total_pills + " à¹€à¸¡à¹‡à¸”"
  };
  renderStickers('drug_envelope', [drugData]);
};

// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸­à¸±à¸›à¹€à¸”à¸•à¸ªà¸–à¸²à¸™à¸°à¹ƒà¸«à¹‰à¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸´à¹‰à¸™ (Done)
window.markAsDone = async function(animalId, currentStatus) {
  if (currentStatus !== 'ready_to_go_home') {
    if (!confirm("âš ï¸ à¸ªà¸±à¸•à¸§à¹Œà¸•à¸±à¸§à¸™à¸µà¹‰à¸¢à¸±à¸‡à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸œà¹ˆà¸²à¸•à¸±à¸”/à¸à¸±à¸à¸Ÿà¸·à¹‰à¸™ à¹à¸™à¹ˆà¹ƒà¸ˆà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆà¸—à¸µà¹ˆà¸ˆà¸°à¸›à¸´à¸”à¹€à¸„à¸ªà¹à¸¥à¸°à¹ƒà¸«à¹‰à¸à¸¥à¸±à¸šà¸šà¹‰à¸²à¸™à¸•à¸­à¸™à¸™à¸µà¹‰?")) return;
  } else {
    if (!confirm("à¸„à¸¸à¸“à¹„à¸”à¹‰à¸—à¸³à¸à¸²à¸£à¸ˆà¸±à¸”à¸¢à¸²à¹à¸¥à¸°à¸­à¸˜à¸´à¸šà¸²à¸¢à¸§à¸´à¸˜à¸µà¹ƒà¸Šà¹‰à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§ à¸¢à¸·à¸™à¸¢à¸±à¸™à¹ƒà¸«à¹‰à¸ªà¸±à¸•à¸§à¹Œà¸à¸¥à¸±à¸šà¸šà¹‰à¸²à¸™?")) return;
  }
  
  try {
    const { error } = await supabase.from("vasd_queue").update({ 
      status: "done", 
      updated_at: new Date() 
    }).eq("animal_id", animalId);
    if (error) throw error;
  } catch (err) {
    alert("à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”: " + err.message);
  }
};

// Realtime Update à¹€à¸à¹‰à¸²à¸”à¸¹à¸à¸²à¸£à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡à¸‚à¸­à¸‡à¸„à¸´à¸§, à¸¢à¸² à¹à¸¥à¸°à¸šà¸£à¸´à¸à¸²à¸£
supabase.channel('rx-realtime')
  .on('postgres_changes', { event: '*', schema: 'public', table: 'vasd_queue' }, loadRxQueue)
  .on('postgres_changes', { event: '*', schema: 'public', table: 'vasd_prescription' }, loadRxQueue)
  .on('postgres_changes', { event: '*', schema: 'public', table: 'vasd_service' }, loadRxQueue)
  .subscribe();

loadRxQueue();
</script>
   <script type="module" src="./js/global-alarm.js"></script>
</body>
</html>
