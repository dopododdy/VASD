<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>RMUTTO - VASD | ‡∏´‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤ (Rx)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&family=Prompt:wght@300;400;500;700&family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>
:root {
  --navy:#0d1b2a; --teal:#1a6b72; --teal-light:#22919a; --accent:#00d4aa;
  --bg:#f0f4f8; --surface:#fff; --text:#1a202c; --text-muted:#718096;
  --border:#e2e8f0; --danger:#e53e3e; --success:#38a169; --warning:#d69e2e;
  --shadow-sm:0 1px 3px rgba(0,0,0,0.06); --shadow-md:0 4px 16px rgba(13,27,42,0.08);
  --radius:14px; --radius-sm:8px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{font-family:"Sarabun",sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}

/* HEADER */
header{
  background:var(--navy);padding:0 32px;display:flex;
  justify-content:space-between;align-items:center;height:68px;
  position:sticky;top:0;z-index:100;box-shadow:0 2px 20px rgba(0,0,0,0.25);
}
.header-brand{display:flex;align-items:center;gap:14px;}
.brand-icon{
  width:40px;height:40px;background:linear-gradient(135deg,var(--teal-light),var(--accent));
  border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;
}
.brand-text h1{font-size:17px;font-weight:700;color:#fff;line-height:1.2;}
.brand-text span{font-size:11px;color:rgba(255,255,255,0.5);}

.btn-home{
  padding:8px 18px;font-size:13px;font-weight:600;font-family:"Sarabun",sans-serif;
  background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.9);
  border:1px solid rgba(255,255,255,0.2);border-radius:var(--radius-sm);
  cursor:pointer;transition:background 0.2s;
}
.btn-home:hover{background:rgba(255,255,255,0.18);}

/* MAIN */
.container{max-width:1200px;margin:0 auto;padding:28px 24px;}

.page-header{
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:24px;animation:fadeUp 0.4s ease both;
}
.page-header h2{font-size:22px;font-weight:700;color:var(--navy);}

/* RX CARD */
.rx-card {
  background:var(--surface);border-radius:var(--radius);
  border:1px solid var(--border);box-shadow:var(--shadow-sm);
  margin-bottom:24px;overflow:hidden;animation:fadeUp 0.4s 0.05s ease both;
  transition:box-shadow 0.2s;
}
.rx-card:hover { box-shadow:var(--shadow-md); }

.rx-header {
  padding:16px 20px; background:#fafbfc; border-bottom:1px solid var(--border);
  display:flex; justify-content:space-between; align-items:center;
}
.rx-header h3 { font-size:16px; color:var(--navy); font-weight:700; }
.rx-header span { color:var(--text-muted); font-size:14px; font-weight:400; }
.rx-header-actions { display: flex; gap: 10px; }

/* TABLE INSIDE CARD */
.table-responsive{overflow-x:auto;-webkit-overflow-scrolling:touch;}
table{width:100%;border-collapse:collapse;min-width:700px;}
thead tr{background:linear-gradient(135deg,var(--navy),#1a2f47);}
thead th{
  padding:12px 10px;text-align:left;font-size:12px;font-weight:700;
  letter-spacing:0.5px;text-transform:uppercase;color:rgba(255,255,255,0.8);
  border:none;white-space:nowrap;
}
tbody tr{border-bottom:1px solid var(--border);transition:background 0.15s;}
tbody td{padding:8px 10px;text-align:left;font-size:14px;border:none;vertical-align:middle;}
tbody tr:last-child{border-bottom:none;}

/* INPUT IN TABLE */
.rx-input {
  width:100%; padding:6px 8px; font-size:14px; font-family:"Sarabun", sans-serif;
  border:1px solid transparent; border-radius:6px; background:transparent; color:var(--text);
  outline:none; transition:all 0.2s;
}
.rx-input:not([readonly]) {
  border-color:var(--border); background:#fff;
}
.rx-input:focus:not([readonly]) {
  border-color:var(--teal-light); box-shadow:0 0 0 2px rgba(34,145,154,0.1);
}

/* BUTTONS */
.btn{
  padding:8px 16px;font-size:13px;font-weight:600;font-family:"Sarabun",sans-serif;
  border:none;border-radius:6px;cursor:pointer;
  transition:opacity 0.2s,transform 0.15s;display:inline-flex;align-items:center;gap:6px;
}
.btn:hover{opacity:0.85;transform:translateY(-1px);}
.btn-sm{padding:5px 8px; font-size:12px; gap:4px; border-radius:4px; margin-right:2px;}

.btn-dispense {background:var(--success);color:#fff;}
.btn-print-all {background:var(--navy);color:#fff;}
.btn-print {background:var(--navy);color:#fff;}
.btn-edit {background:var(--teal-light);color:#fff;}
.btn-save {background:var(--success);color:#fff;}
.btn-delete {background:#e2e8f0;color:var(--danger);}
.btn-delete:hover {background:var(--danger);color:#fff;}

/* UTILS */
.text-danger { color:var(--danger); font-weight:700; }
.text-muted { color:var(--text-muted); font-size:12px; }
.empty-state { text-align:center; padding:60px 20px; color:var(--text-muted); font-size:16px; }

@keyframes fadeUp{from{opacity:0;transform:translateY(14px);}to{opacity:1;transform:translateY(0);}}

/* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏ö‡∏ö‡∏Å‡∏î Ctrl+P (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠) */
@media print {
  body { background: white; padding: 0; }
  header, .btn-home, .page-header button, .btn-dispense, .btn-print-all, .btn-sm { display: none !important; }
  .container { padding: 0; max-width: 100%; }
  .rx-card { box-shadow: none; border: 1px solid #000; break-inside: avoid; margin-bottom: 20px; }
  .rx-header { background: #f0f0f0 !important; border-bottom: 1px solid #000; }
  table { border: 1px solid #000; }
  thead tr { background: #e0e0e0 !important; }
  thead th { color: #000 !important; border-bottom: 1px solid #000; }
  tbody td { border-bottom: 1px solid #ccc; color: #000; }
  .rx-input { border:none !important; background:transparent !important; padding:0 !important; }
}
</style>
</head>
<body>

<header>
  <div class="header-brand">
    <div class="brand-icon">üíä</div>
    <div class="brand-text">
      <h1>‡∏´‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤ (Rx)</h1>
      <span>RMUTTO ‚Äì Veterinary Academic Service Division</span>
    </div>
  </div>
  <button class="btn-home" onclick="location.href='index.html'">üè† ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
</header>

<div class="container">
  <div class="page-header">
    <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏¢‡∏≤ / ‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤</h2>
  </div>
  <div id="rx-container">
    <div class="empty-state">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
  </div>
</div>

<script type="module">
import { supabase } from "./js/supabase.js";

async function loadPrescriptions() {
  try {
    const { data: eventId } = await supabase.rpc("get_today_event");

    const { data: queueData, error } = await supabase
      .from("vasd_queue")
      .select(`
        id, animal_id, status,
        vasd_animal ( 
          event_id, queue_number, animal_name, species, sex,
          vasd_owner(owner_name, phone),
          vasd_service(service_type),
          vasd_prescription ( id, drug_id, dose, freq, days, total_pills )
        )
      `)
      .in("status", ["recovery", "ready_to_go_home"])
      .order("updated_at", { ascending: false });

    if (error) {
      console.error("Error fetching Rx:", error);
      document.getElementById("rx-container").innerHTML = `<div class="empty-state text-danger">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${error.message}</div>`;
      return;
    }

    const animalsWithRx = (queueData || []).filter(q => 
      q.vasd_animal && 
      q.vasd_animal.event_id === eventId && 
      q.vasd_animal.vasd_prescription && 
      q.vasd_animal.vasd_prescription.length > 0
    );

    const container = document.getElementById("rx-container");
    container.innerHTML = "";

    if (animalsWithRx.length === 0) {
      container.innerHTML = `<div class="empty-state">‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏¢‡∏≤‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</div>`;
      return;
    }

    animalsWithRx.forEach((q, index) => {
      const animal = q.vasd_animal;
      const ownerName = animal.vasd_owner ? animal.vasd_owner.owner_name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
      const species = animal.species === "‡∏™" ? "‡∏™‡∏∏‡∏ô‡∏±‡∏Ç" : (animal.species === "‡∏°" ? "‡πÅ‡∏°‡∏ß" : animal.species);
      const rxList = animal.vasd_prescription; 

      // ‡πÄ‡∏Å‡πá‡∏ö rx_id ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      const allRxIds = rxList.map(rx => rx.id).join(",");

      let rxRows = rxList.map((rx, idx) => `
        <tr id="rx-row-${rx.id}">
          <td style="width:5%; text-align:center;">${idx + 1}</td>
          <td style="width:25%;">
            <input type="text" class="rx-input rx-drug" value="${rx.drug_id || ''}" readonly placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤">
          </td>
          <td style="width:20%;">
            <input type="text" class="rx-input rx-dose" value="${rx.dose || ''}" readonly placeholder="‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì">
          </td>
          <td style="width:20%;">
            <input type="text" class="rx-input rx-freq" value="${rx.freq || ''}" readonly placeholder="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà">
          </td>
          <td style="width:10%;">
            <input type="number" class="rx-input rx-days" value="${rx.days || ''}" readonly placeholder="‡∏ß‡∏±‡∏ô" style="width:60px;">
          </td>
          <td style="width:10%;">
            <input type="number" step="0.25" class="rx-input rx-total text-danger" value="${rx.total_pills || 0}" readonly placeholder="‡πÄ‡∏°‡πá‡∏î" style="width:60px; font-weight:bold;">
          </td>
          <td style="width:10%; white-space:nowrap;">
            <button class="btn btn-print btn-sm" onclick="printRx('${rx.id}')" title="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏â‡∏•‡∏≤‡∏Å‡∏¢‡∏≤">üñ®Ô∏è</button>
            <button class="btn btn-edit btn-sm btn-action-edit" onclick="editRx(this)" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‚úèÔ∏è</button>
            <button class="btn btn-save btn-sm btn-action-save" onclick="saveRx(this, '${rx.id}')" style="display:none;" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å">üíæ</button>
            <button class="btn btn-delete btn-sm" onclick="deleteRx('${rx.id}')" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">üóëÔ∏è</button>
          </td>
        </tr>
      `).join("");

      const card = document.createElement("div");
      card.className = "rx-card";
      card.style.animationDelay = `${(index * 0.1) + 0.1}s`; 
      
      card.innerHTML = `
        <div class="rx-header">
          <h3>üêæ ${animal.animal_name} <span style="font-weight:normal;">(${species})</span> <span>| ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á: ${ownerName}</span></h3>
          <div class="rx-header-actions">
            <button class="btn btn-print-all" onclick="printMultipleRx('${allRxIds}')">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button class="btn btn-dispense" onclick="markAsDispensed('${q.animal_id}')">‚úîÔ∏è ‡∏à‡∏±‡∏î‡∏¢‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>
          </div>
        </div>
        <div class="table-responsive">
          <table>
            <thead>
              <tr>
                <th style="text-align:center;">#</th>
                <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤ (Drug ID)</th>
                <th>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì/‡∏Ñ‡∏£‡∏±‡πâ‡∏á</th>
                <th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà</th>
                <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô</th>
                <th>‡∏£‡∏ß‡∏° (‡πÄ‡∏°‡πá‡∏î)</th>
                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody>
              ${rxRows}
            </tbody>
          </table>
        </div>
      `;
      container.appendChild(card);
    });
  } catch (err) {
    console.error("Javascript Error:", err);
    document.getElementById("rx-container").innerHTML = `<div class="empty-state text-danger">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö: ${err.message}</div>`;
  }
}

// ------------------------------------
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô ‡∏à‡∏±‡∏î‡∏¢‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô (‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≠‡∏Å)
// ------------------------------------
window.markAsDispensed = async function(animalId) {
  if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß?\n(‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô '‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß')")) {
    const { error } = await supabase
      .from("vasd_queue")
      .update({ status: "done", updated_at: new Date() })
      .eq("animal_id", animalId);
      
    if (error) {
      alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
      console.error(error);
    } else {
      loadPrescriptions();
    }
  }
};

// ------------------------------------
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡πÅ‡∏•‡∏∞ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≤
// ------------------------------------
window.editRx = function(btn) {
  const tr = btn.closest("tr");
  const inputs = tr.querySelectorAll(".rx-input");
  inputs.forEach(input => input.removeAttribute("readonly"));
  
  tr.querySelector(".btn-action-edit").style.display = "none";
  tr.querySelector(".btn-action-save").style.display = "inline-flex";
};

window.saveRx = async function(btn, rxId) {
  const tr = btn.closest("tr");
  
  const drug_id = tr.querySelector(".rx-drug").value;
  const dose = tr.querySelector(".rx-dose").value;
  const freq = tr.querySelector(".rx-freq").value;
  const days = parseInt(tr.querySelector(".rx-days").value) || 0;
  const total_pills = parseFloat(tr.querySelector(".rx-total").value) || 0;

  const { error } = await supabase
    .from("vasd_prescription")
    .update({ drug_id, dose, freq, days, total_pills })
    .eq("id", rxId);

  if (error) {
    alert("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
    return;
  }

  const inputs = tr.querySelectorAll(".rx-input");
  inputs.forEach(input => input.setAttribute("readonly", true));

  tr.querySelector(".btn-action-save").style.display = "none";
  tr.querySelector(".btn-action-edit").style.display = "inline-flex";
};

// ------------------------------------
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤
// ------------------------------------
window.deleteRx = async function(rxId) {
  if(!confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;

  const { error } = await supabase
    .from("vasd_prescription")
    .delete()
    .eq("id", rxId);

  if (error) {
    alert("‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
  } else {
    document.getElementById(`rx-row-${rxId}`).remove();
  }
};

// ------------------------------------
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô ‡∏î‡∏∂‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏ó‡∏ô‡∏Ñ‡πà‡∏≤ Template ‡∏¢‡∏≤
// ------------------------------------
async function generateStickerHTML(rxId) {
  const { data: rx, error } = await supabase
    .from("vasd_prescription")
    .select(`
      *,
      vasd_animal (
        queue_number, animal_name, species, sex,
        vasd_owner ( owner_name, phone ),
        vasd_service ( service_type )
      )
    `)
    .eq("id", rxId)
    .single();

  if (error || !rx) return null;

  let { data: tmpl } = await supabase.from("vasd_print_template").select("config").eq("template_type", "envelope").single();
  if (!tmpl || !tmpl.config) {
    const { data: bagTmpl } = await supabase.from("vasd_print_template").select("config").eq("template_type", "bag").single();
    tmpl = bagTmpl;
  }
  if (!tmpl || !tmpl.config) return null;

  const a = rx.vasd_animal;
  const spcText = a.species === "‡∏™" ? "‡∏™‡∏∏‡∏ô‡∏±‡∏Ç" : (a.species === "‡∏°" ? "‡πÅ‡∏°‡∏ß" : a.species);
  const ownerName = a.vasd_owner?.owner_name || "";
  const phone = a.vasd_owner?.phone || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
  const services = a.vasd_service?.map(s => s.service_type).join(", ") || "-";

  let html = `<div class="sticker-page">`;
  tmpl.config.forEach(l => {
    let text = l.text
      .replace("{{queue_number}}", a.queue_number || "")
      .replace("{{animal_name}}", a.animal_name || "")
      .replace("{{species}}", spcText)
      .replace("{{sex}}", a.sex || "")
      .replace("{{owner_name}}", ownerName)
      .replace("{{phone}}", phone)
      .replace("{{services}}", services)
      .replace("{{drug_id}}", rx.drug_id || "")
      .replace("{{dose}}", rx.dose || "")
      .replace("{{freq}}", rx.freq || "")
      .replace("{{days}}", rx.days ? rx.days + " ‡∏ß‡∏±‡∏ô" : "")
      .replace("{{total_pills}}", rx.total_pills ? rx.total_pills + " ‡πÄ‡∏°‡πá‡∏î" : "");

    html += `<div class="line" style="left:${l.x||0}px;right:0;top:${l.y||0}px;font-size:${l.size}px;font-weight:${l.weight};font-family:${l.font};text-align:${l.align||"left"};">${text}</div>`;
  });
  html += `</div>`;
  
  return html;
}

// ------------------------------------
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏¢‡∏≤ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
// ------------------------------------
window.printRx = async function(rxId) {
  const content = await generateStickerHTML(rxId);
  if (!content) { alert("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Template ‡∏ã‡∏≠‡∏á‡∏¢‡∏≤/‡∏ñ‡∏∏‡∏á‡∏¢‡∏≤"); return; }
  openPrintWindow(content);
};

// ------------------------------------
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏¢‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡πâ‡∏ô
// ------------------------------------
window.printMultipleRx = async function(rxIdsStr) {
  const rxIds = rxIdsStr.split(",");
  let allContents = "";

  for (let id of rxIds) {
    const content = await generateStickerHTML(id);
    if (content) allContents += content;
  }

  if (allContents === "") { alert("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå"); return; }
  openPrintWindow(allContents);
};

function openPrintWindow(htmlContent) {
  const pw = window.open("","_blank","width=800,height=600");
  pw.document.write(`<html><head><title>Print Rx</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&family=Prompt:wght@400;700&family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
      body { margin: 0; }
      .sticker-page { position: relative; width: 80mm; height: 50mm; background: #fff; overflow: hidden; page-break-after: always; }
      .line { position: absolute; white-space: pre-wrap; word-break: break-word; padding-right: 5px; box-sizing: border-box; color: #000 !important; }
      @page { size: 80mm 50mm; margin: 0; }
    </style>
    </head><body>${htmlContent}
    <script>window.onload=function(){document.fonts.ready.then(()=>{setTimeout(()=>{window.print();window.close();},300);});}<\/script></body></html>`);
  pw.document.close();
}

// ‡∏™‡∏±‡πà‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
loadPrescriptions();

// ‡πÄ‡∏õ‡∏¥‡∏î Realtime
supabase.channel("vasd-rx-live")
  .on("postgres_changes", { event: "*", schema: "public", table: "vasd_queue" }, loadPrescriptions)
  .on("postgres_changes", { event: "*", schema: "public", table: "vasd_prescription" }, loadPrescriptions)
  .subscribe();
</script>
</body>
</html>
