<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>RMUTTO - VASD | ‡∏´‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤ (Rx)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root { --navy:#0d1b2a; --bg:#f0f4f8; --surface:#fff; --text:#1a202c; --border:#e2e8f0; --accent:#00d4aa; }
  body { font-family: 'Sarabun', sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
  .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
  .rx-card { background: var(--surface); padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
  .rx-card h3 { margin-top: 0; color: var(--navy); border-bottom: 2px solid var(--border); padding-bottom: 10px; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  th, td { padding: 10px; text-align: left; border-bottom: 1px solid var(--border); }
  th { background: #f8fafc; }
  .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-family: inherit; font-weight: bold; }
  .btn-print { background: var(--navy); color: white; }
  
  /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ */
  @media print {
    body { background: white; padding: 0; }
    .no-print { display: none !important; }
    .rx-card { box-shadow: none; border: 1px solid #000; break-inside: avoid; }
  }
</style>
</head>
<body>

<div class="header">
  <h2>üíä ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤ (Rx)</h2>
  <button class="btn btn-print no-print" onclick="window.print()">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
</div>

<div id="rx-container">
  <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script type="module">
  // üî¥ ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô URL ‡πÅ‡∏•‡∏∞ Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
  const SUPABASE_URL = "YOUR_SUPABASE_URL"; 
  const SUPABASE_KEY = "YOUR_SUPABASE_ANON_KEY";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  async function loadPrescriptions() {
    // ‡∏î‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏±‡∏Å‡∏ü‡∏∑‡πâ‡∏ô (recovery) ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏¢‡∏≤
    const { data: queueData, error } = await supabase
      .from("vasd_queue")
      .select(`
        id, animal_id, status,
        vasd_animal ( animal_name, species, owner_name ),
        vasd_prescription ( id, drug_id, dose, freq, days, total_pills )
      `)
      .in("status", ["recovery", "discharged"]) // ‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
      .order("updated_at", { ascending: false });

    if (error) {
      console.error("Error fetching Rx:", error);
      document.getElementById("rx-container").innerHTML = `<p style="color:red;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>`;
      return;
    }

    // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏¢‡∏≤ (‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô vasd_prescription)
    const animalsWithRx = queueData.filter(q => q.vasd_prescription && q.vasd_prescription.length > 0);

    const container = document.getElementById("rx-container");
    container.innerHTML = "";

    if (animalsWithRx.length === 0) {
      container.innerHTML = `<p>‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p>`;
      return;
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏Ç‡∏≠‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß
    animalsWithRx.forEach(q => {
      const animal = q.vasd_animal;
      const rxList = q.vasd_prescription;

      let rxRows = rxList.map((rx, index) => `
        <tr>
          <td>${index + 1}</td>
          <td><strong>‡∏¢‡∏≤ ID: ${rx.drug_id}</strong> <br><small class="text-muted">‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á drug catalog ‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ</small></td>
          <td>${rx.dose}</td>
          <td>${rx.freq}</td>
          <td>${rx.days} ‡∏ß‡∏±‡∏ô</td>
          <td style="font-weight:bold; color:#e53e3e;">${rx.total_pills} ‡πÄ‡∏°‡πá‡∏î/‡∏Ç‡∏ß‡∏î</td>
        </tr>
      `).join("");

      const card = document.createElement("div");
      card.className = "rx-card";
      card.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h3>üêæ ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå: ${animal.animal_name} (${animal.species}) | ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á: ${animal.owner_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</h3>
          <button class="btn no-print" style="background:#00d4aa; color:#fff;" onclick="markAsDispensed('${q.animal_id}')">‚úîÔ∏è ‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤‡πÅ‡∏•‡πâ‡∏ß</button>
        </div>
        <table>
          <thead>
            <tr>
              <th width="5%">#</th>
              <th width="30%">‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ (Drug ID)</th>
              <th width="20%">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì/‡∏Ñ‡∏£‡∏±‡πâ‡∏á</th>
              <th width="20%">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà</th>
              <th width="10%">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô</th>
              <th width="15%">‡∏£‡∏ß‡∏°</th>
            </tr>
          </thead>
          <tbody>
            ${rxRows}
          </tbody>
        </table>
      `;
      container.appendChild(card);
    });
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î "‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤‡πÅ‡∏•‡πâ‡∏ß" (‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏õ‡πá‡∏ô done ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠)
  window.markAsDispensed = async function(animalId) {
    if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß?")) {
      // ‡πÇ‡∏Ñ‡πâ‡∏î‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏´‡πâ‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏õ‡πá‡∏ô "done" ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á rx
      alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï DB ‡πÄ‡∏û‡∏¥‡πà‡∏°)");
      loadPrescriptions(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
    }
  };

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
  loadPrescriptions();
</script>
</body>
</html>
