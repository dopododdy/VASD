<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡πÇ‡∏ï‡πä‡∏∞‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤ ‚Äì VASD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&family=Sarabun:wght@300;400;500;600;700&family=Kanit:wght@400;700&family=Prompt:wght@400;700&display=swap" rel="stylesheet">

<style>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TOKENS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
:root {
  --navy:         #0b1929;
  --navy-mid:     #112240;
  --teal:         #0ea5a0;
  --teal-light:   #14c4bc;
  --teal-glow:    rgba(14,165,160,0.25);
  --sky:          #3b82f6;
  --sky-soft:     rgba(59,130,246,0.14);
  --amber:        #f59e0b;
  --amber-soft:   rgba(245,158,11,0.14);
  --rose:         #ef4444;
  --rose-soft:    rgba(239,68,68,0.12);
  --emerald:      #10b981;
  --emerald-soft: rgba(16,185,129,0.14);

  --surface:    rgba(255,255,255,0.04);
  --surface-2:  rgba(255,255,255,0.07);
  --surface-3:  rgba(255,255,255,0.11);
  --border:     rgba(255,255,255,0.08);
  --border-2:   rgba(255,255,255,0.14);
  --text:       #e2e8f0;
  --text-dim:   #94a3b8;
  --text-faint: #4a5568;

  --radius-xs: 6px;
  --radius-sm: 10px;
  --radius:    16px;
  --radius-lg: 22px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }

body {
  font-family: "Sarabun", sans-serif;
  background: var(--navy);
  color: var(--text);
  min-height: 100vh; min-height: 100dvh;
  display: flex; flex-direction: column;
  overflow-x: hidden;
}
body::before {
  content: ""; position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background:
    radial-gradient(ellipse 60% 50% at 20% 10%, rgba(59,130,246,0.08) 0%, transparent 70%),
    radial-gradient(ellipse 50% 40% at 80% 80%, rgba(14,165,160,0.07) 0%, transparent 60%);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   HEADER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
header {
  position: sticky; top: 0; z-index: 200;
  background: rgba(11,25,41,0.88);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-bottom: 1px solid var(--border);
  padding: 0 20px; height: 64px;
  display: flex; align-items: center; justify-content: space-between; gap: 12px;
}
.brand { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
.brand-logo {
  width: 38px; height: 38px;
  background: linear-gradient(135deg, var(--sky), #60a5fa);
  border-radius: 10px; display: flex; align-items: center; justify-content: center;
  font-size: 18px; box-shadow: 0 0 20px var(--sky-soft);
}
.brand-name {
  font-family: "Outfit", sans-serif;
  font-size: 15px; font-weight: 700; color: #fff; line-height: 1; letter-spacing: -0.3px;
}
.brand-sub { font-size: 10px; color: var(--text-dim); margin-top: 2px; }
.btn-home {
  padding: 8px 14px; font-size: 12px; font-weight: 600; font-family: "Sarabun", sans-serif;
  background: var(--surface-2); color: var(--text-dim);
  border: 1px solid var(--border-2); border-radius: var(--radius-sm); cursor: pointer;
  display: flex; align-items: center; gap: 5px;
  transition: background 0.2s, color 0.2s;
  -webkit-tap-highlight-color: transparent;
}
.btn-home:hover { background: var(--surface-3); color: var(--text); }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   WRAP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.wrap {
  position: relative; z-index: 1;
  max-width: 1000px; margin: 0 auto;
  padding: 24px 16px 60px; width: 100%;
}

.page-header {
  display: flex; align-items: flex-start; justify-content: space-between;
  margin-bottom: 22px; flex-wrap: wrap; gap: 10px;
  animation: slideUp 0.4s ease both;
}
.page-title {
  font-family: "Outfit", sans-serif;
  font-size: 20px; font-weight: 800; color: #fff; letter-spacing: -0.5px;
}
.page-sub { font-size: 12px; color: var(--text-dim); margin-top: 3px; }

.section-title {
  font-size: 10px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase;
  color: var(--text-faint); margin-bottom: 12px;
  display: flex; align-items: center; gap: 8px;
}
.section-title::after { content: ""; flex: 1; height: 1px; background: var(--border); }
.section-count {
  font-size: 10px; color: var(--text-dim); background: var(--surface-2);
  border: 1px solid var(--border-2); border-radius: 20px; padding: 2px 10px;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RX CARD
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#rx-container { display: flex; flex-direction: column; gap: 16px; }

.rx-card {
  background: var(--surface);
  border: 1px solid var(--border-2);
  border-radius: var(--radius-lg);
  overflow: hidden;
  animation: slideUp 0.4s ease both;
  transition: border-color 0.2s;
}
/* sky blue top bar */
.rx-card::before {
  content: ""; display: block; height: 3px;
  background: linear-gradient(90deg, var(--sky), #60a5fa);
}

/* ‚îÄ‚îÄ Card Header ‚îÄ‚îÄ */
.rxc-header {
  padding: 14px 16px 12px;
  border-bottom: 1px solid var(--border);
  background: var(--surface-2);
}
.rxc-top-row {
  display: flex; align-items: flex-start; gap: 12px; margin-bottom: 10px;
}
.queue-circle {
  font-family: "Outfit", sans-serif;
  width: 40px; height: 40px; border-radius: 50%;
  background: var(--sky-soft); border: 2px solid rgba(59,130,246,0.3);
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; font-weight: 800; color: #93c5fd; flex-shrink: 0;
}
.rxc-title-block { flex: 1; min-width: 0; }
.rxc-animal-name {
  font-family: "Outfit", sans-serif;
  font-size: 16px; font-weight: 800; color: #fff; line-height: 1.1;
}
.rxc-meta { font-size: 11px; color: var(--text-dim); margin-top: 3px; }

/* service chips */
.svc-chips { display: flex; flex-wrap: wrap; gap: 6px; }
.svc-chip {
  font-size: 11px; font-weight: 500;
  background: rgba(14,165,160,0.1); color: var(--teal-light);
  border: 1px solid rgba(14,165,160,0.2);
  border-radius: 20px; padding: 3px 10px;
}

/* action buttons row */
.rxc-actions {
  display: flex; flex-wrap: wrap; gap: 7px; margin-top: 12px;
  padding-top: 12px; border-top: 1px solid var(--border);
}

/* ‚îÄ‚îÄ Rx Table (desktop) ‚îÄ‚îÄ */
.rx-table-wrap {
  overflow-x: auto; -webkit-overflow-scrolling: touch;
}
.rx-table {
  width: 100%; border-collapse: collapse; min-width: 600px; font-size: 13px;
}
.rx-table thead tr { background: var(--surface-3); }
.rx-table th {
  padding: 9px 10px; text-align: left; font-weight: 700;
  color: var(--text-dim); font-size: 10px; letter-spacing: 0.8px; text-transform: uppercase;
  border-bottom: 1px solid var(--border); white-space: nowrap;
}
.rx-table th:first-child { text-align: center; }
.rx-table tbody tr { border-bottom: 1px solid var(--border); transition: background 0.15s; }
.rx-table tbody tr:last-child { border-bottom: none; }
.rx-table tbody tr:hover { background: var(--surface-2); }
.rx-table td {
  padding: 9px 10px; vertical-align: middle; color: var(--text);
}
.rx-table td:first-child { text-align: center; color: var(--text-dim); font-size: 11px; }

/* editable rx inputs */
.rx-inp {
  width: 100%; padding: 6px 8px;
  font-size: 12px; font-family: "Sarabun", sans-serif;
  background: transparent; border: 1px solid transparent;
  border-radius: var(--radius-xs); color: var(--text); outline: none;
  transition: background 0.2s, border-color 0.2s;
}
.rx-inp:not([readonly]) {
  background: var(--surface-2); border-color: var(--border-2);
}
.rx-inp:focus:not([readonly]) {
  border-color: var(--teal); box-shadow: 0 0 0 2px var(--teal-glow);
}
.rx-inp.total-val {
  font-family: "Outfit", sans-serif; font-weight: 800;
  color: #fca5a5; font-size: 14px; text-align: center;
}

/* ‚îÄ‚îÄ Mobile RX List (‚â§ 600px) ‚îÄ‚îÄ */
.rx-item-list { display: none; flex-direction: column; gap: 8px; padding: 12px; }
.rx-item {
  background: var(--surface-2); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 12px;
  position: relative;
}
.rx-item-name {
  font-size: 13px; font-weight: 700; color: var(--text); margin-bottom: 6px;
  padding-right: 80px;
}
.rx-item-details { font-size: 11px; color: var(--text-dim); line-height: 1.8; }
.rx-item-total {
  font-family: "Outfit", sans-serif; font-size: 16px; font-weight: 800;
  color: #fca5a5;
}
.rx-item-actions {
  position: absolute; top: 10px; right: 10px;
  display: flex; flex-direction: column; gap: 4px; align-items: flex-end;
}

@media (max-width: 600px) {
  .rx-table-wrap { display: none; }
  .rx-item-list  { display: flex; }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BUTTONS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.btn {
  padding: 8px 13px; font-size: 11px; font-weight: 600; font-family: "Sarabun", sans-serif;
  border: none; border-radius: var(--radius-sm); cursor: pointer;
  display: inline-flex; align-items: center; gap: 5px;
  transition: opacity 0.2s, transform 0.15s;
  -webkit-tap-highlight-color: transparent;
  white-space: nowrap;
}
.btn:active { transform: scale(0.95); }
.btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; }

/* action buttons on card */
.btn-add-rx {
  background: rgba(14,165,160,0.15); color: var(--teal-light);
  border: 1px solid rgba(14,165,160,0.3);
}
.btn-add-rx:hover { background: rgba(14,165,160,0.25); }

.btn-print-bag {
  background: var(--sky-soft); color: #93c5fd;
  border: 1px solid rgba(59,130,246,0.3);
}
.btn-print-bag:hover { background: rgba(59,130,246,0.22); }

.btn-print-vaccine {
  background: var(--amber-soft); color: var(--amber);
  border: 1px solid rgba(245,158,11,0.3);
}
.btn-print-vaccine:hover { background: rgba(245,158,11,0.22); }

.btn-print-all-rx {
  background: var(--surface-3); color: var(--text);
  border: 1px solid var(--border-2);
}
.btn-print-all-rx:hover { border-color: var(--teal); color: var(--teal-light); }

.btn-dispense {
  background: linear-gradient(135deg, var(--emerald), #34d399);
  color: #fff; font-size: 12px;
  box-shadow: 0 4px 14px var(--emerald-soft);
}
.btn-dispense:hover { opacity: 0.9; }

/* row action buttons */
.btn-row {
  padding: 5px 9px; font-size: 11px; font-weight: 600; font-family: "Sarabun", sans-serif;
  border: none; border-radius: var(--radius-xs); cursor: pointer;
  display: inline-flex; align-items: center; gap: 3px;
  transition: opacity 0.2s;
  -webkit-tap-highlight-color: transparent;
}
.btn-row-print  { background: var(--surface-3); color: var(--text-dim); border: 1px solid var(--border-2); }
.btn-row-edit   { background: rgba(14,165,160,0.15); color: var(--teal-light); border: 1px solid rgba(14,165,160,0.3); }
.btn-row-save   { background: var(--emerald-soft); color: var(--emerald); border: 1px solid rgba(16,185,129,0.3); display: none; }
.btn-row-del    { background: var(--rose-soft); color: #fca5a5; border: 1px solid rgba(239,68,68,0.3); }

/* ‚îÄ‚îÄ Empty ‚îÄ‚îÄ */
.empty-state {
  text-align: center; padding: 60px 16px;
  color: var(--text-faint); animation: slideUp 0.4s ease both;
}
.empty-state-icon { font-size: 52px; margin-bottom: 14px; }
.empty-state-text { font-size: 14px; color: var(--text-dim); }
.empty-state-sub  { font-size: 12px; margin-top: 6px; }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MODAL (Add Rx)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.modal-overlay {
  position: fixed; inset: 0; z-index: 500;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
  display: none; justify-content: center; align-items: flex-end;
}
@media (min-width: 600px) {
  .modal-overlay { align-items: center; padding: 20px; }
}
.modal-overlay.active { display: flex; }

.modal-box {
  background: var(--navy-mid);
  border: 1px solid var(--border-2);
  width: 100%; max-width: 680px;
  border-radius: var(--radius-lg) var(--radius-lg) 0 0;
  max-height: 90vh; display: flex; flex-direction: column;
  animation: slideUp 0.3s ease both;
}
@media (min-width: 600px) {
  .modal-box { border-radius: var(--radius-lg); max-height: 85vh; }
}

.modal-header {
  padding: 16px 18px; border-bottom: 1px solid var(--border);
  display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
}
.modal-title    { font-family: "Outfit", sans-serif; font-size: 16px; font-weight: 700; color: #fff; }
.modal-subtitle { font-size: 12px; color: var(--text-dim); margin-top: 2px; }
.btn-close {
  width: 32px; height: 32px; border-radius: 50%;
  background: var(--surface-3); border: 1px solid var(--border-2);
  color: var(--text-dim); cursor: pointer; font-size: 16px;
  display: flex; align-items: center; justify-content: center;
  -webkit-tap-highlight-color: transparent;
}
.btn-close:hover { background: var(--rose-soft); color: var(--rose); }

.modal-body { padding: 16px; overflow-y: auto; flex: 1; }

.rx-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
@media (max-width: 480px) { .rx-grid { grid-template-columns: 1fr; } }

.rx-drug-card {
  background: var(--surface);
  border: 1px solid var(--border-2);
  border-radius: var(--radius-sm); padding: 13px;
  cursor: pointer; transition: border-color 0.2s, background 0.2s;
}
.rx-drug-card:hover { border-color: rgba(14,165,160,0.4); }
.rx-drug-card.selected { border-color: var(--teal); background: rgba(14,165,160,0.08); }

.rx-drug-top { display: flex; align-items: flex-start; gap: 9px; }
.rx-drug-card input[type="checkbox"] { display: none; }
.rx-checkbox {
  width: 18px; height: 18px; border-radius: 5px; flex-shrink: 0; margin-top: 1px;
  border: 2px solid var(--border-2); background: var(--surface-2);
  display: flex; align-items: center; justify-content: center;
  transition: background 0.2s, border-color 0.2s;
  font-size: 11px; color: transparent;
}
.rx-drug-card.selected .rx-checkbox { background: var(--teal); border-color: var(--teal); color: #fff; }
.rx-drug-info { flex: 1; }
.rx-cat  { font-size: 9px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; color: var(--text-faint); margin-bottom: 3px; }
.rx-name { font-size: 13px; font-weight: 600; color: var(--text); line-height: 1.3; }

.rx-fields {
  display: none; flex-direction: column; gap: 7px;
  margin-top: 11px; padding-top: 11px; border-top: 1px dashed var(--border-2);
}
.rx-drug-card.selected .rx-fields { display: flex; }

.rx-field-row { display: flex; align-items: center; gap: 8px; }
.rx-field-label { font-size: 10px; font-weight: 700; text-transform: uppercase; color: var(--teal-light); width: 54px; flex-shrink: 0; }
.rx-field-input {
  flex: 1; padding: 6px 9px; font-size: 12px; font-family: "Sarabun", sans-serif;
  background: var(--surface-2); border: 1px solid var(--border-2);
  border-radius: var(--radius-xs); color: var(--text); outline: none;
}
.rx-field-input:focus { border-color: var(--teal); }
.rx-field-sm    { width: 58px; flex: none; }
.rx-field-total { width: 58px; flex: none; font-weight: 700; color: #fca5a5; }

.modal-footer {
  padding: 12px 16px; border-top: 1px solid var(--border);
  display: flex; gap: 8px; flex-shrink: 0;
}
.btn-modal-cancel {
  padding: 10px 18px; font-size: 13px; font-weight: 600; font-family: "Sarabun", sans-serif;
  background: var(--surface-3); color: var(--text-dim);
  border: 1px solid var(--border-2); border-radius: var(--radius-sm); cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}
.btn-modal-save {
  flex: 1; padding: 10px 18px; font-size: 13px; font-weight: 700; font-family: "Sarabun", sans-serif;
  background: linear-gradient(135deg, var(--teal), var(--teal-light));
  color: #fff; border: none; border-radius: var(--radius-sm); cursor: pointer;
  display: flex; align-items: center; justify-content: center; gap: 6px;
  box-shadow: 0 4px 16px var(--teal-glow);
  -webkit-tap-highlight-color: transparent;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PRINT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
@media print {
  body { background: white; }
  header, .wrap > .page-header, .section-title,
  .rxc-actions, .btn, .btn-row,
  .modal-overlay { display: none !important; }
  .wrap { padding: 0; max-width: 100%; }
  .rx-card { box-shadow: none; border: 1px solid #000; break-inside: avoid; margin-bottom: 16px; }
  .rx-card::before { display: none; }
  .rxc-header { background: #f0f0f0 !important; border-bottom: 1px solid #ccc; }
  .rxc-animal-name { color: #000; }
  .rx-table th, .rx-table td { color: #000 !important; border: 1px solid #ccc; }
  .rx-inp { border: none !important; background: transparent !important; padding: 0 !important; color: #000; }
  .rx-item-list { display: none !important; }
  .rx-table-wrap { display: block !important; }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ANIMATIONS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
@keyframes slideUp {
  from { opacity: 0; transform: translateY(18px); }
  to   { opacity: 1; transform: translateY(0); }
}

@media (max-width: 640px) {
  header { height: 56px; padding: 0 14px; }
  .brand-sub { display: none; }
  .wrap { padding: 18px 12px 50px; }
  .page-title { font-size: 18px; }
}
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ -->
<header>
  <div class="brand">
    <div class="brand-logo">üíä</div>
    <div>
      <div class="brand-name">‡πÇ‡∏ï‡πä‡∏∞‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤</div>
      <div class="brand-sub">RMUTTO ‚Äì Veterinary Academic Service Division</div>
    </div>
  </div>
  <button class="btn-home" onclick="location.href='index.html'">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
</header>

<!-- ‚îÄ‚îÄ CONTENT ‚îÄ‚îÄ -->
<div class="wrap">

  <div class="page-header">
    <div>
      <div class="page-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏¢‡∏≤ / ‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤</div>
      <div class="page-sub">‡∏à‡∏±‡∏î‡∏¢‡∏≤ ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏â‡∏•‡∏≤‡∏Å ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô</div>
    </div>
  </div>

  <div class="section-title">
    ‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏¢‡∏≤
    <span class="section-count" id="rxCount">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
    <span></span>
  </div>

  <div id="rx-container">
    <div class="empty-state">
      <div class="empty-state-icon">üíä</div>
      <div class="empty-state-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
    </div>
  </div>

</div>

<!-- ‚îÄ‚îÄ MODAL ADD RX ‚îÄ‚îÄ -->
<div class="modal-overlay" id="rxModal">
  <div class="modal-box">
    <div class="modal-header">
      <div>
        <div class="modal-title">üíä ‡∏™‡∏±‡πà‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</div>
        <div class="modal-subtitle" id="rxModalSub"></div>
      </div>
      <button class="btn-close" onclick="closeRxModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="rx-grid" id="rxModalGrid"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-modal-cancel" onclick="closeRxModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn-modal-save" id="btnModalSave" onclick="saveNewRx()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏¢‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
    </div>
  </div>
</div>

<script type="module">
import { supabase } from "./js/supabase.js";

let currentRxAnimalId = null;

/* ‚îÄ‚îÄ helper ‚îÄ‚îÄ */
function round(val) {
  const n = Math.ceil(val * 4) / 4;
  return n < 0.25 ? 0.25 : n;
}
function getTodayAndNext7() {
  const now   = new Date();
  const next7 = new Date(); next7.setDate(next7.getDate() + 7);
  const fmt = d => d.toLocaleDateString("th-TH", { day:"2-digit", month:"2-digit", year:"numeric" });
  return { todayStr: fmt(now), next7Str: fmt(next7) };
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LOAD PRESCRIPTIONS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function loadPrescriptions() {
  const container = document.getElementById("rx-container");
  try {
    const { data: eventId } = await supabase.rpc("get_today_event");
    const { data: queueData, error } = await supabase
      .from("vasd_queue")
      .select(`id, animal_id, status,
        vasd_animal(
          event_id, queue_number, animal_name, species, sex, actual_weight, est_weight,
          vasd_owner(owner_name, phone),
          vasd_service(service_type),
          vasd_prescription(id, drug_id, dose, freq, days, total_pills)
        )`)
      .in("status", ["recovery", "ready_to_go_home"])
      .order("updated_at", { ascending: false });

    if (error) throw error;

    const list = (queueData || []).filter(q =>
      q.vasd_animal?.event_id === eventId &&
      q.vasd_animal?.vasd_prescription?.length > 0
    );

    document.getElementById("rxCount").textContent = `${list.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
    container.innerHTML = "";

    if (list.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">‚úÖ</div>
          <div class="empty-state-text">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏¢‡∏≤‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</div>
          <div class="empty-state-sub">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡πÄ‡∏Ñ‡∏™‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
        </div>`;
      return;
    }

    list.forEach((q, idx) => {
      const a = q.vasd_animal;
      const ownerName  = a.vasd_owner?.owner_name || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
      const phone      = a.vasd_owner?.phone || "‚Äì";
      const spText     = a.species === "‡∏™" ? "üê∂ ‡∏™‡∏∏‡∏ô‡∏±‡∏Ç" : "üê± ‡πÅ‡∏°‡∏ß";
      const weight     = a.actual_weight || a.est_weight || 0;
      const hasVaccine = (a.vasd_service || []).some(s => s.service_type.includes("‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô"));
      const allRxIds   = (a.vasd_prescription || []).map(r => r.id).join(",");

      /* ‚îÄ‚îÄ desktop table rows ‚îÄ‚îÄ */
      const tableRows = (a.vasd_prescription || []).map((rx, i) => `
        <tr id="rxrow-${rx.id}">
          <td>${i + 1}</td>
          <td><input class="rx-inp rx-drug" value="${rx.drug_id || ""}" readonly></td>
          <td><input class="rx-inp rx-dose" value="${rx.dose || ""}" readonly></td>
          <td><input class="rx-inp rx-freq" value="${rx.freq || ""}" readonly></td>
          <td><input class="rx-inp rx-days" type="number" value="${rx.days || ""}" readonly style="width:52px;"></td>
          <td><input class="rx-inp rx-total total-val" type="number" value="${rx.total_pills || 0}" readonly style="width:52px;"></td>
          <td>
            <div style="display:flex;gap:4px;flex-wrap:nowrap;">
              <button class="btn-row btn-row-print" onclick="printRx('${rx.id}')" title="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ã‡∏≠‡∏á‡∏¢‡∏≤">üñ®</button>
              <button class="btn-row btn-row-edit"  onclick="editRx(this)" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‚úèÔ∏è</button>
              <button class="btn-row btn-row-save"  onclick="saveRx(this,'${rx.id}')" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å">üíæ</button>
              <button class="btn-row btn-row-del"   onclick="deleteRx('${rx.id}')" title="‡∏•‡∏ö">üóë</button>
            </div>
          </td>
        </tr>`).join("");

      /* ‚îÄ‚îÄ mobile list items ‚îÄ‚îÄ */
      const mobileItems = (a.vasd_prescription || []).map(rx => `
        <div class="rx-item" id="rxitem-${rx.id}">
          <div class="rx-item-name">${rx.drug_id || "‚Äì"}</div>
          <div class="rx-item-details">
            ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì: ${rx.dose || "‚Äì"}<br>
            ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà: ${rx.freq || "‚Äì"}<br>
            ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô: ${rx.days || "‚Äì"} ‡∏ß‡∏±‡∏ô
          </div>
          <div class="rx-item-total">${rx.total_pills || 0} ‡πÄ‡∏°‡πá‡∏î</div>
          <div class="rx-item-actions">
            <button class="btn-row btn-row-print" onclick="printRx('${rx.id}')">üñ®</button>
            <button class="btn-row btn-row-del" onclick="deleteRx('${rx.id}')">üóë</button>
          </div>
        </div>`).join("");

      const card = document.createElement("div");
      card.className = "rx-card";
      card.dataset.id = q.animal_id;
      card.style.animationDelay = `${idx * 0.06}s`;

      card.innerHTML = `
        <!-- Header -->
        <div class="rxc-header">
          <div class="rxc-top-row">
            <div class="queue-circle">#${a.queue_number}</div>
            <div class="rxc-title-block">
              <div class="rxc-animal-name">${a.animal_name}</div>
              <div class="rxc-meta">${spText} ¬∑ ${a.sex} ¬∑ ${weight} ‡∏Å‡∏Å. ¬∑ ${ownerName}${phone !== "‚Äì" ? ` ¬∑ <a href="tel:${phone}" style="color:var(--teal-light);text-decoration:none;">${phone}</a>` : ""}</div>
            </div>
          </div>
          <div class="svc-chips">
            ${(a.vasd_service || []).map(s => `<span class="svc-chip">${s.service_type}</span>`).join("")}
          </div>
          <!-- Action Buttons -->
          <div class="rxc-actions">
            <button class="btn btn-add-rx" onclick="openRxModal('${q.animal_id}','${a.animal_name}',${weight},'${a.species}')">üíä ‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
            <button class="btn btn-print-bag" onclick="printBag('${q.animal_id}')">üõçÔ∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ñ‡∏∏‡∏á‡∏¢‡∏≤</button>
            ${hasVaccine ? `<button class="btn btn-print-vaccine" onclick="printVaccine('${q.animal_id}')">üìò ‡∏™‡∏°‡∏∏‡∏î‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô</button>` : ""}
            <button class="btn btn-print-all-rx" onclick="printMultipleRx('${allRxIds}')">üñ®Ô∏è ‡∏ã‡∏≠‡∏á‡∏¢‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button class="btn btn-dispense" onclick="markAsDispensed('${q.animal_id}')">‚úîÔ∏è ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô</button>
          </div>
        </div>

        <!-- Desktop Table -->
        <div class="rx-table-wrap">
          <table class="rx-table">
            <thead>
              <tr>
                <th>#</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤</th><th>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì/‡∏Ñ‡∏£‡∏±‡πâ‡∏á</th>
                <th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà</th><th>‡∏ß‡∏±‡∏ô</th><th>‡∏£‡∏ß‡∏° (‡πÄ‡∏°‡πá‡∏î)</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody>${tableRows}</tbody>
          </table>
        </div>

        <!-- Mobile List -->
        <div class="rx-item-list">${mobileItems}</div>
      `;

      container.appendChild(card);
    });

  } catch (err) {
    console.error(err);
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-text" style="color:#fca5a5;">‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}</div>
      </div>`;
  }
}

/* ‚îÄ‚îÄ Mark dispensed ‚îÄ‚îÄ */
window.markAsDispensed = async function(animalId) {
  if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏à‡∏±‡∏î‡∏¢‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô?")) return;
  const { error } = await supabase.from("vasd_queue").update({ status:"done", updated_at:new Date() }).eq("animal_id", animalId);
  if (error) alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"); else loadPrescriptions();
};

/* ‚îÄ‚îÄ Edit / Save / Delete row ‚îÄ‚îÄ */
window.editRx = function(btn) {
  const tr = btn.closest("tr");
  tr.querySelectorAll(".rx-inp").forEach(el => el.removeAttribute("readonly"));
  tr.querySelector(".btn-row-edit").style.display = "none";
  tr.querySelector(".btn-row-save").style.display = "inline-flex";
};
window.saveRx = async function(btn, rxId) {
  const tr = btn.closest("tr");
  const { error } = await supabase.from("vasd_prescription").update({
    drug_id:     tr.querySelector(".rx-drug").value,
    dose:        tr.querySelector(".rx-dose").value,
    freq:        tr.querySelector(".rx-freq").value,
    days:        parseInt(tr.querySelector(".rx-days").value) || 0,
    total_pills: parseFloat(tr.querySelector(".rx-total").value) || 0,
  }).eq("id", rxId);
  if (error) return alert("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
  tr.querySelectorAll(".rx-inp").forEach(el => el.setAttribute("readonly", true));
  tr.querySelector(".btn-row-save").style.display = "none";
  tr.querySelector(".btn-row-edit").style.display = "inline-flex";
};
window.deleteRx = async function(rxId) {
  if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏ô‡∏µ‡πâ?")) return;
  const { error } = await supabase.from("vasd_prescription").delete().eq("id", rxId);
  if (error) alert("‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  else {
    document.getElementById(`rxrow-${rxId}`)?.remove();
    document.getElementById(`rxitem-${rxId}`)?.remove();
  }
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PRINT FUNCTIONS (identical logic)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function generateStickerHTML(rxId) {
  const { data: rx, error } = await supabase.from("vasd_prescription")
    .select(`*, vasd_animal(queue_number, animal_name, species, sex, vasd_owner(owner_name,phone), vasd_service(service_type))`)
    .eq("id", rxId).single();
  if (error || !rx) return null;
  const { data: tmpl } = await supabase.from("vasd_print_template").select("config").eq("template_type","envelope").single();
  if (!tmpl?.config) return null;

  const a = rx.vasd_animal;
  const { todayStr, next7Str } = getTodayAndNext7();
  const spcText = a.species === "‡∏™" ? "‡∏™‡∏∏‡∏ô‡∏±‡∏Ç" : "‡πÅ‡∏°‡∏ß";
  const services = (a.vasd_service || []).map(s => s.service_type).join(", ") || "-";

  let html = `<div class="sticker-page">`;
  tmpl.config.forEach(l => {
    let text = l.text
      .replace(/{{queue_number}}/g, a.queue_number||"")
      .replace(/{{animal_name}}/g,  a.animal_name||"")
      .replace(/{{species}}/g,      spcText)
      .replace(/{{sex}}/g,          a.sex||"")
      .replace(/{{owner_name}}/g,   a.vasd_owner?.owner_name||"")
      .replace(/{{phone}}/g,        a.vasd_owner?.phone||"‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏")
      .replace(/{{services}}/g,     services)
      .replace(/{{drug_id}}/g,      rx.drug_id||"")
      .replace(/{{dose}}/g,         rx.dose||"")
      .replace(/{{freq}}/g,         rx.freq||"")
      .replace(/{{days}}/g,         rx.days ? rx.days+" ‡∏ß‡∏±‡∏ô" : "")
      .replace(/{{total_pills}}/g,  rx.total_pills ? rx.total_pills+" ‡πÄ‡∏°‡πá‡∏î" : "")
      .replace(/{{today}}/g,        todayStr)
      .replace(/{{next7day}}/g,     next7Str);
    html += `<div class="line" style="left:${l.x||0}px;right:0;top:${l.y||0}px;font-size:${l.size}px;font-weight:${l.weight};font-family:${l.font};text-align:${l.align||"left"};">${text}</div>`;
  });
  return html + `</div>`;
}

async function generateGeneralStickerHTML(animalId, templateType) {
  const { data: a, error } = await supabase.from("vasd_animal")
    .select(`queue_number,animal_name,species,sex,vasd_owner(owner_name,phone),vasd_service(service_type)`)
    .eq("id", animalId).single();
  if (error || !a) return null;
  const { data: tmpl } = await supabase.from("vasd_print_template").select("config").eq("template_type", templateType).single();
  if (!tmpl?.config) return null;

  const spcText  = a.species === "‡∏™" ? "‡∏™‡∏∏‡∏ô‡∏±‡∏Ç" : "‡πÅ‡∏°‡∏ß";
  const services = (a.vasd_service || []).map(s => s.service_type).join(", ") || "-";
  const { todayStr, next7Str } = getTodayAndNext7();

  let html = `<div class="sticker-page">`;
  tmpl.config.forEach(l => {
    let text = l.text
      .replace(/{{queue_number}}/g, a.queue_number||"")
      .replace(/{{animal_name}}/g,  a.animal_name||"")
      .replace(/{{species}}/g,      spcText)
      .replace(/{{sex}}/g,          a.sex||"")
      .replace(/{{owner_name}}/g,   a.vasd_owner?.owner_name||"")
      .replace(/{{phone}}/g,        a.vasd_owner?.phone||"‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏")
      .replace(/{{services}}/g,     services)
      .replace(/{{drug_id}}/g, "").replace(/{{dose}}/g, "").replace(/{{freq}}/g, "")
      .replace(/{{days}}/g, "").replace(/{{total_pills}}/g, "")
      .replace(/{{today}}/g, todayStr).replace(/{{next7day}}/g, next7Str);
    html += `<div class="line" style="left:${l.x||0}px;right:0;top:${l.y||0}px;font-size:${l.size}px;font-weight:${l.weight};font-family:${l.font};text-align:${l.align||"left"};">${text}</div>`;
  });
  return html + `</div>`;
}

function openPrintWindow(htmlContent) {
  const pw = window.open("","_blank","width=800,height=600");
  pw.document.write(`<html><head><title>Print</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&family=Prompt:wght@400;700&family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
      body{margin:0}.sticker-page{position:relative;width:80mm;height:50mm;background:#fff;overflow:hidden;page-break-after:always}
      .line{position:absolute;white-space:pre-wrap;word-break:break-word;padding-right:5px;box-sizing:border-box;color:#000!important}
      @page{size:80mm 50mm;margin:0}
    </style></head><body>${htmlContent}
    <script>window.onload=function(){document.fonts.ready.then(()=>{setTimeout(()=>{window.print();window.close();},300)})}<\/script>
    </body></html>`);
  pw.document.close();
}

window.printRx = async function(rxId) {
  const c = await generateStickerHTML(rxId);
  if (!c) return alert("‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Template '‡∏ã‡∏≠‡∏á‡∏¢‡∏≤' (envelope)");
  openPrintWindow(c);
};
window.printMultipleRx = async function(rxIdsStr) {
  const ids = rxIdsStr.split(","); let all = "";
  for (const id of ids) { const c = await generateStickerHTML(id); if (c) all += c; }
  if (!all) return alert("‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Template '‡∏ã‡∏≠‡∏á‡∏¢‡∏≤'");
  openPrintWindow(all);
};
window.printBag = async function(animalId) {
  const c = await generateGeneralStickerHTML(animalId, "bag");
  if (!c) return alert("‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á Template 'bag' ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");
  openPrintWindow(c);
};
window.printVaccine = async function(animalId) {
  const c = await generateGeneralStickerHTML(animalId, "vaccine");
  if (!c) return alert("‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á Template 'vaccine' ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");
  openPrintWindow(c);
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RX MODAL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
window.openRxModal = function(animalId, animalName, w, species) {
  currentRxAnimalId = animalId;
  w = parseFloat(w) || 0;
  document.getElementById("rxModalSub").textContent = `${animalName} ¬∑ ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á ${w} ‡∏Å‡∏Å.`;

  const drugs = [
    { id:"dox",  cat:"Antibiotic",    name:"Doxycycline 100 mg",  tabs: round((w*10)/100), freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£",  f_num:1, days:14 },
    { id:"n200", cat:"Antibiotic",    name:"Norfloxacin 200 mg",  tabs: round((w*20)/200), freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÄ‡∏ä‡πâ‡∏≤-‡πÄ‡∏¢‡πá‡∏ô",  f_num:2, days:7  },
    { id:"n100", cat:"Antibiotic",    name:"Norfloxacin 100 mg",  tabs: round((w*20)/100), freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÄ‡∏ä‡πâ‡∏≤-‡πÄ‡∏¢‡πá‡∏ô",  f_num:2, days:7  },
    { id:"t60",  cat:"NSAID",         name:"Tolfedine 60 mg",     tabs: round((w*4)/60),   freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£",  f_num:1, days:3  },
    { id:"t6",   cat:"NSAID",         name:"Tolfedine 6 mg",      tabs: round((w*4)/6),    freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£",  f_num:1, days:3  },
    { id:"fbc",  cat:"Blood support", name:"FBC ‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏î",      tabs: w >= 10 ? 1 : 0.5, freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£",  f_num:1, days:14 },
    { id:"cstm", cat:"‡∏≠‡∏∑‡πà‡∏ô‡πÜ",         name:"",                    tabs: 1,                 freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á",             f_num:1, days:5, isCustom: true },
  ];

  document.getElementById("rxModalGrid").innerHTML = drugs.map(d => `
    <div class="rx-drug-card" id="rxcard-${d.id}" onclick="toggleRxDrug('${d.id}')">
      <div class="rx-drug-top">
        <input type="checkbox" id="rxchk-${d.id}" data-name="${d.name}">
        <div class="rx-checkbox" id="rxbox-${d.id}">‚úì</div>
        <div class="rx-drug-info">
          <div class="rx-cat">${d.cat}</div>
          ${d.isCustom
            ? `<input class="rx-field-input" type="text" id="custom-name-${d.id}" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤..." style="margin-top:4px;" onclick="event.stopPropagation()">`
            : `<div class="rx-name">${d.name}</div>`}
        </div>
      </div>
      <div class="rx-fields">
        <div class="rx-field-row">
          <span class="rx-field-label">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì</span>
          <input class="rx-field-input" id="rxdose-${d.id}" value="‡∏õ‡πâ‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡∏∞ ${d.tabs} ‡πÄ‡∏°‡πá‡∏î" oninput="recalcRx('${d.id}',${d.f_num})">
        </div>
        <div class="rx-field-row">
          <span class="rx-field-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà</span>
          <input class="rx-field-input" id="rxfreq-${d.id}" value="${d.freq}" oninput="recalcRx('${d.id}',${d.f_num})">
        </div>
        <div class="rx-field-row">
          <span class="rx-field-label">‡∏à‡∏ô.‡∏ß‡∏±‡∏ô</span>
          <input class="rx-field-input rx-field-sm" type="number" id="rxdays-${d.id}" value="${d.days}" oninput="recalcRx('${d.id}',${d.f_num})">
          <span class="rx-field-label" style="color:var(--text-dim);margin-left:6px;">‡∏£‡∏ß‡∏°</span>
          <input class="rx-field-input rx-field-total" type="number" id="rxtotal-${d.id}" value="${Math.ceil(d.tabs * d.f_num * d.days)}">
        </div>
      </div>
    </div>`).join("");

  document.getElementById("rxModal").classList.add("active");
};

window.toggleRxDrug = function(did) {
  const card = document.getElementById(`rxcard-${did}`);
  const chk  = document.getElementById(`rxchk-${did}`);
  chk.checked = !chk.checked;
  card.classList.toggle("selected", chk.checked);
};

window.recalcRx = function(did, fNum) {
  const dose = parseFloat((document.getElementById(`rxdose-${did}`).value||"").match(/[\d.]+/)?.[0]) || 0;
  const freq = parseFloat((document.getElementById(`rxfreq-${did}`).value||"").match(/[\d.]+/)?.[0]) || fNum || 1;
  const days = parseFloat(document.getElementById(`rxdays-${did}`).value) || 0;
  document.getElementById(`rxtotal-${did}`).value = Math.ceil(dose * freq * days);
};

window.closeRxModal = function() {
  document.getElementById("rxModal").classList.remove("active");
  currentRxAnimalId = null;
};

window.saveNewRx = async function() {
  if (!currentRxAnimalId) return;
  const checked = [...document.querySelectorAll(`input[id^="rxchk-"]:checked`)];
  if (!checked.length) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");

  const rxInserts = checked.map(el => {
    const did = el.id.replace("rxchk-","");
    let drugName = el.dataset.name;
    if (did === "cstm") {
      const cn = document.getElementById(`custom-name-${did}`);
      drugName = cn?.value.trim() || "‡∏¢‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°";
    }
    return {
      animal_id:   currentRxAnimalId,
      drug_id:     drugName,
      dose:        document.getElementById(`rxdose-${did}`).value,
      freq:        document.getElementById(`rxfreq-${did}`).value,
      days:        parseInt(document.getElementById(`rxdays-${did}`).value) || 5,
      total_pills: parseFloat(document.getElementById(`rxtotal-${did}`).value) || 0,
    };
  });

  const saveBtn = document.getElementById("btnModalSave");
  saveBtn.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å..."; saveBtn.disabled = true;
  const { error } = await supabase.from("vasd_prescription").insert(rxInserts);
  saveBtn.textContent = "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏¢‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°"; saveBtn.disabled = false;

  if (error) alert("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
  else { closeRxModal(); loadPrescriptions(); }
};

/* ‚îÄ‚îÄ Real-time ‚îÄ‚îÄ */
supabase.channel("vasd-rx-live")
  .on("postgres_changes", { event:"*", schema:"public", table:"vasd_queue" },        loadPrescriptions)
  .on("postgres_changes", { event:"*", schema:"public", table:"vasd_prescription" }, loadPrescriptions)
  .subscribe();

loadPrescriptions();
</script>
</body>
</html>
