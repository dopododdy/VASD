<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>à¹‚à¸•à¹Šà¸°à¸œà¹ˆà¸²à¸•à¸±à¸” â€“ VASD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOKENS & BASE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --navy:         #0b1929;
  --navy-mid:      #112240;
  --primary:       #3b82f6; 
  --primary-light: #60a5fa;
  --teal:          #0ea5a0;
  --teal-light:    #14c4bc;
  --amber:         #f59e0b;
  --rose:          #ef4444; 
  --emerald:       #10b981;
  --violet:        #8b5cf6;

  --surface:    rgba(255,255,255,0.04);
  --surface-2:  rgba(255,255,255,0.07);
  --surface-3:  rgba(255,255,255,0.11);
  --border:     rgba(255,255,255,0.08);
  --border-2:   rgba(255,255,255,0.14);
  --text:       #e2e8f0;
  --text-dim:   #94a3b8;
  --text-faint: #4a5568;

  --radius-xs: 6px;
  --radius-sm: 10px;
  --radius:    16px;
  --radius-lg: 22px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: "Sarabun", sans-serif;
  background: var(--navy); color: var(--text);
  min-height: 100vh; display: flex; flex-direction: column;
  overflow-x: hidden;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER & LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
header {
  position: sticky; top: 0; z-index: 200;
  background: rgba(11,25,41,0.88); backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  padding: 0 20px; height: 64px;
  display: flex; align-items: center; justify-content: space-between; gap: 12px;
}
.brand { display: flex; align-items: center; gap: 10px; }
.brand-logo {
  width: 38px; height: 38px;
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  border-radius: 10px; display: flex; align-items: center; justify-content: center;
  font-size: 18px; box-shadow: 0 0 20px rgba(59,130,246,0.3);
}
.brand-name { font-family: "Outfit", sans-serif; font-size: 15px; font-weight: 700; color: #fff; line-height: 1; }
.brand-sub { font-size: 10px; color: var(--text-dim); margin-top: 2px; }

.wrap { max-width: 900px; margin: 0 auto; padding: 16px 12px 100px; width: 100%; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SURGERY CARD & TABS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.surg-card {
  background: var(--surface); border: 1px solid var(--border-2);
  border-radius: var(--radius-lg); overflow: hidden; margin-bottom: 16px;
  animation: slideUp 0.4s ease both;
  display: flex; flex-direction: column;
}
.surg-card::before { content: ""; display: block; height: 3px; background: linear-gradient(90deg, var(--primary), var(--primary-light)); }

.sc-header {
  display: flex; align-items: center; gap: 12px; padding: 14px 16px;
  border-bottom: 1px solid var(--border); background: var(--surface-2);
}
.queue-circle {
  font-family: "Outfit", sans-serif; width: 42px; height: 42px; border-radius: 50%;
  background: rgba(59,130,246,0.14); border: 2px solid rgba(59,130,246,0.3);
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 800; color: var(--primary); flex-shrink: 0;
}
.sc-title-block { flex: 1; min-width: 0; }
.sc-animal-name { font-family: "Outfit", sans-serif; font-size: 16px; font-weight: 800; color: #fff; line-height: 1.1; }
.sc-meta { font-size: 11px; color: var(--text-dim); margin-top: 3px; }

/* Tabs */
.tabs-header { display: flex; border-bottom: 1px solid var(--border); background: var(--surface-2); overflow-x: auto; scrollbar-width: none; }
.tabs-header::-webkit-scrollbar { display: none; }
.tab-btn {
  flex: 1; padding: 12px 10px; font-size: 13px; font-weight: 600; font-family: "Sarabun", sans-serif;
  color: var(--text-dim); background: transparent; border: none; border-bottom: 2px solid transparent;
  cursor: pointer; transition: all 0.2s; white-space: nowrap; text-align: center;
}
.tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: rgba(59,130,246,0.05); }

.tab-content { display: none; padding: 16px; flex: 1; }
.tab-content.active { display: block; animation: fadeIn 0.3s ease; }

/* â”€â”€ Tab: Info â”€â”€ */
.info-item { background: var(--surface-2); padding: 12px 14px; border-radius: var(--radius-sm); border: 1px solid var(--border); margin-bottom: 16px; }
.info-label { font-size: 11px; color: var(--text-faint); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }

/* Checklist Style */
.service-list { display: flex; flex-direction: column; gap: 8px; }
.svc-check {
  display: flex; align-items: center; gap: 10px;
  background: var(--surface-3); padding: 10px 14px; border-radius: var(--radius-sm);
  cursor: pointer; transition: background 0.2s; border: 1px solid transparent;
}
.svc-check:hover { background: rgba(59,130,246,0.1); }
.svc-check input[type="checkbox"] {
  width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary);
}
.svc-check span { font-size: 14px; font-weight: 500; color: var(--text); }
.svc-check input:checked + span { color: var(--primary-light); text-decoration: none; }

.form-grid { display: grid; grid-template-columns: 80px 1fr; gap: 8px; margin-bottom: 8px; }
.f-input {
  width: 100%; padding: 10px 12px; font-size: 14px; font-family: "Sarabun", sans-serif;
  background: var(--surface-2); border: 1px solid var(--border-2);
  border-radius: var(--radius-sm); color: var(--text); outline: none; transition: 0.2s;
}
.f-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59,130,246,0.15); }

/* â”€â”€ Tab: Monitoring â”€â”€ */
.monitor-inputs { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin-bottom: 12px; }
.monitor-inputs .wide { grid-column: span 6; }
.monitor-inputs .half { grid-column: span 3; }
.monitor-inputs .third { grid-column: span 2; }

.btn {
  padding: 10px 16px; font-size: 13px; font-weight: 600; font-family: "Sarabun", sans-serif;
  border: none; border-radius: var(--radius-sm); cursor: pointer; text-align: center;
  transition: 0.2s; width: 100%;
}
.btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: #fff; box-shadow: 0 4px 12px rgba(59,130,246,0.25); }
.btn-teal { background: linear-gradient(135deg, var(--teal), var(--teal-light)); color: #fff; box-shadow: 0 4px 12px rgba(14,165,160,0.25); }
.btn-emerald { background: linear-gradient(135deg, var(--emerald), #34d399); color: #fff; font-size: 14px; padding: 14px; }

.table-wrapper {
  margin-top: 16px; border: 1px solid var(--border); border-radius: var(--radius-sm);
  overflow-x: auto; background: var(--surface-2);
}
.vitals-table { width: 100%; min-width: 440px; border-collapse: collapse; font-size: 12px; text-align: center; }
.vitals-table th { background: var(--surface-3); color: var(--text-dim); padding: 8px 6px; border-bottom: 1px solid var(--border); }
.vitals-table td { padding: 8px 6px; border-bottom: 1px solid var(--border); color: var(--text); }

/* â”€â”€ Tab: Rx (Prescription) â”€â”€ */
.rx-item {
  display: flex; gap: 10px; align-items: flex-start;
  background: var(--surface-2); padding: 12px; border-radius: var(--radius-sm);
  margin-bottom: 8px; border: 1px solid var(--border);
}
.rx-item input[type="checkbox"] { width: 18px; height: 18px; margin-top: 2px; accent-color: var(--teal); cursor: pointer; }
.rx-info { flex: 1; }
.rx-name { font-weight: 600; color: #fff; margin-bottom: 6px; font-size: 14px; }
.rx-inputs { display: grid; grid-template-columns: minmax(70px, 1fr) 2fr minmax(60px, 1fr) minmax(60px, 1fr); gap: 6px; align-items: center; }
.rx-input-group { display: flex; align-items: center; gap: 4px; font-size: 11px; color: var(--text-dim); white-space: nowrap; }
.rx-inputs input {
  width: 100%; padding: 6px; font-size: 13px; font-family: "Sarabun", sans-serif;
  background: rgba(0,0,0,0.3); border: 1px solid var(--border-2); border-radius: 6px; color: #fff; text-align: center;
}
.rx-inputs input[type="text"] { text-align: left; font-size: 11px; }

@media (max-width: 500px) {
  .rx-inputs { grid-template-columns: 1fr 1fr; }
  .rx-input-group.freq { grid-column: span 2; }
}

.sc-footer { padding: 16px; background: var(--surface-2); border-top: 1px solid var(--border); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOTTOM NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bottom-nav {
  position: fixed; bottom: 0; left: 0; right: 0; height: 64px;
  background: rgba(11,25,41,0.95); backdrop-filter: blur(20px);
  border-top: 1px solid var(--border); z-index: 200;
  display: flex; justify-content: space-around; align-items: center;
  padding-bottom: env(safe-area-inset-bottom);
}
.nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--text-dim); text-decoration: none; font-size: 10px; font-weight: 600; width: 60px; }
.nav-item.active { color: var(--primary); }
.nav-icon { font-size: 20px; }

@keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="brand-logo">ğŸ›ï¸</div>
    <div>
      <div class="brand-name">à¹‚à¸•à¹Šà¸°à¸œà¹ˆà¸²à¸•à¸±à¸”</div>
      <div class="brand-sub">Surgery Table Monitoring</div>
    </div>
  </div>
</header>

<div class="wrap" id="surgery-container">
  <div style="text-align: center; color: var(--text-dim); padding: 40px;">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹‚à¸•à¹Šà¸°à¸œà¹ˆà¸²à¸•à¸±à¸”...</div>
</div>

<nav class="bottom-nav">
  <a href="index.html" class="nav-item"><span class="nav-icon">ğŸ </span><span>à¸«à¸™à¹‰à¸²à¸«à¸¥à¸±à¸</span></a>
  <a href="animals.html" class="nav-item"><span class="nav-icon">ğŸ¾</span><span>à¸ªà¸±à¸•à¸§à¹Œ</span></a>
  <a href="anesthesia.html" class="nav-item"><span class="nav-icon">ğŸ’‰</span><span>à¸§à¸²à¸‡à¸¢à¸²</span></a>
  <a href="#" class="nav-item active"><span class="nav-icon">ğŸ›ï¸</span><span>à¸œà¹ˆà¸²à¸•à¸±à¸”</span></a>
  <a href="recovery.html" class="nav-item"><span class="nav-icon">â¤ï¸â€ğŸ©¹</span><span>à¸à¸±à¸à¸Ÿà¸·à¹‰à¸™</span></a>
</nav>

<script type="module">
import { supabase } from "./js/supabase.js";

// à¸£à¸²à¸¢à¸à¸²à¸£à¸¢à¸²à¸¡à¸²à¸•à¸£à¸à¸²à¸™à¸—à¸µà¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸ˆà¹ˆà¸²à¸¢à¹„à¸”à¹‰
const drugList = [
  { id: 'doxy100', name: 'à¸›à¸à¸´à¸Šà¸µà¸§à¸™à¸° Doxycycline 100 mg', type: 'abx', mgPerKg: 10, mgPerTab: 100, freq: 'à¸§à¸±à¸™à¸¥à¸° 1 à¸„à¸£à¸±à¹‰à¸‡ à¸à¸£à¹‰à¸­à¸¡à¸­à¸²à¸«à¸²à¸£à¹€à¸¢à¹‡à¸™', days: 7 },
  { id: 'nor100', name: 'à¸›à¸à¸´à¸Šà¸µà¸§à¸™à¸° Norfloxacin 100 mg', type: 'abx', mgPerKg: 10, mgPerTab: 100, freq: 'à¸§à¸±à¸™à¸¥à¸° 1 à¸„à¸£à¸±à¹‰à¸‡ à¸à¸£à¹‰à¸­à¸¡à¸­à¸²à¸«à¸²à¸£à¹€à¸¢à¹‡à¸™', days: 7 },
  { id: 'nor200', name: 'à¸›à¸à¸´à¸Šà¸µà¸§à¸™à¸° Norfloxacin 200 mg', type: 'abx', mgPerKg: 10, mgPerTab: 200, freq: 'à¸§à¸±à¸™à¸¥à¸° 1 à¸„à¸£à¸±à¹‰à¸‡ à¸à¸£à¹‰à¸­à¸¡à¸­à¸²à¸«à¸²à¸£à¹€à¸¢à¹‡à¸™', days: 7 },
  { id: 'tol60', name: 'à¹à¸à¹‰à¸›à¸§à¸” Tolfedine 60 mg', type: 'nsaid', mgPerKg: 4, mgPerTab: 60, freq: 'à¸§à¸±à¸™à¸¥à¸° 1 à¸„à¸£à¸±à¹‰à¸‡ à¸à¸£à¹‰à¸­à¸¡à¸­à¸²à¸«à¸²à¸£à¹€à¸¢à¹‡à¸™', days: 3 },
  { id: 'tol6', name: 'à¹à¸à¹‰à¸›à¸§à¸” Tolfedine 6 mg', type: 'nsaid', mgPerKg: 4, mgPerTab: 6, freq: 'à¸§à¸±à¸™à¸¥à¸° 1 à¸„à¸£à¸±à¹‰à¸‡ à¸à¸£à¹‰à¸­à¸¡à¸­à¸²à¸«à¸²à¸£à¹€à¸¢à¹‡à¸™', days: 3 },
  { id: 'blood', name: 'à¸šà¸³à¸£à¸¸à¸‡à¹€à¸¥à¸·à¸­à¸”', type: 'supp', dosePerKg: 0.1, freq: 'à¸§à¸±à¸™à¸¥à¸° 1 à¸„à¸£à¸±à¹‰à¸‡ à¸à¸£à¹‰à¸­à¸¡à¸­à¸²à¸«à¸²à¸£à¹€à¸Šà¹‰à¸²', days: 7 }
];

// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¹à¸›à¸¥à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸›à¹‰à¸­à¸‡à¸à¸±à¸™ HTML injection
function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

async function loadSurgeryQueue() {
  const container = document.getElementById("surgery-container");
  try {
    const { data: eventId } = await supabase.rpc("get_today_event");
    
    // à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸±à¸•à¸§à¹Œ à¸à¸£à¹‰à¸­à¸¡à¸”à¸¶à¸‡ vasd_vital_signs à¸ˆà¸²à¸à¸à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹‚à¸”à¸¢à¸•à¸£à¸‡
    const { data: queueData, error } = await supabase
      .from("vasd_queue")
      .select(`id, animal_id, status,
        vasd_animal(id, event_id, queue_number, animal_name, species, sex, actual_weight, 
        vasd_service(id, service_type, is_done),
        vasd_vital_signs(*))
      `)
      .eq("status", "surgery")
      .order("updated_at", { ascending: true });

    if (error) throw error;

    const animals = (queueData || []).filter(q => q.vasd_animal && q.vasd_animal.event_id === eventId);
    container.innerHTML = "";

    if (animals.length === 0) {
      container.innerHTML = `<div style="text-align:center; padding: 60px 20px; color: var(--text-dim);">âœ… à¹„à¸¡à¹ˆà¸¡à¸µà¹€à¸„à¸ªà¸à¸³à¸¥à¸±à¸‡à¸œà¹ˆà¸²à¸•à¸±à¸”à¹ƒà¸™à¸‚à¸“à¸°à¸™à¸µà¹‰</div>`;
      return;
    }

    animals.forEach((q, idx) => {
      const a = q.vasd_animal;
      const spText = a.species === "à¸ª" ? "ğŸ¶ à¸ªà¸¸à¸™à¸±à¸‚" : "ğŸ± à¹à¸¡à¸§";
      
      // à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ LocalStorage à¹€à¸à¸·à¹ˆà¸­à¸›à¹‰à¸­à¸‡à¸à¸±à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ à¹‚à¸•à¹Šà¸°, à¸«à¸¡à¸­, à¸§à¸´à¸ªà¸±à¸à¸à¸µ à¸«à¸²à¸¢à¸•à¸­à¸™à¸ªà¸¥à¸±à¸šà¸«à¸™à¹‰à¸² à¸«à¸£à¸·à¸­à¸•à¸­à¸™à¸•à¸²à¸£à¸²à¸‡à¸£à¸µà¹€à¸Ÿà¸£à¸Šà¸­à¸­à¹‚à¸•à¹‰
      const savedTable = escapeHtml(localStorage.getItem(`surg_table_${a.id}`));
      const savedSurgeon = escapeHtml(localStorage.getItem(`surg_surgeon_${a.id}`));
      const savedAnes = escapeHtml(localStorage.getItem(`surg_anes_${a.id}`));
      const activeTab = localStorage.getItem(`surg_tab_${a.id}`) || `tab-info-${a.id}`;

      const isInfoActive = activeTab === `tab-info-${a.id}` ? 'active' : '';
      const isMonitorActive = activeTab === `tab-monitor-${a.id}` ? 'active' : '';
      const isRxActive = activeTab === `tab-rx-${a.id}` ? 'active' : '';
      const isEmergencyActive = activeTab === `tab-emergency-${a.id}` ? 'active' : '';

      // à¸ªà¸£à¹‰à¸²à¸‡ Checklist à¸«à¸±à¸•à¸–à¸à¸²à¸£
      const servicesHtml = (a.vasd_service || []).map(s => `
        <label class="svc-check">
          <input type="checkbox" ${s.is_done ? 'checked' : ''} onchange="toggleServiceStatus('${s.id}', this.checked)">
          <span>${s.service_type}</span>
        </label>
      `).join('') || '<div style="color:var(--text-faint);">à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸«à¸±à¸•à¸–à¸à¸²à¸£</div>';

      // à¸ˆà¸±à¸”à¹€à¸£à¸µà¸¢à¸‡à¹à¸¥à¸°à¸ªà¸£à¹‰à¸²à¸‡à¸•à¸²à¸£à¸²à¸‡ Vital Signs à¸ˆà¸²à¸ Database
      const sortedVitals = (a.vasd_vital_signs || []).sort((x, y) => new Date(x.created_at) - new Date(y.created_at));
      const vitalsHtml = sortedVitals.map(l => `
        <tr>
          <td style="color:var(--primary); font-weight:600;">${l.time_recorded || '-'}</td>
          <td>${l.hr || '-'}</td><td>${l.rr || '-'}</td><td>${l.spo2 || '-'}</td>
          <td>${l.temp || '-'}</td><td style="color:var(--teal-light);">${l.zoletil_top || '-'}</td>
          <td style="text-align:left; font-size:11px;">${l.note || '-'}</td>
        </tr>
      `).join('') || `<tr><td colspan="7" style="color:var(--text-faint);">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸</td></tr>`;

      // à¸„à¸³à¸™à¸§à¸“à¸›à¸£à¸´à¸¡à¸²à¸•à¸£à¸¢à¸² Emergency
      const weight = parseFloat(a.actual_weight) || 0;
      let adrVol = "N/A", atrVol = "N/A", atipVol = "N/A";
      if (weight > 0) {
        adrVol = ((weight * 0.01) / 1).toFixed(2) + " ml";
        atrVol = ((weight * 0.02) / 1).toFixed(2) + " ml";
        atipVol = ((weight * 0.1) / 5).toFixed(2) + " ml";
      }

      // à¸ªà¸£à¹‰à¸²à¸‡ HTML à¸Ÿà¸­à¸£à¹Œà¸¡à¸„à¸³à¸™à¸§à¸“à¸ˆà¹ˆà¸²à¸¢à¸¢à¸² Rx à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´
      let rxHtml = drugList.map(d => {
        let tabs = 0;
        if (weight > 0) {
          if (d.type === 'supp') {
            tabs = Math.round((weight * d.dosePerKg) * 4) / 4; 
          } else {
            let exact = (weight * d.mgPerKg) / d.mgPerTab;
            if (d.type === 'abx') tabs = Math.ceil(exact * 4) / 4;   
            if (d.type === 'nsaid') tabs = Math.floor(exact * 4) / 4; 
          }
        }
        if (tabs < 0) tabs = 0;
        let total = Math.ceil(tabs * 1 * d.days); 

        return `
          <label class="rx-item">
            <input type="checkbox" id="chk-${d.id}-${a.id}" value="${d.id}">
            <div class="rx-info">
               <div class="rx-name">${d.name}</div>
               <div class="rx-inputs">
                  <div class="rx-input-group">
                     <input type="number" step="0.25" id="dose-${d.id}-${a.id}" value="${tabs}" oninput="recalcRx('${d.id}', '${a.id}')"> à¹€à¸¡à¹‡à¸”
                  </div>
                  <div class="rx-input-group freq">
                     <input type="text" id="freq-${d.id}-${a.id}" value="${d.freq}" readonly>
                  </div>
                  <div class="rx-input-group">
                     <input type="number" id="days-${d.id}-${a.id}" value="${d.days}" oninput="recalcRx('${d.id}', '${a.id}')"> à¸§à¸±à¸™
                  </div>
                  <div class="rx-input-group">
                     <input type="number" id="total-${d.id}-${a.id}" value="${total}"> à¸£à¸§à¸¡
                  </div>
               </div>
            </div>
          </label>
        `;
      }).join('');

      const card = document.createElement("div");
      card.className = "surg-card";
      card.innerHTML = `
        <div class="sc-header">
          <div class="queue-circle">#${a.queue_number || "-"}</div>
          <div class="sc-title-block">
            <div class="sc-animal-name">${a.animal_name}</div>
            <div class="sc-meta">${spText} Â· ${a.sex} Â· à¸™à¸™.: ${a.actual_weight || "-"} kg</div>
          </div>
        </div>

        <div class="tabs-header">
          <button class="tab-btn ${isInfoActive}" id="btn-tab-info-${a.id}" onclick="switchTab(this, 'tab-info-${a.id}', '${a.id}')">à¸‚à¹‰à¸­à¸¡à¸¹à¸¥</button>
          <button class="tab-btn ${isMonitorActive}" id="btn-tab-monitor-${a.id}" onclick="switchTab(this, 'tab-monitor-${a.id}', '${a.id}')">Monitoring</button>
          <button class="tab-btn ${isRxActive}" id="btn-tab-rx-${a.id}" style="color:var(--teal);" onclick="switchTab(this, 'tab-rx-${a.id}', '${a.id}')">ğŸ’Š Rx (à¸ˆà¹ˆà¸²à¸¢à¸¢à¸²)</button>
          <button class="tab-btn ${isEmergencyActive}" id="btn-tab-emergency-${a.id}" style="color:var(--rose);" onclick="switchTab(this, 'tab-emergency-${a.id}', '${a.id}')">ğŸš¨</button>
        </div>

        <div id="tab-info-${a.id}" class="tab-content ${isInfoActive}">
          <div class="info-item">
            <div class="info-label">à¸«à¸±à¸•à¸–à¸à¸²à¸£à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸—à¸³</div>
            <div class="service-list">${servicesHtml}</div>
          </div>
          
          <div class="form-grid">
            <input type="text" id="table-${a.id}" class="f-input" placeholder="à¹‚à¸•à¹Šà¸°" value="${savedTable}" oninput="saveLocalInput('${a.id}', 'table', this.value)">
            <input type="text" id="surgeon-${a.id}" class="f-input" placeholder="Surgeon (à¸ªà¸±à¸•à¸§à¹à¸à¸—à¸¢à¹Œ) *" value="${savedSurgeon}" oninput="saveLocalInput('${a.id}', 'surgeon', this.value)">
          </div>
          <input type="text" id="anes-${a.id}" class="f-input" placeholder="Anesthetist (à¸œà¸¹à¹‰à¸Šà¹ˆà¸§à¸¢ / à¸§à¸´à¸ªà¸±à¸à¸à¸µ)" value="${savedAnes}" oninput="saveLocalInput('${a.id}', 'anes', this.value)">
        </div>

        <div id="tab-monitor-${a.id}" class="tab-content ${isMonitorActive}">
          <div class="monitor-inputs">
            <input type="number" id="hr-${a.id}" class="f-input third" placeholder="HR">
            <input type="number" id="rr-${a.id}" class="f-input third" placeholder="RR">
            <input type="number" id="spo2-${a.id}" class="f-input third" placeholder="SpO2%">
            <input type="number" step="0.1" id="temp-${a.id}" class="f-input half" placeholder="Temp">
            <input type="number" step="0.01" id="zol-${a.id}" class="f-input half" placeholder="Zol (ml)">
            <input type="text" id="note-${a.id}" class="f-input wide" placeholder="à¸šà¸±à¸™à¸—à¸¶à¸à¹€à¸à¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡...">
          </div>
          <button class="btn btn-primary" onclick="addVitalSign('${a.id}')">+ à¸šà¸±à¸™à¸—à¸¶à¸ Monitoring à¸¥à¸‡à¸£à¸°à¸šà¸š</button>
          <div class="table-wrapper">
            <table class="vitals-table">
              <thead><tr><th>à¹€à¸§à¸¥à¸²</th><th>HR</th><th>RR</th><th>SpO2</th><th>Temp</th><th>Zol</th><th>Note</th></tr></thead>
              <tbody id="vitals-tbody-${a.id}">${vitalsHtml}</tbody>
            </table>
          </div>
        </div>

        <div id="tab-rx-${a.id}" class="tab-content ${isRxActive}">
          <div class="rx-list" style="margin-bottom:12px;">${rxHtml}</div>
          <button class="btn btn-teal" id="btn-save-rx-${a.id}" onclick="saveRx('${a.id}')">ğŸ’¾ à¸ªà¸±à¹ˆà¸‡à¸¢à¸²à¹à¸¥à¸°à¸ªà¹ˆà¸‡à¹„à¸›à¸«à¹‰à¸­à¸‡à¸ˆà¸±à¸”à¸¢à¸²</button>
        </div>

        <div id="tab-emergency-${a.id}" class="tab-content ${isEmergencyActive}">
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <div style="background: rgba(239,68,68,0.1); padding: 12px; border-radius: 10px; display: flex; justify-content: space-between;">
              <span style="color:var(--rose); font-weight:700;">Adrenaline</span> <b style="font-size:18px;">${adrVol}</b>
            </div>
            <div style="background: rgba(245,158,11,0.1); padding: 12px; border-radius: 10px; display: flex; justify-content: space-between;">
              <span style="color:var(--amber); font-weight:700;">Atropine</span> <b style="font-size:18px;">${atrVol}</b>
            </div>
            <div style="background: rgba(16,185,129,0.1); padding: 12px; border-radius: 10px; display: flex; justify-content: space-between;">
              <span style="color:var(--emerald); font-weight:700;">Atipamezole</span> <b style="font-size:18px;">${atipVol}</b>
            </div>
          </div>
        </div>

        <div class="sc-footer">
          <button class="btn btn-emerald" onclick="finishSurgery('${a.id}')">âœ… à¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸´à¹‰à¸™à¸à¸²à¸£à¸œà¹ˆà¸²à¸•à¸±à¸” (à¸¢à¹‰à¸²à¸¢à¹„à¸›à¸à¸±à¸à¸Ÿà¸·à¹‰à¸™)</button>
        </div>
      `;
      container.appendChild(card);
    });

  } catch (err) {
    console.error(err);
    container.innerHTML = `<div style="text-align:center; padding: 40px; color: #fca5a5;">âŒ à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ</div>`;
  }
}

// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¹€à¸à¹‡à¸šà¸„à¹ˆà¸²à¸¥à¸‡ LocalStorage à¹€à¸‰à¸à¸²à¸° Table, Surgeon, Anes
window.saveLocalInput = function(animalId, field, value) {
  localStorage.setItem(`surg_${field}_${animalId}`, value);
};

// à¸„à¸³à¸™à¸§à¸“à¸¢à¸­à¸”à¸£à¸§à¸¡à¹€à¸¡à¹‡à¸”à¸¢à¸²à¹ƒà¸«à¸¡à¹ˆà¹€à¸¡à¸·à¹ˆà¸­à¸¡à¸µà¸à¸²à¸£à¹à¸à¹‰à¸•à¸±à¸§à¹€à¸¥à¸‚
window.recalcRx = function(drugId, animalId) {
  const dose = parseFloat(document.getElementById(`dose-${drugId}-${animalId}`).value) || 0;
  const days = parseInt(document.getElementById(`days-${drugId}-${animalId}`).value) || 0;
  const total = Math.ceil(dose * 1 * days);
  document.getElementById(`total-${drugId}-${animalId}`).value = total;
};

// à¸ªà¸±à¹ˆà¸‡à¸¢à¸²à¸šà¸±à¸™à¸—à¸¶à¸à¹€à¸‚à¹‰à¸²à¸à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥
window.saveRx = async function(animalId) {
  const inserts = [];
  for (const d of drugList) {
    const chk = document.getElementById(`chk-${d.id}-${animalId}`);
    if (chk && chk.checked) {
       inserts.push({
         animal_id: animalId,
         drug_id: d.name,
         dose: document.getElementById(`dose-${d.id}-${animalId}`).value + ' à¹€à¸¡à¹‡à¸”/à¸„à¸£à¸±à¹‰à¸‡',
         freq: document.getElementById(`freq-${d.id}-${animalId}`).value,
         days: parseInt(document.getElementById(`days-${d.id}-${animalId}`).value) || 0,
         total_pills: parseInt(document.getElementById(`total-${d.id}-${animalId}`).value) || 0
       });
    }
  }

  if (inserts.length === 0) return alert("âš ï¸ à¸à¸£à¸¸à¸“à¸²à¸•à¸´à¹Šà¸à¹€à¸¥à¸·à¸­à¸à¸¢à¸²à¸­à¸¢à¹ˆà¸²à¸‡à¸™à¹‰à¸­à¸¢ 1 à¸Šà¸™à¸´à¸”à¸à¹ˆà¸­à¸™à¸ªà¸±à¹ˆà¸‡");

  const btn = document.getElementById(`btn-save-rx-${animalId}`);
  btn.disabled = true; btn.textContent = "â³ à¸à¸³à¸¥à¸±à¸‡à¸šà¸±à¸™à¸—à¸¶à¸...";
  
  try {
    const { error } = await supabase.from('vasd_prescription').insert(inserts);
    if (error) throw error;
    alert("âœ… à¸ªà¸±à¹ˆà¸‡à¸¢à¸²à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§ à¸£à¸²à¸¢à¸à¸²à¸£à¸–à¸¹à¸à¸ªà¹ˆà¸‡à¹„à¸›à¸¢à¸±à¸‡à¹‚à¸•à¹Šà¸°à¸ˆà¸±à¸”à¸¢à¸²");
    
    btn.textContent = "âœ… à¸ªà¹ˆà¸‡à¸¢à¸²à¹€à¸à¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡";
    btn.disabled = false;
    
    for (const d of drugList) {
      const chk = document.getElementById(`chk-${d.id}-${animalId}`);
      if (chk) chk.checked = false;
    }

  } catch (err) {
    alert("âŒ à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸ªà¸±à¹ˆà¸‡à¸¢à¸²: " + err.message);
    btn.disabled = false; btn.textContent = "ğŸ’¾ à¸ªà¸±à¹ˆà¸‡à¸¢à¸²à¹à¸¥à¸°à¸ªà¹ˆà¸‡à¹„à¸›à¸«à¹‰à¸­à¸‡à¸ˆà¸±à¸”à¸¢à¸²";
  }
};

window.toggleServiceStatus = async function(serviceId, isDone) {
  try {
    const { error } = await supabase.from("vasd_service").update({ is_done: isDone }).eq("id", serviceId);
    if (error) throw error;
  } catch (err) { alert("à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸–à¸²à¸™à¸°à¹„à¸”à¹‰: " + err.message); }
};

window.switchTab = function(btn, targetId, animalId) {
  const card = btn.closest('.surg-card');
  card.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  card.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById(targetId).classList.add('active');
  
  if (animalId) {
    localStorage.setItem(`surg_tab_${animalId}`, targetId);
  }
};

// à¸šà¸±à¸™à¸—à¸¶à¸ Vital Sign à¸¥à¸‡ Database 
window.addVitalSign = async function(animalId) {
  const hr = document.getElementById(`hr-${animalId}`).value;
  const rr = document.getElementById(`rr-${animalId}`).value;
  const spo2 = document.getElementById(`spo2-${animalId}`).value;
  const temp = document.getElementById(`temp-${animalId}`).value;
  const zol = document.getElementById(`zol-${animalId}`).value;
  const note = document.getElementById(`note-${animalId}`).value;
  const timeStr = new Date().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', hour12: false });

  if(!hr && !rr && !spo2 && !temp && !zol && !note) return;

  const data = {
    animal_id: animalId,
    time_recorded: timeStr,
    hr: hr, rr: rr, spo2: spo2, temp: temp, zoletil_top: zol, note: note
  };

  // à¸¥à¹‰à¸²à¸‡à¸„à¹ˆà¸²à¹ƒà¸™à¸Šà¹ˆà¸­à¸‡à¸à¸£à¸­à¸à¹€à¸¡à¸·à¹ˆà¸­à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸³à¹€à¸£à¹‡à¸ˆ
  ['hr', 'rr', 'spo2', 'temp', 'zol', 'note'].forEach(k => {
    document.getElementById(`${k}-${animalId}`).value = '';
  });

  try {
    const { error } = await supabase.from('vasd_vital_signs').insert(data);
    if (error) throw error;
  } catch (err) {
    alert("à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸: " + err.message);
  }
};

window.finishSurgery = async function(animalId) {
  // à¸”à¸¶à¸‡à¸„à¹ˆà¸² Surgeon à¸ˆà¸²à¸ input à¹à¸—à¸™ à¹€à¸à¸£à¸²à¸°à¹€à¸£à¸²à¹ƒà¸Šà¹‰ oninput à¸œà¸¹à¸à¸„à¹ˆà¸²à¹„à¸§à¹‰à¹à¸¥à¹‰à¸§
  const surgeon = document.getElementById(`surgeon-${animalId}`).value.trim();
  if (!surgeon) {
    document.getElementById(`btn-tab-info-${animalId}`).click();
    alert("âš ï¸ à¸à¸£à¸¸à¸“à¸²à¸£à¸°à¸šà¸¸à¸Šà¸·à¹ˆà¸­ Surgeon à¸à¹ˆà¸­à¸™à¸„à¸£à¸±à¸š");
    return;
  }
  if (!confirm("à¸¢à¸·à¸™à¸¢à¸±à¸™à¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸´à¹‰à¸™à¸à¸²à¸£à¸œà¹ˆà¸²à¸•à¸±à¸”à¹à¸¥à¸°à¸ªà¹ˆà¸‡à¹„à¸›à¸¢à¸±à¸‡à¸«à¹‰à¸­à¸‡à¸à¸±à¸à¸Ÿà¸·à¹‰à¸™?")) return;
  try {
    const { error } = await supabase.from("vasd_queue").update({ 
      status: "recovery", 
      surgeon_name: surgeon,
      updated_at: new Date() 
    }).eq("animal_id", animalId);
    if (error) throw error;
    
    // à¸¥à¹‰à¸²à¸‡ LocalStorage à¸—à¸µà¹ˆà¸„à¹‰à¸²à¸‡à¸­à¸¢à¸¹à¹ˆà¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸‚à¸­à¸‡à¸ªà¸±à¸•à¸§à¹Œà¸•à¸±à¸§à¸™à¸µà¹‰à¹€à¸¡à¸·à¹ˆà¸­à¸œà¹ˆà¸²à¸•à¸±à¸”à¹€à¸ªà¸£à¹‡à¸ˆ (à¹€à¸‰à¸à¸²à¸° Info à¸à¸±à¸š Tab)
    ['table', 'surgeon', 'anes', 'tab'].forEach(k => localStorage.removeItem(`surg_${k}_${animalId}`));

  } catch (err) { alert(err.message); }
};

// à¸”à¸±à¸à¸ˆà¸±à¸šà¸à¸²à¸£à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡à¹€à¸à¸·à¹ˆà¸­à¹‚à¸«à¸¥à¸”à¸•à¸²à¸£à¸²à¸‡à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´
supabase.channel('surgery-realtime')
  .on('postgres_changes', { event: '*', schema: 'public', table: 'vasd_queue' }, loadSurgeryQueue)
  .on('postgres_changes', { event: '*', schema: 'public', table: 'vasd_vital_signs' }, loadSurgeryQueue)
  .on('postgres_changes', { event: '*', schema: 'public', table: 'vasd_service' }, loadSurgeryQueue)
  .subscribe();

loadSurgeryQueue();
</script>
   <script type="module" src="./js/global-alarm.js"></script>
</body>
</html>
