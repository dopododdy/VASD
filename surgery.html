<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>RMUTTO - VASD | ‡πÇ‡∏ï‡πä‡∏∞‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î (Surgery)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&family=Prompt:wght@300;400;500;700&family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>
:root {
  --navy:#0d1b2a; --teal:#1a6b72; --teal-light:#22919a; --accent:#00d4aa;
  --bg:#f0f4f8; --surface:#fff; --text:#1a202c; --text-muted:#718096;
  --border:#e2e8f0; --danger:#e53e3e; --success:#38a169; --warning:#d69e2e;
  --shadow-sm:0 1px 3px rgba(0,0,0,0.06); --shadow-md:0 4px 16px rgba(13,27,42,0.08);
  --shadow-lg:0 12px 40px rgba(13,27,42,0.12);
  --radius:10px; --radius-sm:6px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{font-family:"Sarabun",sans-serif;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;}

/* HEADER */
header{
  background:var(--navy);padding:0 32px;display:flex;
  justify-content:space-between;align-items:center;height:68px;
  position:sticky;top:0;z-index:100;box-shadow:0 2px 20px rgba(0,0,0,0.25);flex-shrink:0;
}
.header-brand{display:flex;align-items:center;gap:14px;}
.brand-icon{
  width:40px;height:40px;background:linear-gradient(135deg,var(--teal-light),var(--accent));
  border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;
}
.brand-text h1{font-size:17px;font-weight:700;color:#fff;line-height:1.2;}
.brand-text span{font-size:11px;color:rgba(255,255,255,0.5);}
.btn-home{
  padding:8px 18px;font-size:13px;font-weight:600;font-family:"Sarabun",sans-serif;
  background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.9);
  border:1px solid rgba(255,255,255,0.2);border-radius:var(--radius-sm);cursor:pointer;
}

/* MAIN CONTENT */
.main-content { padding: 24px 32px; flex: 1; overflow-y: auto; }
.section-title { font-size: 20px; font-weight: 700; color: var(--navy); margin-bottom: 20px; display: flex; align-items: center; gap: 8px; border-bottom: 2px solid var(--border); padding-bottom: 12px;}

/* GRID LAYOUTS */
.grid-surgery { display:grid; grid-template-columns:1fr; gap:24px; }

/* CARDS */
.card { background:var(--surface); border-radius:var(--radius); border:1px solid var(--border); box-shadow:var(--shadow-sm); padding:20px; }
.card-header { display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); padding-bottom:12px; margin-bottom:16px; }
.badge-q { background:var(--navy); color:#fff; padding:4px 10px; border-radius:20px; font-size:13px; font-weight:700; }

/* FORMS & TABLES */
.form-control { width:100%; padding:8px 12px; font-family:"Sarabun"; border:1px solid var(--border); border-radius:var(--radius-sm); outline:none; font-size:14px; }
.form-control:focus { border-color:var(--teal); }

.staff-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; background:#f0f4f8; padding:16px; border-radius:var(--radius-sm); margin-bottom:16px; }

.vital-table { width:100%; border-collapse:collapse; margin-bottom:12px; font-size:13px; }
.vital-table th { background:var(--bg); padding:10px; border:1px solid var(--border); text-align:left; color:var(--text-muted); font-weight: 600; position: sticky; top: 0;}
.vital-table td { padding:10px; border:1px solid var(--border); text-align:center; }
.vital-form { display:flex; gap:6px; background:#fff; padding:12px; border:1px solid var(--border); border-radius:var(--radius-sm); margin-bottom:16px; flex-wrap:wrap; align-items: center; }
.vital-form input { flex:1; min-width:70px; padding:8px; font-size:13px; border:1px solid var(--border); border-radius:4px; text-align: center; }

/* BUTTONS */
.btn { padding:10px 16px; font-size:14px; font-weight:700; font-family:"Sarabun"; border:none; border-radius:6px; cursor:pointer; transition: 0.2s;}
.btn-primary { background:var(--teal); color:#fff; }
.btn-primary:hover { background:var(--teal-light); }
.btn-success { background:var(--success); color:#fff; }
.btn-success:hover { background:#2f855a; }
.btn-warning { background:var(--warning); color:#fff; }
.btn-warning:hover { background:#b7791f; }
.btn-danger { background:#fee2e2; color:var(--danger); }
.btn-danger:hover { background:var(--danger); color:#fff; }
.action-bar { display:flex; justify-content:flex-end; gap:12px; margin-top:20px; padding-top:16px; border-top:1px solid var(--border); }

/* ‚îÄ‚îÄ‚îÄ MODAL ADD RX (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Anesthesia) ‚îÄ‚îÄ‚îÄ */
.modal-overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(13, 27, 42, 0.7); z-index: 1000;
  display: none; justify-content: center; align-items: center;
  padding: 20px; backdrop-filter: blur(2px);
}
.modal-overlay.active { display: flex; }
.modal-content {
  background: var(--surface); width: 100%; max-width: 700px;
  border-radius: var(--radius); box-shadow: var(--shadow-lg);
  animation: fadeUp 0.3s ease both; max-height: 90vh; display: flex; flex-direction: column;
}
.modal-header {
  padding: 18px 24px; border-bottom: 1px solid var(--border);
  display: flex; justify-content: space-between; align-items: center; background: #fafbfc; border-radius: var(--radius) var(--radius) 0 0;
}
.modal-header h3 { font-size: 18px; color: var(--navy); margin: 0; display:flex; align-items:center; gap:8px;}
.btn-close-modal { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text-muted); padding:4px;}
.btn-close-modal:hover { color: var(--danger); }
.modal-body { padding: 24px; overflow-y: auto; background:#f8fafc; }
.modal-footer {
  padding: 16px 24px; border-top: 1px solid var(--border);
  display: flex; justify-content: flex-end; gap: 10px; background: #fff; border-radius: 0 0 var(--radius) var(--radius);
}

/* ‚îÄ‚îÄ‚îÄ RX GRID ‚îÄ‚îÄ‚îÄ */
.rx-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
@media(max-width:560px){.rx-grid{grid-template-columns:1fr;}}
.rx-card-item{background:#fff; border:2px solid var(--border);border-radius:var(--radius-sm);padding:14px;
  cursor:pointer;transition:all 0.2s;}
.rx-card-item.selected{border-color:var(--teal-light);background:#e6f6f4;box-shadow:0 2px 8px rgba(34,145,154,0.15);}
.rx-card-item label{display:flex;align-items:flex-start;gap:10px;cursor:pointer; margin:0;}
.rx-card-item input[type="checkbox"]{width:18px;height:18px;accent-color:var(--teal-light);flex-shrink:0;margin-top:2px;}
.rx-cat{font-size:11px;font-weight:700;letter-spacing:0.5px;text-transform:uppercase;color:var(--text-muted);margin-bottom:3px;}
.rx-name{font-size:14px;font-weight:700;color:var(--navy);}
.rx-custom-inputs { display: none; flex-direction: column; gap: 8px; margin-top: 12px; padding-top:12px; border-top:1px dashed #cbd5e0;}
.rx-input-group { display: flex; align-items: center; gap: 8px; }
.rx-input-group label { font-size: 12px; color: var(--teal); font-weight:600; width: 50px; flex-shrink: 0; }
.rx-input-group input { flex: 1; padding: 6px 10px; font-size: 13px; font-family:"Sarabun",sans-serif; border: 1px solid var(--border); border-radius: 4px; outline:none; }
.rx-input-group input:focus{border-color:var(--teal-light);}

@keyframes fadeUp{from{opacity:0;transform:translateY(14px);}to{opacity:1;transform:translateY(0);}}
</style>
</head>
<body>

<header>
  <div class="header-brand">
    <div class="brand-icon">üî¨</div>
    <div class="brand-text">
      <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏ï‡πä‡∏∞‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î (Surgery)</h1>
      <span>RMUTTO ‚Äì Veterinary Academic Service Division</span>
    </div>
  </div>
  <button class="btn-home" onclick="location.href='index.html'">üè† ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
</header>

<div class="main-content">
  <div class="section-title">üìã ‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î / ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏≤‡∏á‡∏¢‡∏≤‡∏™‡∏•‡∏ö</div>
  <div class="grid-surgery" id="surgeryGrid">
    <p style="color:var(--text-muted);">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
  </div>
</div>

<div class="modal-overlay" id="rxModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>üíä ‡∏™‡∏±‡πà‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤ (Prescription)</h3>
      <button class="btn-close-modal" onclick="closeRxModal()">‚úñ</button>
    </div>
    <div class="modal-body">
      <div style="margin-bottom: 14px; font-size:13px; color:var(--text-muted);" id="rxModalAnimalName"></div>
      <div class="rx-grid" id="rxModalGrid">
        </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger" onclick="closeRxModal()" style="background:#e2e8f0; color:var(--text);">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn btn-success" onclick="saveNewRx()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏¢‡∏≤</button>
    </div>
  </div>
</div>

<script type="module">
import { supabase } from "./js/supabase.js";

let currentEventId = null;

async function init() {
  const { data: eventId } = await supabase.rpc("get_today_event");
  currentEventId = eventId;
  loadSurgeryCases();
}

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ñ‡∏™‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°)
async function loadSurgeryCases() {
  const grid = document.getElementById("surgeryGrid");
  try {
    const { data: queues, error: qError } = await supabase
      .from("vasd_queue")
      .select("*")
      .in("status", ["anesthesia", "surgery"]);

    if (qError) throw qError;
    if (!queues || queues.length === 0) {
      grid.innerHTML = `<div style="text-align:center; padding:40px; background:var(--surface); border:1px dashed var(--border); border-radius:var(--radius); color:var(--text-muted);">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏™‡∏£‡∏≠‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</div>`;
      return;
    }

    const animalIds = queues.map(q => q.animal_id);
    const { data: animals, error: aError } = await supabase
      .from("vasd_animal")
      .select(`
        id, queue_number, animal_name, species, sex, actual_weight, health_note,
        vasd_owner(owner_name, phone),
        vasd_service(service_type),
        vasd_vital_signs(*)
      `)
      .in("id", animalIds);

    if (aError) throw aError;

    const activeCases = animals.map(animal => {
      const matchedQueue = queues.find(x => x.animal_id === animal.id);
      return { ...animal, vasd_queue: [matchedQueue] };
    });

    activeCases.sort((a, b) => a.queue_number - b.queue_number);

    grid.innerHTML = activeCases.map(a => {
      const q = a.vasd_queue[0];
      const ownerName = a.vasd_owner?.owner_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
      const phone = a.vasd_owner?.phone || '-';
      const services = (a.vasd_service || []).map(s => s.service_type).join(', ') || '<span style="color:#aaa;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</span>';
      
      let extraNotes = { assistant: '', nurse: '' };
      try { if(q.notes) extraNotes = JSON.parse(q.notes); } catch(e){}

      let tableOptions = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞ --</option>';
      for(let i=1; i<=20; i++) {
        let selected = (q.table_number === i) ? 'selected' : '';
        tableOptions += `<option value="${i}" ${selected}>‡πÇ‡∏ï‡πä‡∏∞‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î‡∏ó‡∏µ‡πà ${i}</option>`;
      }

      const vitals = (a.vasd_vital_signs || []).sort((x, y) => (x.time_recorded || '').localeCompare(y.time_recorded || ''));
      let vitalRows = vitals.map(v => `<tr>
          <td>${v.time_recorded ? v.time_recorded.substring(0,5) : '-'}</td>
          <td>${v.hr||'-'}</td><td>${v.rr||'-'}</td><td>${v.temp||'-'}</td>
          <td>${v.spo2||'-'}</td><td>${v.zoletil_top||'-'}</td><td style="text-align:left;">${v.note||'-'}</td>
        </tr>`).join("");
      if(vitals.length === 0) vitalRows = `<tr><td colspan="7" style="text-align:center; color:#aaa; padding: 20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ä‡∏µ‡∏û</td></tr>`;

      const isAnesthesia = (q.status === 'anesthesia');
      const cardBorderColor = isAnesthesia ? 'var(--warning)' : 'var(--teal)';
      const headerTitle = isAnesthesia ? 'üíâ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏≤‡∏á‡∏¢‡∏≤‡∏™‡∏•‡∏ö (‡∏£‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞)' : `üî¨ ‡πÇ‡∏ï‡πä‡∏∞‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î‡∏ó‡∏µ‡πà ${q.table_number}`;
      const currentTime = new Date().toTimeString().substring(0,5);

      return `
        <div class="card" style="border-top: 4px solid ${cardBorderColor};">
          <div class="card-header" style="background:#f7fafc; padding:16px; margin:-20px -20px 20px -20px; border-radius:10px 10px 0 0;">
            <div style="font-size:18px; font-weight:700; color:${cardBorderColor};">${headerTitle}</div>
            <span class="badge-q">‡∏Ñ‡∏¥‡∏ß ${a.queue_number}</span>
          </div>

          <div style="display:grid; grid-template-columns:1fr 1fr; gap:24px;">
            <div>
              <div style="background:#fff; border:1px solid var(--border); padding:16px; border-radius:var(--radius-sm); margin-bottom:16px;">
                <div style="display:flex; justify-content:space-between; margin-bottom: 8px;">
                  <strong>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå: <span style="color:var(--navy); font-size:16px;">${a.animal_name}</span></strong>
                  <span>${a.species === '‡∏™' ? '‡∏™‡∏∏‡∏ô‡∏±‡∏Ç üê∂' : '‡πÅ‡∏°‡∏ß üê±'} | ${a.sex} | ${a.actual_weight} kg</span>
                </div>
                <div style="border-top: 1px dashed var(--border); padding-top: 8px; margin-top: 8px; font-size:14px;">
                  <strong>‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á:</strong> ${ownerName} (‡πÇ‡∏ó‡∏£: ${phone})<br>
                  <strong>‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£:</strong> <span style="color:var(--teal);">${services}</span><br>
                  <strong>Note:</strong> <span style="color:var(--danger);">${a.health_note || '-'}</span>
                </div>
              </div>

              <h4 style="font-size:14px; color:var(--navy); margin-bottom: 10px;">üë®‚Äç‚öïÔ∏è ‡∏ó‡∏µ‡∏°‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î</h4>
              <div class="staff-grid">
                <div style="grid-column: 1 / -1;"><label style="font-size:12px;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î *</label><select class="form-control" id="table-sel-${a.id}">${tableOptions}</select></div>
                <div><label style="font-size:12px;">Surgeon *</label><input type="text" class="form-control" id="surg-${a.id}" value="${q.surgeon_name || ''}"></div>
                <div><label style="font-size:12px;">Assistant</label><input type="text" class="form-control" id="asst-${a.id}" value="${extraNotes.assistant || ''}"></div>
                <div><label style="font-size:12px;">Anesthetist</label><input type="text" class="form-control" id="anes-${a.id}" value="${q.anesthesiologist_name || ''}"></div>
                <div><label style="font-size:12px;">Nurse</label><input type="text" class="form-control" id="nurs-${a.id}" value="${extraNotes.nurse || ''}"></div>
              </div>
              <button class="btn btn-primary" style="width:100%; margin-bottom:10px; background:var(--navy);" onclick="saveSurgeryInfo('${a.id}')">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>

            <div>
              <h4 style="font-size:14px; color:var(--navy); margin-bottom:8px;">ü©∫ Vitals (‡∏ó‡∏∏‡∏Å 5 ‡∏ô‡∏≤‡∏ó‡∏µ)</h4>
              <div class="vital-form" style="background:#f7fafc;">
                <input type="time" id="v-time-${a.id}" value="${currentTime}" style="flex:0.8; font-weight:bold;">
                <input type="number" id="v-hr-${a.id}" placeholder="HR"><input type="number" id="v-rr-${a.id}" placeholder="RR">
                <input type="number" id="v-temp-${a.id}" placeholder="Temp"><input type="number" id="v-spo2-${a.id}" placeholder="O2%">
                <input type="text" id="v-zol-${a.id}" placeholder="Zol"><input type="text" id="v-note-${a.id}" placeholder="Note" style="flex:2; text-align:left;">
                <button class="btn btn-primary" onclick="addVital('${a.id}')">‚ûï</button>
              </div>
              <div style="max-height:220px; overflow-y:auto; border:1px solid var(--border); border-radius:6px;">
                <table class="vital-table" style="margin:0;">
                  <thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>HR</th><th>RR</th><th>Temp</th><th>O2%</th><th>Zol</th><th>Note</th></tr></thead>
                  <tbody>${vitalRows}</tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="action-bar" style="background:#f0f4f8; margin:-20px -20px; padding:16px 20px; margin-top:20px; border-radius:0 0 10px 10px;">
            <button class="btn btn-warning" onclick="openRxModal('${a.id}', '${a.animal_name}', ${a.actual_weight}, '${a.species}')">üíä ‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤</button>
            <button class="btn btn-success" onclick="finishSurgery('${a.id}')">‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î</button>
          </div>
        </div>
      `;
    }).join("");
  } catch (err) { console.error(err); grid.innerHTML = `<div style="text-align:center; color:red;">Error: ${err.message}</div>`; }
}

window.saveSurgeryInfo = async function(animalId) {
  const tableNum = document.getElementById(`table-sel-${animalId}`).value;
  const surg = document.getElementById(`surg-${animalId}`).value;
  const asst = document.getElementById(`asst-${animalId}`).value;
  const anes = document.getElementById(`anes-${animalId}`).value;
  const nurs = document.getElementById(`nurs-${animalId}`).value;
  const extraNotes = JSON.stringify({ assistant: asst, nurse: nurs });
  const { error } = await supabase.from('vasd_queue').update({
    status: 'surgery', table_number: tableNum ? parseInt(tableNum) : null,
    surgeon_name: surg, anesthesiologist_name: anes, notes: extraNotes, updated_at: new Date()
  }).eq('animal_id', animalId);
  if(error) alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message); else { alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); loadSurgeryCases(); }
};

window.addVital = async function(animalId) {
  const timeInput = document.getElementById(`v-time-${animalId}`).value;
  if (!timeInput) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤");
  const { error } = await supabase.from('vasd_vital_signs').insert({
    animal_id: animalId, time_recorded: timeInput,
    hr: document.getElementById(`v-hr-${animalId}`).value || null, rr: document.getElementById(`v-rr-${animalId}`).value || null,
    temp: document.getElementById(`v-temp-${animalId}`).value || null, spo2: document.getElementById(`v-spo2-${animalId}`).value || null,
    zoletil_top: document.getElementById(`v-zol-${animalId}`).value || null, note: document.getElementById(`v-note-${animalId}`).value || null
  });
  if (error) alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
  else {
    document.querySelectorAll(`#v-hr-${animalId}, #v-rr-${animalId}, #v-temp-${animalId}, #v-spo2-${animalId}, #v-zol-${animalId}, #v-note-${animalId}`).forEach(e => e.value = '');
    loadSurgeryCases();
  }
};

window.finishSurgery = async function(animalId) {
  const surgInput = document.getElementById(`surg-${animalId}`).value;
  const tableInput = document.getElementById(`table-sel-${animalId}`).value;
  if(!tableInput || !surgInput) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÇ‡∏ï‡πä‡∏∞‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠ Surgeon ‡∏Å‡πà‡∏≠‡∏ô");
  if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î?")) return;
  await saveSurgeryInfo(animalId);
  await supabase.from("vasd_queue").update({ status: "recovery", table_number: null, updated_at: new Date() }).eq("animal_id", animalId);
  loadSurgeryCases();
};


/* ‚îÄ‚îÄ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏¢‡∏≤ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal Rx (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Anesthesia) ‚îÄ‚îÄ */
function round(val) { 
  let num = Math.ceil(val * 4) / 4; 
  return num < 0.25 ? 0.25 : num;
}

window.recalcTotalRxNew = function(did) {
  const doseStr = document.getElementById(`newrxdose-${did}`).value;
  const freqStr = document.getElementById(`newrxfreq-${did}`).value;
  const daysStr = document.getElementById(`newrxdays-${did}`).value;

  const doseMatch = doseStr.match(/[\d.]+/);
  const dose = doseMatch ? parseFloat(doseMatch[0]) : 0;
  
  const freqMatch = freqStr.match(/[\d.]+/);
  const freq = freqMatch ? parseFloat(freqMatch[0]) : 0;
  
  const days = parseFloat(daysStr) || 0;

  const total = Math.ceil(dose * freq * days);
  document.getElementById(`newrxtotal-${did}`).value = total;
};

window.toggleNewRx = function(chk, did) {
  const card = document.getElementById(`newrxcard-${did}`);
  const inputs = document.getElementById(`newrxcustom-${did}`);
  if(chk.checked) {
    card.classList.add("selected");
    inputs.style.display = "flex";
  } else {
    card.classList.remove("selected");
    inputs.style.display = "none";
  }
};

let currentRxAnimalId = null;

// ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏™‡∏±‡πà‡∏á‡∏¢‡∏≤
window.openRxModal = function(animalId, animalName, w, species) {
  currentRxAnimalId = animalId;
  w = parseFloat(w) || 0;
  
  document.getElementById("rxModalAnimalName").innerHTML = `‡∏™‡∏±‡πà‡∏á‡∏¢‡∏≤‡πÉ‡∏´‡πâ: <strong>${animalName}</strong> (‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å: ${w} ‡∏Å‡∏Å.)`;
  const grid = document.getElementById("rxModalGrid");
  
  // ‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏¢‡∏≤‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Anesthesia
  const drugs = [
    {id:"dox",    cat:"Antibiotic",    name:"‡∏õ‡∏è‡∏¥‡∏ä‡∏µ‡∏ß‡∏ô‡∏∞ Doxycycline 100 mg",  tabs: round((w*10)/100), freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏¢‡πá‡∏ô", f_num:1, days:14},
    {id:"nor200", cat:"Antibiotic",    name:"‡∏õ‡∏è‡∏¥‡∏ä‡∏µ‡∏ß‡∏ô‡∏∞ Norfloxacin 200 mg",  tabs: round((w*20)/200), freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÄ‡∏ä‡πâ‡∏≤-‡πÄ‡∏¢‡πá‡∏ô ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£", f_num:2, days:7},
    {id:"nor100", cat:"Antibiotic",    name:"‡∏õ‡∏è‡∏¥‡∏ä‡∏µ‡∏ß‡∏ô‡∏∞ Norfloxacin 100 mg",  tabs: round((w*20)/100), freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÄ‡∏ä‡πâ‡∏≤-‡πÄ‡∏¢‡πá‡∏ô ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£", f_num:2, days:7},
    {id:"tolf60", cat:"NSAID",         name:"‡πÅ‡∏Å‡πâ‡∏õ‡∏ß‡∏î Tolfedine 60 mg",      tabs: round((w*4)/60),   freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏¢‡πá‡∏ô", f_num:1, days:3},
    {id:"tolf6",  cat:"NSAID",         name:"‡πÅ‡∏Å‡πâ‡∏õ‡∏ß‡∏î Tolfedine 6 mg",       tabs: round((w*4)/6),    freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏¢‡πá‡∏ô", f_num:1, days:3},
    {id:"fbc",    cat:"Blood support", name:"‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏î FBC",              tabs: (w>=10?1:0.5),     freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏ä‡πâ‡∏≤", f_num:1, days:14},
    {id:"custom1",cat:"‡∏≠‡∏∑‡πà‡∏ô‡πÜ",         name:"‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≤‡πÄ‡∏≠‡∏á...",                tabs: 1, freq:"‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á", f_num:1, days:5, isCustom:true}
  ];

  grid.innerHTML = drugs.map(d => `
    <div class="rx-card-item" id="newrxcard-${d.id}">
      <label>
        <input type="checkbox" id="newrxchk-${d.id}" data-name="${d.name}" onchange="toggleNewRx(this, '${d.id}')">
        <div style="width:100%;">
          <div class="rx-cat">${d.cat}</div>
          ${d.isCustom ? 
            `<input type="text" id="custom-name-${d.id}" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤..." class="rx-input" style="border:1px solid #cbd5e0; background:#fff; margin-top:4px;" onclick="event.preventDefault();">` : 
            `<div class="rx-name">${d.name}</div>`
          }
        </div>
      </label>
      <div class="rx-custom-inputs" id="newrxcustom-${d.id}">
        <div class="rx-input-group">
          <label>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì</label>
          <input type="text" id="newrxdose-${d.id}" value="‡∏õ‡πâ‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡∏∞ ${d.tabs} ‡πÄ‡∏°‡πá‡∏î" oninput="recalcTotalRxNew('${d.id}')">
        </div>
        <div class="rx-input-group">
          <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà</label>
          <input type="text" id="newrxfreq-${d.id}" value="${d.freq}" oninput="recalcTotalRxNew('${d.id}')">
        </div>
        <div class="rx-input-group" style="display:flex; gap:10px;">
          <div style="display:flex; align-items:center; gap:8px;">
            <label>‡∏à‡∏ô.‡∏ß‡∏±‡∏ô</label>
            <input type="number" id="newrxdays-${d.id}" value="${d.days}" style="width:60px;" oninput="recalcTotalRxNew('${d.id}')">
          </div>
          <div style="display:flex; align-items:center; gap:8px;">
            <label style="color:var(--danger);">‡∏£‡∏ß‡∏°</label>
            <input type="number" step="1" id="newrxtotal-${d.id}" value="${Math.ceil(d.tabs * d.f_num * d.days)}" style="width:60px; font-weight:bold; color:var(--danger);">
          </div>
        </div>
      </div>
    </div>`).join("");

  document.getElementById("rxModal").classList.add("active");
};

window.closeRxModal = function() {
  document.getElementById("rxModal").classList.remove("active");
  currentRxAnimalId = null;
};

// ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≤‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
window.saveNewRx = async function() {
  if(!currentRxAnimalId) return;
  const rxInserts = [];
  
  Array.from(document.querySelectorAll(`input[id^="newrxchk-"]:checked`)).forEach(el => {
    const did = el.id.replace("newrxchk-", "");
    
    let drugName = el.dataset.name;
    if(did.startsWith("custom")) {
      const customNameInput = document.getElementById(`custom-name-${did}`);
      if(customNameInput && customNameInput.value.trim() !== "") {
        drugName = customNameInput.value.trim();
      } else {
        drugName = "‡∏¢‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°";
      }
    }

    rxInserts.push({
      animal_id:    currentRxAnimalId,
      drug_id:      drugName, 
      dose:         document.getElementById(`newrxdose-${did}`).value,
      freq:         document.getElementById(`newrxfreq-${did}`).value,
      days:         parseInt(document.getElementById(`newrxdays-${did}`).value) || 5,
      total_pills:  parseFloat(document.getElementById(`newrxtotal-${did}`).value) || 0 
    });
  });

  if(rxInserts.length === 0) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
    return;
  }

  const { error } = await supabase.from("vasd_prescription").insert(rxInserts);
  if(error) {
    alert("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
  } else {
    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤");
    closeRxModal();
  }
};

// Real-time Update
supabase.channel("surgery-live")
  .on("postgres_changes", { event: "*", schema: "public", table: "vasd_queue" }, loadSurgeryCases)
  .on("postgres_changes", { event: "*", schema: "public", table: "vasd_vital_signs" }, loadSurgeryCases)
  .subscribe();

init();
</script>
</body>
</html>
