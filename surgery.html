<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>à¹‚à¸•à¹Šà¸°à¸œà¹ˆà¸²à¸•à¸±à¸” â€“ VASD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOKENS & BASE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --navy:         #0b1929;
  --navy-mid:     #112240;
  --teal:         #0ea5a0;
  --teal-light:   #14c4bc;
  --amber:        #f59e0b;
  --rose:         #ef4444;
  --emerald:      #10b981;
  --violet:       #8b5cf6;

  --surface:    rgba(255,255,255,0.04);
  --surface-2:  rgba(255,255,255,0.07);
  --surface-3:  rgba(255,255,255,0.11);
  --border:     rgba(255,255,255,0.08);
  --border-2:   rgba(255,255,255,0.14);
  --text:       #e2e8f0;
  --text-dim:   #94a3b8;
  --text-faint: #4a5568;

  --radius-xs: 6px;
  --radius-sm: 10px;
  --radius:    16px;
  --radius-lg: 22px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: "Sarabun", sans-serif;
  background: var(--navy); color: var(--text);
  min-height: 100vh; display: flex; flex-direction: column;
  overflow-x: hidden;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
header {
  position: sticky; top: 0; z-index: 200;
  background: rgba(11,25,41,0.88); backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  padding: 0 20px; height: 64px;
  display: flex; align-items: center; justify-content: space-between; gap: 12px;
}
.brand { display: flex; align-items: center; gap: 10px; }
.brand-logo {
  width: 38px; height: 38px;
  background: linear-gradient(135deg, var(--rose), #fb7185);
  border-radius: 10px; display: flex; align-items: center; justify-content: center;
  font-size: 18px; box-shadow: 0 0 20px rgba(239,68,68,0.2);
}
.brand-name { font-family: "Outfit", sans-serif; font-size: 15px; font-weight: 700; color: #fff; line-height: 1; }
.brand-sub { font-size: 10px; color: var(--text-dim); margin-top: 2px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.wrap { max-width: 900px; margin: 0 auto; padding: 16px 12px 100px; width: 100%; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SURGERY CARD & TABS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.surg-card {
  background: var(--surface); border: 1px solid var(--border-2);
  border-radius: var(--radius-lg); overflow: hidden; margin-bottom: 16px;
  animation: slideUp 0.4s ease both;
  display: flex; flex-direction: column;
}
.surg-card::before { content: ""; display: block; height: 3px; background: linear-gradient(90deg, var(--rose), #fb7185); }

.sc-header {
  display: flex; align-items: center; gap: 12px; padding: 14px 16px;
  border-bottom: 1px solid var(--border); background: var(--surface-2);
}
.queue-circle {
  font-family: "Outfit", sans-serif; width: 42px; height: 42px; border-radius: 50%;
  background: rgba(239,68,68,0.14); border: 2px solid rgba(239,68,68,0.3);
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 800; color: var(--rose); flex-shrink: 0;
}
.sc-title-block { flex: 1; min-width: 0; }
.sc-animal-name { font-family: "Outfit", sans-serif; font-size: 16px; font-weight: 800; color: #fff; line-height: 1.1; }
.sc-meta { font-size: 11px; color: var(--text-dim); margin-top: 3px; }

/* Tabs */
.tabs-header { display: flex; border-bottom: 1px solid var(--border); background: var(--surface-2); }
.tab-btn {
  flex: 1; padding: 12px 0; font-size: 13px; font-weight: 600; font-family: "Sarabun", sans-serif;
  color: var(--text-dim); background: transparent; border: none; border-bottom: 2px solid transparent;
  cursor: pointer; transition: all 0.2s;
}
.tab-btn.active { color: var(--rose); border-bottom-color: var(--rose); background: rgba(239,68,68,0.05); }

.tab-content { display: none; padding: 16px; flex: 1; }
.tab-content.active { display: block; animation: fadeIn 0.3s ease; }

/* â”€â”€ Tab: Info & Team â”€â”€ */
.info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
.info-item { background: var(--surface-2); padding: 10px 12px; border-radius: var(--radius-sm); border: 1px solid var(--border); }
.info-label { font-size: 10px; color: var(--text-faint); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; }
.info-val { font-size: 13px; font-weight: 600; color: var(--text); }

.form-grid { display: grid; grid-template-columns: 80px 1fr; gap: 8px; margin-bottom: 8px; }

.f-input {
  width: 100%; padding: 10px 12px; font-size: 14px; font-family: "Sarabun", sans-serif;
  background: var(--surface-2); border: 1px solid var(--border-2);
  border-radius: var(--radius-sm); color: var(--text); outline: none; transition: 0.2s;
}
.f-input:focus { border-color: var(--rose); box-shadow: 0 0 0 3px rgba(239,68,68,0.1); }
.f-input::placeholder { color: var(--text-faint); }
.f-input.error { border-color: var(--rose); background: rgba(239,68,68,0.05); }

/* â”€â”€ Tab: Monitoring â”€â”€ */
.monitor-inputs {
  display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin-bottom: 12px;
}
.monitor-inputs .wide { grid-column: span 6; }
.monitor-inputs .half { grid-column: span 3; }
.monitor-inputs .third { grid-column: span 2; }

.btn {
  padding: 10px 16px; font-size: 13px; font-weight: 600; font-family: "Sarabun", sans-serif;
  border: none; border-radius: var(--radius-sm); cursor: pointer; text-align: center;
  transition: opacity 0.2s, transform 0.1s; width: 100%;
}
.btn:active { transform: scale(0.98); }
.btn-rose { background: linear-gradient(135deg, var(--rose), #fb7185); color: #fff; box-shadow: 0 4px 12px rgba(239,68,68,0.25); }
.btn-emerald { background: linear-gradient(135deg, var(--emerald), #34d399); color: #fff; font-size: 14px; padding: 14px; }

/* Responsive Table */
.table-wrapper {
  margin-top: 16px; border: 1px solid var(--border); border-radius: var(--radius-sm);
  overflow-x: auto; background: var(--surface-2); -webkit-overflow-scrolling: touch;
}
.vitals-table { width: 100%; min-width: 440px; border-collapse: collapse; font-size: 12px; text-align: center; }
.vitals-table th { background: var(--surface-3); color: var(--text-dim); padding: 8px 6px; font-weight: 600; border-bottom: 1px solid var(--border); }
.vitals-table td { padding: 8px 6px; border-bottom: 1px solid var(--border); color: var(--text); }
.vitals-table tr:last-child td { border-bottom: none; }

/* â”€â”€ Card Footer â”€â”€ */
.sc-footer {
  padding: 16px; background: var(--surface-2); border-top: 1px solid var(--border);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOTTOM NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bottom-nav {
  position: fixed; bottom: 0; left: 0; right: 0; height: 64px;
  background: rgba(11,25,41,0.95); backdrop-filter: blur(20px);
  border-top: 1px solid var(--border); z-index: 200;
  display: flex; justify-content: space-around; align-items: center;
  padding-bottom: env(safe-area-inset-bottom);
}
.nav-item {
  display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
  color: var(--text-dim); text-decoration: none; font-size: 10px; font-weight: 600; width: 60px; height: 100%; transition: 0.2s;
}
.nav-item.active { color: var(--rose); }
.nav-icon { font-size: 20px; }
.nav-item:hover { color: var(--text); }
.nav-item.active:hover { color: var(--rose); }

/* ANIMATIONS */
@keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="brand-logo">ğŸ›ï¸</div>
    <div>
      <div class="brand-name">à¹‚à¸•à¹Šà¸°à¸œà¹ˆà¸²à¸•à¸±à¸”</div>
      <div class="brand-sub">Surgery Table Monitoring</div>
    </div>
  </div>
</header>

<div class="wrap" id="surgery-container">
  <div style="text-align: center; color: var(--text-dim); padding: 40px;">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹‚à¸•à¹Šà¸°à¸œà¹ˆà¸²à¸•à¸±à¸”...</div>
</div>

<nav class="bottom-nav">
  <a href="index.html" class="nav-item"><span class="nav-icon">ğŸ </span><span>à¸«à¸™à¹‰à¸²à¸«à¸¥à¸±à¸</span></a>
  <a href="animals.html" class="nav-item"><span class="nav-icon">ğŸ¾</span><span>à¸ªà¸±à¸•à¸§à¹Œ</span></a>
  <a href="anesthesia.html" class="nav-item"><span class="nav-icon">ğŸ’‰</span><span>à¸§à¸²à¸‡à¸¢à¸²</span></a>
  <a href="#" class="nav-item active"><span class="nav-icon">ğŸ›ï¸</span><span>à¸œà¹ˆà¸²à¸•à¸±à¸”</span></a>
  <a href="recovery.html" class="nav-item"><span class="nav-icon">â¤ï¸â€ğŸ©¹</span><span>à¸à¸±à¸à¸Ÿà¸·à¹‰à¸™</span></a>
</nav>

<script type="module">
import { supabase } from "./js/supabase.js";

const vitalsData = {};

async function loadSurgeryQueue() {
  const container = document.getElementById("surgery-container");
  try {
    const { data: eventId } = await supabase.rpc("get_today_event");
    const { data: queueData, error } = await supabase
      .from("vasd_queue")
      .select(`id, animal_id, status,
        vasd_animal(id, event_id, queue_number, animal_name, species, sex, actual_weight, vasd_service(service_type))
      `)
      .eq("status", "surgery")
      .order("updated_at", { ascending: true });

    if (error) throw error;

    const animals = (queueData || []).filter(q => q.vasd_animal && q.vasd_animal.event_id === eventId);
    container.innerHTML = "";

    if (animals.length === 0) {
      container.innerHTML = `<div style="text-align:center; padding: 60px 20px; color: var(--text-dim);">âœ… à¹„à¸¡à¹ˆà¸¡à¸µà¹€à¸„à¸ªà¸à¸³à¸¥à¸±à¸‡à¸œà¹ˆà¸²à¸•à¸±à¸”à¹ƒà¸™à¸‚à¸“à¸°à¸™à¸µà¹‰</div>`;
      return;
    }

    animals.forEach((q, idx) => {
      const a = q.vasd_animal;
      const spText = a.species === "à¸ª" ? "ğŸ¶ à¸ªà¸¸à¸™à¸±à¸‚" : "ğŸ± à¹à¸¡à¸§";
      const services = (a.vasd_service || []).map(s => s.service_type).join(", ") || "â€“";
      
      if(!vitalsData[a.id]) vitalsData[a.id] = [];

      const card = document.createElement("div");
      card.className = "surg-card";
      card.innerHTML = `
        <div class="sc-header">
          <div class="queue-circle">#${a.queue_number || "-"}</div>
          <div class="sc-title-block">
            <div class="sc-animal-name">${a.animal_name}</div>
            <div class="sc-meta">${spText} Â· ${a.sex} Â· à¸™à¹‰à¸³à¸«à¸™à¸±à¸à¸ˆà¸£à¸´à¸‡: ${a.actual_weight || "-"} à¸à¸.</div>
          </div>
        </div>

        <div class="tabs-header">
          <button class="tab-btn active" id="btn-tab-info-${a.id}" onclick="switchTab(this, 'tab-info-${a.id}')">à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ & à¸—à¸µà¸¡à¸œà¹ˆà¸²à¸•à¸±à¸”</button>
          <button class="tab-btn" id="btn-tab-monitor-${a.id}" onclick="switchTab(this, 'tab-monitor-${a.id}')">Monitoring</button>
        </div>

        <div id="tab-info-${a.id}" class="tab-content active">
          <div class="info-grid">
            <div class="info-item"><div class="info-label">à¸«à¸±à¸•à¸–à¸à¸²à¸£</div><div class="info-val" style="color:var(--rose);">${services}</div></div>
            <div class="info-item"><div class="info-label">à¸ªà¸–à¸²à¸™à¸°</div><div class="info-val">à¸à¸³à¸¥à¸±à¸‡à¸œà¹ˆà¸²à¸•à¸±à¸” ğŸ›ï¸</div></div>
          </div>
          
          <div class="form-grid">
            <input type="text" id="table-${a.id}" class="f-input" placeholder="à¹‚à¸•à¹Šà¸°à¸œà¹ˆà¸²à¸•à¸±à¸” (à¹€à¸Šà¹ˆà¸™ 1, 2, A)">
            <input type="text" id="surgeon-${a.id}" class="f-input" placeholder="Surgeon (à¸ªà¸±à¸•à¸§à¹à¸à¸—à¸¢à¹Œ) *" oninput="this.classList.remove('error')">
          </div>
          <input type="text" id="anes-${a.id}" class="f-input" placeholder="Anesthetist (à¸œà¸¹à¹‰à¸Šà¹ˆà¸§à¸¢ / à¸§à¸´à¸ªà¸±à¸à¸à¸µ)">
        </div>

        <div id="tab-monitor-${a.id}" class="tab-content">
          <div class="monitor-inputs">
            <input type="number" id="hr-${a.id}" class="f-input third" placeholder="HR (bpm)">
            <input type="number" id="rr-${a.id}" class="f-input third" placeholder="RR (bpm)">
            <input type="number" id="spo2-${a.id}" class="f-input third" placeholder="SpO2 (%)">
            
            <input type="number" id="temp-${a.id}" class="f-input half" placeholder="T (Â°C)">
            <input type="number" id="zol-${a.id}" class="f-input half" placeholder="Zol (ml)">
            
            <input type="text" id="note-${a.id}" class="f-input wide" placeholder="à¸šà¸±à¸™à¸—à¸¶à¸à¹€à¸à¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡ (à¸¢à¸²à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¹€à¸à¸´à¹ˆà¸¡, à¹€à¸«à¸•à¸¸à¸à¸²à¸£à¸“à¹Œ)...">
          </div>
          <button class="btn btn-rose" onclick="addVitalSign('${a.id}')">+ à¸šà¸±à¸™à¸—à¸¶à¸ Monitoring</button>

          <div class="table-wrapper">
            <table class="vitals-table">
              <thead>
                <tr>
                  <th>à¹€à¸§à¸¥à¸²</th><th>HR</th><th>RR</th><th>SpO2</th><th>Temp</th><th>Zol</th><th>Note</th>
                </tr>
              </thead>
              <tbody id="vitals-tbody-${a.id}">
                <tr><td colspan="7" style="color:var(--text-faint); font-style:italic;">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="sc-footer">
          <button class="btn btn-emerald" onclick="finishSurgery('${a.id}')">âœ… à¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸´à¹‰à¸™à¸à¸²à¸£à¸œà¹ˆà¸²à¸•à¸±à¸” (à¸¢à¹‰à¸²à¸¢à¹„à¸›à¸à¸±à¸à¸Ÿà¸·à¹‰à¸™)</button>
        </div>
      `;
      container.appendChild(card);
      renderVitalsTable(a.id);
    });

  } catch (err) {
    console.error(err);
    container.innerHTML = `<div style="text-align:center; padding: 40px; color: #fca5a5;">âŒ à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ</div>`;
  }
}

// â”€â”€ UI Tab Switcher â”€â”€
window.switchTab = function(btn, targetId) {
  const card = btn.closest('.surg-card');
  card.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  card.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById(targetId).classList.add('active');
};

// â”€â”€ à¸šà¸±à¸™à¸—à¸¶à¸ Vitals â”€â”€
window.addVitalSign = function(animalId) {
  const hr = document.getElementById(`hr-${animalId}`).value;
  const rr = document.getElementById(`rr-${animalId}`).value;
  const spo2 = document.getElementById(`spo2-${animalId}`).value;
  const temp = document.getElementById(`temp-${animalId}`).value;
  const zol = document.getElementById(`zol-${animalId}`).value;
  const note = document.getElementById(`note-${animalId}`).value;

  const now = new Date();
  const timeStr = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });

  if(!hr && !rr && !spo2 && !temp && !zol && !note) return;

  vitalsData[animalId].push({ time: timeStr, hr, rr, spo2, temp, zol, note });
  
  ['hr', 'rr', 'spo2', 'temp', 'zol', 'note'].forEach(k => {
    document.getElementById(`${k}-${animalId}`).value = '';
  });

  renderVitalsTable(animalId);
};

// â”€â”€ à¹à¸ªà¸”à¸‡à¸•à¸²à¸£à¸²à¸‡ Vitals â”€â”€
window.renderVitalsTable = function(animalId) {
  const tbody = document.getElementById(`vitals-tbody-${animalId}`);
  if(!tbody) return;
  const logs = vitalsData[animalId];
  
  if(!logs || logs.length === 0) {
    tbody.innerHTML = `<tr><td colspan="7" style="color:var(--text-faint); font-style:italic;">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸</td></tr>`;
    return;
  }

  tbody.innerHTML = logs.map(l => `
    <tr>
      <td style="color:var(--rose); font-weight:600;">${l.time}</td>
      <td>${l.hr || '-'}</td>
      <td>${l.rr || '-'}</td>
      <td>${l.spo2 || '-'}</td>
      <td>${l.temp || '-'}</td>
      <td style="color:var(--teal-light);">${l.zol || '-'}</td>
      <td style="text-align:left; font-size:11px;">${l.note || '-'}</td>
    </tr>
  `).join('');
};

// â”€â”€ à¸ªà¹ˆà¸‡à¹„à¸›à¸à¸±à¸à¸Ÿà¸·à¹‰à¸™ â”€â”€
window.finishSurgery = async function(animalId) {
  const surgeonInput = document.getElementById(`surgeon-${animalId}`);
  
  if (!surgeonInput || !surgeonInput.value.trim()) {
    const infoTabBtn = document.getElementById(`btn-tab-info-${animalId}`);
    if (infoTabBtn) infoTabBtn.click();
    
    surgeonInput.classList.add('error');
    surgeonInput.focus();
    alert("âš ï¸ à¸à¸£à¸¸à¸“à¸²à¸£à¸°à¸šà¸¸à¸Šà¸·à¹ˆà¸­ à¸ªà¸±à¸•à¸§à¹à¸à¸—à¸¢à¹Œà¸œà¸¹à¹‰à¸œà¹ˆà¸²à¸•à¸±à¸” (Surgeon) à¸à¹ˆà¸­à¸™à¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸´à¹‰à¸™à¸à¸²à¸£à¸œà¹ˆà¸²à¸•à¸±à¸”à¸„à¸£à¸±à¸š");
    return;
  }

  if (!confirm("à¸¢à¸·à¸™à¸¢à¸±à¸™à¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸´à¹‰à¸™à¸à¸²à¸£à¸œà¹ˆà¸²à¸•à¸±à¸”à¹à¸¥à¸°à¸ªà¹ˆà¸‡à¹„à¸›à¸¢à¸±à¸‡à¸«à¹‰à¸­à¸‡à¸à¸±à¸à¸Ÿà¸·à¹‰à¸™?\n(à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸ˆà¸°à¸–à¸¹à¸à¸šà¸±à¸™à¸—à¸¶à¸à¹ƒà¸™à¹€à¸„à¸ªà¸™à¸µà¹‰)")) return;

  try {
    const { error } = await supabase.from("vasd_queue").update({ status: "recovery", updated_at: new Date() }).eq("animal_id", animalId);
    if (error) throw error;
    
    loadSurgeryQueue();
  } catch (err) {
    alert("âŒ à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”: " + err.message);
  }
};

/* â”€â”€ Real-time â”€â”€ */
supabase.channel("vasd-surgery-live")
  .on("postgres_changes", { event: "*", schema: "public", table: "vasd_queue" }, loadSurgeryQueue)
  .subscribe();

loadSurgeryQueue();
</script>
</body>
</html>
