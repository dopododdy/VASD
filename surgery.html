<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>RMUTTO - VASD | ‡πÇ‡∏ï‡πä‡∏∞‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î (Surgery)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&family=Prompt:wght@300;400;500;700&family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>
:root {
  --navy:#0d1b2a; --teal:#1a6b72; --teal-light:#22919a; --accent:#00d4aa;
  --bg:#f0f4f8; --surface:#fff; --text:#1a202c; --text-muted:#718096;
  --border:#e2e8f0; --danger:#e53e3e; --success:#38a169; --warning:#d69e2e;
  --shadow-sm:0 1px 3px rgba(0,0,0,0.06); --shadow-md:0 4px 16px rgba(13,27,42,0.08);
  --radius:10px; --radius-sm:6px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{font-family:"Sarabun",sans-serif;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;}

/* HEADER */
header{
  background:var(--navy);padding:0 32px;display:flex;
  justify-content:space-between;align-items:center;height:68px;
  position:sticky;top:0;z-index:100;box-shadow:0 2px 20px rgba(0,0,0,0.25);flex-shrink:0;
}
.header-brand{display:flex;align-items:center;gap:14px;}
.brand-icon{
  width:40px;height:40px;background:linear-gradient(135deg,var(--teal-light),var(--accent));
  border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;
}
.brand-text h1{font-size:17px;font-weight:700;color:#fff;line-height:1.2;}
.brand-text span{font-size:11px;color:rgba(255,255,255,0.5);}
.btn-home{
  padding:8px 18px;font-size:13px;font-weight:600;font-family:"Sarabun",sans-serif;
  background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.9);
  border:1px solid rgba(255,255,255,0.2);border-radius:var(--radius-sm);cursor:pointer;
}

/* MAIN CONTENT */
.main-content { padding: 24px 32px; flex: 1; overflow-y: auto; }
.section-title { font-size: 20px; font-weight: 700; color: var(--navy); margin-bottom: 20px; display: flex; align-items: center; gap: 8px; border-bottom: 2px solid var(--border); padding-bottom: 12px;}

/* GRID LAYOUTS */
.grid-surgery { display:grid; grid-template-columns:1fr; gap:24px; }

/* CARDS */
.card { background:var(--surface); border-radius:var(--radius); border:1px solid var(--border); box-shadow:var(--shadow-sm); padding:20px; }
.card-header { display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); padding-bottom:12px; margin-bottom:16px; }
.badge-q { background:var(--navy); color:#fff; padding:4px 10px; border-radius:20px; font-size:13px; font-weight:700; }

/* FORMS & TABLES */
.form-control { width:100%; padding:8px 12px; font-family:"Sarabun"; border:1px solid var(--border); border-radius:var(--radius-sm); outline:none; font-size:14px; }
.form-control:focus { border-color:var(--teal); }

.staff-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; background:#f0f4f8; padding:16px; border-radius:var(--radius-sm); margin-bottom:16px; }

.vital-table { width:100%; border-collapse:collapse; margin-bottom:12px; font-size:13px; }
.vital-table th { background:var(--bg); padding:10px; border:1px solid var(--border); text-align:left; color:var(--text-muted); font-weight: 600; position: sticky; top: 0;}
.vital-table td { padding:10px; border:1px solid var(--border); text-align:center; }
.vital-form { display:flex; gap:6px; background:#fff; padding:12px; border:1px solid var(--border); border-radius:var(--radius-sm); margin-bottom:16px; flex-wrap:wrap; align-items: center; }
.vital-form input { flex:1; min-width:70px; padding:8px; font-size:13px; border:1px solid var(--border); border-radius:4px; text-align: center; }

/* BUTTONS */
.btn { padding:10px 16px; font-size:14px; font-weight:700; font-family:"Sarabun"; border:none; border-radius:6px; cursor:pointer; transition: 0.2s;}
.btn-primary { background:var(--teal); color:#fff; }
.btn-primary:hover { background:var(--teal-light); }
.btn-success { background:var(--success); color:#fff; }
.btn-success:hover { background:#2f855a; }
.btn-warning { background:var(--warning); color:#fff; }
.btn-warning:hover { background:#b7791f; }
.action-bar { display:flex; justify-content:flex-end; gap:12px; margin-top:20px; padding-top:16px; border-top:1px solid var(--border); }

/* MODAL */
.modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999; justify-content:center; align-items:center; }
.modal { background:#fff; width:90%; max-width:600px; border-radius:var(--radius); padding:24px; box-shadow:var(--shadow-md); }
.modal-header { font-size:18px; font-weight:700; margin-bottom:16px; border-bottom:1px solid var(--border); padding-bottom:12px; }

@keyframes fadeIn{from{opacity:0;transform:translateY(5px);}to{opacity:1;transform:translateY(0);}}
</style>
</head>
<body>

<header>
  <div class="header-brand">
    <div class="brand-icon">üî¨</div>
    <div class="brand-text">
      <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏ï‡πä‡∏∞‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î (Surgery)</h1>
      <span>RMUTTO ‚Äì Veterinary Academic Service Division</span>
    </div>
  </div>
  <button class="btn-home" onclick="location.href='index.html'">üè† ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
</header>

<div class="main-content">
  <div class="section-title">üìã ‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î / ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏≤‡∏á‡∏¢‡∏≤‡∏™‡∏•‡∏ö</div>
  <div class="grid-surgery" id="surgeryGrid">
    <p style="color:var(--text-muted);">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
  </div>
</div>

<div class="modal-overlay" id="rxModal">
  <div class="modal">
    <div class="modal-header">üíä ‡∏™‡∏±‡πà‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤ (Prescription) <span id="rxAnimalName" style="color:var(--teal);"></span></div>
    <div id="rxFormList" style="display:flex; flex-direction:column; gap:12px; max-height:400px; overflow-y:auto; margin-bottom:20px;">
      </div>
    <div class="action-bar">
      <button class="btn" onclick="closeRxModal()" style="background:#e2e8f0; color:var(--text);">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn btn-success" onclick="saveRx()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤</button>
    </div>
  </div>
</div>

<script type="module">
import { supabase } from "./js/supabase.js";

let currentEventId = null;
let currentRxAnimalId = null;

async function init() {
  const { data: eventId } = await supabase.rpc("get_today_event");
  currentEventId = eventId;
  loadSurgeryCases();
}

// ==========================================
// ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Ñ‡∏™‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏î‡∏°‡∏¢‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î‡∏≠‡∏¢‡∏π‡πà)
// ==========================================
async function loadSurgeryCases() {
  // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á Event ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error ‡∏à‡∏≤‡∏Å .in() ‡πÉ‡∏ô PostgREST ‡∏ö‡∏≤‡∏á‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô
  const { data, error } = await supabase
    .from("vasd_animal")
    .select(`
      id, event_id, queue_number, animal_name, species, sex, actual_weight, health_note,
      vasd_owner(owner_name, phone),
      vasd_service(service_type),
      vasd_queue!inner(id, status, table_number, surgeon_name, anesthesiologist_name, notes),
      vasd_vital_signs(*)
    `)
    .eq("event_id", currentEventId)
    .order("queue_number");

  const grid = document.getElementById("surgeryGrid");

  if (error) {
    console.error("Supabase Query Error:", error);
    grid.innerHTML = `<div style="text-align:center; padding:40px; color:var(--danger);">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${error.message}</div>`;
    return;
  }

  // ‡∏Å‡∏£‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢ JavaScript ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ 'anesthesia' (‡∏ß‡∏≤‡∏á‡∏¢‡∏≤) ‡πÅ‡∏•‡∏∞ 'surgery' (‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î)
  const activeCases = data.filter(a => {
    const status = a.vasd_queue[0]?.status;
    return status === 'anesthesia' || status === 'surgery';
  });

  if (!activeCases || activeCases.length === 0) {
    grid.innerHTML = `<div style="text-align:center; padding:40px; background:var(--surface); border:1px dashed var(--border); border-radius:var(--radius); color:var(--text-muted);">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏™‡∏£‡∏≠‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</div>`;
    return;
  }

  grid.innerHTML = activeCases.map(a => {
    const q = a.vasd_queue[0];
    const ownerName = a.vasd_owner?.owner_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    const phone = a.vasd_owner?.phone || '-';
    
    // ‡∏î‡∏∂‡∏á‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á
    const services = (a.vasd_service || []).map(s => s.service_type).join(', ');
    const displayServices = services ? services : '<span style="color:#aaa;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</span>';
    
    // Parse Staff ‡∏à‡∏≤‡∏Å notes 
    let extraNotes = { assistant: '', nurse: '' };
    try { if(q.notes) extraNotes = JSON.parse(q.notes); } catch(e){}

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Option ‡πÇ‡∏ï‡πä‡∏∞‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
    let tableOptions = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î --</option>';
    for(let i=1; i<=20; i++) {
      let selected = (q.table_number === i) ? 'selected' : '';
      tableOptions += `<option value="${i}" ${selected}>‡πÇ‡∏ï‡πä‡∏∞‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î‡∏ó‡∏µ‡πà ${i}</option>`;
    }

    // ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Vitals ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤
    const vitals = (a.vasd_vital_signs || []).sort((x, y) => {
        const t1 = x.time_recorded || x.created_at || "";
        const t2 = y.time_recorded || y.created_at || "";
        return t1.localeCompare(t2);
    });
    
    let vitalRows = vitals.map(v => {
      let timeStr = v.time_recorded ? v.time_recorded.substring(0,5) : (v.created_at ? new Date(v.created_at).toLocaleTimeString("th-TH").substring(0,5) : '-');
      return `<tr>
        <td>${timeStr}</td><td>${v.hr||'-'}</td><td>${v.rr||'-'}</td><td>${v.temp||'-'}</td>
        <td>${v.spo2 ? v.spo2+'%' : '-'}</td><td>${v.zoletil_top||'-'}</td><td style="text-align:left;">${v.note||'-'}</td>
      </tr>`;
    }).join("");
    if(vitals.length === 0) vitalRows = `<tr><td colspan="7" style="text-align:center; color:#aaa; padding: 20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ä‡∏µ‡∏û</td></tr>`;

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏™‡∏°‡∏≠
    const currentTime = new Date().toTimeString().substring(0,5);

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏Ç‡∏≠‡∏á Card ‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å‡πÅ‡∏¢‡∏∞‡∏ß‡πà‡∏≤ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏≤‡∏á‡∏¢‡∏≤‡∏™‡∏•‡∏ö ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Ç‡∏∂‡πâ‡∏ô‡πÇ‡∏ï‡πä‡∏∞‡πÅ‡∏•‡πâ‡∏ß
    const isAnesthesia = (q.status === 'anesthesia');
    const cardBorderColor = isAnesthesia ? 'var(--warning)' : 'var(--teal)';
    const headerTitle = isAnesthesia ? 'üíâ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏≤‡∏á‡∏¢‡∏≤‡∏™‡∏•‡∏ö (‡∏£‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞)' : `üî¨ ‡πÇ‡∏ï‡πä‡∏∞‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î‡∏ó‡∏µ‡πà ${q.table_number}`;

    return `
      <div class="card" style="border-top: 4px solid ${cardBorderColor};">
        <div class="card-header" style="background:#f7fafc; padding:16px; margin:-20px -20px 20px -20px; border-radius:10px 10px 0 0;">
          <div style="font-size:18px; font-weight:700; color:${cardBorderColor};">
            ${headerTitle}
          </div>
          <span class="badge-q">‡∏Ñ‡∏¥‡∏ß ${a.queue_number}</span>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:24px;">
          <div>
            <div style="background:#fff; border:1px solid var(--border); padding:16px; border-radius:var(--radius-sm); margin-bottom:16px; font-size:14px; line-height:1.8;">
              <div style="display:flex; justify-content:space-between; margin-bottom: 8px;">
                <strong>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå: <span style="color:var(--navy); font-size:16px;">${a.animal_name}</span></strong>
                <span>${a.species === '‡∏™' ? '‡∏™‡∏∏‡∏ô‡∏±‡∏Ç üê∂' : '‡πÅ‡∏°‡∏ß üê±'} | ${a.sex} | ${a.actual_weight} kg</span>
              </div>
              <div style="border-top: 1px dashed var(--border); padding-top: 8px; margin-top: 8px;">
                <strong>‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á:</strong> ${ownerName} (‡πÇ‡∏ó‡∏£: ${phone})<br>
                <strong>‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö:</strong> <span style="color:var(--teal); font-weight: 600;">${displayServices}</span><br>
                <strong>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (Health Note):</strong> <span style="color:var(--danger);">${a.health_note || '‡πÑ‡∏°‡πà‡∏°‡∏µ'}</span>
              </div>
            </div>

            <h4 style="font-size:14px; color:var(--navy); margin-bottom: 10px;">üë®‚Äç‚öïÔ∏è ‡∏£‡∏∞‡∏ö‡∏∏‡πÇ‡∏ï‡πä‡∏∞ ‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡∏°‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î</h4>
            <div class="staff-grid">
              <div style="grid-column: 1 / -1;">
                <label style="font-size:12px; color:var(--text-muted); font-weight:bold;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î *</label>
                <select class="form-control" id="table-sel-${a.id}">${tableOptions}</select>
              </div>
              <div><label style="font-size:12px; color:var(--text-muted);">Surgeon (‡∏®‡∏±‡∏•‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå) *</label><input type="text" class="form-control" id="surg-${a.id}" value="${q.surgeon_name || ''}" placeholder="‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏Å"></div>
              <div><label style="font-size:12px; color:var(--text-muted);">Assistant (‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢)</label><input type="text" class="form-control" id="asst-${a.id}" value="${extraNotes.assistant || ''}" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢"></div>
              <div><label style="font-size:12px; color:var(--text-muted);">Anesthetist (‡∏ß‡∏¥‡∏™‡∏±‡∏ç‡∏ç‡∏µ)</label><input type="text" class="form-control" id="anes-${a.id}" value="${q.anesthesiologist_name || ''}" placeholder="‡∏´‡∏°‡∏≠‡∏î‡∏°‡∏¢‡∏≤"></div>
              <div><label style="font-size:12px; color:var(--text-muted);">Nurse (‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•)</label><input type="text" class="form-control" id="nurs-${a.id}" value="${extraNotes.nurse || ''}" placeholder="‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•"></div>
            </div>
            <button class="btn btn-primary" style="width:100%; margin-bottom:10px; background:var(--navy);" onclick="saveSurgeryInfo('${a.id}')">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏ï‡πä‡∏∞ ‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô</button>
          </div>

          <div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
              <h4 style="font-size:14px; color:var(--navy);">ü©∫ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ä‡∏µ‡∏û (Vital Signs)</h4>
            </div>
            
            <div class="vital-form" style="background:#f7fafc;">
              <input type="time" id="v-time-${a.id}" value="${currentTime}" title="‡πÄ‡∏ß‡∏•‡∏≤" style="flex:0.8; font-weight:bold;">
              <input type="number" id="v-hr-${a.id}" placeholder="HR">
              <input type="number" id="v-rr-${a.id}" placeholder="RR">
              <input type="number" id="v-temp-${a.id}" placeholder="Temp(F)">
              <input type="number" id="v-spo2-${a.id}" placeholder="SpO2%">
              <input type="text" id="v-zol-${a.id}" placeholder="Zoletil">
              <input type="text" id="v-note-${a.id}" placeholder="Note" style="flex:2; text-align:left;">
              <button class="btn btn-primary" onclick="addVital('${a.id}')">‚ûï ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
            
            <div style="max-height:220px; overflow-y:auto; border:1px solid var(--border); border-radius:6px;">
              <table class="vital-table" style="margin:0;">
                <thead><tr><th width="15%">‡πÄ‡∏ß‡∏•‡∏≤</th><th width="12%">HR</th><th width="12%">RR</th><th width="12%">Temp</th><th width="12%">O2%</th><th width="12%">Zoletil</th><th width="25%">Note</th></tr></thead>
                <tbody>${vitalRows}</tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="action-bar" style="background:#f0f4f8; margin:-20px -20px; padding:16px 20px; margin-top:20px; border-radius:0 0 10px 10px;">
          <button class="btn btn-warning" onclick="openRxModal('${a.id}', '${a.animal_name}')">üíä ‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤</button>
          <button class="btn btn-success" onclick="finishSurgery('${a.id}')">‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î</button>
        </div>
      </div>
    `;
  }).join("");
}

// ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞ ‡πÅ‡∏•‡∏∞ ‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î
window.saveSurgeryInfo = async function(animalId) {
  const tableNum = document.getElementById(`table-sel-${animalId}`).value;
  const surg = document.getElementById(`surg-${animalId}`).value;
  const asst = document.getElementById(`asst-${animalId}`).value;
  const anes = document.getElementById(`anes-${animalId}`).value;
  const nurs = document.getElementById(`nurs-${animalId}`).value;

  const extraNotes = JSON.stringify({ assistant: asst, nurse: nurs });

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô surgery (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡πÇ‡∏ï‡πä‡∏∞‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß)
  const { error } = await supabase.from('vasd_queue').update({
    status: 'surgery',
    table_number: tableNum ? parseInt(tableNum) : null,
    surgeon_name: surg,
    anesthesiologist_name: anes,
    notes: extraNotes,
    updated_at: new Date()
  }).eq('animal_id', animalId);

  if(error) alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
  else {
    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏ï‡πä‡∏∞‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î ‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
    loadSurgeryCases(); // ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏µ‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
  }
};

// ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Vital Signs
window.addVital = async function(animalId) {
  const timeInput = document.getElementById(`v-time-${animalId}`).value;
  if (!timeInput) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤");

  const { error } = await supabase.from('vasd_vital_signs').insert({
    animal_id: animalId,
    time_recorded: timeInput,
    hr: document.getElementById(`v-hr-${animalId}`).value || null,
    rr: document.getElementById(`v-rr-${animalId}`).value || null,
    temp: document.getElementById(`v-temp-${animalId}`).value || null,
    spo2: document.getElementById(`v-spo2-${animalId}`).value || null,
    zoletil_top: document.getElementById(`v-zol-${animalId}`).value || null,
    note: document.getElementById(`v-note-${animalId}`).value || null
  });

  if (error) {
    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ä‡∏µ‡∏û‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
  } else {
    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤
    document.getElementById(`v-hr-${animalId}`).value = '';
    document.getElementById(`v-rr-${animalId}`).value = '';
    document.getElementById(`v-temp-${animalId}`).value = '';
    document.getElementById(`v-spo2-${animalId}`).value = '';
    document.getElementById(`v-zol-${animalId}`).value = '';
    document.getElementById(`v-note-${animalId}`).value = '';
    loadSurgeryCases(); // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
  }
};

// ==========================================
// MODAL: ‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤ (Prescription)
// ==========================================
window.openRxModal = function(animalId, animalName) {
  currentRxAnimalId = animalId;
  document.getElementById("rxAnimalName").innerText = `- ${animalName}`;
  
  let formHtml = '';
  for(let i=1; i<=3; i++) {
    formHtml += `
      <div style="display:flex; gap:10px; background:#f7fafc; padding:10px; border:1px solid var(--border); border-radius:6px; align-items:center;">
        <span style="font-weight:bold; color:var(--text-muted);">${i}.</span>
        <input type="text" id="rx-name-${i}" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤" style="flex:2;">
        <input type="text" id="rx-dose-${i}" class="form-control" placeholder="Dose (‡πÄ‡∏ä‡πà‡∏ô 1 ‡πÄ‡∏°‡πá‡∏î)">
        <input type="text" id="rx-freq-${i}" class="form-control" placeholder="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà (‡πÄ‡∏ä‡πà‡∏ô 2 ‡πÄ‡∏ß‡∏•‡∏≤)">
        <input type="number" id="rx-days-${i}" class="form-control" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô" style="width:80px;">
        <input type="number" id="rx-total-${i}" class="form-control" placeholder="‡∏£‡∏ß‡∏°‡πÄ‡∏°‡πá‡∏î" style="width:80px;">
      </div>
    `;
  }
  document.getElementById("rxFormList").innerHTML = formHtml;
  document.getElementById("rxModal").style.display = "flex";
};

window.closeRxModal = function() {
  document.getElementById("rxModal").style.display = "none";
  currentRxAnimalId = null;
};

window.saveRx = async function() {
  const rxInserts = [];
  for(let i=1; i<=3; i++) {
    const name = document.getElementById(`rx-name-${i}`).value;
    if(name.trim() !== '') {
      rxInserts.push({
        animal_id: currentRxAnimalId,
        drug_id: name,
        dose: document.getElementById(`rx-dose-${i}`).value,
        freq: document.getElementById(`rx-freq-${i}`).value,
        days: parseInt(document.getElementById(`rx-days-${i}`).value) || null,
        total_pills: parseFloat(document.getElementById(`rx-total-${i}`).value) || 0
      });
    }
  }

  if(rxInserts.length > 0) {
    const { error } = await supabase.from("vasd_prescription").insert(rxInserts);
    if(error) {
      alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
      return;
    }
  }
  alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÇ‡∏ï‡πä‡∏∞‡∏à‡∏±‡∏î‡∏¢‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ");
  closeRxModal();
};

// ==========================================
// ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î (‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏û‡∏±‡∏Å‡∏ü‡∏∑‡πâ‡∏ô)
// ==========================================
window.finishSurgery = async function(animalId) {
  const surgInput = document.getElementById(`surg-${animalId}`).value;
  const tableInput = document.getElementById(`table-sel-${animalId}`).value;

  if(!tableInput) {
    alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î' ‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡πà‡∏≠‡∏ô");
    document.getElementById(`table-sel-${animalId}`).focus();
    return;
  }
  
  if(!surgInput || surgInput.trim() === "") {
    alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠ 'Surgeon (‡∏®‡∏±‡∏•‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå)' ‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡πà‡∏≠‡∏ô");
    document.getElementById(`surg-${animalId}`).focus();
    return;
  }

  if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡∏´‡πâ‡∏≠‡∏á '‡∏û‡∏±‡∏Å‡∏ü‡∏∑‡πâ‡∏ô' (Recovery) ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;

  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏ï‡πä‡∏∞‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏ó‡∏¥‡πâ‡∏á‡∏ó‡∏ß‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡πâ‡∏≤‡∏¢ Status
  await saveSurgeryInfo(animalId);

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô recovery ‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏¥‡πâ‡∏á
  const { error } = await supabase
    .from("vasd_queue")
    .update({ status: "recovery", table_number: null, updated_at: new Date() })
    .eq("animal_id", animalId);

  if (error) alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
  else {
    alert("‚úÖ ‡∏™‡πà‡∏á‡πÄ‡∏Ñ‡∏™‡πÑ‡∏õ‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å‡∏ü‡∏∑‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
    loadSurgeryCases();
  }
};

// Real-time Update
supabase.channel("surgery-live")
  .on("postgres_changes", { event: "*", schema: "public", table: "vasd_queue" }, loadSurgeryCases)
  .on("postgres_changes", { event: "*", schema: "public", table: "vasd_vital_signs" }, loadSurgeryCases)
  .subscribe();

init();
</script>
</body>
</html>
